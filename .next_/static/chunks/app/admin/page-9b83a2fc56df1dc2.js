(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3698],{235:(e,s,a)=>{"use strict";a.d(s,{J:()=>o});var t=a(5155),l=a(2115),n=a(2894),i=a(3101),r=a(5016);let d=(0,i.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),o=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.b,{ref:s,className:(0,r.cn)(d(),a),...l})});o.displayName=n.b.displayName},689:(e,s,a)=>{Promise.resolve().then(a.bind(a,5975)),Promise.resolve().then(a.bind(a,8232)),Promise.resolve().then(a.bind(a,923))},923:(e,s,a)=>{"use strict";a.d(s,{Tabs:()=>r,TabsContent:()=>c,TabsList:()=>d,TabsTrigger:()=>o});var t=a(5155),l=a(2115),n=a(5667),i=a(5016);let r=n.bL,d=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.B8,{ref:s,className:(0,i.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",a),...l})});d.displayName=n.B8.displayName;let o=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.l9,{ref:s,className:(0,i.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",a),...l})});o.displayName=n.l9.displayName;let c=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.UC,{ref:s,className:(0,i.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...l})});c.displayName=n.UC.displayName},4679:(e,s,a)=>{"use strict";a.d(s,{Cf:()=>x,Es:()=>p,L3:()=>h,c7:()=>u,lG:()=>d,rr:()=>f,zM:()=>o});var t=a(5155),l=a(2115),n=a(3409),i=a(5229),r=a(5016);let d=n.bL,o=n.l9,c=n.ZL;n.bm;let m=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.hJ,{ref:s,className:(0,r.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...l})});m.displayName=n.hJ.displayName;let x=l.forwardRef((e,s)=>{let{className:a,children:l,showClose:d=!0,...o}=e;return(0,t.jsxs)(c,{children:[(0,t.jsx)(m,{}),(0,t.jsxs)(n.UC,{ref:s,className:(0,r.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-lg",a),...o,children:[l,d&&(0,t.jsxs)(n.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,t.jsx)(i.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"sr-only",children:"閉じる"})]})]})]})});x.displayName=n.UC.displayName;let u=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,r.cn)("flex flex-col space-y-1.5 text-center sm:text-left",s),...a})};u.displayName="DialogHeader";let h=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.hE,{ref:s,className:(0,r.cn)("text-lg font-semibold leading-none tracking-tight",a),...l})});h.displayName=n.hE.displayName;let f=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.VY,{ref:s,className:(0,r.cn)("text-sm text-muted-foreground",a),...l})});f.displayName=n.VY.displayName;let p=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,r.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...a})};p.displayName="DialogFooter"},4916:(e,s,a)=>{"use strict";a.d(s,{S:()=>d});var t=a(5155),l=a(2115),n=a(8162),i=a(5917),r=a(5016);let d=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.bL,{ref:s,className:(0,r.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...l,children:(0,t.jsx)(n.C1,{className:(0,r.cn)("flex items-center justify-center text-current"),children:(0,t.jsx)(i.A,{className:"h-4 w-4"})})})});d.displayName=n.bL.displayName},5016:(e,s,a)=>{"use strict";a.d(s,{cn:()=>n});var t=a(2821),l=a(5889);function n(){for(var e=arguments.length,s=Array(e),a=0;a<e;a++)s[a]=arguments[a];return(0,l.QP)((0,t.$)(s))}},5975:(e,s,a)=>{"use strict";a.d(s,{FamiliesTable:()=>z});var t=a(5155),l=a(2115),n=a(7815),i=a(7e3),r=a(7812),d=a(7003),o=a(6633),c=a(5299),m=a(1169),x=a(4033),u=a(7937),h=a(6170),f=a(235),p=a(4679),j=a(7507),g=a(6583),v=a(6651),b=a(4916);let N=e=>fetch(e).then(e=>e.json());function y(e){let{family:s,open:a,onOpenChange:i,onSuccess:r}=e,[o,m]=(0,l.useState)(""),[x,u]=(0,l.useState)([]),[y,w]=(0,l.useState)(!1),{data:_=[]}=(0,n.Ay)("/api/profiles",N),k=s.members.map(e=>e.id),C=_.filter(e=>{var s,a;if(k.includes(e.id)||x.some(s=>s.profile.id===e.id)||!o.trim())return!1;let t=o.toLowerCase();return(null==(s=e.display_name)?void 0:s.toLowerCase().includes(t))||(null==(a=e.ticket_number)?void 0:a.toLowerCase().includes(t))});async function A(){if(0===x.length)return void alert("追加するメンバーを選択してください");w(!0);try{for(let e of x){let a=await fetch("/api/families/".concat(s.id,"/members"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e.profile.id,family_role:e.role})});if(!a.ok){let s=await a.json();throw Error(s.error||"".concat(e.profile.display_name," の追加に失敗しました"))}}r(),i(!1),m(""),u([])}catch(e){console.error("メンバー追加エラー:",e),alert(e instanceof Error?e.message:"メンバーの追加に失敗しました。もう一度お試しください。")}finally{w(!1)}}return(0,t.jsx)(p.lG,{open:a,onOpenChange:i,children:(0,t.jsxs)(p.Cf,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(p.c7,{children:(0,t.jsxs)(p.L3,{className:"flex items-center gap-2",children:[(0,t.jsx)(g.A,{className:"h-5 w-5"}),"メンバーを追加 - ",s.family_name]})}),(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsxs)("div",{className:"text-sm text-muted-foreground",children:["現在のメンバー数: ",s.member_count,"人"]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(f.J,{children:"追加するメンバーを検索"}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(v.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(h.p,{value:o,onChange:e=>m(e.target.value),placeholder:"名前または診察券番号で検索...",className:"pl-10"})]})]}),o.trim()&&(0,t.jsx)("div",{className:"space-y-2 max-h-[200px] overflow-y-auto border rounded-lg p-2",children:0===C.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"該当する患者がいません"}):C.map(e=>{let s=x.some(s=>s.profile.id===e.id);return(0,t.jsxs)("div",{className:"flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer",onClick:()=>{x.find(s=>s.profile.id===e.id)?u(x.filter(s=>s.profile.id!==e.id)):u([...x,{profile:e,role:"child"}])},children:[(0,t.jsx)(b.S,{checked:s}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("span",{className:"font-medium",children:e.display_name||"—"}),(0,t.jsxs)("span",{className:"text-xs text-muted-foreground ml-2",children:["(",e.ticket_number||"診察券なし",")"]})]})]},e.id)})}),x.length>0&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(f.J,{className:"text-sm font-semibold",children:["追加するメンバー (",x.length,"人)"]}),(0,t.jsx)("div",{className:"space-y-2",children:x.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-3 bg-slate-50 rounded-lg border",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[(0,t.jsx)("span",{className:"font-medium",children:e.profile.display_name||"—"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:e.profile.ticket_number||"—"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(j.l6,{value:e.role,onValueChange:s=>{var a;return a=e.profile.id,void u(x.map(e=>e.profile.id===a?{...e,role:s}:e))},children:[(0,t.jsx)(j.bq,{className:"w-[120px]",children:(0,t.jsx)(j.yv,{})}),(0,t.jsxs)(j.gC,{children:[(0,t.jsx)(j.eb,{value:"parent",children:"保護者"}),(0,t.jsx)(j.eb,{value:"child",children:"子ども"})]})]}),(0,t.jsx)(d.$,{size:"sm",variant:"ghost",onClick:()=>u(x.filter(s=>s.profile.id!==e.profile.id)),children:"削除"})]})]},e.profile.id))})]})]}),(0,t.jsxs)(p.Es,{className:"gap-2",children:[(0,t.jsx)(d.$,{variant:"outline",onClick:()=>i(!1),disabled:y,children:"キャンセル"}),(0,t.jsx)(d.$,{onClick:A,disabled:y||0===x.length,children:y?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.A,{className:"h-4 w-4 mr-2 animate-spin"}),"追加中..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.A,{className:"h-4 w-4 mr-2"}),"メンバーを追加"]})})]})]})})}var w=a(8514);function _(e){let{family:s,open:a,onOpenChange:n,onSuccess:i}=e,[r,o]=(0,l.useState)(s.family_name),[m,x]=(0,l.useState)(!1);async function u(){if(!r.trim())return void alert("家族名を入力してください");if(r.trim()===s.family_name)return void n(!1);x(!0);try{let e=await fetch("/api/families/".concat(s.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({family_name:r.trim()})});if(!e.ok){let s=await e.json();throw Error(s.error||"家族名の変更に失敗しました")}i(),n(!1)}catch(e){console.error("家族編集エラー:",e),alert(e instanceof Error?e.message:"家族名の変更に失敗しました。もう一度お試しください。")}finally{x(!1)}}return(0,t.jsx)(p.lG,{open:a,onOpenChange:n,children:(0,t.jsxs)(p.Cf,{className:"max-w-md",children:[(0,t.jsx)(p.c7,{children:(0,t.jsxs)(p.L3,{className:"flex items-center gap-2",children:[(0,t.jsx)(w.A,{className:"h-5 w-5"}),"家族名を編集"]})}),(0,t.jsx)("div",{className:"space-y-4 py-4",children:(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(f.J,{htmlFor:"family-name",children:"家族名"}),(0,t.jsx)(h.p,{id:"family-name",value:r,onChange:e=>o(e.target.value),placeholder:"例: 横山浩紀の家族",autoFocus:!0})]})}),(0,t.jsxs)(p.Es,{className:"gap-2",children:[(0,t.jsx)(d.$,{variant:"outline",onClick:()=>n(!1),disabled:m,children:"キャンセル"}),(0,t.jsx)(d.$,{onClick:u,disabled:m||!r.trim(),children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.A,{className:"h-4 w-4 mr-2 animate-spin"}),"保存中..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(w.A,{className:"h-4 w-4 mr-2"}),"保存"]})})]})]})})}var k=a(2056);function C(e){let{family:s,open:a,onOpenChange:n,onSuccess:i}=e,[r,o]=(0,l.useState)(!1);async function m(){o(!0);try{let e=await fetch("/api/families/".concat(s.id),{method:"DELETE"});if(!e.ok){let s=await e.json();throw Error(s.error||"家族の解散に失敗しました")}i(),n(!1)}catch(e){console.error("家族解散エラー:",e),alert(e instanceof Error?e.message:"家族の解散に失敗しました。もう一度お試しください。")}finally{o(!1)}}return(0,t.jsx)(p.lG,{open:a,onOpenChange:n,children:(0,t.jsxs)(p.Cf,{className:"max-w-md",children:[(0,t.jsxs)(p.c7,{children:[(0,t.jsxs)(p.L3,{className:"flex items-center gap-2 text-rose-600",children:[(0,t.jsx)(k.A,{className:"h-5 w-5"}),"家族を解散しますか？"]}),(0,t.jsxs)(p.rr,{className:"pt-4",children:[(0,t.jsx)("strong",{className:"text-foreground",children:s.family_name})," を解散します。",(0,t.jsx)("br",{}),(0,t.jsx)("br",{}),"すべてのメンバーは個別の家族に戻ります。この操作は取り消せません。"]})]}),(0,t.jsxs)(p.Es,{className:"gap-2",children:[(0,t.jsx)(d.$,{variant:"outline",onClick:()=>n(!1),disabled:r,children:"キャンセル"}),(0,t.jsx)(d.$,{variant:"destructive",onClick:m,disabled:r,children:r?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.A,{className:"h-4 w-4 mr-2 animate-spin"}),"解散中..."]}):"解散する"})]})]})})}function A(e){let{member:s,familyId:a,familyName:n,open:i,onOpenChange:r,onSuccess:o}=e,[m,x]=(0,l.useState)(!1);async function u(){x(!0);try{let e=await fetch("/api/families/".concat(a,"/members/").concat(s.id),{method:"DELETE"});if(!e.ok){let s=await e.json();throw Error(s.error||"メンバーの削除に失敗しました")}o(),r(!1)}catch(e){console.error("メンバー削除エラー:",e),alert(e instanceof Error?e.message:"メンバーの削除に失敗しました。もう一度お試しください。")}finally{x(!1)}}return(0,t.jsx)(p.lG,{open:i,onOpenChange:r,children:(0,t.jsxs)(p.Cf,{className:"max-w-md",children:[(0,t.jsxs)(p.c7,{children:[(0,t.jsxs)(p.L3,{className:"flex items-center gap-2 text-rose-600",children:[(0,t.jsx)(k.A,{className:"h-5 w-5"}),"メンバーを削除しますか？"]}),(0,t.jsxs)(p.rr,{className:"pt-4",children:[(0,t.jsx)("strong",{className:"text-foreground",children:s.display_name||"このメンバー"})," を"," ",(0,t.jsx)("strong",{className:"text-foreground",children:n})," から削除します。",(0,t.jsx)("br",{}),(0,t.jsx)("br",{}),"削除されたメンバーは個別の家族に戻ります。","parent"===s.family_role&&(0,t.jsx)("div",{className:"mt-2 p-2 bg-amber-50 text-amber-800 rounded text-sm",children:"⚠️ このメンバーは保護者です。削除できません。"})]})]}),(0,t.jsxs)(p.Es,{className:"gap-2",children:[(0,t.jsx)(d.$,{variant:"outline",onClick:()=>r(!1),disabled:m,children:"キャンセル"}),(0,t.jsx)(d.$,{variant:"destructive",onClick:u,disabled:m||"parent"===s.family_role,children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.A,{className:"h-4 w-4 mr-2 animate-spin"}),"削除中..."]}):"削除する"})]})]})})}let S=e=>fetch(e).then(e=>e.json());function z(){let{data:e=[],error:s,isLoading:a}=(0,n.Ay)("/api/families",S),[i,r]=(0,l.useState)(null),[x,u]=(0,l.useState)(null),[h,f]=(0,l.useState)(null),[p,j]=(0,l.useState)(null),[g,v]=(0,l.useState)({key:"total_stamp_count",direction:"desc"}),b=(0,l.useMemo)(()=>{let s=e.filter(e=>e.member_count>=2);return s.sort((e,s)=>{let a="asc"===g.direction?1:-1,t=e=>{switch(g.key){case"family_name":var s;return(null!=(s=e.family_name)?s:"").toLowerCase();case"total_stamp_count":return e.total_stamp_count;case"total_visit_count":return e.total_visit_count;case"member_count":return e.member_count;case"last_family_visit":return e.last_family_visit?Date.parse(e.last_family_visit):0}},l=t(e),n=t(s);return l<n?-1*a:l>n?+a:0}),s},[e,g]);function N(e){v(s=>s.key===e?{key:e,direction:"asc"===s.direction?"desc":"asc"}:{key:e,direction:"asc"})}function w(e){return g.key!==e?(0,t.jsx)("span",{className:"ml-1 text-xs text-slate-400",children:"⇅"}):(0,t.jsx)("span",{className:"ml-1 text-xs text-sky-600 font-semibold",children:"asc"===g.direction?"↑":"↓"})}return s?(0,t.jsx)("p",{className:"text-destructive",children:"家族一覧の取得に失敗しました。しばらくしてから再試行してください。"}):a?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-16 space-y-4",children:[(0,t.jsx)(c.A,{className:"h-12 w-12 text-sky-500 animate-spin"}),(0,t.jsx)("p",{className:"text-muted-foreground text-sm",children:"家族データを読み込んでいます..."})]}):(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[b.length,"件の家族が登録されています（2人以上）"]}),(0,t.jsxs)(d.$,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-700",children:[(0,t.jsx)(m.A,{className:"h-4 w-4 mr-1"}),"家族を作成"]})]}),(0,t.jsx)("div",{className:"overflow-hidden rounded-xl border bg-white/90 shadow-sm",children:(0,t.jsxs)(o.XI,{children:[(0,t.jsx)(o.A0,{children:(0,t.jsxs)(o.Hj,{className:"bg-slate-50/80",children:[(0,t.jsx)(o.nd,{className:"w-[50px]"}),(0,t.jsx)(o.nd,{onClick:()=>N("family_name"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["家族名",w("family_name")]})}),(0,t.jsx)(o.nd,{onClick:()=>N("member_count"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["メンバー数",w("member_count")]})}),(0,t.jsx)(o.nd,{onClick:()=>N("total_stamp_count"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["家族合計スタンプ",w("total_stamp_count")]})}),(0,t.jsx)(o.nd,{onClick:()=>N("total_visit_count"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["家族合計来院回数",w("total_visit_count")]})}),(0,t.jsx)(o.nd,{onClick:()=>N("last_family_visit"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["最終来院日",w("last_family_visit")]})}),(0,t.jsx)(o.nd,{children:"操作"})]})}),(0,t.jsx)(o.BF,{children:0===b.length?(0,t.jsx)(o.Hj,{children:(0,t.jsx)(o.nA,{colSpan:7,className:"text-center text-muted-foreground py-8",children:"家族データがありません。"})}):b.map(e=>(0,t.jsx)(E,{family:e,isExpanded:i===e.family_id,onToggleExpand:()=>{var s;return s=e.family_id,void r(e=>e===s?null:s)},onAddMember:e=>u(e),onEdit:(s,a)=>f({id:s,family_name:a,representative_user_id:e.representative_user_id,created_at:e.created_at,updated_at:e.updated_at}),onDelete:(s,a)=>j({id:s,family_name:a,representative_user_id:e.representative_user_id,created_at:e.created_at,updated_at:e.updated_at})},e.family_id))})]})}),x&&(0,t.jsx)(y,{family:x,open:!!x,onOpenChange:e=>!e&&u(null),onSuccess:()=>{u(null)}}),h&&(0,t.jsx)(_,{family:h,open:!!h,onOpenChange:e=>!e&&f(null),onSuccess:()=>{f(null)}}),p&&(0,t.jsx)(C,{family:p,open:!!p,onOpenChange:e=>!e&&j(null),onSuccess:()=>{j(null),r(null)}})]})}function E(e){let{family:s,isExpanded:a,onToggleExpand:h,onAddMember:f,onEdit:p,onDelete:j}=e,{data:g,isLoading:v}=(0,n.Ay)(a?"/api/families/".concat(s.family_id):null,S),b=(null==g?void 0:g.members)||[],[N,y]=(0,l.useState)(null);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(o.Hj,{className:"hover:bg-slate-50/80 transition-colors",children:[(0,t.jsx)(o.nA,{children:(0,t.jsx)(d.$,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:h,children:a?(0,t.jsx)(x.A,{className:"h-4 w-4"}):(0,t.jsx)(u.A,{className:"h-4 w-4"})})}),(0,t.jsx)(o.nA,{className:"font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(m.A,{className:"h-4 w-4 text-slate-400"}),s.family_name]})}),(0,t.jsx)(o.nA,{children:(0,t.jsxs)(r.E,{variant:"outline",className:"font-semibold",children:[s.member_count,"人"]})}),(0,t.jsx)(o.nA,{children:(0,t.jsx)(r.E,{variant:"secondary",className:"font-semibold",children:s.total_stamp_count})}),(0,t.jsx)(o.nA,{children:(0,t.jsxs)(r.E,{variant:"secondary",className:"font-semibold",children:[s.total_visit_count,"回"]})}),(0,t.jsx)(o.nA,{className:"text-muted-foreground text-xs whitespace-nowrap",children:s.last_family_visit?(0,i.B)(s.last_family_visit):"—"}),(0,t.jsx)(o.nA,{children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.$,{size:"sm",variant:"outline",onClick:()=>p(s.family_id,s.family_name),children:"編集"}),(0,t.jsx)(d.$,{size:"sm",variant:"outline",className:"text-rose-600 hover:text-rose-700",onClick:()=>j(s.family_id,s.family_name),children:"解散"})]})})]}),a&&(0,t.jsx)(o.Hj,{children:(0,t.jsx)(o.nA,{colSpan:7,className:"bg-slate-50/50 p-0",children:(0,t.jsx)("div",{className:"p-4 pl-12",children:v?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-2",children:[(0,t.jsx)(c.A,{className:"h-4 w-4 animate-spin"}),"メンバー情報を読み込んでいます..."]}):0===b.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"メンバー情報がありません"}):(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("p",{className:"text-xs font-semibold text-slate-600 mb-3",children:"家族メンバー"}),(0,t.jsx)("div",{className:"grid gap-2",children:b.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between bg-white rounded-lg border p-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(r.E,{variant:"parent"===e.family_role?"default":"secondary",children:"parent"===e.family_role?"保護者":e.line_user_id?"子（スマホあり）":"子（スマホなし）"}),(0,t.jsx)("span",{className:"font-medium",children:e.display_name||"—"}),(0,t.jsxs)("span",{className:"text-xs text-muted-foreground",children:["診察券: ",e.ticket_number||"—"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4 text-sm",children:[(0,t.jsxs)("span",{className:"text-muted-foreground",children:["スタンプ: ",(0,t.jsx)("strong",{children:e.stamp_count})]}),(0,t.jsxs)("span",{className:"text-muted-foreground",children:["来院: ",(0,t.jsxs)("strong",{children:[e.visit_count||0,"回"]})]}),(0,t.jsx)(d.$,{size:"sm",variant:"ghost",className:"text-rose-600 hover:text-rose-700",onClick:()=>y(e),children:"削除"})]})]},e.id))}),(0,t.jsx)("div",{className:"mt-4",children:(0,t.jsxs)(d.$,{size:"sm",variant:"outline",onClick:()=>g&&f(g),children:[(0,t.jsx)(m.A,{className:"h-3.5 w-3.5 mr-1"}),"メンバーを追加"]})})]})})})}),N&&(0,t.jsx)(A,{member:N,familyId:s.family_id,familyName:s.family_name,open:!!N,onOpenChange:e=>!e&&y(null),onSuccess:()=>{y(null)}})]})}},6170:(e,s,a)=>{"use strict";a.d(s,{p:()=>i});var t=a(5155),l=a(2115),n=a(5016);let i=l.forwardRef((e,s)=>{let{className:a,type:l,...i}=e;return(0,t.jsx)("input",{type:l,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:s,...i})});i.displayName="Input"},6633:(e,s,a)=>{"use strict";a.d(s,{A0:()=>r,BF:()=>d,Hj:()=>o,XI:()=>i,nA:()=>m,nd:()=>c});var t=a(5155),l=a(2115),n=a(5016);let i=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("div",{className:"relative w-full overflow-auto",children:(0,t.jsx)("table",{ref:s,className:(0,n.cn)("w-full caption-bottom text-sm",a),...l})})});i.displayName="Table";let r=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("thead",{ref:s,className:(0,n.cn)("[&_tr]:border-b",a),...l})});r.displayName="TableHeader";let d=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("tbody",{ref:s,className:(0,n.cn)("[&_tr:last-child]:border-0",a),...l})});d.displayName="TableBody";let o=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("tr",{ref:s,className:(0,n.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...l})});o.displayName="TableRow";let c=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("th",{ref:s,className:(0,n.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...l})});c.displayName="TableHead";let m=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("td",{ref:s,className:(0,n.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...l})});m.displayName="TableCell"},7e3:(e,s,a)=>{"use strict";function t(e){let s=new Date(e);return new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(s)}a.d(s,{B:()=>t})},7003:(e,s,a)=>{"use strict";a.d(s,{$:()=>o});var t=a(5155),l=a(2115),n=a(2467),i=a(3101),r=a(5016);let d=(0,i.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),o=l.forwardRef((e,s)=>{let{className:a,variant:l,size:i,asChild:o=!1,...c}=e,m=o?n.DX:"button";return(0,t.jsx)(m,{className:(0,r.cn)(d({variant:l,size:i,className:a})),ref:s,...c})});o.displayName="Button"},7507:(e,s,a)=>{"use strict";a.d(s,{bq:()=>x,eb:()=>p,gC:()=>f,l6:()=>c,yv:()=>m});var t=a(5155),l=a(2115),n=a(8786),i=a(4033),r=a(2108),d=a(5917),o=a(5016);let c=n.bL;n.YJ;let m=n.WT,x=l.forwardRef((e,s)=>{let{className:a,children:l,...r}=e;return(0,t.jsxs)(n.l9,{ref:s,className:(0,o.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...r,children:[l,(0,t.jsx)(n.In,{asChild:!0,children:(0,t.jsx)(i.A,{className:"h-4 w-4 opacity-50"})})]})});x.displayName=n.l9.displayName;let u=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.PP,{ref:s,className:(0,o.cn)("flex cursor-default items-center justify-center py-1",a),...l,children:(0,t.jsx)(r.A,{className:"h-4 w-4"})})});u.displayName=n.PP.displayName;let h=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.wn,{ref:s,className:(0,o.cn)("flex cursor-default items-center justify-center py-1",a),...l,children:(0,t.jsx)(i.A,{className:"h-4 w-4"})})});h.displayName=n.wn.displayName;let f=l.forwardRef((e,s)=>{let{className:a,children:l,position:i="popper",...r}=e;return(0,t.jsx)(n.ZL,{children:(0,t.jsxs)(n.UC,{ref:s,className:(0,o.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===i&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:i,...r,children:[(0,t.jsx)(u,{}),(0,t.jsx)(n.LM,{className:(0,o.cn)("p-1","popper"===i&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:l}),(0,t.jsx)(h,{})]})})});f.displayName=n.UC.displayName,l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.JU,{ref:s,className:(0,o.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...l})}).displayName=n.JU.displayName;let p=l.forwardRef((e,s)=>{let{className:a,children:l,...i}=e;return(0,t.jsxs)(n.q7,{ref:s,className:(0,o.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...i,children:[(0,t.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,t.jsx)(n.VF,{children:(0,t.jsx)(d.A,{className:"h-4 w-4"})})}),(0,t.jsx)(n.p4,{children:l})]})});p.displayName=n.q7.displayName,l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(n.wv,{ref:s,className:(0,o.cn)("-mx-1 my-1 h-px bg-muted",a),...l})}).displayName=n.wv.displayName},7812:(e,s,a)=>{"use strict";a.d(s,{E:()=>r});var t=a(5155);a(2115);var l=a(3101),n=a(5016);let i=(0,l.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground",secondary:"border-transparent bg-secondary text-secondary-foreground",destructive:"border-transparent bg-destructive text-destructive-foreground",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function r(e){let{className:s,variant:a,...l}=e;return(0,t.jsx)("div",{className:(0,n.cn)(i({variant:a}),s),...l})}},8232:(e,s,a)=>{"use strict";a.d(s,{PatientsTable:()=>ei});var t=a(5155),l=a(2115),n=a(7815),i=a(7e3);function r(e){if(!e)return null;let[s,a,t]=e.split("-").map(Number);return"".concat(s,"年").concat(a,"月").concat(t,"日")}function d(e){if(!e)return!1;let s=new Date;return s.setHours(0,0,0,0),new Date(e+"T00:00:00")<s}var o=a(7812),c=a(7003),m=a(6170),x=a(235),u=a(4679),h=a(6633),f=a(3409),p=a(3101),j=a(5229),g=a(5016);let v=f.bL;f.l9,f.bm;let b=f.ZL,N=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(f.hJ,{className:(0,g.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...l,ref:s})});N.displayName=f.hJ.displayName;let y=(0,p.F)("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),w=l.forwardRef((e,s)=>{let{side:a="right",className:l,children:n,showClose:i=!0,...r}=e;return(0,t.jsxs)(b,{children:[(0,t.jsx)(N,{}),(0,t.jsxs)(f.UC,{ref:s,className:(0,g.cn)(y({side:a}),l),...r,children:[n,i&&(0,t.jsxs)(f.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[(0,t.jsx)(j.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"sr-only",children:"閉じる"})]})]})]})});w.displayName=f.UC.displayName;let _=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,g.cn)("flex flex-col space-y-1.5 text-center sm:text-left",s),...a})};_.displayName="SheetHeader";let k=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(f.hE,{ref:s,className:(0,g.cn)("text-lg font-semibold leading-none tracking-tight",a),...l})});k.displayName=f.hE.displayName;let C=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,g.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...a})};C.displayName="SheetFooter";let A=["お疲れ様でした。","次回予約は〇〇です。よろしくお願いします。","検診のお知らせです。","ご来院ありがとうございました。"];function S(e){let{profile:s,open:a,onOpenChange:n}=e,[i,r]=(0,l.useState)(""),[d,o]=(0,l.useState)(""),[m,u]=(0,l.useState)(!1),[h,f]=(0,l.useState)(!1),[p,j]=(0,l.useState)(!1),g=[i,d].filter(Boolean).join("\n\n");async function b(){if(g.trim()){u(!0);try{let e=await fetch("/api/profiles/".concat(s.id,"/care-messages"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:g.trim()})});if(!e.ok){let s=await e.json().catch(()=>({}));alert(s.error||"送信に失敗しました。");return}let a=await e.json();j("sent"===a.line_push),f(!0),r(""),o(""),setTimeout(()=>{n(!1),f(!1)},1500)}finally{u(!1)}}}return(0,t.jsx)(v,{open:a,onOpenChange:n,children:(0,t.jsxs)(w,{side:"right",className:"flex flex-col w-full sm:max-w-md",children:[(0,t.jsx)(_,{children:(0,t.jsx)(k,{children:"個別メッセージ送信"})}),(0,t.jsxs)("div",{className:"flex-1 space-y-4 py-4 overflow-auto",children:[(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[s.display_name||"—"," さんへ送信します。内容はケア記録に保存され、患者側の「ケア記録」タブでも確認できます。"]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(x.J,{children:"定型文（任意）"}),(0,t.jsxs)("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:i,onChange:e=>r(e.target.value),children:[(0,t.jsx)("option",{value:"",children:"選択してください"}),A.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(x.J,{htmlFor:"free-text",children:"自由入力"}),(0,t.jsx)("textarea",{id:"free-text",className:"flex min-h-[120px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",placeholder:"追加のメッセージを入力...",value:d,onChange:e=>o(e.target.value)})]}),h&&(0,t.jsx)("p",{className:"text-sm text-green-600",children:p?"送信しました。ケア記録に保存し、LINEにもプッシュしました。":"送信しました。ケア記録に保存されています。（LINE は未設定または送信スキップ）"})]}),(0,t.jsxs)(C,{children:[(0,t.jsx)(c.$,{variant:"outline",onClick:()=>n(!1),children:"キャンセル"}),(0,t.jsx)(c.$,{onClick:b,disabled:!g.trim()||m,children:m?"送信中...":"送信して記録に保存"})]})]})})}var z=a(7599);let E=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(z.bL,{className:(0,g.cn)("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...l,ref:s,children:(0,t.jsx)(z.zi,{className:(0,g.cn)("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})})});E.displayName=z.bL.displayName;var L=a(5937),F=a(6191);let $=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)("textarea",{className:(0,g.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:s,...l})});$.displayName="Textarea";var J=a(7321);let R=l.forwardRef((e,s)=>{let{className:a,orientation:l="horizontal",decorative:n=!0,...i}=e;return(0,t.jsx)(J.b,{ref:s,decorative:n,orientation:l,className:(0,g.cn)("shrink-0 bg-border","horizontal"===l?"h-[1px] w-full":"h-full w-[1px]",a),...i})});R.displayName=J.b.displayName;var T=a(7738),O=a(7937),P=a(5917),D=a(9051);let H=T.bL,B=T.l9;T.YJ,T.ZL,T.Pb,T.z6,l.forwardRef((e,s)=>{let{className:a,inset:l,children:n,...i}=e;return(0,t.jsxs)(T.ZP,{ref:s,className:(0,g.cn)("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",l&&"pl-8",a),...i,children:[n,(0,t.jsx)(O.A,{className:"ml-auto h-4 w-4"})]})}).displayName=T.ZP.displayName,l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(T.G5,{ref:s,className:(0,g.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...l})}).displayName=T.G5.displayName;let I=l.forwardRef((e,s)=>{let{className:a,sideOffset:l=4,...n}=e;return(0,t.jsx)(T.ZL,{children:(0,t.jsx)(T.UC,{ref:s,sideOffset:l,className:(0,g.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...n})})});I.displayName=T.UC.displayName;let U=l.forwardRef((e,s)=>{let{className:a,inset:l,...n}=e;return(0,t.jsx)(T.q7,{ref:s,className:(0,g.cn)("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",l&&"pl-8",a),...n})});U.displayName=T.q7.displayName,l.forwardRef((e,s)=>{let{className:a,children:l,checked:n,...i}=e;return(0,t.jsxs)(T.H_,{ref:s,className:(0,g.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:n,...i,children:[(0,t.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,t.jsx)(T.VF,{children:(0,t.jsx)(P.A,{className:"h-4 w-4"})})}),l]})}).displayName=T.H_.displayName,l.forwardRef((e,s)=>{let{className:a,children:l,...n}=e;return(0,t.jsxs)(T.hN,{ref:s,className:(0,g.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...n,children:[(0,t.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,t.jsx)(T.VF,{children:(0,t.jsx)(D.A,{className:"h-2 w-2 fill-current"})})}),l]})}).displayName=T.hN.displayName,l.forwardRef((e,s)=>{let{className:a,inset:l,...n}=e;return(0,t.jsx)(T.JU,{ref:s,className:(0,g.cn)("px-2 py-1.5 text-sm font-semibold",l&&"pl-8",a),...n})}).displayName=T.JU.displayName,l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(T.wv,{ref:s,className:(0,g.cn)("-mx-1 my-1 h-px bg-muted",a),...l})}).displayName=T.wv.displayName;var G=a(17),M=a(8514),V=a(7125),Z=a(7107),q=a(6132);function X(e){var s,a,n,i,o;let{profile:h,onStampChange:f,onEdit:p,onStampSet:j}=e,[g,v]=(0,l.useState)(!1),[b,N]=(0,l.useState)(!1),[y,w]=(0,l.useState)(null!=(s=h.real_name)?s:""),[_,k]=(0,l.useState)(null!=(a=h.ticket_number)?a:""),[C,A]=(0,l.useState)(h.last_visit_date?h.last_visit_date.slice(0,10):""),[S,z]=(0,l.useState)(null!=(n=h.view_mode)?n:""),[E,L]=(0,l.useState)(null!=(i=h.next_visit_date)?i:""),[F,J]=(0,l.useState)(null!=(o=h.next_memo)?o:""),[T,O]=(0,l.useState)(String(h.stamp_count)),P=e=>{if(v(e),e){var s,a,t,l,n;w(null!=(s=h.real_name)?s:""),k(null!=(a=h.ticket_number)?a:""),A(h.last_visit_date?h.last_visit_date.slice(0,10):""),z(null!=(t=h.view_mode)?t:""),L(null!=(l=h.next_visit_date)?l:""),J(null!=(n=h.next_memo)?n:"")}},D=!!E&&d(E),X=F.length>200,Y=e=>{N(e),e&&O(String(h.stamp_count))};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(H,{children:[(0,t.jsx)(B,{asChild:!0,children:(0,t.jsx)(c.$,{size:"icon",variant:"ghost","aria-label":"その他の操作",children:(0,t.jsx)(G.A,{className:"h-5 w-5"})})}),(0,t.jsxs)(I,{align:"end",children:[(0,t.jsxs)(U,{onClick:()=>P(!0),children:[(0,t.jsx)(M.A,{className:"h-4 w-4 mr-2"}),"編集"]}),(0,t.jsxs)(U,{onClick:()=>f(-1),disabled:h.stamp_count<=0,children:[(0,t.jsx)(V.A,{className:"h-4 w-4 mr-2"}),"-1 スタンプ減らす"]}),(0,t.jsxs)(U,{onClick:()=>Y(!0),children:[(0,t.jsx)(Z.A,{className:"h-4 w-4 mr-2"}),"数値入力"]})]})]}),(0,t.jsx)(u.lG,{open:g,onOpenChange:P,children:(0,t.jsxs)(u.Cf,{className:"max-w-md sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(u.c7,{children:(0,t.jsx)(u.L3,{children:"患者情報を編集"})}),(0,t.jsxs)("div",{className:"grid gap-6 py-4",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"基本情報"}),(0,t.jsxs)("div",{className:"grid gap-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-real-name",children:"本名（管理画面専用）"}),(0,t.jsx)(m.p,{id:"mobile-real-name",value:y,onChange:e=>w(e.target.value),placeholder:"例: 山田 太郎"})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-ticket-number",children:"診察券番号"}),(0,t.jsx)(m.p,{id:"mobile-ticket-number",value:_,onChange:e=>k(e.target.value),placeholder:"例: 12345"})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-last-visit-date",children:"最終来院日"}),(0,t.jsx)(m.p,{id:"mobile-last-visit-date",type:"date",value:C,onChange:e=>A(e.target.value)})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-view-mode",children:"表示モード"}),(0,t.jsxs)("select",{id:"mobile-view-mode",value:S,onChange:e=>z(e.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",children:[(0,t.jsx)("option",{value:"",children:"未設定"}),(0,t.jsx)("option",{value:"adult",children:"大人"}),(0,t.jsx)("option",{value:"kids",children:"キッズ"})]})]})]})]}),(0,t.jsx)(R,{}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"次回来院予定"}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-next-visit-date",children:"次回来院予定日"}),(0,t.jsx)(m.p,{id:"mobile-next-visit-date",type:"date",value:E,onChange:e=>L(e.target.value)}),D&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-amber-600",children:[(0,t.jsx)(q.A,{className:"h-3.5 w-3.5"}),"過去の日付が設定されています"]})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(x.J,{htmlFor:"mobile-next-memo",children:"次回メモ"}),(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)(c.$,{type:"button",variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>J("次回は歯石除去を行います。よろしくお願いします。"),children:"歯石除去"}),(0,t.jsx)(c.$,{type:"button",variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>J("次回は定期検診です。お待ちしております。"),children:"定期検診"})]})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)($,{id:"mobile-next-memo",value:F,onChange:e=>J(e.target.value),placeholder:"次回来院時のメッセージを入力（例: 歯石除去を行います）",rows:4,maxLength:200,className:"resize-none pr-16"}),(0,t.jsxs)("span",{className:"absolute bottom-2 right-2 text-xs ".concat(X?"text-red-600 font-semibold":"text-slate-400"),children:[F.length,"/200"]})]}),X&&(0,t.jsxs)("p",{className:"text-xs text-red-600",children:["200文字を超えています（現在: ",F.length,"文字）"]})]}),(E||F)&&(0,t.jsxs)("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm",children:[(0,t.jsxs)("div",{className:"mb-2 flex items-center gap-1.5 text-xs font-medium text-slate-500",children:[(0,t.jsx)("span",{children:"\uD83D\uDCF1"}),"患者側プレビュー"]}),(0,t.jsxs)("div",{className:"text-slate-700 space-y-1",children:[E&&(0,t.jsxs)("div",{className:"font-semibold",children:["次回来院予定: ",r(E)]}),F&&(0,t.jsx)("div",{className:"whitespace-pre-wrap",children:F})]})]})]})]}),(0,t.jsxs)(u.Es,{className:"flex-row justify-end gap-2",children:[(0,t.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>v(!1),children:"キャンセル"}),(0,t.jsx)(c.$,{size:"sm",onClick:()=>{p({real_name:y.trim()||null,ticket_number:_.trim()||null,last_visit_date:C.trim()||null,view_mode:S.trim()||null,next_visit_date:E.trim()||null,next_memo:F.trim()||null}),v(!1)},disabled:X,children:"保存"})]})]})}),(0,t.jsx)(u.lG,{open:b,onOpenChange:Y,children:(0,t.jsxs)(u.Cf,{children:[(0,t.jsx)(u.c7,{children:(0,t.jsx)(u.L3,{children:"スタンプ数を直接入力"})}),(0,t.jsx)("div",{className:"grid gap-4 py-4",children:(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsxs)(x.J,{htmlFor:"mobile-stamp-count",children:[h.display_name||h.id," のスタンプ数（0〜999）"]}),(0,t.jsx)(m.p,{id:"mobile-stamp-count",type:"number",min:0,max:999,value:T,onChange:e=>O(e.target.value)})]})}),(0,t.jsxs)(u.Es,{children:[(0,t.jsx)(c.$,{variant:"outline",onClick:()=>N(!1),children:"キャンセル"}),(0,t.jsx)(c.$,{onClick:()=>{let e=parseInt(T,10);!Number.isInteger(e)||e<0||e>999||(j(e),N(!1))},children:"保存"})]})]})})]})}function Y(e){let{profile:s,onStampChange:a,onEdit:l,onStampSet:n,onMessage:r,onViewModeToggle:d}=e;return(0,t.jsxs)("div",{className:"bg-white rounded-lg border shadow-sm p-4 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("h3",{className:"font-semibold text-lg truncate",children:s.display_name||"—"}),s.real_name&&(0,t.jsxs)("p",{className:"text-sm font-medium text-slate-700",children:["本名: ",s.real_name]}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["診察券: ",s.ticket_number||"—"]})]}),(0,t.jsx)(o.E,{variant:"secondary",className:"text-lg font-bold px-3 py-1 ml-3 shrink-0",children:s.stamp_count})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"最終来院:"}),(0,t.jsx)("br",{}),(0,t.jsx)("span",{className:"font-medium",children:s.last_visit_date?(0,i.B)(s.last_visit_date):"—"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"最新ログイン:"}),(0,t.jsx)("br",{}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.B)(s.updated_at)})]})]}),(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"公式アカ: "}),!0===s.is_line_friend?(0,t.jsx)("span",{className:"text-emerald-600 font-medium",children:"○ 済"}):(0,t.jsx)("span",{className:"text-muted-foreground",children:"—"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 pt-1",children:[(0,t.jsx)(E,{checked:"kids"===s.view_mode,onCheckedChange:d,"aria-label":"".concat(s.display_name||s.id,"の表示モードを切り替え")}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"kids"===s.view_mode?"キッズモード":"大人モード"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 pt-2",children:[(0,t.jsxs)(c.$,{size:"default",className:"flex-1 bg-indigo-600 hover:bg-indigo-700 text-white border-0 shadow-sm",onClick:r,children:[(0,t.jsx)(L.A,{className:"h-4 w-4 mr-1"}),"メッセージ"]}),(0,t.jsxs)(c.$,{size:"lg",className:"bg-emerald-600 hover:bg-emerald-700 text-white px-6 shadow-sm",onClick:()=>a(1),children:[(0,t.jsx)(F.A,{className:"h-5 w-5 mr-1"}),"+1"]}),(0,t.jsx)(X,{profile:s,onStampChange:a,onEdit:l,onStampSet:n})]})]})}function Q(e){let{patients:s,onStampChange:a,onEdit:l,onStampSet:n,onMessage:i,onViewModeToggle:r}=e;return 0===s.length?(0,t.jsx)("div",{className:"text-center text-muted-foreground py-8 bg-white rounded-lg border",children:"該当する患者がいません。"}):(0,t.jsx)("div",{className:"space-y-3",children:s.map(e=>(0,t.jsx)(Y,{profile:e,onStampChange:s=>a(e.id,s),onEdit:s=>l(e.id,s),onStampSet:s=>n(e.id,s),onMessage:()=>i(e),onViewModeToggle:()=>r(e.id,e.view_mode)},e.id))})}var W=a(7507),K=a(1169),ee=a(6651),es=a(5299),ea=a(4916);let et=e=>fetch(e).then(e=>e.json());function el(e){let{representativeProfile:s,open:a,onOpenChange:i,onSuccess:r}=e,[d,h]=(0,l.useState)("".concat(s.display_name||"ユーザー","の家族")),[f,p]=(0,l.useState)(""),[g,v]=(0,l.useState)([]),[b,N]=(0,l.useState)(!1),{data:y=[]}=(0,n.Ay)("/api/profiles",et),w=y.filter(e=>{var a,t;if(e.id===s.id||g.some(s=>s.profile.id===e.id)||!f.trim())return!1;let l=f.toLowerCase();return(null==(a=e.display_name)?void 0:a.toLowerCase().includes(l))||(null==(t=e.ticket_number)?void 0:t.toLowerCase().includes(l))});async function _(){if(!d.trim())return void alert("家族名を入力してください");N(!0);try{let e=[s.id,...g.map(e=>e.profile.id)],a=await fetch("/api/families",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({family_name:d.trim(),representative_user_id:s.id,member_ids:e})});if(!a.ok){let e=await a.json();throw Error(e.error||"家族の作成に失敗しました")}r(),i(!1),h("".concat(s.display_name||"ユーザー","の家族")),p(""),v([])}catch(e){console.error("家族作成エラー:",e),alert(e instanceof Error?e.message:"家族の作成に失敗しました。もう一度お試しください。")}finally{N(!1)}}return(0,t.jsx)(u.lG,{open:a,onOpenChange:i,children:(0,t.jsxs)(u.Cf,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(u.c7,{children:(0,t.jsxs)(u.L3,{className:"flex items-center gap-2",children:[(0,t.jsx)(K.A,{className:"h-5 w-5"}),"家族を作成 - ",s.display_name||"ユーザー"]})}),(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(x.J,{htmlFor:"family-name",children:"家族名"}),(0,t.jsx)(m.p,{id:"family-name",value:d,onChange:e=>h(e.target.value),placeholder:"例: 横山浩紀の家族"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(x.J,{children:"代表者"}),(0,t.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-slate-50 rounded-lg border",children:[(0,t.jsx)(o.E,{children:"保護者"}),(0,t.jsx)("span",{className:"font-medium",children:s.display_name||"—"}),(0,t.jsxs)("span",{className:"text-xs text-muted-foreground",children:["診察券: ",s.ticket_number||"—"]})]})]}),(0,t.jsx)("div",{className:"border-t pt-4",children:(0,t.jsx)(x.J,{className:"text-base font-semibold",children:"家族メンバーを追加"})}),(0,t.jsx)("div",{className:"space-y-2",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(ee.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(m.p,{value:f,onChange:e=>p(e.target.value),placeholder:"名前または診察券番号で検索...",className:"pl-10"})]})}),f.trim()&&(0,t.jsx)("div",{className:"space-y-2 max-h-[200px] overflow-y-auto border rounded-lg p-2",children:0===w.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"該当する患者がいません"}):w.map(e=>{let s=g.some(s=>s.profile.id===e.id);return(0,t.jsxs)("div",{className:"flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer",onClick:()=>{g.find(s=>s.profile.id===e.id)?v(g.filter(s=>s.profile.id!==e.id)):v([...g,{profile:e,role:"child"}])},children:[(0,t.jsx)(ea.S,{checked:s}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("span",{className:"font-medium",children:e.display_name||"—"}),(0,t.jsxs)("span",{className:"text-xs text-muted-foreground ml-2",children:["(",e.ticket_number||"診察券なし",")"]})]})]},e.id)})}),g.length>0&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(x.J,{className:"text-sm font-semibold",children:"選択されたメンバー"}),(0,t.jsx)("div",{className:"space-y-2",children:g.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-3 bg-slate-50 rounded-lg border",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[(0,t.jsx)("span",{className:"font-medium",children:e.profile.display_name||"—"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:e.profile.ticket_number||"—"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(W.l6,{value:e.role,onValueChange:s=>{var a;return a=e.profile.id,void v(g.map(e=>e.profile.id===a?{...e,role:s}:e))},children:[(0,t.jsx)(W.bq,{className:"w-[120px]",children:(0,t.jsx)(W.yv,{})}),(0,t.jsxs)(W.gC,{children:[(0,t.jsx)(W.eb,{value:"parent",children:"保護者"}),(0,t.jsx)(W.eb,{value:"child",children:"子ども"})]})]}),(0,t.jsx)(c.$,{size:"sm",variant:"ghost",onClick:()=>{var s;return s=e.profile.id,void v(g.filter(e=>e.profile.id!==s))},children:(0,t.jsx)(j.A,{className:"h-4 w-4"})})]})]},e.profile.id))})]})]}),(0,t.jsxs)(u.Es,{className:"gap-2",children:[(0,t.jsx)(c.$,{variant:"outline",onClick:()=>i(!1),disabled:b,children:"キャンセル"}),(0,t.jsx)(c.$,{onClick:_,disabled:b||!d.trim(),children:b?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(es.A,{className:"h-4 w-4 mr-2 animate-spin"}),"作成中..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(K.A,{className:"h-4 w-4 mr-2"}),"家族を作成"]})})]})]})})}let en=e=>fetch(e).then(e=>e.json());function ei(){let{data:e=[],error:s,mutate:a,isLoading:d}=(0,n.Ay)("/api/profiles",en),{data:x=[]}=(0,n.Ay)("/api/families",en),[u,f]=(0,l.useState)(""),[p,j]=(0,l.useState)(null),[g,v]=(0,l.useState)(null),[b,N]=(0,l.useState)({key:"updated_at",direction:"desc"}),y=(0,l.useMemo)(()=>{if(!u.trim())return e;let s=u.trim().toLowerCase();return e.filter(e=>{var a,t,l;return(null==(a=e.display_name)?void 0:a.toLowerCase().includes(s))||(null==(t=e.real_name)?void 0:t.toLowerCase().includes(s))||(null==(l=e.ticket_number)?void 0:l.toLowerCase().includes(s))})},[e,u]),w=(0,l.useMemo)(()=>{let e=[...y];return e.sort((e,s)=>{let a="asc"===b.direction?1:-1,t=e=>{var s,a;switch(b.key){case"ticket_number":return(null!=(s=e.ticket_number)?s:"").toLowerCase();case"stamp_count":return e.stamp_count;case"last_visit_date":return e.last_visit_date?Date.parse(e.last_visit_date):0;case"updated_at":return e.updated_at?Date.parse(e.updated_at):0;case"is_line_friend":return+!!e.is_line_friend;case"view_mode":return(null!=(a=e.view_mode)?a:"").toLowerCase();case"family_category":return J(e)}},l=t(e),n=t(s);return l<n?-1*a:l>n?+a:0}),e},[y,b]);function _(e){N(s=>s.key===e?{key:e,direction:"asc"===s.direction?"desc":"asc"}:{key:e,direction:"asc"})}function k(e){return b.key!==e?(0,t.jsx)("span",{className:"ml-1 text-xs text-slate-400",children:"⇅"}):(0,t.jsx)("span",{className:"ml-1 text-xs text-sky-600 font-semibold",children:"asc"===b.direction?"↑":"↓"})}async function C(s,t){let l=await fetch("/api/profiles/".concat(s,"/stamp"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({delta:t})});if(!l.ok)return;let n=await l.json();a(e.map(e=>e.id===s?n:e),{revalidate:!1})}async function A(s,t){let l=await fetch("/api/profiles/".concat(s,"/stamp-set"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({stamp_count:t})});if(!l.ok)return;let n=await l.json();a(e.map(e=>e.id===s?n:e),{revalidate:!1})}async function z(s,t){let l=await fetch("/api/profiles/".concat(s),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!l.ok)return;let n=await l.json();a(e.map(e=>e.id===s?n:e),{revalidate:!1})}async function $(e,s){await z(e,{view_mode:"kids"===s?"adult":"kids"})}function J(e){if(!e.family_id||!e.family_role)return"なし";let s=x.find(s=>s.family_id===e.family_id);return 1===((null==s?void 0:s.member_count)||0)?"なし":"parent"===e.family_role?"保護者":e.line_user_id?"子（スマホあり）":"子（スマホなし）"}return s?(0,t.jsx)("p",{className:"text-destructive",children:"一覧の取得に失敗しました。しばらくしてから再試行してください。"}):d?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-16 space-y-4",children:[(0,t.jsx)(es.A,{className:"h-12 w-12 text-sky-500 animate-spin"}),(0,t.jsx)("p",{className:"text-muted-foreground text-sm",children:"患者データを読み込んでいます..."})]}):(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,t.jsx)(m.p,{placeholder:"名前または診察券番号で検索",value:u,onChange:e=>f(e.target.value),className:"w-full lg:max-w-sm bg-white/80"}),(0,t.jsx)("span",{className:"hidden text-xs text-muted-foreground md:inline",children:"Supabase の `profiles` テーブルとリアルタイム連携しています。"})]}),(0,t.jsx)("div",{className:"hidden lg:block overflow-hidden rounded-xl border bg-white/90 shadow-sm",children:(0,t.jsxs)(h.XI,{children:[(0,t.jsx)(h.A0,{children:(0,t.jsxs)(h.Hj,{className:"bg-slate-50/80",children:[(0,t.jsx)(h.nd,{children:"LINE表示名"}),(0,t.jsx)(h.nd,{children:"本名"}),(0,t.jsx)(h.nd,{onClick:()=>_("family_category"),className:"cursor-pointer select-none w-[140px]",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["区分",k("family_category")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("ticket_number"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["診察券番号",k("ticket_number")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("stamp_count"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["スタンプ数",k("stamp_count")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("last_visit_date"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["最終来院",k("last_visit_date")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("updated_at"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["最新ログイン",k("updated_at")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("is_line_friend"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["公式アカ友だち",k("is_line_friend")]})}),(0,t.jsx)(h.nd,{onClick:()=>_("view_mode"),className:"cursor-pointer select-none",children:(0,t.jsxs)("span",{className:"inline-flex items-center gap-1",children:["表示モード",k("view_mode")]})}),(0,t.jsx)(h.nd,{children:"次回来院予定日"}),(0,t.jsx)(h.nd,{className:"w-[200px]",children:"次回メモ"}),(0,t.jsx)(h.nd,{className:"w-[300px]",children:"操作"})]})}),(0,t.jsx)(h.BF,{children:0===y.length?(0,t.jsx)(h.Hj,{children:(0,t.jsx)(h.nA,{colSpan:12,className:"text-center text-muted-foreground py-8",children:0===e.length?"患者データがありません。":"該当する患者がいません。"})}):w.map(e=>(0,t.jsxs)(h.Hj,{className:"hover:bg-slate-50/80 transition-colors",children:[(0,t.jsx)(h.nA,{className:"font-medium",children:e.display_name||"—"}),(0,t.jsx)(h.nA,{className:"font-medium text-slate-700",children:e.real_name||"—"}),(0,t.jsx)(h.nA,{className:"text-sm whitespace-nowrap",children:J(e)}),(0,t.jsx)(h.nA,{className:"text-muted-foreground",children:e.ticket_number||"—"}),(0,t.jsx)(h.nA,{children:(0,t.jsx)(o.E,{variant:"secondary",className:"font-semibold",children:e.stamp_count})}),(0,t.jsx)(h.nA,{className:"text-muted-foreground text-xs whitespace-nowrap",children:e.last_visit_date?(0,i.B)(e.last_visit_date):"—"}),(0,t.jsx)(h.nA,{className:"text-muted-foreground text-xs whitespace-nowrap",title:"最新ログイン",children:(0,i.B)(e.updated_at)}),(0,t.jsx)(h.nA,{className:"text-center",children:!0===e.is_line_friend?(0,t.jsx)("span",{className:"text-emerald-600 font-medium",title:"公式アカウントの友だち登録済み",children:"〇 済"}):(0,t.jsx)("span",{className:"text-muted-foreground",children:"—"})}),(0,t.jsx)(h.nA,{children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(E,{checked:"kids"===e.view_mode,onCheckedChange:()=>$(e.id,e.view_mode),"aria-label":"".concat(e.display_name||e.id,"の表示モードを切り替え")}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground min-w-[40px]",children:"kids"===e.view_mode?"キッズ":"大人"})]})}),(0,t.jsx)(h.nA,{className:"text-muted-foreground text-xs whitespace-nowrap align-top",children:e.next_visit_date?r(e.next_visit_date):"—"}),(0,t.jsx)(h.nA,{className:"text-muted-foreground text-[11px] max-w-[200px] align-top",children:(0,t.jsx)("div",{className:"whitespace-pre-wrap break-words leading-relaxed",children:e.next_memo||"—"})}),(0,t.jsx)(h.nA,{children:(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)(er,{profile:e,onSave:s=>z(e.id,s)}),(0,t.jsxs)(c.$,{size:"sm",variant:"outline",className:"border-rose-300 text-rose-700 hover:bg-rose-50 hover:border-rose-400 hover:text-rose-800",onClick:()=>C(e.id,-1),disabled:e.stamp_count<=0,children:[(0,t.jsx)(V.A,{className:"h-3.5 w-3.5"})," -1"]}),(0,t.jsxs)(c.$,{size:"sm",variant:"outline",className:"border-emerald-300 text-emerald-700 hover:bg-emerald-50 hover:border-emerald-400 hover:text-emerald-800",onClick:()=>C(e.id,1),children:[(0,t.jsx)(F.A,{className:"h-3.5 w-3.5"})," +1"]}),(0,t.jsx)(ed,{profile:e,onSave:s=>A(e.id,s)}),(0,t.jsxs)(c.$,{size:"sm",variant:"outline",className:"border-emerald-300 text-emerald-700 hover:bg-emerald-50 hover:border-emerald-400",onClick:()=>v(e),children:[(0,t.jsx)(K.A,{className:"h-3.5 w-3.5"}),"家族作成"]}),(0,t.jsxs)(c.$,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white border-0 shadow-sm",onClick:()=>j(e),children:[(0,t.jsx)(L.A,{className:"h-3.5 w-3.5"}),"メッセージ"]})]})})]},e.id))})]})}),(0,t.jsx)("div",{className:"block lg:hidden",children:(0,t.jsx)(Q,{patients:w,onStampChange:C,onEdit:z,onStampSet:A,onMessage:j,onViewModeToggle:$})}),p&&(0,t.jsx)(S,{profile:p,open:!!p,onOpenChange:e=>!e&&j(null)}),g&&(0,t.jsx)(el,{representativeProfile:g,open:!!g,onOpenChange:e=>!e&&v(null),onSuccess:()=>a()})]})}function er(e){var s,a,n,i,o;let{profile:h,onSave:f}=e,[p,j]=(0,l.useState)(!1),[g,v]=(0,l.useState)(null!=(s=h.real_name)?s:""),[b,N]=(0,l.useState)(null!=(a=h.ticket_number)?a:""),[y,w]=(0,l.useState)(h.last_visit_date?h.last_visit_date.slice(0,10):""),[_,k]=(0,l.useState)(null!=(n=h.view_mode)?n:""),[C,A]=(0,l.useState)(null!=(i=h.next_visit_date)?i:""),[S,z]=(0,l.useState)(null!=(o=h.next_memo)?o:""),E=!!C&&d(C),L=S.length>200;return(0,t.jsxs)(u.lG,{open:p,onOpenChange:e=>{if(j(e),e){var s,a,t,l,n;v(null!=(s=h.real_name)?s:""),N(null!=(a=h.ticket_number)?a:""),w(h.last_visit_date?h.last_visit_date.slice(0,10):""),k(null!=(t=h.view_mode)?t:""),A(null!=(l=h.next_visit_date)?l:""),z(null!=(n=h.next_memo)?n:"")}},children:[(0,t.jsx)(u.zM,{asChild:!0,children:(0,t.jsxs)(c.$,{variant:"outline",size:"sm",className:"border-amber-300 text-amber-800 hover:bg-amber-50 hover:border-amber-400",children:[(0,t.jsx)(M.A,{className:"h-3.5 w-3.5"}),"編集"]})}),(0,t.jsxs)(u.Cf,{className:"max-w-md sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(u.c7,{children:(0,t.jsx)(u.L3,{children:"患者情報を編集"})}),(0,t.jsxs)("div",{className:"grid gap-6 py-4",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"基本情報"}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"real-name",children:"本名（管理画面専用）"}),(0,t.jsx)(m.p,{id:"real-name",value:g,onChange:e=>v(e.target.value),placeholder:"例: 山田 太郎"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"ticket-number",children:"診察券番号"}),(0,t.jsx)(m.p,{id:"ticket-number",value:b,onChange:e=>N(e.target.value),placeholder:"例: 12345"})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"last-visit-date",children:"最終来院日"}),(0,t.jsx)(m.p,{id:"last-visit-date",type:"date",value:y,onChange:e=>w(e.target.value)})]})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"view-mode",children:"表示モード"}),(0,t.jsxs)("select",{id:"view-mode",value:_,onChange:e=>k(e.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",children:[(0,t.jsx)("option",{value:"",children:"未設定"}),(0,t.jsx)("option",{value:"adult",children:"大人"}),(0,t.jsx)("option",{value:"kids",children:"キッズ"})]})]})]}),(0,t.jsx)(R,{}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"次回来院予定"}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(x.J,{htmlFor:"next-visit-date",children:"次回来院予定日"}),(0,t.jsx)(m.p,{id:"next-visit-date",type:"date",value:C,onChange:e=>A(e.target.value)}),E&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-amber-600",children:[(0,t.jsx)(q.A,{className:"h-3.5 w-3.5"}),"過去の日付が設定されています"]})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(x.J,{htmlFor:"next-memo",children:"次回メモ"}),(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)(c.$,{type:"button",variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>z("次回は歯石除去を行います。よろしくお願いします。"),children:"歯石除去"}),(0,t.jsx)(c.$,{type:"button",variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>z("次回は定期検診です。お待ちしております。"),children:"定期検診"})]})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)($,{id:"next-memo",value:S,onChange:e=>z(e.target.value),placeholder:"次回来院時のメッセージを入力（例: 歯石除去を行います）",rows:4,maxLength:200,className:"resize-none pr-16"}),(0,t.jsxs)("span",{className:"absolute bottom-2 right-2 text-xs ".concat(L?"text-red-600 font-semibold":"text-slate-400"),children:[S.length,"/200"]})]}),L&&(0,t.jsxs)("p",{className:"text-xs text-red-600",children:["200文字を超えています（現在: ",S.length,"文字）"]})]}),(C||S)&&(0,t.jsxs)("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm",children:[(0,t.jsxs)("div",{className:"mb-2 flex items-center gap-1.5 text-xs font-medium text-slate-500",children:[(0,t.jsx)("span",{children:"\uD83D\uDCF1"}),"患者側プレビュー"]}),(0,t.jsxs)("div",{className:"text-slate-700 space-y-1",children:[C&&(0,t.jsxs)("div",{className:"font-semibold",children:["次回来院予定: ",r(C)]}),S&&(0,t.jsx)("div",{className:"whitespace-pre-wrap",children:S})]})]})]})]}),(0,t.jsxs)(u.Es,{className:"flex-row justify-end gap-2",children:[(0,t.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>j(!1),children:"キャンセル"}),(0,t.jsx)(c.$,{size:"sm",onClick:()=>{f({real_name:g.trim()||null,ticket_number:b.trim()||null,last_visit_date:y.trim()||null,view_mode:_.trim()||null,next_visit_date:C.trim()||null,next_memo:S.trim()||null}),j(!1)},disabled:L,children:"保存"})]})]})]})}function ed(e){let{profile:s,onSave:a}=e,[n,i]=(0,l.useState)(!1),[r,d]=(0,l.useState)(String(s.stamp_count));return(0,t.jsxs)(u.lG,{open:n,onOpenChange:e=>{i(e),e&&d(String(s.stamp_count))},children:[(0,t.jsx)(u.zM,{asChild:!0,children:(0,t.jsxs)(c.$,{variant:"outline",size:"sm",className:"border-slate-300 text-slate-700 hover:bg-slate-100 hover:border-slate-400",children:[(0,t.jsx)(Z.A,{className:"h-3.5 w-3.5"}),"数値"]})}),(0,t.jsxs)(u.Cf,{children:[(0,t.jsx)(u.c7,{children:(0,t.jsx)(u.L3,{children:"スタンプ数を直接入力"})}),(0,t.jsx)("div",{className:"grid gap-4 py-4",children:(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsxs)(x.J,{htmlFor:"stamp-count",children:[s.display_name||s.id," のスタンプ数（0〜999）"]}),(0,t.jsx)(m.p,{id:"stamp-count",type:"number",min:0,max:999,value:r,onChange:e=>d(e.target.value)})]})}),(0,t.jsxs)(u.Es,{children:[(0,t.jsx)(c.$,{variant:"outline",onClick:()=>i(!1),children:"キャンセル"}),(0,t.jsx)(c.$,{onClick:()=>{let e=parseInt(r,10);!Number.isInteger(e)||e<0||e>999||(a(e),i(!1))},children:"保存"})]})]})]})}}},e=>{e.O(0,[5707,7815,1808,2534,8441,1255,7358],()=>e(e.s=689)),_N_E=e.O()}]);