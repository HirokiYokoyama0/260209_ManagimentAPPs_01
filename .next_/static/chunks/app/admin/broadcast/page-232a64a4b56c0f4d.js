(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2806],{235:(e,t,s)=>{"use strict";s.d(t,{J:()=>o});var a=s(5155),r=s(2115),n=s(2894),i=s(3101),l=s(5016);let d=(0,i.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),o=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.b,{ref:t,className:(0,l.cn)(d(),s),...r})});o.displayName=n.b.displayName},923:(e,t,s)=>{"use strict";s.d(t,{Tabs:()=>l,TabsContent:()=>c,TabsList:()=>d,TabsTrigger:()=>o});var a=s(5155),r=s(2115),n=s(5667),i=s(5016);let l=n.bL,d=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.B8,{ref:t,className:(0,i.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...r})});d.displayName=n.B8.displayName;let o=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.l9,{ref:t,className:(0,i.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",s),...r})});o.displayName=n.l9.displayName;let c=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.UC,{ref:t,className:(0,i.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...r})});c.displayName=n.UC.displayName},4679:(e,t,s)=>{"use strict";s.d(t,{Cf:()=>u,Es:()=>p,L3:()=>f,c7:()=>x,lG:()=>d,rr:()=>h,zM:()=>o});var a=s(5155),r=s(2115),n=s(3409),i=s(5229),l=s(5016);let d=n.bL,o=n.l9,c=n.ZL;n.bm;let m=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.hJ,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...r})});m.displayName=n.hJ.displayName;let u=r.forwardRef((e,t)=>{let{className:s,children:r,showClose:d=!0,...o}=e;return(0,a.jsxs)(c,{children:[(0,a.jsx)(m,{}),(0,a.jsxs)(n.UC,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-lg",s),...o,children:[r,d&&(0,a.jsxs)(n.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(i.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"閉じる"})]})]})]})});u.displayName=n.UC.displayName;let x=e=>{let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...s})};x.displayName="DialogHeader";let f=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.hE,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight",s),...r})});f.displayName=n.hE.displayName;let h=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.VY,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",s),...r})});h.displayName=n.VY.displayName;let p=e=>{let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s})};p.displayName="DialogFooter"},5016:(e,t,s)=>{"use strict";s.d(t,{cn:()=>n});var a=s(2821),r=s(5889);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,r.QP)((0,a.$)(t))}},5670:(e,t,s)=>{Promise.resolve().then(s.bind(s,7900))},6170:(e,t,s)=>{"use strict";s.d(t,{p:()=>i});var a=s(5155),r=s(2115),n=s(5016);let i=r.forwardRef((e,t)=>{let{className:s,type:r,...i}=e;return(0,a.jsx)("input",{type:r,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:t,...i})});i.displayName="Input"},7e3:(e,t,s)=>{"use strict";function a(e){let t=new Date(e);return new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(t)}s.d(t,{B:()=>a})},7003:(e,t,s)=>{"use strict";s.d(t,{$:()=>o});var a=s(5155),r=s(2115),n=s(2467),i=s(3101),l=s(5016);let d=(0,i.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),o=r.forwardRef((e,t)=>{let{className:s,variant:r,size:i,asChild:o=!1,...c}=e,m=o?n.DX:"button";return(0,a.jsx)(m,{className:(0,l.cn)(d({variant:r,size:i,className:s})),ref:t,...c})});o.displayName="Button"},7812:(e,t,s)=>{"use strict";s.d(t,{E:()=>l});var a=s(5155);s(2115);var r=s(3101),n=s(5016);let i=(0,r.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground",secondary:"border-transparent bg-secondary text-secondary-foreground",destructive:"border-transparent bg-destructive text-destructive-foreground",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function l(e){let{className:t,variant:s,...r}=e;return(0,a.jsx)("div",{className:(0,n.cn)(i({variant:s}),t),...r})}},7900:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>g});var a=s(5155),r=s(2115),n=s(7003),i=s(6170),l=s(235),d=s(923),o=s(7812),c=s(5299),m=s(1169);let u=(0,s(1847).A)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);var x=s(7815),f=s(7e3),h=s(4679);let p=e=>fetch(e).then(e=>e.json());function g(){return(0,a.jsxs)("div",{className:"container max-w-6xl py-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold mb-6",children:"一斉配信"}),(0,a.jsxs)(d.Tabs,{defaultValue:"new",className:"space-y-4",children:[(0,a.jsxs)(d.TabsList,{children:[(0,a.jsx)(d.TabsTrigger,{value:"new",children:"新規配信"}),(0,a.jsx)(d.TabsTrigger,{value:"history",children:"配信履歴"})]}),(0,a.jsx)(d.TabsContent,{value:"new",children:(0,a.jsx)(b,{})}),(0,a.jsx)(d.TabsContent,{value:"history",children:(0,a.jsx)(j,{})})]})]})}function b(){var e,t,s,d;let[o,x]=(0,r.useState)({}),[f,h]=(0,r.useState)(""),[p,g]=(0,r.useState)(null),[b,j]=(0,r.useState)(!1),[v,y]=(0,r.useState)(!1),N=async()=>{j(!0);try{let e=await fetch("/api/broadcast/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),t=await e.json();g(t)}catch(e){console.error("Preview error:",e),alert("プレビューの取得に失敗しました")}finally{j(!1)}},w=async()=>{if(!f.trim())return void alert("メッセージを入力してください");if(!p||0===p.count)return void alert("対象者がいません");if(confirm("".concat(p.count,"名に送信します。よろしいですか？\n\n推定メッセージ通数: ").concat(p.estimatedCost,"通"))){y(!0);try{let e=await fetch("/api/broadcast/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({segment:o,message:f,sentBy:"admin"})}),t=await e.json();t.success?(alert("送信完了しました\n対象者: ".concat(t.targetCount,"名\n成功: ").concat(t.successCount,"名\n失敗: ").concat(t.failedCount,"名")),h(""),x({}),g(null)):alert("送信に失敗しました: ".concat(t.error))}catch(e){console.error("Send error:",e),alert("送信に失敗しました")}finally{y(!1)}}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg border shadow-sm space-y-4",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"対象者の絞り込み"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"スタンプ数（最小）"}),(0,a.jsx)(i.p,{type:"number",placeholder:"例: 10",value:(null==(e=o.stampCount)?void 0:e.min)||"",onChange:e=>x({...o,stampCount:{...o.stampCount,min:e.target.value?Number(e.target.value):void 0}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"スタンプ数（最大）"}),(0,a.jsx)(i.p,{type:"number",placeholder:"例: 20",value:(null==(t=o.stampCount)?void 0:t.max)||"",onChange:e=>x({...o,stampCount:{...o.stampCount,max:e.target.value?Number(e.target.value):void 0}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"最終来院日数（最小）"}),(0,a.jsx)(i.p,{type:"number",placeholder:"例: 90（日）",value:(null==(s=o.lastVisitDays)?void 0:s.min)||"",onChange:e=>x({...o,lastVisitDays:{...o.lastVisitDays,min:e.target.value?Number(e.target.value):void 0}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"最終来院日数（最大）"}),(0,a.jsx)(i.p,{type:"number",placeholder:"例: 180（日）",value:(null==(d=o.lastVisitDays)?void 0:d.max)||"",onChange:e=>x({...o,lastVisitDays:{...o.lastVisitDays,max:e.target.value?Number(e.target.value):void 0}})})]})]}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:(0,a.jsxs)(l.J,{children:[(0,a.jsx)("input",{type:"checkbox",className:"mr-2",checked:o.isLineFriend||!1,onChange:e=>x({...o,isLineFriend:e.target.checked})}),"LINE友だち登録済みのみ"]})}),(0,a.jsx)(n.$,{onClick:N,disabled:b,children:b?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.A,{className:"mr-2 h-4 w-4 animate-spin"}),"読み込み中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.A,{className:"mr-2 h-4 w-4"}),"対象者を確認"]})})]}),p&&(0,a.jsxs)("div",{className:"bg-blue-50 p-6 rounded-lg border border-blue-200",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"対象者プレビュー"}),(0,a.jsxs)("p",{className:"text-2xl font-bold text-blue-600 mb-2",children:[p.count,"名"]}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["推定メッセージ通数: ",p.estimatedCost,"通"]}),p.preview.length>0&&(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:"最初の10名:"}),p.preview.map((e,t)=>(0,a.jsxs)("div",{className:"text-sm text-gray-700",children:[t+1,". ",e.display_name||"名前未設定"," (スタンプ:"," ",e.stamp_count,"個)"]},e.id))]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg border shadow-sm space-y-4",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"メッセージ"}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"メッセージ内容"}),(0,a.jsx)("textarea",{className:"w-full p-3 border rounded-md min-h-[200px]",placeholder:"メッセージを入力してください  変数を使えます: {name} - 患者名 {stamp_count} - スタンプ数 {ticket_number} - 診察券番号",value:f,onChange:e=>h(e.target.value),maxLength:1e3}),(0,a.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:[f.length," / 1000文字"]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(n.$,{size:"sm",variant:"outline",onClick:()=>h(f+"{name}"),children:["{name}","を挿入"]}),(0,a.jsxs)(n.$,{size:"sm",variant:"outline",onClick:()=>h(f+"{stamp_count}"),children:["{stamp_count}","を挿入"]}),(0,a.jsxs)(n.$,{size:"sm",variant:"outline",onClick:()=>h(f+"{ticket_number}"),children:["{ticket_number}","を挿入"]})]}),(0,a.jsx)(n.$,{onClick:w,disabled:!p||0===p.count||v,size:"lg",className:"w-full",children:v?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.A,{className:"mr-2 h-4 w-4 animate-spin"}),"送信中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u,{className:"mr-2 h-4 w-4"}),p?"".concat(p.count,"名に送信"):"送信"]})})]})]})}function j(){let{data:e,error:t,isLoading:s}=(0,x.Ay)("/api/broadcast/logs",p);if(s)return(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)(c.A,{className:"h-8 w-8 animate-spin text-gray-400"})});if(t)return(0,a.jsx)("p",{className:"text-red-500",children:"配信履歴の取得に失敗しました"});let r=(null==e?void 0:e.logs)||[];return(0,a.jsx)("div",{className:"bg-white rounded-lg border shadow-sm",children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{className:"bg-gray-50 border-b",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"送信日時"}),(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"送信者"}),(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"対象者数"}),(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"成功/失敗"}),(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"メッセージ"}),(0,a.jsx)("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"アクション"})]})}),(0,a.jsx)("tbody",{children:0===r.length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:6,className:"px-4 py-8 text-center text-gray-500",children:"配信履歴がありません"})}):r.map(e=>(0,a.jsxs)("tr",{className:"border-b hover:bg-gray-50",children:[(0,a.jsx)("td",{className:"px-4 py-3 text-sm",children:(0,f.B)(e.sent_at)}),(0,a.jsx)("td",{className:"px-4 py-3 text-sm",children:e.sent_by}),(0,a.jsxs)("td",{className:"px-4 py-3 text-sm",children:[e.target_count,"名"]}),(0,a.jsxs)("td",{className:"px-4 py-3 text-sm",children:[(0,a.jsxs)(o.E,{variant:"secondary",className:"mr-1",children:["成功 ",e.success_count]}),e.failed_count>0&&(0,a.jsxs)(o.E,{variant:"destructive",children:["失敗 ",e.failed_count]})]}),(0,a.jsxs)("td",{className:"px-4 py-3 text-sm max-w-xs truncate",children:[e.message_text.slice(0,30),"..."]}),(0,a.jsx)("td",{className:"px-4 py-3 text-sm",children:(0,a.jsx)(v,{log:e})})]},e.id))})]})})})}function v(e){let{log:t}=e;return(0,a.jsxs)(h.lG,{children:[(0,a.jsx)(h.zM,{asChild:!0,children:(0,a.jsx)(n.$,{size:"sm",variant:"outline",children:"詳細"})}),(0,a.jsxs)(h.Cf,{className:"max-w-2xl",children:[(0,a.jsx)(h.c7,{children:(0,a.jsx)(h.L3,{children:"配信詳細"})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"送信日時"}),(0,a.jsx)("p",{children:(0,f.B)(t.sent_at)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"送信者"}),(0,a.jsx)("p",{children:t.sent_by})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"対象者数"}),(0,a.jsxs)("p",{children:[t.target_count,"名"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"送信結果"}),(0,a.jsxs)("p",{children:["成功: ",t.success_count,"名 / 失敗: ",t.failed_count,"名"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"セグメント条件"}),(0,a.jsx)("pre",{className:"bg-gray-100 p-3 rounded text-sm overflow-auto",children:JSON.stringify(t.segment_conditions,null,2)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(l.J,{children:"メッセージ内容"}),(0,a.jsx)("div",{className:"bg-gray-100 p-3 rounded whitespace-pre-wrap",children:t.message_text})]})]})]})]})}}},e=>{e.O(0,[5707,7815,1808,8441,1255,7358],()=>e(e.s=5670)),_N_E=e.O()}]);