# イベントログ仕様（管理ダッシュボード開発者向け）

**対象**: Phase 7 管理ダッシュボード開発者
**作成日**: 2026-02-23
**目的**: ユーザー行動ログを管理画面で可視化・分析できるようにする

---

## 1. 概要

### 実装済みの内容
- ✅ LIFFアプリ側でイベントログ送信実装完了
- ✅ Supabase `event_logs` テーブル作成完了
- ✅ 集計用ビュー2つ作成完了
- ✅ データ保持期間: 400日（約13ヶ月）

### 管理ダッシュボード側で実装してほしいこと
- イベントログの可視化（リアルタイムログストリーム、グラフ表示）
- 分析SQL実行画面
- CSV出力機能
- ユーザー行動フロー分析

---

## 2. データベーススキーマ

### 2.1 event_logs テーブル

| カラム名 | 型 | 説明 | 例 |
|---------|---|------|---|
| `id` | UUID | 一意のログID | `550e8400-e29b-41d4-a716-446655440000` |
| `user_id` | TEXT | ユーザーID（profiles.id） | `U5c70cd61a4c1b...` |
| `event_name` | TEXT | イベント種別 | `app_open`, `stamp_scan_success` |
| `source` | TEXT | 流入元 | `line_msg_0223`, `direct` |
| `metadata` | JSONB | 追加データ（JSON形式） | `{"current_stamp_count": 50}` |
| `created_at` | TIMESTAMPTZ | イベント発生日時 | `2026-02-23 10:15:32+09` |

#### インデックス
- `idx_event_logs_user_id` - ユーザー別検索用
- `idx_event_logs_event_name` - イベント種別検索用
- `idx_event_logs_created_at` - 日時範囲検索用
- `idx_event_logs_source` - 流入元検索用
- `idx_event_logs_user_event` - 複合インデックス
- `idx_event_logs_event_created` - 複合インデックス

---

## 3. 記録されているイベント一覧

### 3.1 基本イベント

| event_name | 説明 | 発生タイミング | metadata例 |
|-----------|------|--------------|-----------|
| `app_open` | アプリ起動 | ログイン完了時 | `{user_agent, screen_size, viewport_size, referrer}` |
| `page_view` | ページ閲覧 | 将来実装予定 | `{page_path, previous_path}` |

### 3.2 スタンプ関連

| event_name | 説明 | 発生タイミング | metadata例 |
|-----------|------|--------------|-----------|
| `stamp_page_view` | スタンプページ閲覧 | `/stamp` 表示時 | `{current_stamp_count: 50}` |
| `stamp_scan_start` | QRスキャン開始 | スキャンボタンタップ | `{scan_type: 'qr'}` |
| `stamp_scan_success` | QRスキャン成功 | スキャン成功時 | `{stamps_added: 5, type: 'regular'}` |
| `stamp_scan_fail` | QRスキャン失敗 | スキャン失敗時 | `{error: 'duplicate'}` |

### 3.3 予約関連

| event_name | 説明 | 発生タイミング | metadata例 |
|-----------|------|--------------|-----------|
| `reservation_button_click` | 予約ボタンクリック | 予約ボタンタップ時 | `{from_page: '/', current_stamp_count: 50}` |

### 3.4 ゲーム関連

| event_name | 説明 | 発生タイミング | metadata例 |
|-----------|------|--------------|-----------|
| `slot_game_open` | スロットゲーム画面を開く | `/slot` 表示時 | `{}` |
| `slot_game_play` | スロットゲームプレイ | ゲーム終了時 | `{result: 'win', stamps_won: 5}` |

### 3.5 特典関連（将来実装予定）

| event_name | 説明 | metadata例 |
|-----------|------|-----------|
| `reward_list_view` | 特典一覧閲覧 | `{}` |
| `reward_exchange_success` | 特典交換成功 | `{reward_id: 1, reward_name: 'フッ素塗布'}` |

### 3.6 家族機能関連（将来実装予定）

| event_name | 説明 | metadata例 |
|-----------|------|-----------|
| `family_join_success` | 家族参加成功 | `{family_id: 'xxx'}` |
| `child_mode_open` | 子供モード開く | `{child_id: 'manual-child-xxx'}` |

---

## 4. 集計用ビュー（既に作成済み）

### 4.1 daily_active_users ビュー

**目的**: 日別アクティブユーザー数（DAU）

```sql
SELECT * FROM daily_active_users;
```

**カラム**:
- `date` (DATE): 日付
- `active_users` (BIGINT): アクティブユーザー数

**データ範囲**: 過去400日分

**使用例**:
```sql
-- 直近7日間のDAU
SELECT * FROM daily_active_users
WHERE date >= current_date - interval '7 days'
ORDER BY date DESC;
```

---

### 4.2 event_summary ビュー

**目的**: イベント別集計（人気機能ランキング）

```sql
SELECT * FROM event_summary;
```

**カラム**:
- `event_name` (TEXT): イベント名
- `total_events` (BIGINT): 総イベント数
- `unique_users` (BIGINT): ユニークユーザー数
- `first_occurrence` (TIMESTAMPTZ): 初回発生日時
- `last_occurrence` (TIMESTAMPTZ): 最終発生日時

**データ範囲**: 直近30日分

**使用例**:
```sql
-- 人気機能TOP10
SELECT * FROM event_summary
ORDER BY total_events DESC
LIMIT 10;
```

---

## 5. よく使う分析SQL

### 5.1 LINE配信後のアプリ起動率

```sql
-- キャンペーン「line_msg_0223」の効果測定
WITH campaign_data AS (
  SELECT DISTINCT user_id
  FROM event_logs
  WHERE source = 'line_msg_0223'
    AND event_name = 'app_open'
    AND created_at >= '2026-02-23 00:00:00+09'
    AND created_at <= '2026-02-24 00:00:00+09'
)
SELECT
  COUNT(*) as opened_users,
  -- 配信対象者数は別途取得が必要
  ROUND(100.0 * COUNT(*) / 100, 2) as open_rate_percent
FROM campaign_data;
```

---

### 5.2 予約ボタンクリック履歴

```sql
-- 直近30日の予約ボタンクリック履歴
SELECT
  p.display_name,
  p.ticket_number,
  el.created_at as clicked_at,
  el.metadata->>'current_stamp_count' as stamps_at_click,
  el.metadata->>'from_page' as from_page
FROM event_logs el
JOIN profiles p ON el.user_id = p.id
WHERE el.event_name = 'reservation_button_click'
  AND el.created_at >= current_date - interval '30 days'
ORDER BY el.created_at DESC;
```

---

### 5.3 スロットゲームプレイ履歴

```sql
-- スロットゲームプレイ履歴（直近30日）
SELECT
  p.display_name,
  p.ticket_number,
  el.created_at as played_at,
  el.metadata->>'result' as result,
  (el.metadata->>'stamps_won')::int as stamps_won
FROM event_logs el
JOIN profiles p ON el.user_id = p.id
WHERE el.event_name = 'slot_game_play'
  AND el.created_at >= current_date - interval '30 days'
ORDER BY el.created_at DESC;
```

---

### 5.4 ユーザー行動フロー（特定ユーザー）

```sql
-- 特定ユーザーの行動履歴（時系列）
SELECT
  el.created_at,
  el.event_name,
  el.source,
  el.metadata
FROM event_logs el
WHERE el.user_id = 'U5c70cd61...'  -- ユーザーIDを指定
  AND el.created_at >= current_date - interval '7 days'
ORDER BY el.created_at ASC;
```

---

### 5.5 イベント別ユニークユーザー数

```sql
-- イベント別ユニークユーザー数（直近7日）
SELECT
  event_name,
  COUNT(DISTINCT user_id) as unique_users,
  COUNT(*) as total_events,
  ROUND(COUNT(*) * 1.0 / COUNT(DISTINCT user_id), 2) as events_per_user
FROM event_logs
WHERE created_at >= current_date - interval '7 days'
GROUP BY event_name
ORDER BY unique_users DESC;
```

---

### 5.6 時間帯別アクティビティ

```sql
-- 時間帯別のapp_openイベント数
SELECT
  EXTRACT(HOUR FROM created_at) as hour,
  COUNT(*) as open_count
FROM event_logs
WHERE event_name = 'app_open'
  AND created_at >= current_date - interval '30 days'
GROUP BY hour
ORDER BY hour;
```

---

### 5.7 スタンプスキャン成功率

```sql
-- スタンプスキャンの成功率（直近30日）
WITH scan_stats AS (
  SELECT
    SUM(CASE WHEN event_name = 'stamp_scan_start' THEN 1 ELSE 0 END) as starts,
    SUM(CASE WHEN event_name = 'stamp_scan_success' THEN 1 ELSE 0 END) as successes,
    SUM(CASE WHEN event_name = 'stamp_scan_fail' THEN 1 ELSE 0 END) as failures
  FROM event_logs
  WHERE created_at >= current_date - interval '30 days'
)
SELECT
  starts,
  successes,
  failures,
  ROUND(100.0 * successes / NULLIF(starts, 0), 2) as success_rate_percent
FROM scan_stats;
```

---

### 5.8 日別イベント推移

```sql
-- 日別イベント数推移（直近30日）
SELECT
  DATE(created_at) as date,
  COUNT(*) as total_events,
  COUNT(DISTINCT user_id) as unique_users
FROM event_logs
WHERE created_at >= current_date - interval '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

---

### 5.9 流入元別アクティビティ

```sql
-- 流入元（source）別のアプリ起動数
SELECT
  COALESCE(source, 'direct') as source,
  COUNT(*) as open_count,
  COUNT(DISTINCT user_id) as unique_users
FROM event_logs
WHERE event_name = 'app_open'
  AND created_at >= current_date - interval '30 days'
GROUP BY source
ORDER BY open_count DESC;
```

---

## 6. 管理ダッシュボードで実装してほしい画面

### 6.1 リアルタイムログストリーム

**画面イメージ**:
```
[2026-02-23 10:15:32] app_open - U5c70cd61... (line_msg_0223)
[2026-02-23 10:15:45] reservation_button_click - U1234abcd... (direct)
[2026-02-23 10:16:12] slot_game_play - U5c70cd61... (direct) - WIN: 5 stamps
```

**実装方法**:
- Supabaseのリアルタイムサブスクリプション使用
- 最新100件のログを表示
- 自動スクロール

**サンプルコード**:
```typescript
const subscription = supabase
  .channel('event_logs_changes')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'event_logs'
  }, (payload) => {
    setLogs(prev => [payload.new, ...prev].slice(0, 100));
  })
  .subscribe();
```

---

### 6.2 総合ダッシュボード

**表示内容**:
- 本日のアクティブユーザー数（DAU）
- 直近7日間のDAU推移グラフ
- 人気機能TOP5（event_summary使用）
- 本日のイベント数
- 予約ボタンクリック数（本日/今週/今月）

**使用するグラフライブラリ**:
- Chart.js または Recharts

---

### 6.3 イベント分析画面

**機能**:
- イベント種別でフィルター
- 日付範囲指定
- ユーザーID検索
- CSV出力ボタン

**表示内容**:
- イベント一覧テーブル（ページネーション付き）
- 各カラム: 日時、ユーザー、イベント名、流入元、メタデータ

---

### 6.4 ユーザー行動フロー

**機能**:
- ユーザーIDまたは診察券番号で検索
- 選択したユーザーの行動履歴を時系列表示
- 視覚的なタイムライン表示

**表示例**:
```
横山光紀（診察券123456）の行動履歴

10:00 app_open (line_msg_0223)
10:05 stamp_page_view (50個保有)
10:10 reservation_button_click
10:15 slot_game_play (WIN: 5 stamps)
```

---

### 6.5 キャンペーン効果測定

**機能**:
- 流入元（source）で絞り込み
- 指定期間のapp_open数を集計
- 開封率グラフ表示

**使用例**:
- LINE配信「line_msg_0223」のクリック数
- 配信から24時間以内の開封率

---

### 6.6 SQL実行画面（管理者専用）

**機能**:
- 任意のSQLクエリを実行
- 結果をテーブル表示
- CSV出力ボタン
- よく使うクエリをプリセット登録

**セキュリティ**:
- SELECT文のみ実行可能（INSERT/UPDATE/DELETE禁止）
- サービスロールキー使用

---

## 7. データアクセス方法

### 7.1 Supabaseクライアントでの取得

```typescript
import { supabase } from '@/lib/supabase';

// 直近100件のイベントログ取得
const { data, error } = await supabase
  .from('event_logs')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(100);
```

---

### 7.2 サービスロールキーの使用

**重要**: 管理ダッシュボードでは全ログにアクセスできるよう、サービスロールキーを使用してください。

```typescript
import { getSupabaseAdmin } from '@/lib/supabase';

const supabaseAdmin = getSupabaseAdmin();

const { data, error } = await supabaseAdmin
  .from('event_logs')
  .select(`
    *,
    profiles(display_name, ticket_number)
  `)
  .order('created_at', { ascending: false })
  .limit(100);
```

---

### 7.3 ビューの使用

```typescript
// DAU取得
const { data: dauData } = await supabaseAdmin
  .from('daily_active_users')
  .select('*')
  .order('date', { ascending: false })
  .limit(30);

// イベントサマリー取得
const { data: eventSummary } = await supabaseAdmin
  .from('event_summary')
  .select('*')
  .order('total_events', { ascending: false });
```

---

## 8. CSV出力の実装例

```typescript
const exportToCSV = (data: any[], filename: string) => {
  // ヘッダー行
  const headers = Object.keys(data[0]);
  const csvContent = [
    headers.join(','),
    ...data.map(row => headers.map(h => JSON.stringify(row[h])).join(','))
  ].join('\n');

  // BOM付きでUTF-8エンコード
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
};

// 使用例
const handleExport = async () => {
  const { data } = await supabaseAdmin
    .from('event_logs')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(1000);

  exportToCSV(data, `event_logs_${new Date().toISOString()}.csv`);
};
```

---

## 9. パフォーマンス考慮事項

### 9.1 大量データの取得

**問題**: 数万件のログを一度に取得するとメモリ不足

**対策**:
```typescript
// ページネーション使用
const pageSize = 100;
const { data, error } = await supabaseAdmin
  .from('event_logs')
  .select('*')
  .order('created_at', { ascending: false })
  .range(0, pageSize - 1);
```

---

### 9.2 日付範囲指定

**推奨**: 常に日付範囲を指定してクエリを実行

```typescript
const { data } = await supabaseAdmin
  .from('event_logs')
  .select('*')
  .gte('created_at', '2026-02-01')
  .lte('created_at', '2026-02-28')
  .order('created_at', { ascending: false });
```

---

## 10. セキュリティ

### 10.1 RLSポリシー

event_logsテーブルはRLS有効ですが、以下のポリシーが設定済み:
- ユーザー: 自分のログのみ書き込み・閲覧可能
- サービスロール: 全ログ閲覧可能

**管理ダッシュボードでは必ずサービスロールキーを使用してください。**

---

### 10.2 環境変数

```env
# Supabase ダッシュボード: Settings → API → service_role（secret）の値を設定
# 実際のキーは .env.local にのみ記載し、リポジトリには絶対にコミットしないこと
SUPABASE_SERVICE_ROLE_KEY=<本番の値は.env.localに設定>
```

**注意**: 実際の値は `.env.local` に設定し、このドキュメントやリポジトリには記載しないでください。

---

## 11. データ保持期間

- **現在の設定**: 400日（約13ヶ月）
- **自動削除関数**: `delete_old_event_logs()`（手動実行が必要）

**定期実行の設定（将来）**:
- Supabase Edge Functions または外部cronで月1回実行
- 管理ダッシュボードに手動実行ボタン追加を推奨

```sql
-- 手動実行
SELECT delete_old_event_logs();
```

---

## 12. トラブルシューティング

### 12.1 ログが表示されない

**確認事項**:
1. LIFFアプリでイベントが発生しているか？
2. Supabase Table Editorで `event_logs` にデータがあるか？
3. サービスロールキーを使用しているか？

**デバッグ用SQL**:
```sql
-- 最新10件確認
SELECT * FROM event_logs ORDER BY created_at DESC LIMIT 10;
```

---

### 12.2 パフォーマンスが遅い

**対策**:
1. 日付範囲を絞る
2. インデックスを活用（user_id、event_name、created_at）
3. ページネーションを使用

---

## 13. 実装優先順位

### Phase 1（必須）
1. ✅ リアルタイムログストリーム
2. ✅ 総合ダッシュボード（DAU、イベント数）
3. ✅ イベント分析画面（一覧表示）

### Phase 2（推奨）
4. CSV出力機能
5. ユーザー行動フロー
6. キャンペーン効果測定

### Phase 3（オプション）
7. SQL実行画面
8. 高度な分析機能（コホート分析等）

---

## 14. 参考資料

- **設計書**: `Doc/83_イベントログ設計（ユーザの操作ログ）.md`
- **SQLファイル**: `supabase/015_create_event_logs_table_ForUser.sql`
- **フロントエンド実装**: `lib/analytics.ts`

---

## 15. 質問・サポート

実装中に不明点があれば、以下を確認してください:
1. `Doc/83_イベントログ設計（ユーザの操作ログ）.md` - 詳細設計
2. Supabase Dashboard → Table Editor → `event_logs` - 実際のデータ
3. このドキュメントのSQLクエリ例

---

**最終更新日**: 2026-02-23
**ステータス**: 実装待ち（Phase 7 管理ダッシュボード）
