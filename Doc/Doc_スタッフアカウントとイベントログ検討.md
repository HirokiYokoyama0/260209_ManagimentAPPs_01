# スタッフアカウント＋権限 と イベントログ の検討

**作成日:** 2026-02-08  
**目的:** ①スタッフごとのアカウント＋権限変更 と ②実施内容のイベントログ を導入すべきか判断するため、複雑さと工数・メリットを整理する。

---

## 現状の認証

| 項目 | 内容 |
|------|------|
| 方式 | 単一の「管理者」ログイン（環境変数 `ADMIN_USER` / `ADMIN_PASSWORD`） |
| セッション | 署名付き Cookie（`admin_session`）。中身は「admin + 有効期限 + 署名」のみで**誰か**は区別していない |
| 保護範囲 | `/admin` 配下と `/api/profiles` は「ログイン済みか」のみチェック。**権限の違いはなし** |

→ 現状は「誰がログインしているか」を識別していないため、②のログで「誰が」を残すには①（スタッフ単位のアカウント）が前提になる。

---

## ① スタッフごとのアカウント＋権限変更

### やりたいこと

- スタッフごとにアカウント（ログインID・パスワード）を作成できる
- スタッフごとに「できる操作」を変えたい（例: スタンプだけ / メッセージ送信可 / 一斉配信のみ管理者など）

### 必要な変更（概要）

| 項目 | 内容 |
|------|------|
| **DB** | スタッフ用テーブル（例: `staff` または `admin_users`）。ログインID、パスワードハッシュ、表示名、**権限（ロール or フラグ）**。 |
| **認証** | ログイン時に「どのスタッフか」を特定し、セッションに **staff_id**（と必要なら権限）を含める。現在の「admin.期限.署名」を「staff_id.期限.署名」などに変更。 |
| **権限チェック** | 各API（スタンプ変更・メッセージ送信・一斉配信・特典交換・家族編集など）で「このスタッフはこの操作をしてよいか」を判定。未許可なら 403。 |
| **UI** | スタッフ一覧・追加・編集・無効化（削除は論理削除推奨）。権限のオン/オフ or ロール選択。 |

### 権限の設計案（シンプル）

- **ロール方式（おすすめ）**: 「管理者」「一般」「閲覧のみ」など数パターンに固定。実装が単純。
- **フラグ方式**: 「スタンプ編集可」「メッセージ送信可」「一斉配信可」「特典交換操作可」「家族編集可」「スタッフ管理可」などを個別ON/OFF。柔軟だが項目が増えると複雑。

### 複雑さの目安

- **中**。テーブル追加・マイグレーション・ログインフロー変更・**全書き込みAPIに権限チェック追加**・スタッフ管理画面の実装が必要。
- 書き込みAPIはおおよそ **15箇所以上**（profiles 更新・スタンプ・スタンプ直接設定・メッセージ送信・家族CRUD・特典交換 complete/cancel/delete・一斉配信送信・ログイン/ログアウトなど）。ここに「このロールなら許可」を入れる必要がある。

---

## ② イベントログ（誰が何をしたか）

### やりたいこと

- どのスタッフが、いつ、どんな操作をしたかを記録する（後から確認・監査用）。

### 必要な変更（概要）

| 項目 | 内容 |
|------|------|
| **DB** | 操作ログ用テーブル（例: `activity_logs`）。`staff_id`, `action`（例: stamp_increment, message_send, broadcast_send）, `target_type` / `target_id`（対象患者・特典交換など）, `details`（JSON など）, `created_at`。 |
| **記録タイミング** | 各「書き込み」が成功した直後に 1 件 INSERT。**誰**を記録するには、セッションに staff_id が含まれている必要がある（＝①を先に入れておくか、同一ログインのまま「操作者＝共通」で記録するか）。 |
| **記録箇所** | 上記と同様、書き込みがあるAPI・ログイン/ログアウトの **15箇所以上** で「ログ書き込み」を呼ぶ。共通ヘルパー（例: `logActivity(staffId, action, payload)`）を作れば実装は単純だが、**呼び忘れがないよう注意**。 |
| **UI** | 必須ではない。まずは DB 上で確認し、必要なら「操作履歴」一覧画面を後から追加可能。 |

### 複雑さの目安

- **中**。テーブル 1 つとヘルパー 1 本で足りるが、**記録すべきAPIが多く、漏れがないようにする手間**がある。
- 「誰が」を意味ある形で残すには、**①でスタッフ単位のログインにしておく必要がある**。①なしで②だけ入れると「常に同じ管理者」のログになり、監査価値は下がる。

---

## ①と②を両方やる場合

- ①で「スタッフ」と「権限」を入れると、セッションに **staff_id** が乗る。
- ②は「誰が」＝その staff_id で記録すればよいので、**設計として自然**。
- 一方で、**変更箇所が重なる**（同じAPI群に「権限チェック」と「ログ記録」の両方を入れる）ため、まとめて実装する方が無駄が少ない。
- 複雑さは **中〜高**。工数目安は、設計〜実装〜テストまでで **おおむね 2〜4 日**（人数・仕様の詰め方に依存）。

---

## 選択肢とおすすめ

| 選択肢 | 内容 | 複雑さ | おすすめ度 |
|--------|------|--------|------------|
| **A. 両方やる** | スタッフアカウント＋権限＋イベントログ | 中〜高 | 責任の所在と監査をはっきりさせたい場合 |
| **B. ①だけ（権限は後回し）** | スタッフごとアカウントのみ。権限は全員同じ「一般」のまま | 低〜中 | まず「誰がログインしているか」だけ分かればよい場合。後から権限・②を足しやすい |
| **C. ②だけ** | 単一ログインのまま、操作ログだけ記録（「誰」は常に同一） | 中 | 「いつ・何をしたか」だけ必要なら可。後で①を入れたら staff_id を紐づけ可能 |
| **D. やらない** | 現状の単一共有ログインのまま | なし | 運用がシンプルでよいなら現状維持で十分 |

### 判断の目安

- **「誰が何をしたか」を残したい・責任を明確にしたい**  
  → **①＋②**（A）を推奨。複雑にはなるが、一度入れておくと運用・トラブル時の確認が楽になる。
- **「とりあえず誰が触ったか分かればよい」**  
  → **①のみ（B）** から始め、ログは「ログインしたスタッフ」だけ記録する簡易版の②を後から追加する、でもよい。
- **「権限の切り分けは今は不要。ログも不要」**  
  → **D**。無理に導入しなくてよい。

---

## 結論（やるべきかどうか）

- **複雑になりすぎるか**  
  → ①と②を**両方・きちんとやる**と、変更箇所と設計は確かに増えるが、**「複雑になりすぎて手に負えない」レベルではない**。ロール数と権限項目を少なめにすれば、中規模の追加で収まる。

- **やるべきか**  
  - **責任の所在や監査を重視するなら** → **やる価値あり**（A、または B→②の順で段階的にも可）。
  - **現状の運用で困っていない・スタッフも少ない** → **やらなくてよい**（D）。必要になったタイミングで B → ② → 権限の順で検討できる。

必要なら、次のステップとして「ロール案（管理者／一般／閲覧のみの具体的な許可一覧）」や「activity_logs テーブル定義案」を別ドキュメントにまとめられる。
