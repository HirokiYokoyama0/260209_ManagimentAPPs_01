# 88_アンケート機能 ダッシュボード側 開発計画

**作成日:** 2026-02-26  
**目的:** LIFF側の開発 Phase と整合した、管理ダッシュボード側の実装順序・成果物・受け入れ条件を定義する。

**関連ドキュメント:**
- [86_アンケート機能仕様検討_ダッシュボード側.md](86_アンケート機能仕様検討_ダッシュボード側.md) - 画面・API 仕様
- [87_アンケート機能_懸念点対応方針.md](87_アンケート機能_懸念点対応方針.md) - DB・認証方針

---

## LIFF側 Phase との対応

| LIFF Phase | 内容 | ダッシュボードとの関係 |
|------------|------|------------------------|
| **Phase 1** | データベースマイグレーション作成・実行 | **共通**。ダッシュボード側も同一マイグレーションを前提に開発 |
| **Phase 2** | LIFF API（/api/survey/submit, /api/survey/check） | ダッシュボードは「配信対象の登録」ができると LIFF の check が意味を持つ |
| **Phase 3** | フロント - アンケート画面（/survey/[surveyId]） | ダッシュボードで作成したアンケートが LIFF で表示される |
| **Phase 4** | 共有コンポーネント（StarRating, NPSScale 等） | ダッシュボードの結果集計画面で必要に応じて流用可能 |
| **Phase 5** | アプリ起動時のアンケートモーダル表示 | ダッシュボードで `show_on_liff_open` を ON にした配信がモーダルに出る |
| **Phase 6** | テスト・動作確認 | 両者で連携テスト |

---

## ダッシュボード側 開発 Phase

### Phase 1: データベースマイグレーションの確認・実行（LIFF と共通）

**目的:** アンケート用テーブル・ビュー・RPC を用意し、LIFF・ダッシュボード両方の土台にする。

| 項目 | 内容 |
|------|------|
| **成果物** | 017_create_survey_tables.sql（または同等）の作成・適用 |
| **内容** | `surveys` / `survey_answers` / `survey_targets` テーブル、`survey_target_status` ビュー、`increment_survey_postponed` RPC、RLS ポリシー |
| **担当** | ダッシュボード or 共通（事前に役割を決定） |
| **受け入れ** | マイグレーション成功、Supabase 上でテーブル・ビュー・RPC が存在すること |

**注意:** 87 の「修正版データベース設計」および 05_Database_Schema への追記と整合させる。

---

### Phase 2: ダッシュボード用 API 実装

**目的:** アンケート一覧・作成・配信対象の登録・一覧・結果取得を API で提供する。LIFF の Phase 2（submit/check）と並行可能。

| # | API | パス | 概要 | 優先度 |
|---|-----|------|------|--------|
| 1 | アンケート一覧 | `GET /api/surveys` | 一覧取得（id, title, is_active, 配信数・回答数は別 API でも可） | 高 |
| 2 | アンケート作成 | `POST /api/surveys` | 1件作成（Phase 1 は固定質問 q1/q2/q3 想定） | 高 |
| 3 | 配信対象者登録 | `POST /api/surveys/targets/create` | targetType: all / filter / manual、show_on_liff_open 等 | 高 |
| 4 | 配信対象者一覧 | `GET /api/surveys/targets/list?surveyId=` | survey_target_status ベース、回答率付き | 高 |
| 5 | 結果集計 | `GET /api/surveys/results?surveyId=` | Q1 分布・NPS・自由記述（Phase 4 以降の画面用） | 中 |

**技術要件:**
- `createSupabaseAdminClient()`（`@/lib/supabase/server-admin`）を使用
- 既存の simple-auth（Cookie）による /admin 保護の対象とする（API は /admin から呼ばれる想定で、必要に応じてミドルウェアで保護）

**受け入れ:** 上記 1〜4 が仕様（86）に沿って動作し、LIFF の check で「配信対象に登録したユーザー」にのみアンケートが紐づくことを確認できること。

---

### Phase 3: フロントエンド - アンケート一覧・作成・配信対象者選択

**目的:** 管理画面からアンケートを登録し、誰に配信するかを設定できるようにする。LIFF Phase 3（/survey/[surveyId]）で実際に表示するアンケートをここで用意する。

| 項目 | 内容 |
|------|------|
| **画面** | `/admin/surveys` 一覧、`/admin/surveys/new` 新規作成、`/admin/surveys/[surveyId]` 詳細、`/admin/surveys/[surveyId]/targets` 配信対象者選択 |
| **機能** | アンケート作成（タイトル・説明・報酬スタンプ数・is_active）、配信方法（全員 / 条件フィルタ / 個別）、配信実行（survey_targets 挿入） |
| **条件フィルタ** | Phase 1 では「最終来院日」「スタンプ数」まで。年齢は Phase 2 以降（86・87 方針） |
| **ナビ** | `lib/admin-nav.ts` の `mainNav` に「アンケート」を追加（例: `{ label: "アンケート", href: "/admin/surveys" }`） |

**受け入れ:**
- 一覧で作成したアンケートが表示される
- 配信対象者を「全員」または条件で設定し、配信開始後に `survey_targets` にレコードが入る
- LIFF のアンケート画面（Phase 3）で、当該 survey_id のアンケートが表示できる（対象ユーザーで check が通る）

---

### Phase 4: フロントエンド - 一覧確認・集計結果・配信設定

**目的:** アンケートの**一覧確認**（配信対象数・回答率）と**集計結果**の表示、および配信設定の更新までをダッシュボードで完結させる。  
**詳細仕様:** [89_アンケート機能_Phase4_集計・一覧仕様.md](89_アンケート機能_Phase4_集計・一覧仕様.md)

| 項目 | 内容 |
|------|------|
| **一覧確認** | **アンケート一覧**（`/admin/surveys`）で各アンケートの「配信対象数」「回答率」を表示する。 |
| **一覧確認** | **回答状況一覧**（`/admin/surveys/[surveyId]/targets`）で対象者ごと「回答済み/未回答」「後回し回数」を表示。CSV 出力は任意。 |
| **集計結果** | **結果集計画面**（`/admin/surveys/[surveyId]/results`）で Q1 分布（1〜5の件数）、NPS、自由記述一覧を表示。 |
| **配信設定** | アンケート詳細 or 専用タブで「LIFFアプリ初期表示 ON/OFF」「配信期間」を設定・更新。 |

**受け入れ:**
- アンケート一覧で配信対象数・回答率が分かること
- 回答状況一覧で回答済み/未回答・後回しが正しく表示されること
- 結果集計画面で Q1 分布・NPS・自由記述が表示されること
- show_on_liff_open を ON にしたアンケートが、LIFF の「起動時モーダル」の対象になること（配信設定 UI 実装後）

---

### Phase 5: LINE 自動配信（任意・後回し可）

**目的:** 配信対象者に LINE メッセージを一斉送信する機能。86 の Phase 5 に相当。

| 項目 | 内容 |
|------|------|
| **API** | `POST /api/surveys/send-line`（surveyId, 対象者リスト or survey_targets から取得） |
| **画面** | 配信設定で「LINE自動配信 ON」時に、送信実行ボタンと確認ダイアログ |
| **前提** | LINE Messaging API のチャネルアクセストークン、既存の一斉配信との統合方針が決まっていること |

**受け入れ:** 対象ユーザーの line_user_id に対して、指定アンケートの案内メッセージが送信されること。

**注:** LIFF Phase 5（モーダル表示）が先に必要であれば、本 Phase は Phase 6 以降にずらしてもよい。

---

### Phase 6: テスト・動作確認（LIFF と連携）

**目的:** ダッシュボードで「作成 → 配信対象設定 → 配信」まで実施したときに、LIFF 側でアンケート表示・回答・結果反映が一通り動くことを確認する。

| 確認項目 | 内容 |
|----------|------|
| 配信〜表示 | ダッシュボードで配信したアンケートが、対象ユーザーで LIFF 起動時モーダル / アンケート画面に表示される |
| 回答〜反映 | LIFF で回答すると survey_answers に保存され、ダッシュボードの回答状況・結果集計に反映される |
| 「あとで」 | LIFF で「あとで」を押すと increment_survey_postponed が呼ばれ、回答状況一覧の「後回し回数」が増える |
| 権限・エラー | 未ログイン or 非対象ユーザーではアンケートが表示されないこと、API エラーハンドリングが適切であること |

---

## 実施順序の目安

```
Phase 1（共通）   : マイグレーション作成・実行
        ↓
Phase 2（ダッシュボード）: ダッシュボード用 API 実装
        ↓
Phase 3（ダッシュボード）: アンケート一覧・作成・配信対象者選択 UI
        ↓
Phase 4（ダッシュボード）: 配信設定・回答状況・結果集計 UI
        ↓
Phase 5（任意）   : LINE 自動配信
        ↓
Phase 6（両者）   : 連携テスト・動作確認
```

- **Phase 1** は LIFF と**同時または先行**で完了させる。
- **Phase 2** は LIFF の Phase 2（submit/check API）と**並行**可能。早めに完了すると LIFF の check を「配信対象あり」で検証しやすい。
- **Phase 3** まで完了すると、LIFF Phase 3・5 で「ダッシュボードで作ったアンケート」を実際に表示・回答できる。
- **Phase 4** で回答状況・結果を見られるようにし、**Phase 6** で LIFF とまとめて受け入れする。

---

## 成果物チェックリスト（ダッシュボード側）

| Phase | 成果物 | パス・備考 |
|-------|--------|------------|
| 1 | マイグレーション | `supabase/017_*.sql`、05_Database_Schema 追記 |
| 2 | アンケート一覧 API | `app/api/surveys/route.ts`（GET） |
| 2 | アンケート作成 API | `app/api/surveys/route.ts`（POST） or create/route.ts |
| 2 | 配信対象者登録 API | `app/api/surveys/targets/create/route.ts` |
| 2 | 配信対象者一覧 API | `app/api/surveys/targets/list/route.ts` |
| 2 | 結果集計 API | `app/api/surveys/results/route.ts` |
| 3 | アンケート一覧画面 | `app/admin/surveys/page.tsx` |
| 3 | 新規作成画面 | `app/admin/surveys/new/page.tsx` |
| 3 | アンケート詳細画面 | `app/admin/surveys/[surveyId]/page.tsx` |
| 3 | 配信対象者選択画面 | `app/admin/surveys/[surveyId]/targets/page.tsx` |
| 3 | ナビ追加 | `lib/admin-nav.ts` にアンケートリンク |
| 4 | 一覧確認（アンケート一覧） | 配信対象数・回答率の列を追加（API 拡張 or 集計付き） |
| 4 | 一覧確認（回答状況） | targets 画面（済）。CSV 出力は任意 |
| 4 | 集計結果 | `app/admin/surveys/[surveyId]/results/page.tsx`（済） |
| 4 | 配信設定 UI | 詳細 or 専用タブで LIFF 表示 ON/OFF・配信期間を更新 |
| 5 | LINE 送信 API | `app/api/surveys/send-line/route.ts`（任意） |
| 6 | テスト観点・実施記録 | Doc または Issue で整理 |

---

## 進捗と次のフェーズ（2026-02 時点）

### 完了済み

| Phase | 内容 | 備考 |
|-------|------|------|
| **1** | マイグレーション | 017（アンケートテーブル）、018（survey_reward 時の last_visit_date 除外） |
| **2** | ダッシュボード用 API | 一覧・作成・配信対象登録/一覧・結果集計・候補検索・未回答に戻す・操作ログ |
| **3** | 一覧・作成・配信対象者 | 診察券番号で候補検索、未回答に戻す列、スタッフログ（配信/未回答に戻す） |
| **4（一部）** | 回答状況・結果集計 | targets で回答状況一覧、`/admin/surveys/[id]/results` で結果表示 |

### 次のフェーズ

| 順 | フェーズ | 内容 | 成果物目安 |
|----|----------|------|------------|
| **1** | **Phase 4 残り** | **配信設定の更新 UI** | アンケート詳細で「LIFF初期表示 ON/OFF」「配信期間」を編集できるようにする。既存対象の `show_on_liff_open` 一括更新 API または PATCH surveys 等 |
| **2** | **Phase 5（任意）** | **LINE 自動配信** | `POST /api/surveys/send-line`、配信設定画面に送信ボタン |
| **3** | **Phase 6** | **連携テスト** | ダッシュボード ⇔ LIFF の一連の流れ（配信→表示→回答→結果反映）の確認・ドキュメント化 |

### 実施順序の目安（再掲）

```
Phase 1 ✅ → Phase 2 ✅ → Phase 3 ✅ → Phase 4（配信設定UI）→ Phase 5（LINE送信・任意）→ Phase 6（テスト）
```

---

**最終更新:** 2026-02-26（進捗・次のフェーズを追記）
