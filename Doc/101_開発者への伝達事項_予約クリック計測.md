# 開発者への伝達事項：予約ボタンクリック計測機能

**対象**: 管理ダッシュボード開発担当者
**日付**: 2026年2月14日
**優先度**: 🟡 中（必須ではないが推奨）

---

## 📋 要約（3行で）

1. LIFF側の「予約する」ボタンにクリック計測機能を追加します
2. データベースに`reservation_button_clicks`カラムを追加し、クリック数をカウント
3. 管理ダッシュボードの分析画面に「予約ボタンクリック数」を表示してください

---

## 🎯 背景・目的

### なぜ必要か？

現状、患者がLIFF内の「予約する」ボタンをクリックしても、その情報がどこにも記録されていません。これでは：

- ❌ どれだけの患者が予約に興味を持っているかわからない
- ❌ 予約導線の改善効果を測定できない
- ❌ エンゲージメントの高いユーザーを特定できない

### 何ができるようになるか？

- ✅ 患者ごとのクリック数を確認
- ✅ 全体の予約意欲を数値化
- ✅ クリック数とスタンプ数（来院回数）の相関分析
- ✅ 将来的な改善施策の判断材料

---

## 🏗️ 実装内容（5つの作業）

### 1️⃣ データベース変更

**ファイル**: `supabase/006_add_reservation_clicks.sql`（新規作成）

```sql
-- profilesテーブルにカラム追加
ALTER TABLE profiles
ADD COLUMN reservation_button_clicks INTEGER DEFAULT 0;

-- コメント追加
COMMENT ON COLUMN profiles.reservation_button_clicks IS '予約ボタンのクリック回数';
```

**実行方法**:
```bash
# SupabaseダッシュボードのSQL Editorで実行
# または
supabase db push
```

**確認**:
```sql
-- カラムが追加されているか確認
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'profiles' AND column_name = 'reservation_button_clicks';
```

---

### 2️⃣ API作成

**ファイル**: `app/api/users/[userId]/reservation-click/route.ts`（新規作成）

```typescript
import { NextRequest, NextResponse } from "next/server";
import { createSupabaseServerClient } from "@/lib/supabase/server";

/**
 * POST /api/users/[userId]/reservation-click
 * 予約ボタンのクリック数をカウントアップ
 */
export async function POST(
  request: NextRequest,
  { params }: { params: { userId: string } }
) {
  try {
    const { userId } = params;

    if (!userId) {
      return NextResponse.json(
        { success: false, error: "userIdが必要です" },
        { status: 400 }
      );
    }

    const supabase = await createSupabaseServerClient();

    // クリック数を+1（排他制御付き）
    const { error } = await supabase.rpc('increment_reservation_clicks', {
      p_user_id: userId
    });

    if (error) {
      console.error("予約クリックカウントエラー:", error);
      return NextResponse.json(
        { success: false, error: error.message },
        { status: 500 }
      );
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("予約クリックAPI例外:", error);
    return NextResponse.json(
      { success: false, error: "サーバーエラー" },
      { status: 500 }
    );
  }
}
```

**Supabase関数も追加** (`supabase/006_add_reservation_clicks.sql`に追記):
```sql
-- 安全にカウントアップする関数
CREATE OR REPLACE FUNCTION increment_reservation_clicks(p_user_id TEXT)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE profiles
  SET reservation_button_clicks = COALESCE(reservation_button_clicks, 0) + 1
  WHERE id = p_user_id;
END;
$$;
```

---

### 3️⃣ LIFF側の修正（2ファイル）

#### ファイル1: `app/(liff)/adult/home/page.tsx`

**修正箇所**: `handleReservation`関数（109-130行目付近）

**Before**:
```typescript
const handleReservation = async () => {
  // 診察券番号をコピー
  await navigator.clipboard.writeText(displayTicketNumber);
  alert(`診察券番号をコピーしました！...`);

  // アポツールを開く
  window.open("https://reservation.stransa.co.jp/...", "_blank");
};
```

**After**:
```typescript
const handleReservation = async () => {
  if (displayTicketNumber === "未登録") {
    alert("診察券番号が登録されていません。受付でお尋ねください。");
    return;
  }

  try {
    // 診察券番号をコピー
    await navigator.clipboard.writeText(displayTicketNumber);
    alert(`診察券番号をコピーしました！\n予約画面で貼り付けてください。\n\n診察券番号: ${displayTicketNumber}`);

    // 🆕 クリック数をカウント（エラーでもユーザー体験は妨げない）
    if (profile?.userId) {
      fetch(`/api/users/${profile.userId}/reservation-click`, {
        method: 'POST',
      }).catch((error) => {
        console.error("クリックカウントエラー:", error);
        // エラーでも予約ページは開く
      });
    }

    // アポツールを開く
    window.open("https://reservation.stransa.co.jp/...", "_blank");
  } catch (error) {
    console.error("予約ボタンエラー:", error);
    alert("エラーが発生しました。もう一度お試しください。");
  }
};
```

#### ファイル2: `app/(liff)/kids/home/page.tsx`

**同様の修正を適用**（handleReservation関数）

---

### 4️⃣ 型定義の更新

**ファイル**: `lib/types.ts`

```typescript
export type Profile = {
  id: string;
  line_user_id: string;
  display_name: string | null;
  picture_url: string | null;
  stamp_count: number;
  ticket_number: string | null;
  last_visit_date: string | null;
  created_at: string;
  updated_at: string;
  is_line_friend?: boolean | null;
  view_mode?: string | null;
  next_visit_date?: string | null;
  next_memo?: string | null;
  next_memo_updated_at?: string | null;
  /** 予約ボタンのクリック回数 */
  reservation_button_clicks?: number; // 🆕 追加
};
```

---

### 5️⃣ 管理ダッシュボードへの表示

#### 分析画面（`app/admin/analysis/page.tsx`）

**追加する指標**:

```typescript
// 既存のサマリーカード群に追加
<div className="rounded-xl bg-white p-6 shadow-sm ring-1 ring-slate-100">
  <div className="flex items-center gap-3">
    <div className="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white">
      <Calendar className="h-6 w-6" />
    </div>
    <div>
      <p className="text-sm text-slate-500">予約ボタンクリック数</p>
      <p className="text-2xl font-bold text-slate-800">
        {profiles.reduce((sum, p) => sum + (p.reservation_button_clicks || 0), 0)}回
      </p>
      <p className="text-xs text-slate-400">
        平均 {(profiles.reduce((sum, p) => sum + (p.reservation_button_clicks || 0), 0) / profiles.length).toFixed(1)}回/人
      </p>
    </div>
  </div>
</div>
```

#### 患者一覧画面（`app/admin/page.tsx`）- オプション

テーブルに列を追加する場合：

```typescript
<TableHead>予約クリック</TableHead>

// TableBodyで
<TableCell className="text-center">
  {p.reservation_button_clicks || 0}回
</TableCell>
```

---

## 📊 ユーザー別クリック数の確認方法

### SQLでの集計例

```sql
-- クリック数トップ10
SELECT
  display_name AS 患者名,
  ticket_number AS 診察券番号,
  reservation_button_clicks AS クリック数,
  stamp_count AS スタンプ数
FROM profiles
WHERE reservation_button_clicks > 0
ORDER BY reservation_button_clicks DESC
LIMIT 10;
```

```sql
-- クリック率
SELECT
  COUNT(*) FILTER (WHERE reservation_button_clicks > 0) AS クリックユーザー数,
  COUNT(*) AS 総ユーザー数,
  ROUND(
    100.0 * COUNT(*) FILTER (WHERE reservation_button_clicks > 0) / COUNT(*),
    2
  ) AS クリック率
FROM profiles;
```

### 管理ダッシュボードでの表示

- **総クリック数**: `SUM(reservation_button_clicks)`
- **平均クリック数**: `総クリック数 / 患者数`
- **クリック率**: `クリックしたユーザー数 / 総ユーザー数 × 100`

---

## ⚠️ 重要な注意事項

### 1. エラーハンドリング

**絶対守ること**: APIコールが失敗しても予約ページは開く

```typescript
// ❌ ダメな例
await fetch('/api/...'); // エラーで止まる

// ✅ 良い例
fetch('/api/...').catch(console.error); // エラーでも続行
```

### 2. オフライン時の動作

- ユーザーがオフラインの場合、カウントされない
- ただし、予約ページは開く（ユーザー体験優先）
- これは仕様として許容

### 3. 実際の予約完了とは別

- あくまで「ボタンをクリックした回数」
- 実際に予約を完了したかは不明
- Stransa（予約システム）との連携は別途必要

### 4. パフォーマンス

- カウントアップは非同期で実行
- ユーザー体験を妨げない設計
- エラーが発生しても予約機能は動作

---

## 🧪 テスト方法

### 1. データベース確認

```sql
-- カラムが追加されているか
SELECT * FROM profiles LIMIT 1;
```

### 2. API動作確認

```bash
# Postmanまたはcurl
curl -X POST http://localhost:3000/api/users/U1234567890abcdef/reservation-click
```

**期待される結果**:
```json
{
  "success": true
}
```

### 3. LIFF実機テスト

1. LINEアプリでminiアプリを開く
2. 「予約する」ボタンをクリック
3. Supabaseで該当ユーザーの`reservation_button_clicks`が+1されているか確認

```sql
-- 特定ユーザーのクリック数を確認
SELECT display_name, reservation_button_clicks
FROM profiles
WHERE id = 'U1234567890abcdef';
```

### 4. 管理ダッシュボード確認

1. `/admin/analysis`を開く
2. 「予約ボタンクリック数」が表示されているか確認
3. 数値が正しいか確認

---

## 📁 ファイル一覧

### 新規作成（3ファイル）

1. `supabase/006_add_reservation_clicks.sql` - マイグレーションSQL
2. `app/api/users/[userId]/reservation-click/route.ts` - APIエンドポイント
3. `Doc/08_予約ボタンクリック計測機能.md` - 仕様書

### 修正（4ファイル）

1. `app/(liff)/adult/home/page.tsx` - AdultHomeの予約ボタン
2. `app/(liff)/kids/home/page.tsx` - KidsHomeの予約ボタン
3. `lib/types.ts` - Profile型の更新
4. `app/admin/analysis/page.tsx` - 分析画面への表示追加

### 更新（2ファイル）

1. `Doc/00_ファイル構成.md` - ファイル一覧更新
2. `Doc/99_変更履歴.md` - 変更履歴追加

---

## 🚀 実装の優先順位

| 作業 | 優先度 | 所要時間 |
|------|--------|----------|
| データベース変更 | 🔴 高 | 5分 |
| API作成 | 🔴 高 | 10分 |
| LIFF修正 | 🔴 高 | 15分 |
| 型定義更新 | 🟡 中 | 5分 |
| 分析画面表示 | 🟢 低 | 15分 |
| 患者一覧表示 | 🟢 低 | 10分 |

**合計実装時間**: 約1時間

---

## 🔮 将来の拡張案

現在は「累積カウンター」方式ですが、将来的により詳細な分析が必要になった場合：

### Phase 2: 履歴テーブル追加

```sql
CREATE TABLE reservation_button_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT REFERENCES profiles(id),
  clicked_at TIMESTAMPTZ DEFAULT NOW(),
  source_page TEXT -- 'adult_home', 'kids_home'
);
```

**可能になること**:
- 日別・月別のクリック推移グラフ
- 時間帯別の分析
- A/Bテストの効果測定

---

## 📞 質問・サポート

### よくある質問

**Q: エラーが発生したらどうなる？**
A: 予約ページは正常に開きます。カウントが漏れるだけで、ユーザー体験は妨げられません。

**Q: 同時に複数回クリックしたら？**
A: データベースのトランザクション処理で正確にカウントされます。

**Q: オフライン時は？**
A: カウントされませんが、これは仕様として許容しています。

**Q: 実装しないとどうなる？**
A: 予約機能は正常に動作します。ただし、データ分析ができなくなります。

### 連絡先

実装中に不明点があれば、プロジェクト担当者までご連絡ください。

---

**作成日**: 2026年2月14日
**対象バージョン**: 管理ダッシュボード v1.0+
**重要度**: 🟡 中（推奨だが必須ではない）
