# スタッフごとアカウント仕様書

**作成日:** 2026-02-08  
**前提:** [Doc_スタッフアカウントとイベントログ検討.md](Doc_スタッフアカウントとイベントログ検討.md) の「①だけ先にやる」方針。  
**スコープ:** スタッフごとのアカウントのみ。**権限の切り分けは行わず、全員同じ操作が可能**とする。  
**目的:** ログインしている「誰」を識別できるようにし、のちのイベントログ（23）で「誰が」を記録できる土台にする。

---

## 1. 概要

- 現状の「単一の管理者ID/パスワード（環境変数）」をやめ、**スタッフ用テーブル**で複数アカウントを管理する。
- ログイン時は「ログインID＋パスワード」でスタッフを特定し、セッションに **staff_id** を含める。
- 管理画面の操作権限は**全スタッフ同一**（閲覧・編集・一斉配信・特典交換・家族編集・スタッフ管理のすべてが可能）。
- スタッフの追加・編集・無効化は、ログイン済みのスタッフが行う（誰でも可）。

---

## 2. データベース設計

### 2.1 テーブル: `staff`

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| `id` | UUID | NO | gen_random_uuid() | 主キー |
| `login_id` | TEXT | NO | - | ログイン用ID（英数字など、一意） |
| `password_hash` | TEXT | NO | - | パスワードのハッシュ（bcrypt 推奨） |
| `display_name` | TEXT | YES | - | 表示名（例: 山田 太郎） |
| `is_active` | BOOLEAN | NO | true | 有効フラグ。false の場合はログイン不可 |
| `created_at` | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| `updated_at` | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約**

- PRIMARY KEY: `id`
- UNIQUE: `login_id`
- CHECK: `login_id` は空文字不可（長さ・形式はアプリ側でバリデーション可）

**インデックス**

- `idx_staff_login_id` … ログイン時の検索用（UNIQUE で自ずと付与される場合は省略可）
- `idx_staff_is_active` … 有効スタッフ一覧取得用（必要に応じて）

**RLS**

- 管理画面用のため、開発段階では `allow_public_read` 等で全件参照・更新可、またはサービスロールでアクセス。本番では「管理画面API経由のみ」を想定し、RLS はアプリ層の認証に依存する形でも可。

### 2.2 マイグレーション

- 新規ファイル例: `supabase/013_create_staff_table.sql`
- 内容: 上記の `staff` テーブル作成。
- **初回データ:** 既存の環境変数 `ADMIN_USER` / `ADMIN_PASSWORD` を利用し、マイグレーション内または別の seed 用SQLで「1件目のスタッフ」を登録する想定（後述「5. 移行」参照）。

---

## 3. 認証・セッション

### 3.1 セッショントークン形式

- **現状:** `admin.{expiry}.{signature}`
- **変更後:** `{staff_id}.{expiry}.{signature}`  
  - `staff_id` は UUID の文字列（ハイフン付きでよい）。
  - 署名対象: `{staff_id}.{expiry}`。署名アルゴリズムは現状どおり HMAC-SHA256、秘密鍵は `AUTH_SECRET`。

### 3.2 ログインフロー

1. ユーザーがログインID・パスワードを送信。
2. `staff` テーブルで `login_id` が一致し、かつ `is_active = true` の行を取得。
3. パスワードと `password_hash` を照合（bcrypt.compare）。
4. 一致すれば、その行の `id` を `staff_id` としてセッショントークンを作成し、Cookie に設定してリダイレクト。
5. 一致しなければログイン失敗（従来どおりエラー表示・リダイレクト）。

### 3.3 ログアウト

- 現状と同様、セッション Cookie を削除するだけでよい。

### 3.4 検証（middleware・API）

- Cookie の値を検証する際、**署名が正しければ payload の先頭を staff_id として解釈**する。
- middleware では「有効なセッションか」だけ判定すればよい（従来どおり）。  
- API 側で「誰が」必要なときは、**Cookie を検証して staff_id を取り出す**ヘルパーを用意する（例: `getStaffIdFromRequest(request)`）。  
  - 未ログイン・無効トークンの場合は null を返し、呼び出し元で 401 など扱う。

---

## 4. API 設計

### 4.1 認証

| メソッド | パス | 説明 |
|----------|------|------|
| POST | /api/auth/login | ログインID・パスワードで認証。成功時は staff_id 入りセッションを発行。 |
| POST | /api/auth/logout | セッション Cookie を削除。 |

### 4.2 スタッフ管理（全スタッフ同一権限のため、ログイン済みなら誰でも利用可）

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/staff | スタッフ一覧取得（is_active は含める。一覧表示で「無効」も表示する想定）。 |
| POST | /api/staff | スタッフ追加（login_id, password, display_name）。 |
| PATCH | /api/staff/[id] | 表示名・パスワードの更新。パスワードは「送信された場合のみ」更新。 |
| PATCH | /api/staff/[id]/deactivate | is_active = false に更新（ログイン不可にする）。 |

- 一覧取得では、ログイン中の staff_id が分かれば「自分」をマークする程度でよい。権限による出し分けは不要。

### 4.3 既存 API

- 既存の管理画面用 API（profiles, families, reward-exchanges, broadcast など）は、**認証チェックは「ログイン済みか」のまま**でよい。
- 変更点は「セッションから staff_id を取得できるようにする」ことのみ。  
- 各 API 内で権限分けは行わない（全員同じ権限）。

---

## 5. UI 設計

### 5.1 ログイン画面

- 現状の「ユーザー名」「パスワード」を、**ログインID**・**パスワード**の入力にそのまま利用。
- ラベルを「ログインID」に変更する程度でよい。

### 5.2 スタッフ管理画面（新規）

- **パス例:** `/admin/staff`
- **内容:**
  - スタッフ一覧（ログインID、表示名、有効/無効、最終更新日時など）。
  - 「追加」: ログインID・パスワード・表示名を入力して登録。
  - 「編集」: 表示名の変更、パスワードの変更（任意）。
  - 「無効化」: 該当スタッフをログイン不可にする。復活が必要なら「有効化」を別途用意してもよい。
- ナビゲーション（ヘッダー等）に「スタッフ管理」リンクを追加。

### 5.3 ヘッダーでの「誰でログインしているか」

- ログイン中の `staff_id` から `display_name`（または `login_id`）を表示すると、「誰でログインしているか」が分かりやすい。  
- 取得方法: セッションの staff_id で `staff` を 1 件取得する API（例: GET /api/auth/me）を用意し、ヘッダーで利用する。

---

## 6. 実装上の注意

### 6.1 パスワード

- 保存するのは必ず **ハッシュ**（bcrypt 推奨）。平文は保存しない。
- Node では `bcrypt` または `bcryptjs` を使用。  
  - ハッシュ生成: `bcrypt.hash(password, 10)`  
  - 照合: `bcrypt.compare(plainPassword, row.password_hash)`

### 6.2 ログインID の重複

- 追加・編集時に `login_id` の一意制約に違反した場合は、409 Conflict または 400 で「このログインIDは既に使われています」などを返す。

### 6.3 無効化したスタッフ

- `is_active = false` のスタッフは、ログイン処理の段階で「該当なし」として弾く。  
- 既に発行済みのセッションは、**無効化後も期限まで有効**とするか、無効化時に全セッションを無効にするかは要件次第。  
  - シンプルなのは「無効化後も既存セッションは期限まで有効」とし、次回ログイン時には弾く形。

---

## 7. 移行（既存環境からの移行）

- 現在は環境変数 `ADMIN_USER` / `ADMIN_PASSWORD` の 1 アカウント想定。
- **移行手順案:**
  1. `staff` テーブルを作成するマイグレーション（013）を適用。
  2. 初回のみ、`ADMIN_USER` を `login_id`、`ADMIN_PASSWORD` を bcrypt でハッシュした値を `password_hash` に持つスタッフを 1 件 INSERT（マイグレーション内で環境変数を参照できない場合は、手動実行用の SQL を Doc に記載、または seed スクリプトで実行）。
  3. アプリを「スタッフテーブル認証」に切り替え（環境変数認証を削除）。
  4. 既存の `admin_session` Cookie は形式が変わるため、**一度全員ログアウト（Cookie 削除）してもらい、新形式で再ログイン**してもらう想定でよい。

---

## 8. 今後の拡張（本仕様のスコープ外）

- **権限の切り分け:** 将来、ロールやフラグを追加する場合は、`staff` に `role` や `permissions` を追加し、各 API で「このスタッフはこの操作可か」を判定する。
- **イベントログ:** 本仕様で「誰（staff_id）」が識別できるようになるため、[23_イベントログ設計（スタッフ操作ログ）.md](23_イベントログ設計（スタッフ操作ログ）.md) に従い、各操作後に `staff_id` を付与してログを記録する。

---

## 9. 関連ドキュメント

- [Doc_スタッフアカウントとイベントログ検討.md](Doc_スタッフアカウントとイベントログ検討.md) … 方針・選択肢の整理
- [23_イベントログ設計（スタッフ操作ログ）.md](23_イベントログ設計（スタッフ操作ログ）.md) … スタッフ導入後に実施するイベントログ設計
- [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md) … 現行の認証・画面構成
- [05_Database_Schema.md](05_Database_Schema.md) … 既存スキーマ（staff テーブル追加後はここに追記）

---

最終更新: 2026-02-08
