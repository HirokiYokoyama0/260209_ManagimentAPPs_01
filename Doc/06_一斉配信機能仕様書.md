# 一斉配信機能仕様書

つくばホワイト歯科 管理ダッシュボードの一斉配信機能の設計仕様書です。

---

## 1. 概要・目的

### 目的
患者セグメント（スタンプ数、来院間隔、表示モードなど）に応じて、効率的に一斉メッセージを配信し、リコール率向上・患者エンゲージメント強化を実現する。

### 基本方針
- **安全性優先**: 誤送信防止のため、3ステップのワークフロー（抽出 → 作成 → 確認・送信）
- **スタッフが迷わない**: UIはシンプルで直感的に
- **配信ログの記録**: いつ・誰が・誰に・何を送ったかを完全記録
- **コスト意識**: LINE Messaging APIの無料枠を考慮した通数表示

---

## 2. 配信対象の絞り込み（セグメント設定）

### 2.1 セグメント条件

患者一覧画面または新規作成する「一斉配信」画面で、以下の条件で絞り込みが可能。

#### スタンプ数による絞り込み

| 条件例 | 用途 |
|--------|------|
| スタンプ 0個 | 初診後のフォローアップ |
| スタンプ 1-5個 | 継続来院の促進 |
| スタンプ 15-19個 | 「あと少しで特典！」のリマインド |
| スタンプ 20個以上 | 特典利用の案内・感謝メッセージ |

#### 来院間隔による絞り込み

| 条件例 | 用途 |
|--------|------|
| 最終来院から 90日以上 | 定期検診のリマインド |
| 最終来院から 180日以上 | 久しぶりの患者へのアプローチ |
| 最終来院から 30日未満 | 治療後のフォローアップ |

#### 表示モードによる絞り込み

| 条件 | 用途 |
|------|------|
| キッズモードのみ | 夏休みイベント・子供向けキャンペーン |
| 大人モードのみ | ホワイトニング・予防歯科の案内 |

#### 公式アカ友だちフラグ

| 条件 | 用途 |
|------|------|
| 友だち登録済みのみ | 実際にLINEにメッセージが届くユーザー |
| 未登録 | アプリ内には登録済みだがLINE友だち未登録の人（メッセージ不可） |

### 2.2 複合条件

複数条件の組み合わせも可能：
- 「スタンプ 10個以上」**かつ** 「最終来院から 90日以上」
- 「キッズモード」**かつ** 「友だち登録済み」

---

## 3. 一斉配信のワークフロー（3ステップ）

### ステップ1: ターゲット抽出

#### 画面構成
- **場所**: `/admin/broadcast`（新規ページ）または患者一覧画面に「一斉配信」ボタンを追加
- **UI要素**:
  - セグメント条件選択（ドロップダウン・スライダー・チェックボックス）
  - 「プレビュー」ボタン → 対象者一覧を表示
  - **対象者数表示**: 「対象者：〇〇名」（リアルタイム更新）
  - 「次へ（メッセージ作成）」ボタン

#### 機能詳細
```typescript
// セグメント条件の型定義
interface BroadcastSegment {
  stampCount?: { min?: number; max?: number };     // スタンプ数範囲
  lastVisitDays?: { min?: number; max?: number };  // 最終来院からの日数
  viewMode?: 'adult' | 'kids' | null;              // 表示モード
  isLineFriend?: boolean;                          // 公式アカ友だちフラグ
}
```

#### バックエンドAPI
- `GET /api/broadcast/preview` - セグメント条件に基づく対象者数とプレビュー取得
  - Request Body: `BroadcastSegment`
  - Response: `{ count: number; preview: Profile[] }` （最初の10名程度を返す）

---

### ステップ2: メッセージ作成

#### 画面構成
- **対象者情報**: 「〇〇名に配信します」を上部に固定表示
- **メッセージ入力エリア**:
  - テキストエリア（1000文字まで）
  - プレースホルダー変数機能:
    - `{name}` → 患者の氏名
    - `{stamp_count}` → 現在のスタンプ数
    - 例: 「{name}様、現在のスタンプは{stamp_count}個です！」
- **定型テンプレート選択** (オプション):
  - 「定期検診のご案内」
  - 「スタンプキャンペーン」
  - 「季節のお知らせ」
  - 将来的にはDB（`message_templates`）から取得

#### AI支援機能（将来拡張）
- Cursor AIなどを活用した歯科専用テンプレート生成
- 「90日未来院の患者向けのフレンドリーなメッセージを生成」など

#### 機能詳細
- 変数置換のプレビュー表示
- 文字数カウント表示
- 「戻る」ボタン（ステップ1に戻る）
- 「次へ（確認）」ボタン

---

### ステップ3: 確認・送信

#### 画面構成
- **最終確認画面**:
  - 対象者数: 「〇〇名」
  - 配信条件サマリ: 「スタンプ 15-19個、最終来院 90日以上」
  - メッセージプレビュー（変数置換後のサンプル表示）
  - **LINEメッセージ通数**: 「今回の配信で〇〇通消費します」
  - **今月の残り無料枠**: 「今月の無料枠: 残り〇〇通 / 1000通」（LINE Messaging APIの無料枠）

#### テスト送信機能
- 「自分のLINEにテスト送信」ボタン
  - 管理者のLINE IDを環境変数で設定
  - 実際の配信前に内容を確認

#### 送信実行
- **送信ボタン**: 「〇〇名に送信する」
- 確認ダイアログ: 「本当に送信しますか？」（誤操作防止）
- 送信処理:
  - バックグラウンドジョブで順次送信（Next.js API Route）
  - プログレスバー表示: 「送信中... 〇〇/〇〇名 完了」
  - 完了後: 「送信完了しました」+ ログ記録

---

## 4. 技術仕様

### 4.1 LINE Messaging API

#### Multicast API の使用

```typescript
// LINE Multicast API 仕様
POST https://api.line.me/v2/bot/message/multicast

Headers:
  Authorization: Bearer {CHANNEL_ACCESS_TOKEN}
  Content-Type: application/json

Body:
{
  "to": ["U1234567890abcdef...", "U1234567890abcdef..."], // 最大500件
  "messages": [
    {
      "type": "text",
      "text": "メッセージ内容"
    }
  ]
}
```

#### 実装方針
- 対象者が500人以下: 1回のMulticast APIで送信
- 対象者が500人超: 500人ずつに分割して複数回送信
- エラーハンドリング: 送信失敗時はログに記録し、リトライ処理を検討

### 4.2 データベース設計

#### broadcast_logs テーブル

```sql
CREATE TABLE IF NOT EXISTS broadcast_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 配信情報
  sent_by TEXT NOT NULL,                    -- 送信者（管理者名またはID）
  segment_conditions JSONB NOT NULL,        -- セグメント条件（JSON形式）
  message_text TEXT NOT NULL,               -- 送信メッセージ内容

  -- 配信結果
  target_count INTEGER NOT NULL,            -- 対象者数
  success_count INTEGER DEFAULT 0,          -- 送信成功数
  failed_count INTEGER DEFAULT 0,           -- 送信失敗数

  -- タイムスタンプ
  sent_at TIMESTAMPTZ DEFAULT NOW(),        -- 送信実行日時
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX IF NOT EXISTS idx_broadcast_logs_sent_at
  ON broadcast_logs(sent_at DESC);
```

#### broadcast_recipients テーブル（オプション：詳細ログ）

送信先ごとの詳細ログを残す場合（将来拡張）:

```sql
CREATE TABLE IF NOT EXISTS broadcast_recipients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  broadcast_log_id UUID REFERENCES broadcast_logs(id),
  profile_id TEXT REFERENCES profiles(id),
  status TEXT NOT NULL,                     -- 'success' | 'failed'
  error_message TEXT,
  sent_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.3 APIエンドポイント

#### `GET /api/broadcast/preview`
セグメント条件に基づく対象者のプレビュー

**Request Body**:
```typescript
{
  stampCount?: { min?: number; max?: number };
  lastVisitDays?: { min?: number; max?: number };
  viewMode?: 'adult' | 'kids' | null;
  isLineFriend?: boolean;
}
```

**Response**:
```typescript
{
  count: number;              // 対象者数
  preview: Profile[];         // プレビュー（最初の10件）
  estimatedCost: number;      // 推定メッセージ通数
}
```

#### `POST /api/broadcast/send`
一斉配信の実行

**Request Body**:
```typescript
{
  segment: BroadcastSegment;  // セグメント条件
  message: string;            // メッセージ内容（変数含む）
  sentBy: string;             // 送信者名
  testMode?: boolean;         // テストモード（管理者にのみ送信）
}
```

**Response**:
```typescript
{
  success: boolean;
  broadcastLogId: string;     // broadcast_logs の ID
  targetCount: number;
  successCount: number;
  failedCount: number;
}
```

#### `GET /api/broadcast/logs`
配信履歴の取得

**Response**:
```typescript
{
  logs: Array<{
    id: string;
    sentBy: string;
    targetCount: number;
    successCount: number;
    sentAt: string;
    messageText: string;      // 最初の50文字
  }>;
}
```

### 4.4 変数置換ロジック

```typescript
// メッセージ内の変数を置換
function replaceVariables(message: string, profile: Profile): string {
  return message
    .replace(/{name}/g, profile.display_name || 'お客様')
    .replace(/{stamp_count}/g, String(profile.stamp_count || 0))
    .replace(/{ticket_number}/g, profile.ticket_number || '未設定');
}
```

---

## 5. UI/UX 設計

### 5.1 画面遷移フロー

```
患者一覧画面 (/admin)
  ↓ [一斉配信] ボタン
一斉配信画面 (/admin/broadcast)
  ├─ タブ: [新規配信] [配信履歴]
  │
  └─ [新規配信] タブ
       ├─ ステップ1: ターゲット抽出
       │   - セグメント条件設定
       │   - 対象者数リアルタイム表示
       │   - [プレビュー] ボタン → 対象者一覧モーダル
       │   - [次へ] ボタン
       │
       ├─ ステップ2: メッセージ作成
       │   - メッセージ入力エリア
       │   - 定型テンプレート選択
       │   - 変数挿入ボタン
       │   - [戻る] / [次へ] ボタン
       │
       └─ ステップ3: 確認・送信
           - 配信条件サマリ
           - メッセージプレビュー
           - メッセージ通数・残り無料枠表示
           - [テスト送信] ボタン
           - [送信実行] ボタン → 確認ダイアログ
           - 送信中プログレスバー
           - 完了メッセージ
```

### 5.2 配信履歴タブ

#### 表示内容
| 列 | 内容 |
|----|------|
| 送信日時 | YYYY-MM-DD HH:mm |
| 送信者 | 管理者名 |
| 対象条件 | 「スタンプ 15-19個」など簡潔に表示 |
| 対象者数 | 〇〇名 |
| 成功/失敗 | 〇〇成功 / △△失敗 |
| メッセージ | 最初の30文字 + ... |
| アクション | [詳細] ボタン |

#### 詳細モーダル
- 完全なメッセージ内容
- セグメント条件の詳細
- 送信結果の詳細（成功率など）

---

## 6. 運用上の注意点・制約

### 6.1 LINE Messaging API の制約

#### 無料枠
- **月間 1,000通まで無料**（2024年時点）
- 1,000通を超えると追加料金が発生
- ダッシュボードで「今月の利用状況」を表示し、コスト意識を促す

#### レート制限
- Multicast API: 1回あたり最大 500人
- 送信レート: 明確な公開制限はないが、短時間に大量送信すると制限される可能性
- 実装: 500人ごとに分割 + 適切なインターバル（500ms程度）を設ける

### 6.2 配信タイミング制約

#### 夜間配信の制限
- **配信禁止時間帯**: 21:00 - 9:00（患者の迷惑にならないよう）
- システム側でチェックし、禁止時間帯の場合は警告表示
- 将来的には「予約送信」機能を実装（翌朝9時に自動送信など）

#### 配信頻度の制限
- **同一患者への配信制限**: 7日以内に2回以上の一斉配信は警告
- `broadcast_recipients` テーブルで管理

### 6.3 誤送信防止

#### 確認ステップの強制
- ステップ3での確認ダイアログは必須
- 「本当に送信しますか？ 対象者: 〇〇名」を表示

#### テスト送信の推奨
- 初回配信時は必ず「テスト送信」を促すメッセージを表示

#### ロールバック不可の警告
- 「送信後の取り消しはできません」を明記

---

## 7. 将来の拡張機能

### Phase 1（短期）
- [ ] 基本的な一斉配信機能（スタンプ数・来院間隔・表示モード）
- [ ] テスト送信機能
- [ ] 配信履歴の記録・閲覧

### Phase 2（中期）
- [ ] 予約送信機能（日時指定）
- [ ] リッチメッセージ対応（画像・ボタン付きメッセージ）
- [ ] 配信結果の分析（開封率・反応率）※ LINEの制約により限定的
- [ ] セグメント保存機能（よく使う条件を保存）

### Phase 3（長期）
- [ ] A/Bテスト機能（異なるメッセージで効果比較）
- [ ] AI支援メッセージ生成（Cursor連携）
- [ ] 自動配信ルール（例: 90日未来院の患者に自動でリマインド）

---

## 8. データフロー

### 配信実行の流れ

```
管理者（ブラウザ）
  ↓ セグメント条件を選択
/api/broadcast/preview
  ↓ 対象者数をリアルタイム取得
Supabase（profiles テーブル）
  ↓ 対象者データを返却
管理者がメッセージ作成
  ↓ 送信実行
/api/broadcast/send
  ↓ ①対象者を取得
Supabase（profiles テーブル）
  ↓ ②変数置換処理
  ↓ ③Multicast API 送信（500人ずつ）
LINE Messaging API
  ↓ ④配信結果を記録
Supabase（broadcast_logs テーブル）
  ↓ 完了
管理者に結果表示
```

---

## 9. 実装の優先順位

### 最優先（MVP）
1. ターゲット抽出機能（スタンプ数・来院間隔・友だちフラグ）
2. メッセージ作成（テキストのみ、変数置換）
3. 確認・送信機能（Multicast API連携）
4. 配信ログ記録（broadcast_logs）

### 次点
5. 配信履歴画面
6. テスト送信機能
7. 夜間配信制限
8. メッセージ通数表示

### 将来対応
9. 予約送信
10. リッチメッセージ
11. AI支援
12. 自動配信ルール

---

## 10. セキュリティ・コンプライアンス

### 個人情報保護
- LINE IDなどの個人情報は適切に暗号化・管理
- ログには個人を特定できる情報（LINE ID）を含めない（profile_id のみ記録）

### 権限管理
- 一斉配信機能は管理者権限のみ（将来的にロール分け）
- 送信履歴には「誰が送信したか」を必ず記録

---

最終更新: 2026-02-14
