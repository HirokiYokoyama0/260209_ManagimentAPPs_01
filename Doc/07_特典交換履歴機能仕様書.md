# ç‰¹å…¸äº¤æ›å±¥æ­´æ©Ÿèƒ½ä»•æ§˜æ›¸

> ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€Œç‰¹å…¸äº¤æ›å±¥æ­´ã€ã‚¿ãƒ–ã‚’è¿½åŠ ã—ã€æ‚£è€…ãŒã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ã£ã¦ä½•ã‚’äº¤æ›ã—ãŸã‹ã‚’æŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†ï¼ˆ2026-02-14ï¼‰

---

## 1. æ¦‚è¦

**ç›®çš„**: æ‚£è€…ãŒLINEãƒŸãƒ‹ã‚¢ãƒ—ãƒªï¼ˆLIFFï¼‰ã§ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ã£ã¦ç‰¹å…¸ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°å‰²å¼•ã€ã‚±ã‚¢ç”¨å“ãªã©ï¼‰ã‚’äº¤æ›ã—ãŸå±¥æ­´ã‚’ã€ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä¸€è¦§è¡¨ç¤ºãƒ»ç®¡ç†ã™ã‚‹

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:
- å—ä»˜ã‚¹ã‚¿ãƒƒãƒ•ãŒã€Œèª°ãŒä½•ã®ç‰¹å…¸ã‚’äº¤æ›ã—ãŸã‹ã€ã‚’ç¢ºèª
- ç‰¹å…¸ã®å¼•ãæ›ãˆçŠ¶æ³ï¼ˆpending/completed/cancelledï¼‰ã‚’ç®¡ç†
- äººæ°—ã®ç‰¹å…¸ã‚’æŠŠæ¡ã—ã€åœ¨åº«ç®¡ç†ã‚„æ–°ã—ã„ç‰¹å…¸ä¼ç”»ã®å‚è€ƒã«ã™ã‚‹

**å®Ÿè£…çŠ¶æ³**: Phase 1å®Œäº†

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ï¼ˆå®Ÿéš›ï¼‰

**æ³¨æ„**: å®Ÿéš›ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸€éƒ¨ã‚«ãƒ©ãƒ ãŒç•°ãªã‚Šã¾ã™ã€‚

### 2-1. rewards ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç‰¹å…¸ãƒã‚¹ã‚¿ãƒ¼ï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|---|------|
| `id` | UUID | ä¸»ã‚­ãƒ¼ |
| `name` | TEXT | ç‰¹å…¸åï¼ˆä¾‹: ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°20%OFFã€é›»å‹•æ­¯ãƒ–ãƒ©ã‚·ï¼‰ |
| `description` | TEXT | ç‰¹å…¸ã®èª¬æ˜ |
| `required_stamps` | INTEGER | å¿…è¦ã‚¹ã‚¿ãƒ³ãƒ—æ•° |
| `stock_count` | INTEGER | åœ¨åº«æ•°ï¼ˆnull ã®å ´åˆã¯ç„¡åˆ¶é™ï¼‰ |
| `is_active` | BOOLEAN | æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆé…å¸ƒåœæ­¢ã®å ´åˆã¯ falseï¼‰ |
| `image_url` | TEXT | ç‰¹å…¸ç”»åƒURL |
| `created_at` | TIMESTAMPTZ | ä½œæˆæ—¥æ™‚ |
| `updated_at` | TIMESTAMPTZ | æ›´æ–°æ—¥æ™‚ |

### 2-2. reward_exchanges ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆäº¤æ›å±¥æ­´ï¼‰

**å®Ÿè£…ã•ã‚ŒãŸå®Ÿéš›ã®æ§‹é€ **:

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|---|------|
| `id` | UUID | ä¸»ã‚­ãƒ¼ |
| `user_id` | TEXT | äº¤æ›ã—ãŸæ‚£è€…ã®IDï¼ˆprofiles.id ã¸ã®å‚ç…§ï¼‰ |
| `reward_id` | UUID | äº¤æ›ã—ãŸç‰¹å…¸ã®IDï¼ˆrewards.id ã¸ã®å‚ç…§ï¼‰ |
| `stamp_count_used` | INTEGER | ä½¿ç”¨ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—æ•° |
| `status` | TEXT | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpending: æœªå¼•æ¸¡, completed: å¼•æ¸¡æ¸ˆ, cancelled: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ |
| `exchanged_at` | TIMESTAMPTZ | äº¤æ›ç”³è«‹æ—¥æ™‚ |
| `notes` | TEXT | å‚™è€ƒï¼ˆç‰¹å…¸åãªã©ã‚’è¨˜éŒ²ï¼‰ |
| `created_at` | TIMESTAMPTZ | ä½œæˆæ—¥æ™‚ |
| `updated_at` | TIMESTAMPTZ | æ›´æ–°æ—¥æ™‚ |

**æ³¨æ„**: `completed_at`ã€`completed_by` ã‚«ãƒ©ãƒ ã¯å®Ÿéš›ã«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ã§ç®¡ç†ã—ã¾ã™ã€‚

---

## 3. ç”»é¢è¨­è¨ˆ

### 3-1. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

**è¿½åŠ å ´æ‰€**: ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼

```
æ‚£è€…ä¸€è¦§ | åˆ†æ | ä¸€æ–‰é…ä¿¡ | ç‰¹å…¸äº¤æ›å±¥æ­´ â† æ–°è¦è¿½åŠ 
```

**ãƒ«ãƒ¼ãƒˆ**: `/admin/reward-exchanges`

### 3-2. ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¦· ã¤ãã°ãƒ›ãƒ¯ã‚¤ãƒˆæ­¯ç§‘ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰                      â”‚
â”‚ [æ‚£è€…ä¸€è¦§] [åˆ†æ] [ä¸€æ–‰é…ä¿¡] [â˜…ç‰¹å…¸äº¤æ›å±¥æ­´] [ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹å…¸äº¤æ›å±¥æ­´                                                  â”‚
â”‚                                                              â”‚
â”‚ ãƒ•ã‚£ãƒ«ã‚¿:                                                     â”‚
â”‚ [å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â–¼] [å…¨æœŸé–“ â–¼] [ğŸ” æ‚£è€…åãƒ»ç‰¹å…¸åã§æ¤œç´¢]         â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ‚£è€…å | ç‰¹å…¸å | ã‚¹ã‚¿ãƒ³ãƒ—æ•° | äº¤æ›æ—¥æ™‚ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ“ä½œ â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ æ¨ªå±±æµ©ç´€ | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°20%OFF | 5 | 2026/02/10 03:23 | â”‚   â”‚
â”‚ â”‚           pending [âœ“å®Œäº†] [Ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«]               â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ æ¨ªå±±æµ©ç´€ | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°20%OFF | 5 | 2026/02/10 03:23 | â”‚   â”‚
â”‚ â”‚           pending [âœ“å®Œäº†] [Ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«]               â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ...                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚ è¡¨ç¤ºä»¶æ•°: 50ä»¶ / å…¨123ä»¶                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3-3. ã‚«ãƒ©ãƒ ä»•æ§˜

| ã‚«ãƒ©ãƒ  | å†…å®¹ | å‚™è€ƒ |
|--------|------|------|
| **æ‚£è€…å** | `profiles.display_name` | ã‚¯ãƒªãƒƒã‚¯ã§æ‚£è€…è©³ç´°ã«é·ç§» |
| **ç‰¹å…¸å** | `rewards.name` | ç‰¹å…¸ã‚¢ã‚¤ã‚³ãƒ³ä»˜ã |
| **ã‚¹ã‚¿ãƒ³ãƒ—æ•°** | `reward_exchanges.stamp_count_used` | ä½¿ç”¨ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—æ•° |
| **äº¤æ›æ—¥æ™‚** | `reward_exchanges.exchanged_at` | YYYY/MM/DD HH:mm å½¢å¼ |
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | `reward_exchanges.status` | ãƒãƒƒã‚¸è¡¨ç¤ºï¼ˆpending: é»„ã€completed: ç·‘ã€cancelled: ç°ï¼‰ |
| **æ“ä½œ** | ãƒœã‚¿ãƒ³ | pending ã®å ´åˆã®ã¿ã€Œå®Œäº†ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º |

### 3-4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

| status | æ—¥æœ¬èª | ãƒãƒƒã‚¸è‰² | èª¬æ˜ |
|--------|-------|---------|------|
| `pending` | æœªå¼•æ¸¡ | é»„è‰²ï¼ˆamberï¼‰ | æ‚£è€…ãŒç‰¹å…¸ã‚’ç”³è«‹ã—ãŸãŒã€ã¾ã å—ä»˜ã§å¼•ãæ¸¡ã—ã¦ã„ãªã„ |
| `completed` | å¼•æ¸¡æ¸ˆ | ç·‘è‰²ï¼ˆgreenï¼‰ | å—ä»˜ã§ç‰¹å…¸ã‚’å¼•ãæ¸¡ã—å®Œäº† |
| `cancelled` | ã‚­ãƒ£ãƒ³ã‚»ãƒ« | ç°è‰²ï¼ˆgrayï¼‰ | åœ¨åº«åˆ‡ã‚Œãªã©ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ |

---

## 4. æ©Ÿèƒ½ä»•æ§˜

### 4-1. ä¸€è¦§è¡¨ç¤º

**API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/reward-exchanges`

**å–å¾—ãƒ‡ãƒ¼ã‚¿**:
```typescript
type RewardExchangeWithDetails = {
  id: string;
  user_id: string;
  user_name: string; // profiles.display_name
  user_picture_url: string | null; // profiles.picture_url
  reward_id: string;
  reward_name: string; // rewards.name
  reward_image_url: string | null; // rewards.image_url
  stamp_count_used: number;
  status: 'pending' | 'completed' | 'cancelled';
  exchanged_at: string; // ISO 8601
  completed_at: string | null;
  completed_by: string | null;
  notes: string | null;
};
```

**SQL ã‚¯ã‚¨ãƒªï¼ˆä¾‹ï¼‰**:
```sql
SELECT
  re.id,
  re.user_id,
  p.display_name AS user_name,
  p.picture_url AS user_picture_url,
  re.reward_id,
  r.name AS reward_name,
  r.image_url AS reward_image_url,
  re.stamp_count_used,
  re.status,
  re.exchanged_at,
  re.completed_at,
  re.completed_by,
  re.notes
FROM reward_exchanges re
  INNER JOIN profiles p ON re.user_id = p.id
  INNER JOIN rewards r ON re.reward_id = r.id
ORDER BY re.exchanged_at DESC
LIMIT 50;
```

**ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½**:
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿: `?status=pending` / `?status=completed` / `?status=cancelled`
- æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿: `?from=2026-02-01&to=2026-02-28`
- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿: `?search=æ¨ªå±±` ï¼ˆæ‚£è€…åã¾ãŸã¯ç‰¹å…¸åã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼‰

### 4-2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆå¼•ãæ¸¡ã—å®Œäº†ï¼‰

**API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/reward-exchanges/[id]/complete`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "completedBy": "ç”°ä¸­ï¼ˆå—ä»˜ï¼‰"
}
```

**å‡¦ç†å†…å®¹**:
1. `reward_exchanges` ã®è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°:
   - `status` ã‚’ `completed` ã«å¤‰æ›´
   - `completed_at` ã‚’ç¾åœ¨æ™‚åˆ»ã«è¨­å®š
   - `completed_by` ã«ã‚¹ã‚¿ãƒƒãƒ•åã‚’è¨˜éŒ²

### 4-3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰

**API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/reward-exchanges/[id]/cancel`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "notes": "åœ¨åº«åˆ‡ã‚Œã®ãŸã‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
}
```

**å‡¦ç†å†…å®¹**:
1. `reward_exchanges` ã®è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°:
   - `status` ã‚’ `cancelled` ã«å¤‰æ›´

**âš ï¸ é‡è¦**: ã‚¹ã‚¿ãƒ³ãƒ—ã¯**è¿”å´ã—ã¾ã›ã‚“**ï¼ˆç©ã¿ä¸Šã’å¼ã®ãŸã‚ï¼‰

### 4-4. è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

äº¤æ›å±¥æ­´ã®è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º:
- æ‚£è€…æƒ…å ±ï¼ˆåå‰ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã€è¨ºå¯Ÿåˆ¸ç•ªå·ï¼‰
- ç‰¹å…¸æƒ…å ±ï¼ˆç‰¹å…¸åã€ç”»åƒã€å¿…è¦ã‚¹ã‚¿ãƒ³ãƒ—æ•°ï¼‰
- äº¤æ›æ—¥æ™‚
- å¼•ãæ¸¡ã—å®Œäº†æ—¥æ™‚ãƒ»æ‹…å½“è€…ï¼ˆcompleted ã®å ´åˆï¼‰
- å‚™è€ƒï¼ˆcancelled ã®å ´åˆï¼‰

---

## 5. å®Ÿè£…ç¯„å›²ï¼ˆPhase 1ï¼‰âœ…

### å«ã‚€æ©Ÿèƒ½
- âœ… ç‰¹å…¸äº¤æ›å±¥æ­´ã®ä¸€è¦§è¡¨ç¤ºï¼ˆæœ€æ–°50ä»¶ï¼‰
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆpending / completed / cancelledï¼‰
- âœ… æ‚£è€…åãƒ»ç‰¹å…¸åã§ã®æ¤œç´¢
- âœ… ã€Œå¼•ãæ¸¡ã—å®Œäº†ã€ãƒœã‚¿ãƒ³ï¼ˆpending â†’ completedï¼‰
- âœ… ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ï¼ˆpending â†’ cancelledï¼‰**ã‚¹ã‚¿ãƒ³ãƒ—ã¯è¿”å´ã—ãªã„**
- âœ… ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ï¼ˆå…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¯¾å¿œï¼‰
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®è‰²åˆ†ã‘è¡¨ç¤º

### é‡è¦ãªå®Ÿè£…ä»•æ§˜
- **ã‚¹ã‚¿ãƒ³ãƒ—ã¯ç©ã¿ä¸Šã’å¼**: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã‚¹ã‚¿ãƒ³ãƒ—ã¯è¿”å´ã•ã‚Œã¾ã›ã‚“
- **å‰Šé™¤æ©Ÿèƒ½**: å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨å‰Šé™¤å¯èƒ½
- **RLSãƒãƒªã‚·ãƒ¼**: `supabase/005_reward_exchanges_rls.sql` ã§è¨­å®šæ¸ˆã¿

### å«ã¾ãªã„æ©Ÿèƒ½ï¼ˆPhase 2 ä»¥é™ã§æ¤œè¨ï¼‰
- âŒ æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
- âŒ è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- âŒ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
- âŒ ç‰¹å…¸ãƒã‚¹ã‚¿ãƒ¼ï¼ˆrewards ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã®ç®¡ç†ç”»é¢

---

## 6. UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

### 6-1. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/
  admin/
    reward-exchanges/
      page.tsx              # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
api/
  reward-exchanges/
    route.ts                # GET: ä¸€è¦§å–å¾—
    [id]/
      complete/
        route.ts            # POST: å®Œäº†å‡¦ç†
      cancel/
        route.ts            # POST: ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
lib/
  types.ts                  # RewardExchange å‹å®šç¾©è¿½åŠ 
components/
  admin/
    reward-exchanges-table.tsx  # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```

### 6-2. å‹å®šç¾©

**lib/types.ts** ã«è¿½åŠ :

```typescript
// ç‰¹å…¸ãƒã‚¹ã‚¿ãƒ¼
export type Reward = {
  id: string;
  name: string;
  description: string | null;
  required_stamps: number;
  stock_count: number | null;
  is_active: boolean;
  image_url: string | null;
  created_at: string;
  updated_at: string;
};

// ç‰¹å…¸äº¤æ›å±¥æ­´
export type RewardExchange = {
  id: string;
  user_id: string;
  reward_id: string;
  stamp_count_used: number;
  status: 'pending' | 'completed' | 'cancelled';
  exchanged_at: string;
  completed_at: string | null;
  completed_by: string | null;
  notes: string | null;
  created_at: string;
};

// è©³ç´°æƒ…å ±ä»˜ãäº¤æ›å±¥æ­´ï¼ˆJOINçµæœï¼‰
export type RewardExchangeWithDetails = RewardExchange & {
  user_name: string;
  user_picture_url: string | null;
  reward_name: string;
  reward_image_url: string | null;
};
```

---

## 7. ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 7-1. ã‚«ãƒ©ãƒ¼

| è¦ç´  | ã‚«ãƒ©ãƒ¼ | Tailwind |
|------|-------|----------|
| pending ãƒãƒƒã‚¸ | é»„è‰² | `bg-amber-100 text-amber-700` |
| completed ãƒãƒƒã‚¸ | ç·‘è‰² | `bg-green-100 text-green-700` |
| cancelled ãƒãƒƒã‚¸ | ç°è‰² | `bg-gray-100 text-gray-600` |
| å®Œäº†ãƒœã‚¿ãƒ³ | ç·‘è‰² | `bg-green-600 hover:bg-green-700` |
| ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ | èµ¤è‰² | `bg-red-100 text-red-700 hover:bg-red-200` |

### 7-2. ã‚¢ã‚¤ã‚³ãƒ³

- ç‰¹å…¸äº¤æ›å±¥æ­´ã‚¿ãƒ–: `Gift` (lucide-react)
- å®Œäº†ãƒœã‚¿ãƒ³: `Check`
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³: `X`
- æ¤œç´¢: `Search`
- ãƒ•ã‚£ãƒ«ã‚¿: `Filter`

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ¨©é™

- ç®¡ç†ç”»é¢ã®ãŸã‚ã€ã™ã¹ã¦ã®æ“ä½œã«èªè¨¼ãŒå¿…è¦ï¼ˆmiddleware ã§ä¿è­·æ¸ˆã¿ï¼‰
- RLS ãƒãƒªã‚·ãƒ¼: `reward_exchanges` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ç®¡ç†è€…ã®ã¿èª­ã¿æ›¸ãå¯èƒ½ã«è¨­å®š

---

## 9. å®Ÿè£…é †åº

1. **å‹å®šç¾©ã®è¿½åŠ ** - `lib/types.ts`
2. **API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ**
   - `GET /api/reward-exchanges` - ä¸€è¦§å–å¾—
   - `POST /api/reward-exchanges/[id]/complete` - å®Œäº†å‡¦ç†
   - `POST /api/reward-exchanges/[id]/cancel` - ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
3. **ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ** - `app/admin/reward-exchanges/page.tsx`
4. **ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°** - `components/admin-header.tsx`
5. **ãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®äº¤æ›ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèª

---

## 10. LIFF ã‚¢ãƒ—ãƒªã¨ã®é€£æºä»•æ§˜

### 10-1. LIFFå´ã§å®Ÿè£…ã™ã¹ãå‡¦ç†

æ‚£è€…ãŒLIFFã‚¢ãƒ—ãƒªã§ã€Œã“ã®ç‰¹å…¸ã¨äº¤æ›ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ï¼š

```javascript
// ç‰¹å…¸äº¤æ›ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚
async function handleExchangeReward(rewardId, requiredStamps, rewardName) {
  const supabase = createClient();

  // reward_exchangesãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹ã ã‘
  const { data, error } = await supabase
    .from('reward_exchanges')
    .insert({
      user_id: lineUserId,           // LINE User ID
      reward_id: rewardId,            // ç‰¹å…¸IDï¼ˆUUIDï¼‰
      stamp_count_used: requiredStamps, // å¿…è¦ã‚¹ã‚¿ãƒ³ãƒ—æ•°ï¼ˆè¨˜éŒ²ç”¨ã®ã¿ï¼‰
      status: 'pending',              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¿…ãš 'pending'
      exchanged_at: new Date().toISOString(),
      notes: `ç‰¹å…¸äº¤æ›: ${rewardName}`, // ç‰¹å…¸åã‚’è¨˜éŒ²
    });

  // âš ï¸ é‡è¦: ã‚¹ã‚¿ãƒ³ãƒ—ã¯æ¸›ã‚‰ã—ã¾ã›ã‚“ï¼ˆç©ã¿ä¸Šã’å¼ã®ãŸã‚ï¼‰
  // profiles.stamp_count ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„

  if (!error) {
    alert('ç‰¹å…¸äº¤æ›ã‚’ç”³è«‹ã—ã¾ã—ãŸã€‚å—ä»˜ã§ãŠå—ã‘å–ã‚Šãã ã•ã„ã€‚');
  }
}
```

### 10-2. é‡è¦ãªé€£æºä»•æ§˜

| é …ç›® | ä»•æ§˜ |
|-----|-----|
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸå€¤** | å¿…ãš `'pending'`ï¼ˆæœªå¼•æ¸¡ï¼‰ã§ç™»éŒ² |
| **ã‚¹ã‚¿ãƒ³ãƒ—ã®æ‰±ã„** | äº¤æ›ã—ã¦ã‚‚**æ¸›ã‚‰ã•ãªã„**ï¼ˆç©ã¿ä¸Šã’å¼ï¼‰ |
| **stamp_count_used** | è¨˜éŒ²ç”¨ã®æ•°å€¤ï¼ˆå®Ÿéš›ã«ã¯æ¸›ç®—ã—ãªã„ï¼‰ |
| **ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚** | ã‚¹ã‚¿ãƒ³ãƒ—ã¯å…ƒã€…æ¸›ã£ã¦ã„ãªã„ã®ã§ä½•ã‚‚ã—ãªã„ |
| **å—ã‘å–ã‚Šæ–¹æ³•** | å—ä»˜ã§ç®¡ç†ç”»é¢ã‚’è¦‹ã¦æ‰‹æ¸¡ã— â†’ ã€Œâœ“å®Œäº†ã€ãƒœã‚¿ãƒ³ |

### 10-3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[æ‚£è€…] LIFF ã§äº¤æ›ç”³è«‹
  â†“
[DB] reward_exchanges ã« status='pending' ã§è¨˜éŒ²
[DB] profiles.stamp_count ã¯å¤‰æ›´ãªã—ï¼ˆç©ã¿ä¸Šã’å¼ï¼‰
  â†“
[å—ä»˜] ç®¡ç†ç”»é¢ã§ pending ä¸€è¦§ã‚’ç¢ºèª
[å—ä»˜] æ‚£è€…æ¥é™¢æ™‚ã«ç‰¹å…¸ã‚’æ¸¡ã—ã¦ã€Œâœ“å®Œäº†ã€ã‚¯ãƒªãƒƒã‚¯
  â†“
[DB] status='completed' ã«æ›´æ–°
```

---

## 11. å‚™è€ƒ

- å®Ÿè£…å®Œäº†æ—¥: 2026-02-14
- RLSãƒãƒªã‚·ãƒ¼è¨­å®šæ¸ˆã¿: `supabase/005_reward_exchanges_rls.sql`
- æ‚£è€…ãŒã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ã£ã¦ç‰¹å…¸ã‚’äº¤æ›ã™ã‚‹æ©Ÿèƒ½ï¼ˆLIFFå´ï¼‰ã¯æœªå®Ÿè£…ã®ãŸã‚ã€å°†æ¥çš„ã«é€£æºãŒå¿…è¦
- **ã‚¹ã‚¿ãƒ³ãƒ—ã¯ç©ã¿ä¸Šã’å¼**: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„å‰Šé™¤ã—ã¦ã‚‚ã‚¹ã‚¿ãƒ³ãƒ—ã¯æˆ»ã‚Šã¾ã›ã‚“

---

æœ€çµ‚æ›´æ–°: 2026-02-14
