# イベントログ設計（スタッフ操作ログ）

**作成日:** 2026-02-08  
**前提:** [22_スタッフごとアカウント仕様.md](22_スタッフごとアカウント仕様.md) が実装済みであること。セッションに **staff_id** が含まれており、各 API で「誰が」操作したかを取得できる。  
**目的:** どのスタッフが、いつ、どんな操作をしたかを記録し、後から**確認・監査**できるようにする。

---

## 0. 本ドキュメントのスコープ：スタッフ操作ログのみ

| 種類 | 目的 | 本ドキュメント |
|------|------|----------------|
| **スタッフ操作ログ** | 誰が・いつ・何をしたかの**監視・確認・監査**。`activity_logs`（staff_id 必須）。 | ✅ **対象** |
| **ユーザイベントログ** | 患者（LIFF利用者）の行動・利用状況の**データ分析**（将来）。別テーブル・別設計の想定。 | ❌ **対象外** |

- ユーザイベントログ（例: QRスキャン、画面表示、特典閲覧など）は、**分析用途**で要件・保持期間・集計方法が異なるため、別途設計することを推奨する。本ドキュメントでは **スタッフの操作ログ** のみを扱う。

---

## 1. 概要

- 管理画面での**書き込みを伴う操作**が成功した直後に、1 操作につき 1 件のログを `activity_logs` テーブルに INSERT する。
- ログには必ず **staff_id**（誰が）を含める。セッションから取得する。
- ログイン・ログアウトも「操作」として記録する。
- 初期スコープでは**一覧画面の実装は必須としない**。DB 上で確認できれば十分とし、必要になったら「操作履歴」画面を追加する。

---

## 2. データベース設計

### 2.1 テーブル: `activity_logs`

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| `id` | UUID | NO | gen_random_uuid() | 主キー |
| `staff_id` | UUID | **YES** | - | 操作したスタッフ（FK → staff.id）。**NULL = 従来の環境変数ログイン（admin）** |
| `action` | TEXT | NO | - | 操作種別（後述「3. 記録する操作一覧」） |
| `target_type` | TEXT | YES | - | 対象の種類（例: profile, reward_exchange, family） |
| `target_id` | TEXT | YES | - | 対象のID（例: 患者ID、特典交換ID） |
| `details` | JSONB | YES | - | 補足（任意）。例: { "delta": 1, "field": "stamp_count" } |
| `created_at` | TIMESTAMPTZ | NO | NOW() | 発生日時 |

**制約**

- PRIMARY KEY: `id`
- FOREIGN KEY: `staff_id` → `staff(id)` ON DELETE RESTRICT  
  - スタッフは [22_スタッフごとアカウント仕様](22_スタッフごとアカウント仕様.md) のとおり無効化（論理削除）のみとし、物理削除しない。`staff_id` は **NULL 許容**。NULL の場合は従来の環境変数（ADMIN_USER/ADMIN_PASSWORD）でログインした「admin」の操作として記録する。

**インデックス**

- `idx_activity_logs_staff_id` … スタッフごとの履歴取得
- `idx_activity_logs_created_at` … 日時順一覧・期間検索
- `idx_activity_logs_action` … 操作種別での絞り込み（必要に応じて）

**RLS**

- 管理画面用。開発段階では読み取り・挿入を許可するポリシー、またはサービスロールで挿入。**更新・削除は行わない**（追記のみ）。

### 2.2 マイグレーション

- `supabase/014_create_activity_logs_table.sql` … テーブル作成、インデックス、FK。staff_id は NULL 許容（従来 admin の操作も記録するため）。

---

## 3. 記録する操作一覧

以下の操作が**成功した直後**に 1 件ずつ記録する。失敗時は記録しない。

| action（推奨値） | 説明 | target_type | target_id | details 例 |
|------------------|------|-------------|-----------|------------|
| `login` | ログイン成功 | - | - | - |
| `logout` | ログアウト | - | - | - |
| `profile_update` | 患者情報の更新（PATCH /api/profiles/[id]） | profile | profiles.id | { "fields": ["ticket_number", "last_visit_date"] } |
| `stamp_increment` | スタンプ +1（PATCH /api/profiles/[id]/stamp） | profile | profiles.id | { "delta": 1 } |
| `stamp_set` | スタンプ直接設定（PATCH /api/profiles/[id]/stamp-set） | profile | profiles.id | { "value": 5 } |
| `message_send` | 個別メッセージ送信（POST /api/profiles/[id]/care-messages） | profile | profiles.id | - |
| `broadcast_send` | 一斉配信送信（POST /api/broadcast/send） | - | - | { "recipient_count": 10 } |
| `reward_exchange_complete` | 特典引き渡し完了（POST .../complete） | reward_exchange | reward_exchanges.id | - |
| `reward_exchange_cancel` | 特典交換キャンセル（POST .../cancel） | reward_exchange | reward_exchanges.id | - |
| `reward_exchange_delete` | 特典交換削除（DELETE .../delete） | reward_exchange | reward_exchanges.id | - |
| `family_create` | 家族作成（POST /api/families） | family | families.id | - |
| `family_update` | 家族更新（PATCH /api/families/[id]） | family | family_id | - |
| `family_delete` | 家族削除（DELETE /api/families/[id]） | family | family_id | - |
| `family_member_add` | 家族メンバー追加（POST .../members） | family | family_id | { "user_id": "..." } |
| `family_member_remove` | 家族メンバー解除（DELETE .../members/[user_id]） | family | family_id | { "user_id": "..." } |
| `staff_create` | スタッフ追加（POST /api/staff） | staff | staff.id | - |
| `staff_update` | スタッフ更新（PATCH /api/staff/[id]） | staff | staff.id | - |
| `staff_deactivate` | スタッフ無効化（PATCH .../deactivate） | staff | staff.id | - |

- `target_type` / `target_id` / `details` は、**後から「何を」を追いやすいように**入れておく。必須ではなく、取れない場合は null でよい。
- 新規 API を追加したときは、この一覧と「記録箇所」に追加する。

---

## 4. アプリ側の実装

### 4.1 ヘルパー: ログ記録

- **場所例:** `lib/activity-log.ts`（または `lib/audit.ts`）
- **役割:** Supabase に 1 件 INSERT するだけの関数を用意する。

**インターフェース例**

```ts
type LogAction = 
  | "login" | "logout"
  | "profile_update" | "stamp_increment" | "stamp_set" | "message_send"
  | "broadcast_send"
  | "reward_exchange_complete" | "reward_exchange_cancel" | "reward_exchange_delete"
  | "family_create" | "family_update" | "family_delete" | "family_member_add" | "family_member_remove"
  | "staff_create" | "staff_update" | "staff_deactivate";

async function logActivity(
  supabase: SupabaseClient,
  params: {
    staffId: string;
    action: LogAction;
    targetType?: string | null;
    targetId?: string | null;
    details?: Record<string, unknown> | null;
  }
): Promise<void>;
```

- 内部で `activity_logs` に INSERT。**失敗しても業務処理は止めない**（try/catch で握りつぶすか、ログだけ出力して続行）。監査用なので、ログ記録の 500 でスタンプ更新をロールバックする必要はない。

### 4.2 記録箇所（呼び出し）

- 各 API の**成功パスの最後**で、`getStaffIdFromRequest(request)` で staff_id を取得し、`logActivity(supabase, { staffId, action, ... })` を呼ぶ。
- **対象となる API（目安）:**

| API | 記録する action |
|-----|-----------------|
| POST /api/auth/login | login |
| POST /api/auth/logout | logout |
| PATCH /api/profiles/[id] | profile_update |
| PATCH /api/profiles/[id]/stamp | stamp_increment |
| PATCH /api/profiles/[id]/stamp-set | stamp_set |
| POST /api/profiles/[id]/care-messages | message_send |
| POST /api/broadcast/send | broadcast_send |
| POST /api/reward-exchanges/[id]/complete | reward_exchange_complete |
| POST /api/reward-exchanges/[id]/cancel | reward_exchange_cancel |
| DELETE /api/reward-exchanges/[id]/delete | reward_exchange_delete |
| POST /api/families | family_create |
| PATCH /api/families/[family_id] | family_update |
| DELETE /api/families/[family_id] | family_delete |
| POST /api/families/[family_id]/members | family_member_add |
| DELETE /api/families/[family_id]/members/[user_id] | family_member_remove |
| POST /api/staff | staff_create |
| PATCH /api/staff/[id] | staff_update |
| PATCH /api/staff/[id]/deactivate | staff_deactivate |

- GET（参照のみ）は原則記録しない。必要なら後から「重要な参照」だけ追加する。

### 4.3 従来の admin ログイン時

- 環境変数（ADMIN_USER/ADMIN_PASSWORD）でログインした場合はセッションに staff_id が入らない。この場合も **staff_id = NULL で logActivity を呼び、activity_logs に記録する**。NULL であることで「従来の admin」の操作と判別できる。一覧確認時は `staff_id IS NULL` で絞れば admin の操作だけを表示できる。

---

## 5. 運用・確認

- **確認方法:** Supabase の Table Editor や SQL で `activity_logs` を参照。`staff_id` で staff と JOIN すれば「誰が」が分かる。`staff_id IS NULL` の行は従来の環境変数ログイン（admin）の操作。
- **保持期間:** 無期限でもよいが、容量が気になる場合は「1年経過したログをアーカイブまたは削除」などのポリシーを後から検討する。
- **UI:** 管理ダッシュボードに「スタッフ操作ログ」タブを追加済み（`/admin/activity-logs`）。`GET /api/activity-logs` で取得し、日時・操作者・操作・対象・詳細を表形式で表示。将来的に「admin（環境変数ログイン）のみタブを表示する」仕様にすることも可能。

---

## 6. 関連ドキュメント

- [22_スタッフごとアカウント仕様.md](22_スタッフごとアカウント仕様.md) … スタッフテーブル・セッションに staff_id を含める仕様
- [Doc_スタッフアカウントとイベントログ検討.md](Doc_スタッフアカウントとイベントログ検討.md) … 方針検討
- [05_Database_Schema.md](05_Database_Schema.md) … 既存スキーマ（activity_logs 追加後はここに追記）
- **ユーザイベントログ** … データ分析用は別設計。必要になったら別ドキュメント（例: 25_ユーザイベントログ設計.md）でテーブル・送信元（LIFF等）・保持期間を定義する。

---

最終更新: 2026-02-08
