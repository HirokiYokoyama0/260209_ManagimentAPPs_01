# つくばホワイト歯科 管理ダッシュボード仕様書

## 1. 概要・コンセプト

**「現場での使いやすさ」と「将来のメッセージ拡張性」の両立**

- Next.js (TypeScript) + shadcn/ui で構築する、つくばホワイト歯科専用の管理画面。
- 患者（profiles）の一覧表示・スタンプ管理・個別メッセージ送信を一元的に扱い、将来的な LINE Messaging API 一斉送信にも対応できる土台を用意する。

---

## 2. 認証・セキュリティ

| 項目 | 仕様 |
|------|------|
| **認証方式** | 簡易認証（ログイン ID + パスワード）。デフォルトは `admin` / `admin`。 |
| **セッション** | 署名付き Cookie（`admin_session`）で保持。ミドルウェアで検証。 |
| **ルート保護** | `/admin` 配下は未認証時は `/admin/login` へリダイレクト。 |

### 実装のポイント

- 環境変数 `ADMIN_USER` / `ADMIN_PASSWORD` でログイン ID・パスワードを変更可能（未設定時は admin / admin）。
- `AUTH_SECRET` で Cookie 署名用シークレットを指定可能（本番では設定推奨）。

---

## 3. 患者一覧画面（メイン）

### 3.1 データソース・表示

- **データソース**: Supabase の `profiles` テーブル。
- **UI**: shadcn/ui の **DataTable** コンポーネントで一覧表示。
- **ローディング**: データ取得中は回転スピナーと「患者データを読み込んでいます...」を表示。

### 3.2 検索・フィルタ

| 機能 | 仕様 |
|------|------|
| **リアルタイム検索** | 名前または診察券番号で絞り込み（クライアント側） |
| **表示項目** | 氏名、診察券番号、スタンプ数、最終来院、最新ログイン、公式アカ友だち、表示モード、操作 |

### 3.3 ステータス表示

| 項目 | 表示方法 |
|------|----------|
| **スタンプ数** | `stamp_count` をバッジで表示 |
| **最終来院** | Supabase の `last_visit_date` を JST で表示（未設定は —） |
| **最新ログイン** | Supabase の `updated_at` を JST で表示 |
| **公式アカ友だち** | `is_line_friend` が true の場合「〇 済」、それ以外は「—」 |
| **表示モード** | スイッチで大人/キッズを切り替え |

### 3.4 編集可能項目

- **診察券番号**（`ticket_number`）と **最終来院日**（`last_visit_date`）は、各行の「編集」ボタンからダイアログで変更可能。保存時に `PATCH /api/profiles/[id]` で Supabase を更新する。
- **表示モード**（`view_mode`）は、スイッチで adult/kids を切り替え可能。

---

## 4. 個別操作（アクション）

リストの各行に、即座に操作できるボタンを配置。色・アイコンで識別しやすくしている。

### 4.1 編集（診察券番号・最終来院日・表示モード）

- **編集** ボタンでダイアログを開き、診察券番号・最終来院日・表示モードを入力して保存。`PATCH /api/profiles/[id]` で Supabase を更新。

### 4.2 スタンプのクイック修正

| 操作 | 仕様 |
|------|------|
| **-1 / +1** | クリックで DB を即時更新。SWR でキャッシュ更新。色分け（-1: ローズ系、+1: エメラルド系）。 |
| **数値** | Dialog で 0〜999 を直接入力して保存。 |

### 4.3 メッセージ送信

- **メッセージ** ボタン（インディゴ強調）で、右から **Sheet** をスライド表示。定型文＋自由入力で送信し、care_messages に保存（LINE 設定があれば push も送信）。

---

## 5. 個別メッセージ送信機能

LINE Messaging API 連携を視野に入れた仕様。

### 5.1 簡易テキスト送信

| 項目 | 内容 |
|------|------|
| **定型文** | 「お疲れ様でした」「次回予約は〇〇です」などのテンプレートを選択可能（将来拡張でテンプレート管理も検討） |
| **自由入力** | 定型文に加え、自由テキストを入力して送信 |

### 5.2 ケア記録の保存

- 送信した内容は DB に保存する。
- 患者側の「ケア記録」タブでも同じ内容を参照できるようにする（既存の LINE ミニアプリ仕様と整合）。

### 5.3 一斉送信（将来拡張）

- 特定の条件（例：スタンプ10個の人、最終来院が○ヶ月前の人）に一括でメッセージを送る **土台** を設計段階で考慮する。
- 条件指定UI・送信履歴・送信前確認ダイアログなどの要件を、フェーズ2で詳細化。

---

## 6. 分析画面

`/admin/analysis` で以下の情報を可視化。

| 項目 | 内容 |
|------|------|
| **スタンプ分布** | 0個、1-5個、6-10個、11個以上の人数を表示 |
| **公式アカ友だち率** | is_line_friend が true の割合 |
| **直近14日以内のログイン** | updated_at が直近14日以内の患者数 |

---

## 7. 技術スタック

| 役割 | 技術 | 理由 |
|------|------|------|
| **Framework** | Next.js 15 (App Router) | Vercel へのデプロイが容易で、API 構築も内包できる |
| **言語** | TypeScript | 型安全性により開発効率とバグ削減を実現 |
| **UI Library** | shadcn/ui + Tailwind CSS | 管理画面に必要な「表・ボタン・入力欄」が高品質で揃う |
| **アイコン** | Lucide React | シンプルで細身のスタイリッシュなアイコン |
| **Database** | Supabase (PostgreSQL) | 既に接続済みの `profiles` テーブルを活用 |
| **データ取得・キャッシュ** | SWR | スタンプ更新時など、画面をリロードせずに数値を反映 |
| **外部API** | LINE Messaging API | `pushMessage` により、管理者から患者へ能動的に通知 |

### 補足

- **Python/Flask** の経験があれば、Next.js の API Routes や Server Actions の考え方は転用しやすい。
- Cursor との相性も良く、型安全な TypeScript で開発しやすい。

---

## 8. 画面・ルート構成（案）

| パス | 説明 |
|------|------|
| `/admin/login` | 管理者ログイン |
| `/admin` | ダッシュボードトップ（患者一覧がメイン） |
| `/admin/analysis` | 分析画面 |
| `/admin/broadcast` | 一斉配信画面 |
| `/admin/reward-exchanges` | 特典交換履歴画面 |

※ 一覧と個別操作は同一画面内で完結する想定。

---

## 9. データ・API まわり

- **profiles**: `stamp_count`, `ticket_number`, `last_visit_date`, `updated_at`, `is_line_friend`, `view_mode` などを利用。診察券番号・最終来院日・表示モードは `PATCH /api/profiles/[id]` で更新。
- **care_messages**: 送信メッセージを保存。`supabase/002_create_care_messages_table.sql` で作成。RLS は SELECT/INSERT 許可。
- **LINE Messaging API**: .env.local の Channel ID/Secret または Access Token で pushMessage を実行。

---

## 10. 実装メモ・セットアップ

### 環境変数（.env.local）

- `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` … 既存の Supabase 接続用。
- **LINE Messaging API（プッシュ送信）**
  - `LINE_CHANNEL_ID` または `Channel_ID` … LINE チャネル ID
  - `LINE_CHANNEL_SECRET` または `Channel_secret` … LINE チャネルシークレット
  - 上記2つがあると、送信時に短期チャネルアクセストークンを取得して pushMessage を実行します。
  - オプション: `LINE_CHANNEL_ACCESS_TOKEN` を設定すると、こちらを優先して使用（長期トークンは LINE Developers コンソールで発行）。

### 認証（簡易）

- ログイン **ID**: `admin`、**パスワード**: `admin` でログイン（変更する場合は .env.local の `ADMIN_USER` / `ADMIN_PASSWORD` を設定）。
- 未認証で `/admin` にアクセスすると `/admin/login` にリダイレクトされる。

### ケア記録テーブル（care_messages）

- 個別メッセージを使う前に、Supabase SQL エディタで `supabase/002_create_care_messages_table.sql` を実行するだけ。追加のキー設定は不要。

### 起動

- `npm install` のあと `npm run dev` で開発サーバー起動。トップ `/` から「管理画面へ」で `/admin` に遷移（未認証時は `/admin/login` へ）。
- **遅い場合**: `npm run dev` は Turbopack 使用で軽量化済み。さらに速くしたいときは `npm run build` → `npm run start` で本番モード起動（初回ビルド後はレスポンスが速い）。

---

## 11. 今後の拡張候補・TODO

詳細は [99_変更履歴.md](99_変更履歴.md) を参照。

### Phase 2: 管理機能の拡充（短期）

#### すぐに実装すると便利な機能
- [ ] **CSV ダウンロード機能**
  - スタンプ分布データのエクスポート
  - 公式アカ友だち一覧のエクスポート
  - 患者一覧の全データエクスポート

- [ ] **公式アカ友だちフィルタトグル**
  - 友だち登録済みのみ表示
  - 未登録のみ表示
  - スタンプ数範囲指定（例: 5個以上 / 10個以上）

#### UI/UX の磨き込み
- [ ] **患者詳細パネル**
  - 患者一覧の行をクリックしたときに、右側に簡易プロフィールパネルを出す
  - 過去メッセージやスタンプ履歴のサマリを表示

- [ ] **モバイル対応の改善**
  - タブレット表示での見え方を調整
  - 列の折り返し、ボタンの並び最適化

### Phase 3: メッセージ機能の強化（中期）

- [ ] **メッセージテンプレート管理画面**
  - いまはコンポーネント内に定義している定型文を、DB（例: message_templates）で管理
  - 管理画面から「追加 / 編集 / 削除」ができるようにする

- [ ] **送信履歴の一覧**
  - `care_messages` を元に、「いつ誰にどんなメッセージを送ったか」を一覧・検索
  - 将来的には「分析画面」とも連動（どのメッセージが反応が良いか、など）

- [ ] **一斉送信の土台**
  - 条件指定の例:
    - スタンプ数◯個以上
    - 最終来院日が◯ヶ月以上前
    - 公式アカ友だちのみ
  - いきなり本番送信せず、まずは「対象者一覧のプレビュー」と「テスト送信（1人だけ）」を用意

### Phase 4: 分析機能の拡充（中期）

- [ ] **activity_logs テーブルの導入**
  - 「ログイン履歴テーブル（例: activity_logs）」を追加
  - 日次・2週間ごとの推移グラフを出す

- [ ] **分析項目の追加**
  - ログイン回数の推移（直近14日 / 2週間ごと）
  - ミニアプリ起動回数（LIFF 側と連携した場合）
  - 来院無し期間ごとの患者数（6ヶ月以上来ていない人、など）

### Phase 5: 認証・権限まわり（長期）

- [ ] **管理ユーザーの複数化**
  - いまは簡易認証（admin / パスワード）1パターンのみ
  - 将来的には「閲覧のみ」「スタンプ編集可」「メッセージ送信可」などのロール分け

- [ ] **ログイン履歴の保存**
  - `activity_logs` テーブルを導入し、管理画面ログイン成功時に `login` イベントを記録
  - これを使って「だれがどのくらいシステムを使っているか」を分析画面に反映

### Phase 6: パフォーマンス・運用（長期）

- [ ] **大量データ時のパフォーマンス**
  - 患者数が増えたときのために、ページネーションや無限スクロールを検討
  - API 側でのサーバーサイド検索・ソートの導入

- [ ] **本番運用時のログ・監視**
  - エラー時の通知（例: Vercel + Sentry）を検討
  - Supabase のログを使った不正アクセス検知（将来的な話）

---

*本仕様書は、Next.js + shadcn/ui による管理ダッシュボードの設計・実装の指針として利用する。*

---

最終更新: 2026-02-14
