# テスト用QRコード表示（管理ダッシュボード）

**作成日:** 2026-02-08  
**目的:** 来院時スタンプ付与のテスト用に、管理画面から2種類のQRコードを表示するタブを用意する。  
**関連:** [24_QRコード表示_LIFFアプリ開発者へ.md](24_QRコード表示_LIFFアプリ開発者へ.md)（LIFF側の読み取り・API連携仕様）

---

## 1. 概要

- 本番運用では、来院時に**院内に設置した実物のQRコード**を患者がLIFFアプリのカメラで読み取る想定。
- 開発・テスト時には実物QRを用意しにくいため、**管理ダッシュボードに「テスト用QRコード」を2つ表示するタブ**を設ける。
- スタッフが画面に表示したQRを、テスト端末のLIFFアプリで読み取り、スタンプ付与フローを確認できるようにする。

---

## 2. 表示する2種類のQRコード

**※ ポイント概念は廃止。スタンプは「個数」に統一。**

| ラベル | 用途 | 1回スキャンあたりの付与 | ペイロード |
|--------|------|-------------------------|------------|
| **優良患者様用** | 来院時スタンプ（優良） | **10スタンプ** | `{"type":"premium","stamps":10}` |
| **通常患者様用** | 来院時スタンプ（通常） | **5スタンプ** | `{"type":"regular","stamps":5}` |

- いずれも LIFF側がQRを読み取り、**読み取った `stamps` の値をスタンプ登録APIに渡す**想定。
- LIFF開発者向けの詳細は [24_QRコード表示_LIFFアプリ開発者へ.md](24_QRコード表示_LIFFアプリ開発者へ.md) を参照。

---

## 3. 画面・ルート

- **パス:** `/admin/qr` または `/admin/test-qr`（例）
- **タブ名（ナビ表示）:** 「テストQR」または「QRコード」
- 管理画面ヘッダーのナビにリンクを1本追加する。

---

## 4. 画面レイアウト案

- **タイトル:** 「テスト用QRコード」（サブタイトルで「LIFFアプリのカメラで読み取ってスタンプ付与をテストできます」など）
- **2つのブロックを横並び（PC）／縦並び（スマホ）**
  - 各ブロックに「ラベル」「QRコード画像」「付与スタンプ数（10／5）」「ペイロード確認用文字列」「注意（テスト用である旨）」を記載。
- **QRコードの内容（データ形式）**
  - `{"type":"premium","stamps":10}`（優良・10個/回）と `{"type":"regular","stamps":5}`（通常・5個/回）をそのまま文字列としてエンコードし、QRコード画像を生成する（実装: `app/admin/qr/page.tsx`）。
  - 管理画面側は「表示用の固定ペイロード」を持ち、QRコード生成ライブラリ（例: `qrcode` npm パッケージ）で画像または SVG を生成して表示する。

---

## 5. 技術メモ（実装側）

- **QRコード生成:** クライアントまたはサーバーで、所定の文字列をQRに変換。Node なら `qrcode` 等で Buffer/DataURL を生成し、`<img src={dataUrl} />` で表示する方法が簡単。
- **ペイロード:** テスト用のため固定値でよい。本番用QRは別途、トークンや有効期限を含める仕様を検討する。
- **認証:** この画面は管理画面のため、既存のログイン認証がかかっている前提。未ログインは `/admin/login` へリダイレクト。

---

## 6. 本番運用との違い

- **本番:** 院内に設置するQRは、同じペイロード形式でも「QRコードID」や有効期限・署名などを含め、不正利用を防ぐ設計を検討する。
- **テスト用:** 上記2種類の固定ペイロードで十分。LIFF側で「テスト用QR」と「本番用QR」を区別する必要がある場合は、ペイロードに `"env":"test"` などを含めてもよい（LIFF開発者向け doc と合わせる）。

---

## 7. 関連ドキュメント

- [24_QRコード表示_LIFFアプリ開発者へ.md](24_QRコード表示_LIFFアプリ開発者へ.md) … QR内容形式・スキャン後のAPI仕様
- [05_Database_Schema.md](05_Database_Schema.md) … `stamp_history` の `amount`・`stamp_method`・`qr_code_id`
- [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md) … 管理画面全体

---

最終更新: 2026-02-08
