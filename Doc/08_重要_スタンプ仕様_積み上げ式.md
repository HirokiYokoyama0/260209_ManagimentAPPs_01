# ⚠️ 重要: スタンプ仕様（積み上げ式）

**最終更新: 2026-02-14**

---

## 📌 このドキュメントの目的

このドキュメントは、**スタンプが積み上げ式である**という重要な仕様を明確に記録し、開発時の誤実装を防ぐために作成されました。

---

## 🎯 基本原則

### スタンプは「積み上げ式」である

```
✅ スタンプは常に増加する（加算のみ）
❌ スタンプは減少しない（減算しない）
```

この仕様は、ポイントカードの「累計スタンプ数」の概念に基づいています。

---

## 📊 積み上げ式 vs 消費式の違い

| 項目 | 積み上げ式（当プロジェクト） | 消費式（他のシステム例） |
|------|---------------------------|----------------------|
| **スタンプの性質** | 累計・記録用 | 消費可能なポイント |
| **特典交換時** | 減らさない | 減らす（消費する） |
| **キャンセル時** | 何もしない（元々減っていない） | スタンプを返却する |
| **データベースの動作** | `profiles.stamp_count` は加算のみ | `profiles.stamp_count` を増減 |
| **例** | 「累計100個達成！」 | 「残りポイント: 50pt」 |

---

## 🚫 絶対にやってはいけないこと

### ❌ 特典交換時にスタンプを減らす

```javascript
// ❌ 間違った実装例
async function handleExchangeReward(rewardId, requiredStamps) {
  // 特典交換記録を追加
  await supabase.from('reward_exchanges').insert({...});

  // ❌ これは絶対にやってはいけない！
  await supabase
    .from('profiles')
    .update({
      stamp_count: currentStampCount - requiredStamps  // ❌ 減算してはいけない
    })
    .eq('line_user_id', userId);
}
```

### ❌ キャンセル時にスタンプを返却する

```javascript
// ❌ 間違った実装例
async function handleCancelExchange(exchangeId, stampCountUsed) {
  // 交換記録をキャンセル状態に更新
  await supabase
    .from('reward_exchanges')
    .update({ status: 'cancelled' })
    .eq('id', exchangeId);

  // ❌ これは絶対にやってはいけない！
  await supabase
    .from('profiles')
    .update({
      stamp_count: currentStampCount + stampCountUsed  // ❌ 加算してはいけない
    })
    .eq('line_user_id', userId);
}
```

---

## ✅ 正しい実装方法

### ✅ 特典交換時の正しい実装

```javascript
// ✅ 正しい実装例（LIFFアプリ側）
async function handleExchangeReward(rewardId, requiredStamps, rewardName) {
  const supabase = createClient();

  // reward_exchangesテーブルに記録を追加するだけ
  const { data, error } = await supabase
    .from('reward_exchanges')
    .insert({
      user_id: lineUserId,
      reward_id: rewardId,
      stamp_count_used: requiredStamps, // 記録用の数値（実際には減算しない）
      status: 'pending',
      exchanged_at: new Date().toISOString(),
      notes: `特典交換: ${rewardName}`,
    });

  // ✅ 重要: profiles.stamp_count は一切変更しない

  if (error) {
    alert('交換申請に失敗しました');
    return;
  }

  alert('特典交換を申請しました！\nスタッフに「この画面」をお見せください。');
}
```

### ✅ キャンセル時の正しい実装

```javascript
// ✅ 正しい実装例（管理ダッシュボード側）
async function handleCancel(id: string) {
  const confirmed = confirm(
    "キャンセルしますか？（スタンプは返却されません）"
  );

  if (!confirmed) return;

  // 交換記録のステータスを変更するだけ
  const response = await fetch(`/api/reward-exchanges/${id}/cancel`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ notes: "管理者によるキャンセル" }),
  });

  // ✅ 重要: スタンプは元々減っていないので、何もしない
}
```

---

## 📝 データベースのフィールド説明

### `reward_exchanges.stamp_count_used` フィールドの意味

| 項目 | 説明 |
|------|------|
| **名称** | `stamp_count_used` |
| **データ型** | `INTEGER NOT NULL` |
| **意味** | この特典交換に「使用するはずだった」スタンプ数（記録用） |
| **実際の動作** | **profiles.stamp_count は減算しない** |
| **用途** | 履歴の記録・分析用 |

**重要**: `stamp_count_used` という名前は「使用済み」を意味しますが、実際には**スタンプを減らす処理は実行しません**。これは記録用の数値です。

---

## 🔧 スタンプが変更される唯一のケース

スタンプが増加する（加算される）ケースは以下のみです:

### 1. 来院時にスタンプを付与（通常操作）

```typescript
// app/api/profiles/[id]/stamps/route.ts
await supabase.rpc('increment_stamp_count', {
  target_user_id: profile.id,
  increment_value: 1  // +1加算
});
```

### 2. 緊急操作用API（管理者のみ）

```typescript
// app/api/profiles/[id]/stamps/adjust/route.ts
// ⚠️ これは緊急操作用（+1/-1の増減処理）
// 例: 誤って付与してしまったスタンプの修正など
await supabase.rpc('increment_stamp_count', {
  target_user_id: profile.id,
  increment_value: adjustment  // +1 or -1
});
```

**注意**: 緊急操作APIでの減算（-1）は、誤操作の修正など特別な場合にのみ使用します。**特典交換とは無関係**です。

---

## 🎓 なぜ積み上げ式なのか？

### 理由1: 達成感の提供

- 「累計100個達成！」のような達成感を提供
- スタンプが減ると達成感が損なわれる

### 理由2: シンプルな履歴管理

- スタンプ数は常に増加するため、履歴がシンプル
- 「いつ何個目のスタンプを獲得したか」が明確

### 理由3: データ整合性

- 減算処理がないため、データの不整合が発生しにくい
- トランザクション管理が不要

---

## 📋 チェックリスト（開発者向け）

新機能を実装する際は、以下をチェックしてください:

- [ ] スタンプを減らす処理（`stamp_count - X`）を書いていないか？
- [ ] キャンセル時にスタンプを返却する処理を書いていないか？
- [ ] 特典交換時に `profiles.stamp_count` を更新していないか？
- [ ] ユーザー向けメッセージに「スタンプを使用」「スタンプを消費」などの誤解を招く表現がないか？

---

## 🚨 過去の実装ミス事例

### 事例: LIFFアプリ統合ドキュメントでの誤り（2026-02-14）

**誤った記載内容**:
```javascript
// 特典交換時にスタンプを減らす（❌ 間違い）
await supabase.from('profiles')
  .update({ stamp_count: currentStampCount - requiredStamps })
  .eq('line_user_id', userId);
```

**問題点**:
- 積み上げ式の仕様を理解せず、消費式の実装を提案
- LIFF開発者に誤った実装方法を伝えるところだった

**教訓**:
- **「特典交換 = スタンプ減算」という先入観を持たない**
- 仕様書を必ず確認する
- わからない場合は質問する

---

## 📚 関連ドキュメント

- [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md) - スタンプ機能の概要
- [07_特典交換履歴機能仕様書.md](07_特典交換履歴機能仕様書.md) - 特典交換機能の詳細仕様
- [00_ファイル構成.md](00_ファイル構成.md) - スタンプ関連APIの場所

---

## 🔍 まとめ

| 項目 | 内容 |
|------|------|
| **スタンプの性質** | 積み上げ式（累計） |
| **特典交換時** | スタンプは減らさない |
| **キャンセル時** | スタンプは返却しない（元々減っていない） |
| **stamp_count_used** | 記録用の数値（実際の減算は行わない） |
| **スタンプが変わるとき** | 来院時の付与・緊急操作のみ |

---

**⚠️ この仕様を変更する場合は、プロジェクト全体に影響するため、必ず関係者全員で協議してください。**

---

最終更新: 2026-02-14
