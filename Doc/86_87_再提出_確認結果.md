# 86・87 再提出ドキュメント 確認結果

**確認日:** 2026-02-26  
**対象:** 86_アンケート機能仕様検討_ダッシュボード側.md / 87_アンケート機能_懸念点対応方針.md

---

## 1. 対応済み・整合している点

87 の対応方針に沿って、86 が以下のように修正されていることを確認した。

| 項目 | 86の状態 | 87との整合 |
|------|----------|------------|
| **全員配信** | `from profiles` のみ（is_active なし）、コメントで「is_active カラムは存在しないため条件なし」 | ✅ 一致 |
| **スタンプ数条件** | `stamp_count >= 50`（複数形なし）、コメントで「★ stamp_count」 | ✅ 一致 |
| **最終来院日** | `last_visit_date` 使用、不要な JOIN を避ける旨のコメント | ✅ 一致 |
| **年齢フィルタ** | API例でコメントアウト、「Phase 1では未実装」と明記 | ✅ 一致 |
| **ビュー survey_target_status** | `p.display_name`（line_display_name ではない旨のコメントあり） | ✅ 一致 |
| **配信対象者API** | `createServerSupabaseAdminClient` 使用、is_active/age を使わない | ✅ 方針どおり |
| **「あとで」** | `increment_survey_postponed` RPC 使用 | ✅ 87の修正案Bと一致 |
| **ユースケース 9.2** | `stamp_count >= 100`（10個 = 100pt） | ✅ 一致 |
| **ユースケース 9.3** | `last_visit_date` のみで抽出、JOIN なし | ✅ 一致 |

87 の「017_create_survey_tables.sql」案も、`surveys` / `survey_answers` / `survey_targets` / ビュー / RPC が 05 スキーマや既存方針と矛盾しない内容になっている。

---

## 2. 残っている不整合・要修正

### 2.1 ダッシュボード用 Supabase クライアントの関数名

- **86・87 の記載:** `createServerSupabaseAdminClient` を import して使用。
- **実コード（本プロジェクト）:** `lib/supabase/server-admin.ts` が export しているのは **`createSupabaseAdminClient`** のみ。`createServerSupabaseAdminClient` は存在しない。

**対応:** 86 の API 例および 87 の「修正案」で、  
**`createServerSupabaseAdminClient` → `createSupabaseAdminClient`** に読み替えるか、Doc を修正する。

---

### 2.2 LIFF 側の「現在ユーザー」取得方法と 87 の認証方針

- **86（6.3 LIFFアプリ側の実装）:**  
  `supabase.auth.getSession()` でセッション取得 → `session.user.id` を `line_user_id` として profiles を検索 → `profile.id` を使用。
- **87（3.1）:**  
  「LIFF: LINEログインのみ / anon key / auth.uid() NULL」と明記し、**auth.uid() は使わない**方針。

このままだと、**Supabase Auth を LIFF で使っていない**構成では `getSession()` が常に null になり、アンケート表示チェックが動かない。

**取りうる解釈:**

- **A)** LIFF では Supabase Auth を導入する（LINE を IdP にしたカスタム認証など）。  
  → その前提なら 86 の `getSession()` は妥当。87 に「LIFF では Supabase Auth を利用する」と追記するとよい。
- **B)** LIFF では Supabase Auth を使わず、LINE のユーザーID だけで `profile.id` を決める。  
  → 86 の例は誤り。`liff.getProfile().userId`（または LIFF から渡される LINE user id）で、  
  - 自前 API に LINE user id を渡して `profile.id` を取得する、または  
  - anon で `profiles` を `line_user_id = lineUserId` で検索して `id` を取得する  
  といった流れに 86 を書き換える必要がある。

**対応:** 87 の「認証方式」と 86 の「LIFF で誰を current user とするか」を一致させる。  
- Supabase Auth を使うなら 87 にその旨を追記。  
- 使わないなら 86 の LIFF 例を「LINE user id → profile.id 取得」に合わせて修正する。

---

### 2.3 86 のファイルパス表記（軽微）

- **86（6.1）:** 依然として `dashboard/app/surveys/...` と表記。
- **87:** 「実際のパスは `app/admin/surveys/...`。読み替え（修正不要）」としている。

実装時は読み替えで足りるが、86 側に「本プロジェクトでは `app/admin/surveys/` に相当する」と一文あると、後から見る人に分かりやすい。

---

## 3. 残っている懸念点（要確認・合意）

### 3.1 RLS を「using (true)」にした場合のリスク

87 では、`survey_targets` / `survey_answers` を anon で「using (true)」にし、**アプリ層で user_id を絞る**方針。

- **懸念:** anon キーが漏れた場合、**全ユーザーの survey_targets / survey_answers が読まれたり書き換えられたりする**可能性がある。
- **現状の他テーブル:** profiles 等も開発段階では RLS を緩くしている想定であり、運用は「anon を漏らさない」「必要なら後から RLS を厳格化」で揃えている。
- **推奨:** Phase 1 では 87 の方針のまま進め、**本番化時に「自分の user_id のみ」に制限する RLS や、service_role のみで操作する API 経由に寄せる**ことを 87 の「Phase 2 以降」に一言書いておくとよい。

---

### 3.2 ビュー `survey_target_status` の ORDER BY

- 87 の 017 案では、ビュー定義内で `order by st.created_at desc` を指定している。
- PostgreSQL では、ビューに ORDER BY を書いても、**そのビューを SELECT する際の結果順序は保証されない**（仕様上は「最適化で無視してよい」とされている）。
- 86 の list API では `.order('created_at', { ascending: false })` を再度指定しているため、**実装上は問題ない**。  
  ドキュメント上「ビューで並び順を保証する」と書かないようにするか、「並び順は API の ORDER BY で指定すること」と 86/87 に注記するとよい。

---

### 3.3 017 の surveys テーブルに updated_at がない

- 87 の 017 では `surveys` に `created_at` のみで、`updated_at` はない。
- アンケート定義を「下書き→公開」のように更新する運用があるなら、`updated_at` があると履歴管理しやすい。
- **対応:** Phase 1 でアンケート定義の更新がなければそのままでよい。更新機能を入れるタイミングで `surveys.updated_at` 追加を検討する、と 87 に一文あるとよい。

---

## 4. まとめ

| 種別 | 内容 | 推奨アクション |
|------|------|----------------|
| **要修正** | クライアント名 `createServerSupabaseAdminClient` → 実装は `createSupabaseAdminClient` | 86/87 の記述を `createSupabaseAdminClient` に合わせる |
| **要合意** | LIFF で Supabase Auth を使うか否か | 使うなら 87 に明記；使わないなら 86 の LIFF 例を「LINE user id → profile.id」に書き換え |
| **軽微** | 86 のパス表記が `dashboard/app/` のまま | 必要なら「本プロジェクトでは app/admin/ に読み替え」を 86 に追記 |
| **運用・将来** | RLS 緩和のリスク、ビュー ORDER BY、surveys.updated_at | 87 に上記の注記・Phase 2 での見直しを追記 |

以上を反映したうえで、86・87 は実装に進めてよい内容になっている。  
**実装時は必ず `createSupabaseAdminClient` を使用すること。**
