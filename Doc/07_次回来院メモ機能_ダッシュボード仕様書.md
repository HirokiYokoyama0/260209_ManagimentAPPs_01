# 次回来院メモ機能 - ダッシュボード仕様書

**作成日**: 2026-02-14
**対象**: Phase 2（管理機能の拡充）
**関連文書**: [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md)

---

## 1. 概要

管理画面の患者一覧から「次回来院予定日」と「次回来院時のメモ」を設定・編集できる機能を追加します。

### 背景
- スタッフが次回来院予定日と患者向けメッセージを設定できるようにする
- 患者のLINEミニアプリホーム画面に表示される
- 例: 「次回来院予定日: 2026年4月13日」「メッセージ: 次回は歯石除去を行います」

---

## 2. UI/UX設計

### 2.1 設計方針

**✅ 採用案: 既存の「編集」ダイアログに統合（Option A）**

理由:
- 患者情報編集とメモ編集は同じ操作文脈
- ボタンを増やさない（UIシンプル化）
- 既存のProfileEditDialogを拡張

### 2.2 ダイアログレイアウト（幅広対応版）

#### PC表示（1024px以上）: 横幅を拡張

```
┌────────────────────────────────────────────────────────────────┐
│ 患者情報を編集                                         [×]      │
├────────────────────────────────────────────────────────────────┤
│                                                                  │
│ ┌─ 基本情報 ─────────────────────────────────────────┐        │
│ │                                                       │        │
│ │ 診察券番号                  最終来院日               │        │
│ │ [12345            ]         [2026-02-14      ]       │        │
│ │                                                       │        │
│ │ 表示モード                                            │        │
│ │ [▼ 大人            ]                                 │        │
│ └───────────────────────────────────────────────────┘        │
│                                                                  │
│ ┌─ 次回来院予定 ─────────────────────────────────────┐        │
│ │                                                       │        │
│ │ 次回来院予定日                                        │        │
│ │ [2026-04-13        ] ⚠️ 過去の日付です              │        │
│ │                                                       │        │
│ │ 次回メモ                                             │        │
│ │ ┌─────────────────────────────────────┐          │        │
│ │ │ 次回は歯石除去を行います。よろしくお願い │          │        │
│ │ │ します。                                │ 48/200文字│        │
│ │ └─────────────────────────────────────┘          │        │
│ │                                                       │        │
│ │ 📱 患者側プレビュー                                   │        │
│ │ ┌───────────────────────────────┐                │        │
│ │ │ 次回来院予定: 2026年4月13日          │                │        │
│ │ │ 次回は歯石除去を行います。よろしく   │                │        │
│ │ │ お願いします。                       │                │        │
│ │ └───────────────────────────────┘                │        │
│ └───────────────────────────────────────────────────┘        │
│                                                                  │
│                                   [キャンセル]  [保存]          │
└────────────────────────────────────────────────────────────────┘
```

#### スマホ表示（1024px未満）: 縦スクロール対応

```
┌────────────────────────────┐
│ 患者情報を編集       [×]  │
├────────────────────────────┤
│ ─ 基本情報 ──────────     │
│                             │
│ 診察券番号                  │
│ [12345              ]       │
│                             │
│ 最終来院日                  │
│ [2026-02-14         ]       │
│                             │
│ 表示モード                  │
│ [▼ 大人             ]      │
│                             │
│ ─ 次回来院予定 ──────     │
│                             │
│ 次回来院予定日              │
│ [2026-04-13         ]       │
│ ⚠️ 過去の日付です          │
│                             │
│ 次回メモ                    │
│ ┌───────────────────┐     │
│ │ 次回は歯石除去を行   │     │
│ │ います。よろしくお願 │     │
│ │ いします。           │     │
│ │                      │     │
│ │               48/200 │     │
│ └───────────────────┘     │
│                             │
│ 📱 プレビュー               │
│ ┌─────────────────┐       │
│ │ 次回来院予定:        │       │
│ │ 2026年4月13日        │       │
│ │ 次回は歯石除去を行い │       │
│ │ ます。よろしくお願い │       │
│ │ します。             │       │
│ └─────────────────┘       │
│                             │
│   [キャンセル]  [保存]     │
└────────────────────────────┘
```

### 2.3 デザイン改善ポイント

#### ✅ ダイアログ幅の拡張
```tsx
// 変更前
<DialogContent className="max-w-md">

// 変更後（PC: 広め、スマホ: フル幅）
<DialogContent className="max-w-md sm:max-w-2xl">
```

#### ✅ 2カラムレイアウト（PC）
```tsx
<div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
  <div>
    <Label>診察券番号</Label>
    <Input ... />
  </div>
  <div>
    <Label>最終来院日</Label>
    <Input type="date" ... />
  </div>
</div>
```

#### ✅ セクション区切り
```tsx
<Separator className="my-6" />
<h3 className="text-sm font-semibold text-slate-700 mb-4">
  次回来院予定
</h3>
```

#### ✅ コンパクトなボタン配置
```tsx
<DialogFooter className="flex-row justify-end gap-2">
  <Button variant="outline" size="sm">キャンセル</Button>
  <Button size="sm">保存</Button>
</DialogFooter>
```

#### ✅ 文字数カウンター（右下配置）
```tsx
<div className="relative">
  <Textarea
    maxLength={200}
    rows={4}
    className="resize-none pr-16"
  />
  <span className="absolute bottom-2 right-2 text-xs text-slate-400">
    {memoText.length}/200
  </span>
</div>
```

#### ✅ プレビューのコンパクト化
```tsx
<div className="rounded-lg bg-slate-50 p-3 text-sm">
  <div className="mb-1 flex items-center gap-1 text-xs text-slate-500">
    <span className="inline-block h-4 w-4">📱</span>
    患者側プレビュー
  </div>
  <div className="text-slate-700">
    {previewContent}
  </div>
</div>
```

---

## 3. フィールド仕様

### 3.1 次回来院予定日（`next_visit_date`）

| 項目 | 内容 |
|------|------|
| 型 | `date` (HTML input type="date") |
| 必須 | 任意 |
| デフォルト | 空欄 |
| バリデーション | 過去日付は警告表示のみ（送信は可能） |
| 表示形式（患者側） | `2026年4月13日` |

#### 過去日付の警告
```tsx
{isPastDate(nextVisitDate) && (
  <div className="flex items-center gap-1 text-xs text-amber-600">
    <AlertCircle className="h-3 w-3" />
    過去の日付が設定されています
  </div>
)}
```

### 3.2 次回メモ（`next_memo`）

| 項目 | 内容 |
|------|------|
| 型 | `textarea` |
| 必須 | 任意 |
| 最大文字数 | 200文字 |
| 行数 | 4行（固定高さ） |
| バリデーション | 200文字超過時にエラー表示 |
| プレースホルダー | `次回来院時のメッセージを入力（例: 歯石除去を行います）` |

#### 文字数超過時のエラー表示
```tsx
{memoText.length > 200 && (
  <p className="text-xs text-red-600">
    200文字を超えています（現在: {memoText.length}文字）
  </p>
)}
```

### 3.3 更新日時（`next_memo_updated_at`）

- 自動更新（データベーストリガー）
- UI上は表示しない
- API応答には含める

---

## 4. バリデーション

### 4.1 フロントエンド（リアルタイム）

```tsx
// 文字数チェック
const [memoText, setMemoText] = useState("");
const isValid = memoText.length <= 200;

// 過去日付チェック（警告のみ）
const isPastDate = (dateStr: string | null): boolean => {
  if (!dateStr) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(dateStr + 'T00:00:00');
  return target < today;
};
```

### 4.2 API（送信時）

```typescript
// app/api/profiles/[id]/route.ts

if (next_memo && next_memo.length > 200) {
  return NextResponse.json(
    { error: "メッセージは200文字以内で入力してください" },
    { status: 400 }
  );
}
```

---

## 5. プレビュー機能

### 5.1 表示内容

患者のLINEミニアプリで表示される形式をリアルタイムプレビュー:

```tsx
const formatVisitDate = (dateStr: string | null): string | null => {
  if (!dateStr) return null;
  const [year, month, day] = dateStr.split('-').map(Number);
  return `${year}年${month}月${day}日`;
};

const previewContent = (
  <>
    {nextVisitDate && (
      <div className="mb-2 font-semibold">
        次回来院予定: {formatVisitDate(nextVisitDate)}
      </div>
    )}
    {nextMemo && (
      <div className="whitespace-pre-wrap">{nextMemo}</div>
    )}
    {!nextVisitDate && !nextMemo && (
      <span className="text-slate-400">
        日付またはメモを入力すると、ここにプレビューが表示されます
      </span>
    )}
  </>
);
```

### 5.2 プレビューのスタイル

```tsx
<div className="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
  <div className="mb-2 flex items-center gap-1.5 text-xs font-medium text-slate-500">
    <span>📱</span>
    患者側プレビュー
  </div>
  <div className="text-slate-700">
    {previewContent}
  </div>
</div>
```

---

## 6. データフロー

### 6.1 読み込み

```
患者一覧画面
  ↓ SWR fetch
  ↓ GET /api/profiles
  ↓
Supabase profiles テーブル
  ↓ 返却
  ↓ { id, name, ..., next_visit_date, next_memo }
  ↓
ProfileEditDialog に表示
```

### 6.2 保存

```
ProfileEditDialog
  ↓ フォーム送信
  ↓ PATCH /api/profiles/[id]
  ↓ { next_visit_date, next_memo }
  ↓
API でバリデーション
  ↓
Supabase UPDATE
  ↓ トリガー発火: next_memo_updated_at = NOW()
  ↓
SWR mutate でキャッシュ更新
  ↓
患者一覧に即座に反映
```

---

## 7. API設計

### 7.1 既存エンドポイントの拡張

**エンドポイント**: `PATCH /api/profiles/[id]`

#### リクエスト例
```json
{
  "ticket_number": "12345",
  "last_visit_date": "2026-02-14",
  "view_mode": "adult",
  "next_visit_date": "2026-04-13",
  "next_memo": "次回は歯石除去を行います。よろしくお願いします。"
}
```

#### レスポンス例
```json
{
  "success": true,
  "profile": {
    "id": "abc123",
    "display_name": "田中太郎",
    "ticket_number": "12345",
    "last_visit_date": "2026-02-14",
    "view_mode": "adult",
    "next_visit_date": "2026-04-13",
    "next_memo": "次回は歯石除去を行います。よろしくお願いします。",
    "next_memo_updated_at": "2026-02-14T10:30:00Z"
  }
}
```

#### エラーレスポンス例
```json
{
  "error": "メッセージは200文字以内で入力してください"
}
```

---

## 8. コンポーネント設計

### 8.1 変更対象ファイル

| ファイル | 変更内容 | 行数 |
|----------|----------|------|
| `components/admin/patients-table.tsx` | ProfileEditDialog を拡張 | +100行 |
| `lib/types.ts` | Profile 型に3フィールド追加 | +3行 |
| `app/api/profiles/[id]/route.ts` | バリデーション追加 | +20行 |
| `lib/memo.ts` | 日付フォーマット・バリデーション関数 | +30行（新規） |

### 8.2 新規ユーティリティ（`lib/memo.ts`）

```typescript
/**
 * 日付文字列を「YYYY年MM月DD日」形式に変換
 * タイムゾーンの影響を受けないよう、文字列分割を使用
 */
export function formatVisitDate(dateString: string | null): string | null {
  if (!dateString) return null;
  const [year, month, day] = dateString.split('-').map(Number);
  return `${year}年${month}月${day}日`;
}

/**
 * 指定日が過去かどうかを判定
 */
export function isPastDate(dateString: string | null): boolean {
  if (!dateString) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(dateString + 'T00:00:00');
  return target < today;
}

/**
 * 次回メモが200文字以内かを判定
 */
export function isValidMemoLength(memo: string | null): boolean {
  if (!memo) return true;
  return memo.length <= 200;
}
```

---

## 9. 実装優先順位

### Phase 1（MVP: 最小実装）

- [x] データベーススキーマ追加（`next_visit_date`, `next_memo`, `next_memo_updated_at`）
- [ ] `lib/types.ts` の Profile 型拡張
- [ ] `lib/memo.ts` 作成（日付フォーマット・バリデーション関数）
- [ ] `app/api/profiles/[id]/route.ts` の拡張
- [ ] `components/admin/patients-table.tsx` の ProfileEditDialog 拡張
  - [ ] 2カラムレイアウト実装
  - [ ] ダイアログ幅拡張（`max-w-2xl`）
  - [ ] 次回来院予定日フィールド追加
  - [ ] 次回メモフィールド追加（文字数カウンター付き）
  - [ ] 過去日付警告表示
  - [ ] プレビュー機能実装

### Phase 2（拡張機能）

- [ ] 患者一覧テーブルに「次回来院予定日」列を追加
- [ ] 日付でソート機能追加
- [ ] メッセージ内変数置換機能（`{name}`, `{stamp_count}` など）
- [ ] 過去日付の一括クリア機能
- [ ] 次回来院予定の一括通知機能

---

## 10. テストシナリオ

### 10.1 正常系

1. ✅ 次回来院予定日のみ設定 → 保存成功
2. ✅ 次回メモのみ設定 → 保存成功
3. ✅ 両方設定 → 保存成功
4. ✅ 両方空欄（削除） → 保存成功
5. ✅ プレビューがリアルタイム更新される

### 10.2 準正常系

6. ⚠️ 過去日付を設定 → 警告表示されるが保存可能
7. ⚠️ 200文字ちょうど → 保存成功
8. ⚠️ 改行を含むメモ → プレビューで改行が表示される

### 10.3 異常系

9. ❌ 201文字のメモ → フロントエンド・APIでエラー
10. ❌ 不正な日付形式 → HTML5バリデーションでブロック

---

## 11. 既知の制約事項

### 技術的制約

- **ダイアログ幅**: スマホでは縦スクロールが必要になる場合がある
- **プレビュー精度**: LINEミニアプリ側のCSSと完全一致しない可能性
- **トリガー依存**: `next_memo_updated_at` の自動更新はデータベーストリガーに依存

### 運用上の制約

- **過去日付の許容**: フロントエンド警告のみで、保存は可能
- **データベース制約なし**: CHECK制約を設けないため、運用柔軟性を優先
- **複数管理者**: 同時編集時の競合は未対応（last-write-winsモデル）

---

## 12. 参考資料

- [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md) - 全体仕様
- [00_ファイル構成.md](00_ファイル構成.md) - プロジェクト構造
- [99_変更履歴.md](99_変更履歴.md) - 実装進捗

---

最終更新: 2026-02-14
