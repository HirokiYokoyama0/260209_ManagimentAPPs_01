# 87_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½_æ‡¸å¿µç‚¹å¯¾å¿œæ–¹é‡

**ä½œæˆæ—¥:** 2026-02-26
**ç›®çš„:** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–‹ç™ºè€…ã‹ã‚‰æŒ‡æ‘˜ã•ã‚ŒãŸ86ä»•æ§˜æ›¸ã®ä¸æ•´åˆãƒ»æ‡¸å¿µç‚¹ã«å¯¾ã™ã‚‹å…¬å¼å¯¾å¿œæ–¹é‡

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- [85_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨.md](85_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨.md) - LIFFå´ä»•æ§˜
- [86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨_ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´.md](86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨_ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´.md) - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ä»•æ§˜
- [86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½_ä¸æ•´åˆãƒ»æ‡¸å¿µç‚¹ä¸€è¦§.md](86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½_ä¸æ•´åˆãƒ»æ‡¸å¿µç‚¹ä¸€è¦§.md) - é–‹ç™ºè€…ã‹ã‚‰ã®æŒ‡æ‘˜

---

## ğŸ“‹ ç›®æ¬¡

1. [å¯¾å¿œæ–¹é‡ã‚µãƒãƒªãƒ¼](#1-å¯¾å¿œæ–¹é‡ã‚µãƒãƒªãƒ¼)
2. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚¹ã‚­ãƒ¼ãƒé–¢é€£](#2-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒé–¢é€£)
3. [èªè¨¼ãƒ»RLSé–¢é€£](#3-èªè¨¼rlsé–¢é€£)
4. [å®Ÿè£…ã‚³ãƒ¼ãƒ‰é–¢é€£](#4-å®Ÿè£…ã‚³ãƒ¼ãƒ‰é–¢é€£)
5. [ãã®ä»–ã®èª¿æ•´](#5-ãã®ä»–ã®èª¿æ•´)
6. [ä¿®æ­£ç‰ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#6-ä¿®æ­£ç‰ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#7-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## 1. å¯¾å¿œæ–¹é‡ã‚µãƒãƒªãƒ¼

### 1.1 ç·Šæ€¥åº¦åˆ¥åˆ†é¡

| å„ªå…ˆåº¦ | é …ç›® | å¯¾å¿œæ–¹é‡ | æ‹…å½“ |
|--------|------|---------|------|
| ğŸ”´ **Critical** | ã‚«ãƒ©ãƒ åã®ä¸ä¸€è‡´ï¼ˆ`stamp_count`, `display_name`ï¼‰ | **85/86ã‚’ä¿®æ­£**ï¼ˆç¾çŠ¶ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ã‚‹ï¼‰ | LIFFæ‹…å½“ |
| ğŸ”´ **Critical** | RLSãƒ»èªè¨¼æ–¹å¼ã®ä¸æ•´åˆ | **æ–¹é‡ã‚’ç¢ºå®š**ï¼ˆauth.uid()ã‚’ä½¿ã‚ãªã„ï¼‰ | è¦å”è­° |
| ğŸŸ¡ **High** | `is_active`, `age` ã®å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ  | **ä½¿ã‚ãªã„æ–¹å‘ã§ä¿®æ­£** | LIFFæ‹…å½“ |
| ğŸŸ¡ **High** | æœ€çµ‚æ¥é™¢æ—¥ã®æ¡ä»¶ï¼ˆ`created_at` vs `visit_date`ï¼‰ | **`last_visit_date` / `visit_date` ã«çµ±ä¸€** | LIFFæ‹…å½“ |
| ğŸŸ¢ **Medium** | `postponed_count` ã®æ›´æ–°æ–¹æ³• | **æ­£ã—ã„å®Ÿè£…ã«ä¿®æ­£** | LIFFæ‹…å½“ |
| ğŸŸ¢ **Medium** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ | **`app/admin/`ã«èª­ã¿æ›¿ãˆ** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹…å½“ |
| ğŸ”µ **Low** | LINEé…ä¿¡ã¨æ—¢å­˜ä¸€æ–‰é…ä¿¡ã®çµ±åˆ | **Phase 2ä»¥é™ã§æ¤œè¨** | ä¸¡è€… |

### 1.2 åŸºæœ¬æ–¹é‡

âœ… **ç¾çŠ¶ã®ã‚¹ã‚­ãƒ¼ãƒï¼ˆ05_Database_Schema.mdï¼‰ã‚’å„ªå…ˆ**
- 85/86ã®ä»•æ§˜æ›¸ã‚’ç¾çŠ¶ã«åˆã‚ã›ã¦ä¿®æ­£
- æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã¯æœ€å°é™ã«

âœ… **èªè¨¼æ–¹å¼ã¯ç¾çŠ¶ã® simple-auth + RLSç·©å’Œ ã‚’ç¶­æŒ**
- `auth.uid()` ä¾å­˜ã®RLSã¯ä½¿ã‚ãªã„
- ã‚¢ãƒ—ãƒªå±¤ã§ user_id ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ã‚’æ‹…ä¿

âœ… **æ®µéšçš„å®Ÿè£…ã‚’æ¨å¥¨**
- Phase 1: å›ºå®šè³ªå•ï¼ˆq1, q2, q3ï¼‰+ åŸºæœ¬é…ä¿¡æ©Ÿèƒ½
- Phase 2: JSONBå‹•çš„è³ªå• + é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿
- Phase 3: ç®¡ç†ç”»é¢UI + LINEè‡ªå‹•é…ä¿¡

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚¹ã‚­ãƒ¼ãƒé–¢é€£

### 2.1 âŒ å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ ã¸ã®å¯¾å¿œ

#### **å•é¡Œ1: `profiles.is_active`**

**86ã§ã®ä½¿ç”¨:**
```sql
-- å…¨å“¡é…ä¿¡
select id from profiles where is_active = true;
```

**ç¾çŠ¶:** `is_active` ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„

**å¯¾å¿œæ–¹é‡:** âœ… **ä½¿ã‚ãªã„**
- å…¨å“¡é…ä¿¡æ™‚ã¯ `where` æ¡ä»¶ãªã—ã§å…¨ä»¶å–å¾—
- å°†æ¥çš„ã«ã€Œé€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ç®¡ç†ã—ãŸã„å ´åˆã®ã¿è¿½åŠ æ¤œè¨

**ä¿®æ­£å¾Œã®SQL:**
```sql
-- å…¨å“¡é…ä¿¡ï¼ˆis_active æ¡ä»¶ã‚’å‰Šé™¤ï¼‰
select id from profiles;

-- ã¾ãŸã¯ã€ã‚¹ã‚¿ãƒ³ãƒ—æ•°0ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–ï¼ˆå®Ÿè³ªçš„ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ¤å®šï¼‰
select id from profiles where stamp_count > 0;
```

---

#### **å•é¡Œ2: `profiles.age`**

**86ã§ã®ä½¿ç”¨:**
```sql
-- å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿
where age >= 30;
```

**ç¾çŠ¶:** `age` ã‚«ãƒ©ãƒ ã‚‚ `birth_date` ã‚«ãƒ©ãƒ ã‚‚å­˜åœ¨ã—ãªã„

**å¯¾å¿œæ–¹é‡:** âœ… **Phase 1ã§ã¯ä½¿ã‚ãªã„**
- å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã¯ **Phase 2ä»¥é™** ã§æ¤œè¨
- å¿…è¦ã«ãªã£ãŸã‚‰ `birth_date DATE` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã€å¹´é½¢ã¯SQLå´ã§è¨ˆç®—
  ```sql
  -- å°†æ¥å®Ÿè£…ã™ã‚‹å ´åˆ
  where EXTRACT(YEAR FROM AGE(birth_date)) >= 30;
  ```

**å½“é¢ã®å¯¾å‡¦:**
- é…ä¿¡å¯¾è±¡è€…ãƒ•ã‚£ãƒ«ã‚¿ã‹ã‚‰ã€Œå¹´é½¢å±¤ã€ã¯é™¤å¤–
- ã€Œæœ€çµ‚æ¥é™¢æ—¥ã€ã€Œã‚¹ã‚¿ãƒ³ãƒ—æ•°ã€ã®ã¿ã§é‹ç”¨é–‹å§‹

---

#### **å•é¡Œ3: `profiles.stamps_count` â†’ `stamp_count`**

**86ã§ã®ä½¿ç”¨:**
```sql
where stamps_count >= 50;  -- âŒ èª¤ã‚Š
```

**ç¾çŠ¶:** æ­£ã—ã„ã‚«ãƒ©ãƒ åã¯ **`stamp_count`**ï¼ˆè¤‡æ•°å½¢ã§ã¯ãªã„ï¼‰

**å¯¾å¿œæ–¹é‡:** âœ… **85/86ã®ã™ã¹ã¦ã®SQLä¾‹ã‚’ `stamp_count` ã«ä¿®æ­£**

**ä¿®æ­£ä¾‹:**
```sql
-- ã‚¹ã‚¿ãƒ³ãƒ—5å€‹ä»¥ä¸Šï¼ˆ50pt = 5å€‹ï¼‰
where stamp_count >= 50;
```

---

#### **å•é¡Œ4: `profiles.line_display_name` â†’ `display_name`**

**86ã§ã®ä½¿ç”¨:**
```sql
-- ãƒ“ãƒ¥ãƒ¼å®šç¾©
p.line_display_name
```

**ç¾çŠ¶:** æ­£ã—ã„ã‚«ãƒ©ãƒ åã¯ **`display_name`**

**å¯¾å¿œæ–¹é‡:** âœ… **`display_name` ã«çµ±ä¸€**

---

### 2.2 âŒ æ—¥ä»˜ã‚«ãƒ©ãƒ ã®å–ã‚Šé•ãˆ

#### **å•é¡Œ: `stamp_history.created_at` ã‚’æœ€çµ‚æ¥é™¢æ—¥ã¨ã—ã¦ä½¿ç”¨**

**86ã§ã®ä½¿ç”¨ï¼ˆ9.3 ä¼‘çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡ºï¼‰:**
```sql
having max(sh.created_at) < now() - interval '90 days'  -- âŒ èª¤ã‚Š
```

**ç¾çŠ¶ã®æ­£ã—ã„ã‚«ãƒ©ãƒ :**
- **`profiles.last_visit_date`**: æœ€çµ‚æ¥é™¢æ—¥ï¼ˆãƒˆãƒªã‚¬ãƒ¼ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ï¼‰
- **`stamp_history.visit_date`**: å®Ÿéš›ã®æ¥é™¢æ—¥
- **`stamp_history.created_at`**: ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚ï¼ˆâ‰ æ¥é™¢æ—¥ï¼‰

**å¯¾å¿œæ–¹é‡:** âœ… **`profiles.last_visit_date` ã¾ãŸã¯ `stamp_history.visit_date` ã‚’ä½¿ç”¨**

**ä¿®æ­£å¾Œã®SQL:**
```sql
-- æ–¹æ³•A: profiles ã®ã¿ã§æŠ½å‡ºï¼ˆæ¨å¥¨ï¼šé«˜é€Ÿï¼‰
select id from profiles
where last_visit_date < now() - interval '90 days'
   or last_visit_date is null;

-- æ–¹æ³•B: stamp_history ã¨çµåˆï¼ˆä¸è¦ã«JOINã—ãªã„ï¼‰
select p.id from profiles p
left join stamp_history sh on p.id = sh.user_id
group by p.id
having max(sh.visit_date) < now() - interval '90 days'
   or max(sh.visit_date) is null;
```

---

### 2.3 âœ… `surveys` / `survey_answers` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºå®š

**ç¾çŠ¶:** 05_Database_Schema.md ã«ã¯æœªè¨˜è¼‰

**å¯¾å¿œæ–¹é‡:** âœ… **ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ¼ãƒã§æ–°è¦ä½œæˆ**

#### Phase 1ç‰ˆï¼ˆå›ºå®šè³ªå•ï¼‰

```sql
-- surveys ãƒ†ãƒ¼ãƒ–ãƒ«
create table surveys (
  id text primary key,                      -- 'satisfaction_2026Q1'
  title text not null,                      -- 'ã”åˆ©ç”¨æº€è¶³åº¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ'
  description text,                         -- èª¬æ˜æ–‡
  reward_stamps integer not null default 3, -- å ±é…¬ã‚¹ã‚¿ãƒ³ãƒ—æ•°ï¼ˆå€‹ãƒ»æ•´æ•°ï¼‰
  is_active boolean not null default true,
  start_date timestamptz,
  end_date timestamptz,
  created_at timestamptz not null default now()
);

-- survey_answers ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå›ºå®šã‚¹ã‚­ãƒ¼ãƒï¼‰
create table survey_answers (
  id uuid primary key default gen_random_uuid(),
  user_id text not null references profiles(id) on delete cascade,
  survey_id text not null references surveys(id) on delete cascade,
  q1_rating integer,        -- Q1: 5æ®µéšè©•ä¾¡ï¼ˆ1ã€œ5ï¼‰
  q2_comment text,          -- Q2: è‡ªç”±è¨˜è¿°
  q3_recommend integer,     -- Q3: æ¨å¥¨åº¦ï¼ˆ0ã€œ10ï¼‰
  created_at timestamptz not null default now(),
  unique(user_id, survey_id)
);

create index idx_survey_answers_survey_id on survey_answers(survey_id);
create index idx_survey_answers_created_at on survey_answers(created_at);
```

#### Phase 2ç‰ˆï¼ˆå‹•çš„è³ªå• - å°†æ¥æ‹¡å¼µï¼‰

```sql
-- surveys ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆquestions ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
alter table surveys add column questions jsonb;

-- survey_answers ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆanswers JSONB ã«å¤‰æ›´ï¼‰
-- â€» Phase 2ã§å®Ÿè£…æ™‚ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
```

---

## 3. èªè¨¼ãƒ»RLSé–¢é€£

### 3.1 ç¾çŠ¶ã®èªè¨¼æ–¹å¼ã®ç¢ºèª

| ç’°å¢ƒ | èªè¨¼æ–¹å¼ | Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | `auth.uid()` |
|------|---------|---------------------|-------------|
| **LIFFï¼ˆæ‚£è€…å´ï¼‰** | LINEãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ï¼ˆLIFF SDKï¼‰ | anon key | âŒ NULL |
| **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç®¡ç†å´ï¼‰** | Cookieï¼ˆsimple-authï¼‰ | service_role | âŒ NULL |

**é‡è¦:**
- LIFFå´ã¯ **Supabase Auth ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ã¯ LIFF SDK ã® `liff.getProfile()` ã§å–å¾—ã—ãŸ LINE user id ã‚’å…ƒã«ã€`profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ `id` ã‚’å–å¾—
- ã—ãŸãŒã£ã¦ `auth.uid()` ã¯**å¸¸ã« NULL** ã§ä½¿ç”¨ä¸å¯

**çµè«–:** `auth.uid()` ã¯**ä½¿ãˆãªã„**

### 3.2 RLSæ–¹é‡ã®æ±ºå®š

#### âŒ 86ã®å½“åˆæ¡ˆï¼ˆauth.uid()ä¾å­˜ï¼‰

```sql
-- ã“ã‚Œã¯å‹•ã‹ãªã„
create policy "Users can view their own targets"
  on survey_targets for select
  using (auth.uid()::text = user_id);
```

#### âœ… ä¿®æ­£æ¡ˆA: RLSã‚’ç·©å’Œï¼ˆã‚¢ãƒ—ãƒªå±¤ã§åˆ¶å¾¡ï¼‰

```sql
-- LIFFï¼ˆæ‚£è€…å´ï¼‰: anon key ã§è‡ªåˆ†ã®è¡Œã®ã¿å‚ç…§
create policy "anon_can_read_survey_targets"
  on survey_targets for select
  using (true);  -- å…¨ä»¶å‚ç…§å¯èƒ½ã ãŒã€ã‚¢ãƒ—ãƒªå´ã§ user_id ã§ãƒ•ã‚£ãƒ«ã‚¿

create policy "anon_can_update_survey_targets"
  on survey_targets for update
  using (true);  -- å…¨ä»¶æ›´æ–°å¯èƒ½ã ãŒã€ã‚¢ãƒ—ãƒªå´ã§ user_id ã§ãƒ•ã‚£ãƒ«ã‚¿

-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç®¡ç†å´ï¼‰: service_role ã§å…¨ä»¶æ“ä½œå¯èƒ½
-- â€» service_role ã¯ RLS ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã€ãƒãƒªã‚·ãƒ¼ä¸è¦
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…ä¿æ–¹æ³•:**
- LIFFå´: ã‚¯ã‚¨ãƒªã«å¿…ãš `.eq('user_id', profile.id)` ã‚’ä»˜ã‘ã‚‹
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´: service_role ã§ç›´æ¥æ“ä½œ

#### âœ… ä¿®æ­£æ¡ˆB: ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã§èªè¨¼ï¼ˆã‚ˆã‚Šå³å¯†ï¼‰

```sql
-- ã‚¢ãƒ—ãƒªå´ã§ X-User-ID ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã€RLSã§æ¤œè¨¼
create policy "authenticated_user_can_read"
  on survey_targets for select
  using (current_setting('request.headers')::json->>'x-user-id' = user_id);
```

**æ¨å¥¨:** â­ **ä¿®æ­£æ¡ˆAï¼ˆRLSç·©å’Œ + ã‚¢ãƒ—ãƒªå±¤åˆ¶å¾¡ï¼‰**
- ç¾çŠ¶ã®èªè¨¼æ–¹å¼ã¨æ•´åˆæ€§ãŒé«˜ã„
- å®Ÿè£…ãŒå®¹æ˜“
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ã‚¢ãƒ—ãƒªå±¤ã§æ‹…ä¿ï¼ˆæ—¢å­˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åŒã˜ï¼‰

---

### 3.3 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ API ã® Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

#### âŒ 86ã®å½“åˆæ¡ˆ

```typescript
// ã“ã‚Œã¯ä½¿ã‚ãªã„
const supabase = createRouteHandlerClient({ cookies });
```

#### âœ… ä¿®æ­£æ¡ˆï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ã®æœ€æ–°çŠ¶æ³ã«åˆã‚ã›ã‚‹ï¼‰

```typescript
// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨APIã¯ service_role ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨
// â˜… æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿéš›ã®é–¢æ•°: createSupabaseAdminClientï¼ˆlib/supabase/server-admin.tsï¼‰
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';

export async function POST(request: Request) {
  const supabase = createSupabaseAdminClient();

  // â€» ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼ã¯æ—¢å­˜ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§å®Ÿæ–½æ¸ˆã¿
  // ï¼ˆ/admin é…ä¸‹ã® Cookie æ¤œè¨¼ï¼‰

  const { data } = await supabase.from('survey_targets').select('*');
  return NextResponse.json({ data });
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- `createRouteHandlerClient` ã¯ä½¿ã‚ãªã„
- **æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ `createSupabaseAdminClient()` ã‚’ä½¿ç”¨**ï¼ˆ`app/api/families`ãƒ»`app/api/activity-logs`ãƒ»`app/api/auth` ç­‰ã¨åŒæ§˜ï¼‰
- API ãƒ«ãƒ¼ãƒˆã¯ **`app/api/surveys/...`** ã«é…ç½®ï¼ˆ`app/api/profiles`ãƒ»`app/api/broadcast` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
- ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼ã¯æ—¢å­˜ã® simple-auth ã§å®Ÿæ–½

---

## 4. å®Ÿè£…ã‚³ãƒ¼ãƒ‰é–¢é€£

### 4.1 ã€Œã‚ã¨ã§ã€ãƒœã‚¿ãƒ³ã®å®Ÿè£…ä¿®æ­£

#### âŒ 86ã®å½“åˆæ¡ˆ

```typescript
// ã“ã‚Œã¯å‹•ã‹ãªã„
postponed_count: supabase.rpc('increment', { row: 'postponed_count' })
```

#### âœ… ä¿®æ­£æ¡ˆA: SELECT â†’ UPDATE

```typescript
const handleSurveyLater = async () => {
  // 1. ç¾åœ¨å€¤ã‚’å–å¾—
  const { data: target } = await supabase
    .from('survey_targets')
    .select('postponed_count')
    .eq('user_id', userId)
    .eq('survey_id', surveyId)
    .single();

  // 2. +1 ã—ã¦æ›´æ–°
  await supabase
    .from('survey_targets')
    .update({
      postponed_count: (target?.postponed_count || 0) + 1,
      last_postponed_at: new Date().toISOString(),
    })
    .eq('user_id', userId)
    .eq('survey_id', surveyId);

  setSurveyModal(null);
};
```

#### âœ… ä¿®æ­£æ¡ˆB: RPCé–¢æ•°ã‚’ä½œæˆï¼ˆæ¨å¥¨ï¼‰

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:**
```sql
-- 017_create_survey_tables.sql ã«è¿½åŠ 
create or replace function increment_survey_postponed(
  p_user_id text,
  p_survey_id text
)
returns void as $$
begin
  update survey_targets
  set
    postponed_count = postponed_count + 1,
    last_postponed_at = now()
  where user_id = p_user_id
    and survey_id = p_survey_id;
end;
$$ language plpgsql security definer;
```

**LIFFå´:**
```typescript
const handleSurveyLater = async () => {
  await supabase.rpc('increment_survey_postponed', {
    p_user_id: userId,
    p_survey_id: surveyId,
  });

  setSurveyModal(null);
};
```

**æ¨å¥¨:** â­ **ä¿®æ­£æ¡ˆBï¼ˆRPCé–¢æ•°ï¼‰**
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®‰å…¨
- ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«
- æ—¢å­˜ã® `increment_reservation_clicks` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³

---

### 4.2 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ã®æœ€æ–°çŠ¶æ³ï¼‰

| ç¨®åˆ¥ | ãƒ‘ã‚¹ | å‚™è€ƒ |
|------|------|------|
| **ç®¡ç†ç”»é¢ï¼ˆãƒšãƒ¼ã‚¸ï¼‰** | `app/admin/surveys/...` | æ‚£è€…ä¸€è¦§ãƒ»åˆ†æãƒ»ä¸€æ–‰é…ä¿¡ãƒ»ç‰¹å…¸äº¤æ›ãƒ»ãƒ­ã‚°ç­‰ã¨åŒæ§˜ |
| **API ãƒ«ãƒ¼ãƒˆ** | `app/api/surveys/...` | `app/api/profiles`ãƒ»`app/api/broadcast`ãƒ»`app/api/activity-logs` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ |

**å¯¾å¿œ:** 86 ã‚’ä¸Šè¨˜ã«åˆã‚ã›ã¦è¨˜è¼‰æ¸ˆã¿ã€‚å®Ÿè£…æ™‚ã¯ `createSupabaseAdminClient`ï¼ˆ`@/lib/supabase/server-admin`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚

---

## 5. ãã®ä»–ã®èª¿æ•´

### 5.1 ã‚¹ã‚¿ãƒ³ãƒ—å ±é…¬ã®ä»˜ä¸æ–¹æ³•

#### è¦ä»¶
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã§ã€Œã‚¹ã‚¿ãƒ³ãƒ—3å€‹ã€ã‚’ä»˜ä¸ï¼ˆreward_stamps ã¯å€‹æ•°ï¼‰
- æ—¢å­˜ã®ç©ã¿ä¸Šã’å¼ã¨æ•´åˆã‚’å–ã‚‹

#### âœ… å®Ÿè£…æ–¹é‡

**APIå®Ÿè£…ä¾‹ï¼ˆ`app/api/survey/submit/route.ts`ï¼‰:**
```typescript
// 1. å›ç­”ã‚’survey_answersã«ä¿å­˜
await supabase.from('survey_answers').insert({
  user_id: profile.id,
  survey_id: surveyId,
  q1_rating,
  q2_comment,
  q3_recommend,
});

// 2. ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´ã«è¿½åŠ ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨åŒã˜ï¼‰
await supabase.from('stamp_history').insert({
  user_id: profile.id,
  visit_date: new Date().toISOString(),
  stamp_number: profile.stamp_count + 30,  // ç¾åœ¨å€¤ + 3å€‹ï¼ˆå†…éƒ¨ã¯10å€: 3å€‹=30ï¼‰
  amount: 30,                              // ä»Šå›ä»˜ä¸: 3å€‹
  stamp_method: 'survey_reward',           // â˜… æ–°è¦ãƒ¡ã‚½ãƒƒãƒ‰
  notes: `ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”: ${surveyId}`,
});

// 3. ãƒˆãƒªã‚¬ãƒ¼ã§ profiles.stamp_count ãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹

// 4. survey_targets ã® answered_at ã‚’æ›´æ–°
await supabase
  .from('survey_targets')
  .update({ answered_at: new Date().toISOString() })
  .eq('user_id', profile.id)
  .eq('survey_id', surveyId);
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- `stamp_method` ã«æ–°ã—ã„å€¤ `'survey_reward'` ã‚’ä½¿ç”¨
- æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆ`update_profile_stamp_count`ï¼‰ãŒè‡ªå‹•çš„ã« `profiles.stamp_count` ã‚’æ›´æ–°
- ç©ã¿ä¸Šã’å¼ãªã®ã§æ¸›ç®—ä¸è¦

---

### 5.2 LINEé…ä¿¡ã¨æ—¢å­˜ä¸€æ–‰é…ä¿¡ã®çµ±åˆ

#### ç¾çŠ¶
- æ—¢å­˜: ä¸€æ–‰é…ä¿¡æ©Ÿèƒ½ï¼ˆ06ä»•æ§˜æ›¸ï¼‰
- 86: ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”¨LINEé…ä¿¡

#### âœ… å¯¾å¿œæ–¹é‡

**Phase 1:** â­ **åˆ¥ã€…ã«å®Ÿè£…**
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯ survey_targets ãƒ™ãƒ¼ã‚¹ã§é…ä¿¡
- æ—¢å­˜ä¸€æ–‰é…ä¿¡ã¯ãã®ã¾ã¾ç¶­æŒ
- é‹ç”¨ã§ä½¿ã„åˆ†ã‘

**Phase 2ä»¥é™:** çµ±åˆæ¤œè¨
- ä¸€æ–‰é…ä¿¡ã®ã€Œç¨®åˆ¥ã€ã«ã€Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé…ä¿¡ã€ã‚’è¿½åŠ 
- é…ä¿¡å±¥æ­´ã§ä¸€å…ƒç®¡ç†

---

### 5.3 é…ä¿¡å¯¾è±¡è€…æŠ½å‡ºã®æœ€é©åŒ–

#### âŒ 86ã®ä¾‹ï¼ˆä¸è¦ãªJOINï¼‰

```sql
-- æœ€çµ‚æ¥é™¢æ—¥30æ—¥ä»¥å†…ï¼ˆstamp_history ã¨ JOIN ã—ã¦ã„ã‚‹ï¼‰
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select p.id, 'satisfaction_2026Q1', true
from profiles p
join stamp_history sh on p.id = sh.user_id
where sh.created_at >= now() - interval '30 days'
group by p.id;
```

#### âœ… ä¿®æ­£æ¡ˆï¼ˆprofiles ã®ã¿ã§æŠ½å‡ºï¼‰

```sql
-- profiles ã ã‘ã§å¯èƒ½ï¼ˆé«˜é€Ÿï¼‰
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'satisfaction_2026Q1', true
from profiles
where last_visit_date >= now() - interval '30 days';
```

**åŸå‰‡:**
- **profiles ã«é›†ç´„ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ï¼ˆlast_visit_date, stamp_count ãªã©ï¼‰ã¯ profiles ã®ã¿ã§æŠ½å‡º**
- stamp_history ã¨ã® JOIN ã¯æœ€å°é™ã«ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰

---

## 6. ä¿®æ­£ç‰ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 6.1 æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: `017_create_survey_tables.sql`

```sql
-- ========================================
-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
-- Phase 2.8: æ‚£è€…æº€è¶³åº¦èª¿æŸ»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨
-- ========================================

-- ========================================
-- 1. surveys ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®šç¾©ï¼‰
-- ========================================
create table surveys (
  id text primary key,                      -- 'satisfaction_2026Q1' ãªã©
  title text not null,                      -- 'ã”åˆ©ç”¨æº€è¶³åº¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ'
  description text,                         -- èª¬æ˜æ–‡
  reward_stamps integer not null default 3, -- å ±é…¬ã‚¹ã‚¿ãƒ³ãƒ—æ•°ï¼ˆå€‹ãƒ»æ•´æ•°ï¼‰
  is_active boolean not null default true,  -- å…¬é–‹ä¸­ã‹ã©ã†ã‹
  start_date timestamptz,                   -- å…¬é–‹é–‹å§‹æ—¥
  end_date timestamptz,                     -- å…¬é–‹çµ‚äº†æ—¥
  created_at timestamptz not null default now()
);

-- ========================================
-- 2. survey_answers ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿ï¼‰
-- ========================================
create table survey_answers (
  id uuid primary key default gen_random_uuid(),
  user_id text not null references profiles(id) on delete cascade,
  survey_id text not null references surveys(id) on delete cascade,

  -- è³ªå•å›ç­”ï¼ˆPhase 1: å›ºå®šã‚¹ã‚­ãƒ¼ãƒï¼‰
  q1_rating integer,        -- Q1: 5æ®µéšè©•ä¾¡ï¼ˆ1ã€œ5ï¼‰
  q2_comment text,          -- Q2: è‡ªç”±è¨˜è¿°
  q3_recommend integer,     -- Q3: æ¨å¥¨åº¦ï¼ˆ0ã€œ10ã€NPSè¨ˆç®—ç”¨ï¼‰

  created_at timestamptz not null default now(),

  -- é‡è¤‡å›ç­”é˜²æ­¢
  unique(user_id, survey_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
create index idx_survey_answers_survey_id on survey_answers(survey_id);
create index idx_survey_answers_created_at on survey_answers(created_at);
create index idx_survey_answers_user_id on survey_answers(user_id);

-- ========================================
-- 3. survey_targets ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé…ä¿¡å¯¾è±¡è€…ï¼‰
-- ========================================
create table survey_targets (
  id uuid primary key default gen_random_uuid(),
  user_id text not null references profiles(id) on delete cascade,
  survey_id text not null references surveys(id) on delete cascade,

  -- è¡¨ç¤ºåˆ¶å¾¡
  show_on_liff_open boolean not null default false,  -- LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã™ã‚‹ã‹

  -- å›ç­”çŠ¶æ³
  answered_at timestamptz,  -- å›ç­”å®Œäº†æ—¥æ™‚ï¼ˆNULLãªã‚‰æœªå›ç­”ï¼‰

  -- å¾Œå›ã—ã‚«ã‚¦ãƒ³ãƒˆ
  postponed_count integer not null default 0,  -- ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ãŸå›æ•°
  last_postponed_at timestamptz,              -- æœ€å¾Œã«ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ãŸæ—¥æ™‚

  -- ãƒ¡ã‚¿æƒ…å ±
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),

  -- é‡è¤‡é˜²æ­¢
  unique(user_id, survey_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
create index idx_survey_targets_user_id on survey_targets(user_id);
create index idx_survey_targets_survey_id on survey_targets(survey_id);
create index idx_survey_targets_show_on_liff on survey_targets(show_on_liff_open) where show_on_liff_open = true;
create index idx_survey_targets_answered on survey_targets(answered_at);

-- ========================================
-- 4. RLSãƒãƒªã‚·ãƒ¼
-- ========================================
alter table surveys enable row level security;
alter table survey_answers enable row level security;
alter table survey_targets enable row level security;

-- surveys: å…¬é–‹ä¸­ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯å…¨å“¡ãŒå‚ç…§å¯èƒ½
create policy "anon_can_read_active_surveys"
  on surveys for select
  using (is_active = true);

-- survey_answers: è‡ªåˆ†ã®å›ç­”ã®ã¿å‚ç…§ãƒ»æŒ¿å…¥å¯èƒ½
create policy "anon_can_read_own_answers"
  on survey_answers for select
  using (true);  -- ã‚¢ãƒ—ãƒªå±¤ã§ user_id ãƒ•ã‚£ãƒ«ã‚¿

create policy "anon_can_insert_own_answers"
  on survey_answers for insert
  with check (true);  -- ã‚¢ãƒ—ãƒªå±¤ã§ user_id æ¤œè¨¼

-- survey_targets: è‡ªåˆ†ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±ã®ã¿å‚ç…§ãƒ»æ›´æ–°å¯èƒ½
create policy "anon_can_read_own_targets"
  on survey_targets for select
  using (true);  -- ã‚¢ãƒ—ãƒªå±¤ã§ user_id ãƒ•ã‚£ãƒ«ã‚¿

create policy "anon_can_update_own_targets"
  on survey_targets for update
  using (true);  -- ã‚¢ãƒ—ãƒªå±¤ã§ user_id ãƒ•ã‚£ãƒ«ã‚¿

-- ç®¡ç†è€…ï¼ˆservice_roleï¼‰ã¯å…¨ä»¶æ“ä½œå¯èƒ½ï¼ˆRLSã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰

-- ========================================
-- 5. ãƒ“ãƒ¥ãƒ¼: é…ä¿¡å¯¾è±¡è€…ã®ä¸€è¦§ï¼ˆç®¡ç†ç”»é¢ç”¨ï¼‰
-- ========================================
create or replace view survey_target_status as
select
  st.id,
  st.survey_id,
  s.title as survey_title,
  st.user_id,
  p.real_name,
  p.display_name,  -- â˜… line_display_name ã§ã¯ãªã display_name
  st.show_on_liff_open,
  st.answered_at,
  case
    when st.answered_at is not null then 'å›ç­”æ¸ˆã¿'
    else 'æœªå›ç­”'
  end as status,
  st.postponed_count,
  st.last_postponed_at,
  st.created_at
from survey_targets st
join surveys s on st.survey_id = s.id
join profiles p on st.user_id = p.id
order by st.created_at desc;

-- ========================================
-- 6. RPCé–¢æ•°: ã€Œã‚ã¨ã§ã€ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
-- ========================================
create or replace function increment_survey_postponed(
  p_user_id text,
  p_survey_id text
)
returns void as $$
begin
  update survey_targets
  set
    postponed_count = postponed_count + 1,
    last_postponed_at = now(),
    updated_at = now()
  where user_id = p_user_id
    and survey_id = p_survey_id;
end;
$$ language plpgsql security definer;

-- ========================================
-- 7. åˆæœŸãƒ‡ãƒ¼ã‚¿
-- ========================================
insert into surveys (id, title, description, reward_stamps) values
  ('satisfaction_2026Q1', 'ã”åˆ©ç”¨æº€è¶³åº¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ', 'å½“é™¢ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ãŠèã‹ã›ãã ã•ã„', 3);
```

---

### 6.2 stamp_method ã®æ‹¡å¼µ

æ—¢å­˜ã® `stamp_method` ã«æ–°ã—ã„å€¤ã‚’è¿½åŠ :

| å€¤ | èª¬æ˜ |
|----|------|
| `'qr_scan'` | QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆæ—¢å­˜ï¼‰ |
| `'manual_admin'` | ç®¡ç†è€…ãŒæ‰‹å‹•ä»˜ä¸ï¼ˆæ—¢å­˜ï¼‰ |
| `'import'` | ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ—¢å­˜ï¼‰ |
| **`'survey_reward'`** | **ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å ±é…¬ï¼ˆæ–°è¦ï¼‰** â­ |

---

## 7. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 7.1 Phase 1ï¼ˆæœ€å°æ©Ÿèƒ½ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ `017_create_survey_tables.sql` ã‚’ä½œæˆãƒ»å®Ÿè¡Œ
- [ ] `surveys` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª
- [ ] `survey_answers` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª
- [ ] `survey_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª
- [ ] `survey_target_status` ãƒ“ãƒ¥ãƒ¼ä½œæˆç¢ºèª
- [ ] `increment_survey_postponed` RPCé–¢æ•°ä½œæˆç¢ºèª
- [ ] 05_Database_Schema.md ã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½è¨˜

#### LIFFå´ï¼ˆæ‚£è€…å´ï¼‰
- [ ] `/survey/[surveyId]/page.tsx` å®Ÿè£…
- [ ] `SurveyForm` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] `SurveyModal` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…ï¼ˆLIFFåˆæœŸè¡¨ç¤ºç”¨ï¼‰
- [ ] `/api/survey/submit/route.ts` å®Ÿè£…
  - [ ] `stamp_method: 'survey_reward'` ã§ stamp_history ã«è¿½åŠ 
  - [ ] survey_targets ã® answered_at æ›´æ–°
- [ ] `/api/survey/check/route.ts` å®Ÿè£…
- [ ] ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã® survey_targets ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- [ ] ã€Œã‚ã¨ã§ã€ãƒœã‚¿ãƒ³ã§ `increment_survey_postponed` RPC å‘¼ã³å‡ºã—

#### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ï¼ˆç®¡ç†å´ï¼‰
- [ ] `/app/admin/surveys/page.tsx` å®Ÿè£…ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ï¼‰
- [ ] `/app/admin/surveys/[surveyId]/targets/page.tsx` å®Ÿè£…ï¼ˆé…ä¿¡å¯¾è±¡è€…é¸æŠï¼‰
- [ ] `/api/surveys/targets/create/route.ts` å®Ÿè£…
  - [ ] service_role ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨
  - [ ] ã‚«ãƒ©ãƒ åä¿®æ­£ï¼ˆ`stamp_count`, `display_name`, `last_visit_date`ï¼‰
  - [ ] `is_active`, `age` æ¡ä»¶ã¯ä½¿ã‚ãªã„
- [ ] `/api/surveys/targets/list/route.ts` å®Ÿè£…ï¼ˆå›ç­”çŠ¶æ³ä¸€è¦§ï¼‰
- [ ] `/api/surveys/results/route.ts` å®Ÿè£…ï¼ˆçµæœé›†è¨ˆï¼‰

#### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] 85_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨.md ã‚’ä¿®æ­£
  - [ ] ã‚«ãƒ©ãƒ åçµ±ä¸€
  - [ ] SQLä¾‹ã®ä¿®æ­£
- [ ] 86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨_ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´.md ã‚’ä¿®æ­£
  - [ ] ã‚«ãƒ©ãƒ åçµ±ä¸€
  - [ ] èªè¨¼ãƒ»RLSæ–¹å¼ã®ä¿®æ­£
  - [ ] SQLä¾‹ã®ä¿®æ­£
  - [ ] APIå®Ÿè£…ä¾‹ã®ä¿®æ­£

---

### 7.2 Phase 2ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ï¼‰

- [ ] `surveys.questions` ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆJSONBï¼‰
- [ ] `survey_answers.answers` ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆJSONBï¼‰
- [ ] å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè£…
- [ ] æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿UIå®Ÿè£…ï¼ˆå¹´é½¢å±¤è¿½åŠ ã®å ´åˆã¯ `birth_date` ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
- [ ] LINEè‡ªå‹•é…ä¿¡æ©Ÿèƒ½å®Ÿè£…

---

## 8. ã¾ã¨ã‚

### 8.1 é‡è¦ãªä¿®æ­£ç‚¹

| é …ç›® | ä¿®æ­£å†…å®¹ |
|------|---------|
| **ã‚«ãƒ©ãƒ å** | `stamps_count` â†’ `stamp_count`<br>`line_display_name` â†’ `display_name` |
| **æ—¥ä»˜æ¡ä»¶** | `stamp_history.created_at` â†’ `profiles.last_visit_date` |
| **å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ ** | `is_active`, `age` ã¯ä½¿ã‚ãªã„ |
| **RLSæ–¹å¼** | `auth.uid()` ä¾å­˜ â†’ ã‚¢ãƒ—ãƒªå±¤åˆ¶å¾¡ |
| **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èªè¨¼** | `createRouteHandlerClient` â†’ `service_role` |
| **ã€Œã‚ã¨ã§ã€æ›´æ–°** | æ¶ç©ºã®RPC â†’ `increment_survey_postponed` é–¢æ•° |
| **ã‚¹ã‚¿ãƒ³ãƒ—å ±é…¬** | `stamp_method: 'survey_reward'` ã§æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã«çµ±åˆ |

### 8.2 ç¢ºèªäº‹é …ï¼ˆè¦å”è­°ï¼‰

| é …ç›® | è³ªå• | å›ç­” |
|------|------|------|
| **å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿** | Phase 1ã§å®Ÿè£…ã™ã‚‹ã‹ï¼Ÿ | â†’ **Phase 2ä»¥é™** ã§æ¤œè¨ |
| **LINEé…ä¿¡çµ±åˆ** | æ—¢å­˜ä¸€æ–‰é…ä¿¡ã¨çµ±åˆã™ã‚‹ã‹ï¼Ÿ | â†’ **Phase 1ã¯åˆ¥ã€…ã€Phase 2ã§çµ±åˆæ¤œè¨** |
| **RLSå³å¯†åŒ–** | ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼ã‚’ä½¿ã†ã‹ï¼Ÿ | â†’ **Phase 1ã¯ã‚¢ãƒ—ãƒªå±¤åˆ¶å¾¡ã€Phase 2ã§æ¤œè¨** |

### 8.3 æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. âœ… ã“ã®å¯¾å¿œæ–¹é‡ï¼ˆDoc/87ï¼‰ã‚’LIFFæ‹…å½“ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹…å½“ã§åˆæ„
2. âœ… 85/86ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£
3. âœ… `017_create_survey_tables.sql` ã‚’ä½œæˆ
4. âœ… Phase 1å®Ÿè£…é–‹å§‹

---

## 9. å®Ÿè£…ä¸Šã®è£œè¶³äº‹é …ï¼ˆ2026-02-26 è¿½è¨˜ï¼‰

### 9.1 Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã®ç¢ºèªï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ã®æœ€æ–°çŠ¶æ³ï¼‰

**é‡è¦:** æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿéš›ã®æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **ç®¡ç†ç”¨ï¼ˆservice_roleï¼‰:** `createSupabaseAdminClient()` ã‚’ **`@/lib/supabase/server-admin`** ã‹ã‚‰ importã€‚  
  `app/api/families`ãƒ»`app/api/activity-logs`ãƒ»`app/api/auth` ç­‰ã§ä½¿ç”¨ã€‚
- **LIFFå´ï¼ˆæ‚£è€…ï¼‰:** anon key ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§åˆ©ç”¨ã—ã¦ã„ã‚‹ Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã§ã€`user_id` ã¯ **`profiles.id`** ã‚’æŒ‡å®šã™ã‚‹ã€‚

**ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ API ã®è¨˜è¿°ä¾‹:**
```typescript
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';
const supabase = createSupabaseAdminClient();
```

### 9.2 LIFFå´ã®èªè¨¼æ–¹å¼

**é‡è¦:** æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **Supabase Auth ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“**ï¼ˆLINE ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ï¼‰ã€‚

- LINE SDK ã® `userId` ã¯ **`profiles.line_user_id`** ã«ç›¸å½“ã™ã‚‹ã€‚
- **`survey_targets.user_id`** ã¯ **`profiles.id`**ï¼ˆPKï¼‰ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã€LIFF å´ã§ã¯ã€ŒLINE user id â†’ profiles.idã€ã®è§£æ±ºãŒå¿…è¦ã€‚
- è§£æ±ºä¾‹: (1) æ—¢å­˜ API ã§ `line_user_id` ã‚’æ¸¡ã— `profiles.id` ã‚’è¿”ã™ã€(2) anon ã§ `profiles` ã‚’ `line_user_id = ?` ã§å–å¾—ã— `id` ã‚’ä½¿ç”¨ã€‚

**å®Ÿè£…ä¾‹ï¼ˆprofiles.id ã‚’æ—¢ã«ä¿æŒã—ã¦ã„ã‚‹å ´åˆï¼‰:**
```typescript
const { profile } = useLiff(); // ã‚¢ãƒ—ãƒªã§ profile.id = profiles.id ã‚’ä¿æŒã—ã¦ã„ã‚‹æƒ³å®š

const { data } = await supabase
  .from('survey_targets')
  .eq('user_id', profile.id)  // â˜… profiles.idï¼ˆLINE userId ã®å ´åˆã¯äº‹å‰ã«è§£æ±ºã™ã‚‹ã“ã¨ï¼‰
  .select('*');
```

### 9.3 å°†æ¥çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æ¤œè¨äº‹é …

**Phase 1:** RLSç·©å’Œï¼ˆ`using (true)`ï¼‰+ ã‚¢ãƒ—ãƒªå±¤åˆ¶å¾¡ã§å®Ÿè£…

**Phase 2ä»¥é™ã§æ¤œè¨ã™ã¹ãäº‹é …:**
- RLSãƒãƒªã‚·ãƒ¼ã®å³æ ¼åŒ–ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼ãªã©ï¼‰
- anon keyæ¼æ´©æ™‚ã®ãƒªã‚¹ã‚¯è»½æ¸›ç­–
- service_role ã‚­ãƒ¼ã®é©åˆ‡ãªç®¡ç†å¾¹åº•

### 9.4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒä¸Šã®æ³¨æ„ç‚¹

**ãƒ“ãƒ¥ãƒ¼ã® ORDER BY ã«ã¤ã„ã¦:**
- PostgreSQLã®ä»•æ§˜ä¸Šã€ãƒ“ãƒ¥ãƒ¼å®šç¾©å†…ã® `ORDER BY` ã¯çµæœé †åºã‚’ä¿è¨¼ã—ã¾ã›ã‚“
- APIå®Ÿè£…æ™‚ã«å¿…ãš `.order()` ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„

**surveys ãƒ†ãƒ¼ãƒ–ãƒ«ã® updated_at:**
- Phase 1 ã§ã¯ `created_at` ã®ã¿
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®šç¾©ã®æ›´æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹éš›ã« `updated_at` ã‚«ãƒ©ãƒ è¿½åŠ ã‚’æ¤œè¨

---

**æœ€çµ‚æ›´æ–°:** 2026-02-26ï¼ˆå®Ÿè£…è£œè¶³è¿½è¨˜ï¼‰
**æ‰¿èªå¾…ã¡:** LIFFæ‹…å½“ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹…å½“ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼
