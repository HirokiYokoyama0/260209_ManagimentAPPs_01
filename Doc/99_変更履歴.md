# プロジェクト変更履歴

このファイルは、つくばホワイト歯科 管理ダッシュボードプロジェクトの実装内容・進捗状況を時系列で管理します。

---

## 📊 現在のステータス

**プロジェクト開始日**: 2025年2月上旬
**最終更新日**: 2026-02-14
**現在のフェーズ**: Phase 1（管理ダッシュボード基本機能）完了

---

## ✅ 実装済み機能

### Phase 1: 管理ダッシュボード基本機能（完了）

#### 認証・セキュリティ
- [x] 簡易認証システム（ログインID/パスワード）
  - デフォルト: `admin` / `admin`
  - 環境変数で変更可能（`ADMIN_USER` / `ADMIN_PASSWORD`）
- [x] セッション管理（署名付きCookie）
- [x] ミドルウェアによる `/admin` ルート保護

#### 患者一覧機能
- [x] Supabase の `profiles` テーブルとの連携
- [x] リアルタイムデータフェッチ（SWR使用）
- [x] 検索機能（名前・診察券番号）
- [x] ソート機能
  - 診察券番号
  - スタンプ数
  - 最終来院日
  - 最新ログイン（`updated_at`）
  - 公式アカ友だちフラグ
  - 表示モード
- [x] ローディング表示（スピナー）

#### 患者情報管理
- [x] 診察券番号の編集
- [x] 最終来院日の編集
- [x] 表示モード切り替え（大人/キッズ）

#### スタンプ管理
- [x] クイック増減ボタン（-1 / +1）
- [x] 直接数値入力（0〜999）
- [x] リアルタイム反映（SWR mutate）

#### メッセージ送信機能
- [x] 個別メッセージ送信シート（右スライド表示）
- [x] 定型文テンプレート
  - 「お疲れ様でした」
  - 「次回予約のご案内」
  - 「定期検診のリマインド」
- [x] 自由入力フィールド
- [x] `care_messages` テーブルへの保存
- [x] LINE Messaging API 連携（プッシュ送信）
  - Channel ID/Secret または Access Token 対応

#### 分析画面
- [x] スタンプ分布グラフ（0個、1-5個、6-10個、11個以上）
- [x] 公式アカ友だち率
- [x] 直近14日以内のログイン人数

#### UI/UX
- [x] shadcn/ui ベースのモダンなデザイン
- [x] レスポンシブ対応
- [x] 色分けされた操作ボタン
  - 編集: アンバー系
  - -1: ローズ系
  - +1: エメラルド系
  - メッセージ: インディゴ系

---

## 🚧 現在進行中

- 特になし

---

## 📝 今後の実装予定（優先順位順）

### Phase 2: 管理機能の拡充（短期）

#### すぐに実装すると便利な機能
- [ ] CSV ダウンロード機能
  - スタンプ分布データ
  - 公式アカ友だち一覧
  - 患者一覧エクスポート
- [ ] 公式アカ友だちフィルタトグル
  - 友だち登録済みのみ表示
  - 未登録のみ表示

#### メッセージ機能の強化
- [ ] メッセージテンプレート管理画面
  - テンプレート追加・編集・削除
  - DB（`message_templates`テーブル）で管理
- [ ] 送信履歴一覧・検索
  - `care_messages` 一覧表示
  - 日付・患者名で検索
  - 送信内容の確認

### Phase 3: 一斉送信機能（中期）

- [ ] 条件指定ウィザード
  - スタンプ数による絞り込み
  - 最終来院日による絞り込み
  - 公式アカ友だちのみ
- [ ] 対象者プレビュー
  - 送信対象者一覧の確認
  - 人数カウント表示
- [ ] テスト送信機能
  - 1人だけにテスト送信
  - 本番送信前の確認
- [ ] 一斉送信実行
  - バッチ処理
  - 送信結果の記録

### Phase 4: 分析機能の強化（中期）

- [ ] `activity_logs` テーブルの導入
  - ログインイベント記録
  - 管理画面操作履歴
- [ ] 利用状況グラフ
  - ログイン回数の推移（日次・週次）
  - ミニアプリ起動回数
  - 来院無し期間ごとの患者数分析
- [ ] ダッシュボードの拡充
  - 個別患者の詳細パネル（過去メッセージ・スタンプ履歴）
  - 分析結果のビジュアル化

### Phase 5: LINEミニアプリ実装（長期）

- [ ] LIFF（LINE Front-end Framework）導入
- [ ] 患者向け機能実装
  - デジタル診察券表示
  - QRコードスキャン機能
  - スタンプ表示（来院履歴）
  - セルフケアログ
  - ケア記録閲覧
- [ ] ハブラーシカキャラクター導入

### Phase 6: 運用・保守機能（長期）

- [ ] 大量データ対応
  - ページネーション
  - 無限スクロール
  - サーバーサイド検索・ソート
- [ ] 管理ユーザーの複数化
  - ユーザー管理画面
  - ロール・権限管理
    - 閲覧のみ
    - スタンプ編集可
    - メッセージ送信可
    - 管理者（全権限）
- [ ] エラー監視・ログ管理
  - Sentry 連携
  - Vercel ログ活用
  - 不正アクセス検知

---

## 🔧 技術的変更履歴

### 2026-02-14
- ローディングスピナーを追加（患者一覧読み込み中の表示改善）
- `Loader2` アイコンと「患者データを読み込んでいます...」メッセージを表示
- SWR の `isLoading` 状態を活用

### 2025-02-11
- 分析画面を追加（`/admin/analysis`）
- スタンプ分布・友だち率・ログイン状況の可視化

### 2025-02-10
- 管理ダッシュボード基本機能完成
- 患者一覧・スタンプ管理・メッセージ送信機能実装
- Vercel デプロイ準備完了

### 2025-02-09
- `care_messages` テーブル作成
- LINE Messaging API 連携実装
- 個別メッセージ送信機能実装

### 2025-02-08
- プロジェクト初期化
- Next.js 15 + TypeScript + shadcn/ui セットアップ
- Supabase 連携
- `profiles` テーブル作成
- 認証システム実装

---

## 📌 既知の課題・制約事項

### 技術的制約
- 簡易認証のため、複数管理者の同時運用は未対応
- 患者数が1000人を超えた場合のパフォーマンス未検証
- LIFF（LINEミニアプリ）部分は未実装

### 機能的制約
- メッセージテンプレートがコード内にハードコード
- 一斉送信機能は未実装
- 送信履歴の詳細検索は未対応

---

## 📚 参考資料

- [01_クイックスタート.md](01_クイックスタート.md) - 起動手順
- [02_管理ダッシュボード仕様書.md](02_管理ダッシュボード仕様書.md) - 詳細仕様
- [03_Supabaseセットアップ手順.md](03_Supabaseセットアップ手順.md) - DB設定
- [04_LINEミニアプリ仕様書.md](04_LINEミニアプリ仕様書.md) - 将来実装予定

---

## ✏️ 更新ルール

このファイルは以下のタイミングで更新してください：

1. 新機能を実装したとき
2. 既存機能を大きく変更したとき
3. 技術スタックを変更したとき
4. 重要な意思決定をしたとき

**記載形式**: 日付（YYYY-MM-DD）+ 簡潔な説明

---

最終更新: 2026-02-14
