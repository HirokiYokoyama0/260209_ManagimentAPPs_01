# プロジェクト変更履歴

このファイルは、つくばホワイト歯科 管理ダッシュボードプロジェクトの実装内容・進捗状況を時系列で管理します。

---

## 📊 現在のステータス

**プロジェクト開始日**: 2025年2月上旬
**最終更新日**: 2026-02-14
**現在のフェーズ**: Phase 1（管理ダッシュボード基本機能）完了

---

## ✅ 実装済み機能

### Phase 1: 管理ダッシュボード基本機能（完了）

#### 認証・セキュリティ
- [x] 簡易認証システム（ログインID/パスワード）
  - デフォルト: `admin` / `admin`
  - 環境変数で変更可能（`ADMIN_USER` / `ADMIN_PASSWORD`）
- [x] セッション管理（署名付きCookie）
- [x] ミドルウェアによる `/admin` ルート保護

#### 患者一覧機能
- [x] Supabase の `profiles` テーブルとの連携
- [x] リアルタイムデータフェッチ（SWR使用）
- [x] 検索機能（名前・診察券番号）
- [x] ソート機能
  - 診察券番号
  - スタンプ数
  - 最終来院日
  - 最新ログイン（`updated_at`）
  - 公式アカ友だちフラグ
  - 表示モード
- [x] ローディング表示（スピナー）

#### 患者情報管理
- [x] 診察券番号の編集
- [x] 最終来院日の編集
- [x] 表示モード切り替え（大人/キッズ）
- [x] **次回来院メモ機能（2026-02-14追加）**
  - 次回来院予定日の設定
  - 次回メモの入力（200文字制限）
  - デフォルトメッセージボタン（歯石除去/定期検診）
  - 患者一覧テーブルに列表示（改行対応・上揃え）
  - リアルタイムプレビュー機能
  - 過去日付警告表示

#### スタンプ管理
- [x] クイック増減ボタン（-1 / +1）
- [x] 直接数値入力（0〜999）
- [x] リアルタイム反映（SWR mutate）

#### メッセージ送信機能
- [x] 個別メッセージ送信シート（右スライド表示）
- [x] 定型文テンプレート
  - 「お疲れ様でした」
  - 「次回予約のご案内」
  - 「定期検診のリマインド」
- [x] 自由入力フィールド
- [x] `care_messages` テーブルへの保存
- [x] LINE Messaging API 連携（プッシュ送信）
  - Channel ID/Secret または Access Token 対応

#### 分析画面
- [x] スタンプ分布グラフ（0個、1-5個、6-10個、11個以上）
- [x] 公式アカ友だち率
- [x] 直近14日以内のログイン人数

#### UI/UX
- [x] shadcn/ui ベースのモダンなデザイン
- [x] **完全レスポンシブ対応（2026-02-14追加）**
  - **PC表示**: Table形式（1024px以上）
  - **スマホ表示**: Card形式（1024px未満）
  - **ハンバーガーメニュー**: スマホ用ナビゲーション
  - **タッチ操作最適化**: 44×44px以上のタップ領域
  - **片手操作対応**: 右下に大きな+1ボタン配置
- [x] 色分けされた操作ボタン
  - 編集: アンバー系
  - -1: ローズ系
  - +1: エメラルド系
  - メッセージ: インディゴ系

---

## 🚧 現在進行中

- 特になし

---

## 📝 今後の実装予定（優先順位順）

### Phase 2: 管理機能の拡充（短期）

#### すぐに実装すると便利な機能
- [ ] CSV ダウンロード機能
  - スタンプ分布データ
  - 公式アカ友だち一覧
  - 患者一覧エクスポート
- [ ] 公式アカ友だちフィルタトグル
  - 友だち登録済みのみ表示
  - 未登録のみ表示

#### メッセージ機能の強化
- [ ] メッセージテンプレート管理画面
  - テンプレート追加・編集・削除
  - DB（`message_templates`テーブル）で管理
- [ ] 送信履歴一覧・検索
  - `care_messages` 一覧表示
  - 日付・患者名で検索
  - 送信内容の確認

### Phase 3: 一斉配信機能（中期）

**詳細仕様**: [06_一斉配信機能仕様書.md](06_一斉配信機能仕様書.md)

#### MVP（最優先実装）
- [ ] ターゲット抽出機能
  - スタンプ数による絞り込み（範囲指定）
  - 最終来院日による絞り込み（日数範囲）
  - 表示モードによる絞り込み（大人/キッズ）
  - 公式アカ友だちフラグ
  - 複合条件対応
- [ ] メッセージ作成画面
  - テキスト入力（1000文字まで）
  - 変数置換機能（{name}、{stamp_count}など）
  - 定型テンプレート選択
- [ ] 確認・送信機能
  - 対象者数・メッセージ通数表示
  - LINE Multicast API連携（500人ずつ分割送信）
  - 送信進捗表示
- [ ] 配信ログ記録
  - `broadcast_logs` テーブル作成
  - 配信条件・結果の記録

#### 次点実装
- [ ] 配信履歴画面
  - 過去の配信一覧表示
  - 配信詳細モーダル
- [ ] テスト送信機能
  - 管理者自身のLINEへのテスト配信
- [ ] 運用制約
  - 夜間配信制限（21:00-9:00は警告）
  - 同一患者への配信頻度制限
  - 今月の無料枠残数表示

#### 将来拡張
- [ ] 予約送信機能（日時指定）
- [ ] リッチメッセージ対応
- [ ] 配信結果分析（開封率など）
- [ ] セグメント保存機能
- [ ] AI支援メッセージ生成

### Phase 4: 分析機能の強化（中期）

- [ ] `activity_logs` テーブルの導入
  - ログインイベント記録
  - 管理画面操作履歴
- [ ] 利用状況グラフ
  - ログイン回数の推移（日次・週次）
  - ミニアプリ起動回数
  - 来院無し期間ごとの患者数分析
- [ ] ダッシュボードの拡充
  - 個別患者の詳細パネル（過去メッセージ・スタンプ履歴）
  - 分析結果のビジュアル化

### Phase 5: LINEミニアプリ実装（長期）

- [ ] LIFF（LINE Front-end Framework）導入
- [ ] 患者向け機能実装
  - デジタル診察券表示
  - QRコードスキャン機能
  - スタンプ表示（来院履歴）
  - セルフケアログ
  - ケア記録閲覧
- [ ] ハブラーシカキャラクター導入

### Phase 6: 運用・保守機能（長期）

- [ ] 大量データ対応
  - ページネーション
  - 無限スクロール
  - サーバーサイド検索・ソート
- [ ] 管理ユーザーの複数化
  - ユーザー管理画面
  - ロール・権限管理
    - 閲覧のみ
    - スタンプ編集可
    - メッセージ送信可
    - 管理者（全権限）
- [ ] エラー監視・ログ管理
  - Sentry 連携
  - Vercel ログ活用
  - 不正アクセス検知

---

## 🔧 技術的変更履歴

### 2026-02-14（深夜）
- **📊 予約ボタンクリック計測機能の実装**
  - **データベース対応**
    - `supabase/006_add_reservation_clicks.sql` 作成
      - `profiles` テーブルに `reservation_button_clicks` カラム追加（INTEGER, DEFAULT 0）
      - `increment_reservation_clicks()` 関数作成（排他制御付きカウントアップ）
      - インデックス作成（集計クエリの高速化）
  - **API作成**
    - `app/api/users/[userId]/reservation-click/route.ts` 作成
      - POSTメソッドでクリック数をカウントアップ
      - Supabase RPCでストアドファンクション呼び出し
      - エラーハンドリング実装
  - **型定義の更新**
    - `lib/types.ts` の Profile型に `reservation_button_clicks?: number` 追加
  - **分析画面の拡張**
    - `app/admin/analysis/page.tsx` にサマリーカード追加
      - 総クリック数表示
      - 平均クリック数（クリック数/患者数）表示
      - サマリーカード数を4→5列に変更（`md:grid-cols-5`）
  - **ドキュメント作成**
    - `Doc/08_予約ボタンクリック計測機能.md` - 技術仕様書
    - `Doc/100_主な機能一覧（クライアント説明用）.md` - クライアント向け機能説明
    - `Doc/101_LIFF開発者への伝達事項_予約クリック計測.md` - LIFF開発者向け実装ガイド
  - **LIFF側の対応事項**
    - AdultHome.tsx と KidsHome.tsx の handleReservation 関数に API呼び出しを追加する必要あり（LIFF側プロジェクトで実装）
    - エラーでもユーザー体験を妨げない設計（`.catch()` でエラーを握りつぶす）
  - **活用方法**
    - ユーザー別クリック数の確認が可能
    - SQLで詳細な集計・分析が可能（クリック率、相関分析など）
    - 予約導線の改善効果測定に活用

### 2026-02-14（夜）
- **📝 次回来院メモ機能の実装**
  - **データベース対応**
    - `lib/types.ts` に Profile型の拡張（3フィールド追加）
      - `next_visit_date?: string | null`
      - `next_memo?: string | null`
      - `next_memo_updated_at?: string | null`
  - **新規ユーティリティファイル作成**
    - `lib/memo.ts` 作成（日付フォーマット・バリデーション関数）
      - `formatVisitDate()` - タイムゾーン問題回避の日付フォーマット
      - `isPastDate()` - 過去日付判定
      - `isValidMemoLength()` - 200文字制限チェック
  - **新規UIコンポーネント作成**
    - `components/ui/textarea.tsx` - Textareaコンポーネント
    - `components/ui/separator.tsx` - Separatorコンポーネント
  - **API拡張**
    - `app/api/profiles/[id]/route.ts` にバリデーション追加
      - 200文字超過時のエラーレスポンス
      - `next_visit_date` と `next_memo` フィールドの処理
  - **編集ダイアログの拡張（PC・モバイル共通）**
    - ダイアログ幅を `max-w-2xl` に拡張
    - 基本情報と次回来院予定を2セクションに分離
    - 2カラムレイアウト（診察券番号と最終来院日を横並び）
    - 次回来院予定日フィールド + 過去日付警告
    - 次回メモフィールド + 文字数カウンター（200/200）
    - リアルタイムプレビュー機能
    - デフォルトメッセージボタン2個（歯石除去/定期検診）
  - **患者一覧テーブルに列追加**
    - 次回来院予定日列（`formatVisitDate()` 使用）
    - 次回メモ列（改行対応・上揃え・`text-[11px]`）
  - **依存パッケージ追加**
    - `@radix-ui/react-separator` インストール

### 2026-02-14（午後）
- **📱 完全レスポンシブ対応実装**
  - **患者一覧タブのスマホ対応**
    - PC: Table形式（1024px以上）
    - スマホ: Card形式（1024px未満）
    - 新規コンポーネント作成
      - `components/admin/mobile/mobile-patient-list.tsx`
      - `components/admin/mobile/mobile-patient-card.tsx`
      - `components/admin/mobile/mobile-patient-actions-menu.tsx`
  - **特典交換タブのスマホ対応**
    - PC: Table形式（1024px以上）
    - スマホ: Card形式（1024px未満）
    - 新規コンポーネント作成
      - `components/admin/mobile/mobile-reward-exchange-list.tsx`
      - `components/admin/mobile/mobile-reward-exchange-card.tsx`
      - `components/admin/mobile/mobile-reward-exchange-actions.tsx`
  - **ヘッダーのスマホメニュー対応**
    - ハンバーガーメニューボタン追加（スマホのみ表示）
    - ドロップダウンナビゲーション実装
    - 患者一覧/分析/一斉配信/特典交換への遷移
  - **一斉配信タブのフォーム改善**
    - `grid-cols-2` → `grid-cols-1 md:grid-cols-2` に変更
    - スマホで1列、PC で2列表示
  - **タッチ操作の最適化**
    - ボタンサイズを44×44px以上に統一
    - +1ボタンを右下に大きく配置（片手操作対応）
    - メッセージSheetをスマホで全画面表示（`w-full sm:max-w-md`）
  - **新規UIコンポーネント追加**
    - `components/ui/dropdown-menu.tsx`（@radix-ui/react-dropdown-menu）

### 2026-02-14（午前）
- **ドキュメント整理**
  - Docフォルダを MECE構造に整理
  - `00_ファイル構成.md` を新規作成（プロジェクト全体の構造説明）
  - `99_変更履歴.md` を新規作成（進捗管理）
  - 旧ファイル6個を `archive/` フォルダに移動
  - ファイル名を番号付きに統一（00_, 02_, 03_, ...）
- **一斉配信機能の仕様策定**
  - `06_一斉配信機能仕様書.md` を作成
  - 3ステップワークフロー（抽出 → 作成 → 確認・送信）を定義
  - LINE Multicast API 連携方針を決定
  - `broadcast_logs` テーブル設計を完了
  - セグメント条件・変数置換・運用制約を明確化
- **UIの改善**
  - ローディングスピナーを追加（患者一覧読み込み中の表示改善）
  - `Loader2` アイコンと「患者データを読み込んでいます...」メッセージを表示
  - SWR の `isLoading` 状態を活用

### 2025-02-11
- 分析画面を追加（`/admin/analysis`）
- スタンプ分布・友だち率・ログイン状況の可視化

### 2025-02-10
- 管理ダッシュボード基本機能完成
- 患者一覧・スタンプ管理・メッセージ送信機能実装
- Vercel デプロイ準備完了

### 2025-02-09
- `care_messages` テーブル作成
- LINE Messaging API 連携実装
- 個別メッセージ送信機能実装

### 2025-02-08
- プロジェクト初期化
- Next.js 15 + TypeScript + shadcn/ui セットアップ
- Supabase 連携
- `profiles` テーブル作成
- 認証システム実装

---

## 📌 既知の課題・制約事項

### 技術的制約
- 簡易認証のため、複数管理者の同時運用は未対応
- 患者数が1000人を超えた場合のパフォーマンス未検証
- LIFF（LINEミニアプリ）部分は未実装

### 機能的制約
- メッセージテンプレートがコード内にハードコード
- 一斉送信機能は未実装
- 送信履歴の詳細検索は未対応

---

## 📚 参考資料

- [00_ファイル構成.md](00_ファイル構成.md) - プロジェクト全体のファイル・フォルダ構成
- [02_クイックスタート.md](02_クイックスタート.md) - 起動手順
- [03_管理ダッシュボード仕様書.md](03_管理ダッシュボード仕様書.md) - 基本機能仕様
- [04_Supabaseセットアップ手順.md](04_Supabaseセットアップ手順.md) - DB設定
- [05_LINEミニアプリ仕様書.md](05_LINEミニアプリ仕様書.md) - 将来実装予定
- [06_一斉配信機能仕様書.md](06_一斉配信機能仕様書.md) - 一斉配信機能の詳細設計

---

## ✏️ 更新ルール

このファイルは以下のタイミングで更新してください：

1. 新機能を実装したとき
2. 既存機能を大きく変更したとき
3. 技術スタックを変更したとき
4. 重要な意思決定をしたとき

**記載形式**: 日付（YYYY-MM-DD）+ 簡潔な説明

---

最終更新: 2026-02-14
