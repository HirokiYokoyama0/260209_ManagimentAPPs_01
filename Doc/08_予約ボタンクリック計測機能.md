# 予約ボタンクリック計測機能 仕様書

## 📋 概要

LINE miniアプリ（LIFF）内の「予約する」ボタンがクリックされた回数を計測し、管理ダッシュボードで確認できる機能です。

**担当の分け方**
- **LIFF担当**: 「予約する」ボタンに計測API呼び出しを1行追加（所要目安 約15分）。エラー時も予約ページは開く設計。
- **管理ダッシュボード担当**: DBカラム追加・API実装・分析画面での表示。
- **優先度**: 中（推奨。必須ではない）

---

## 🎯 目的

- 患者の予約意欲を数値化
- 予約導線の効果測定
- エンゲージメントの高いユーザーの特定
- 将来的な改善施策の判断材料

---

## 🏗️ システム構成

### 1. データベース設計

#### profilesテーブルへのカラム追加

```sql
ALTER TABLE profiles
ADD COLUMN reservation_button_clicks INTEGER DEFAULT 0;

COMMENT ON COLUMN profiles.reservation_button_clicks IS '予約ボタンのクリック回数';
```

| カラム名 | 型 | デフォルト | 説明 |
|---------|-----|-----------|------|
| `reservation_button_clicks` | INTEGER | 0 | 予約ボタンのクリック累計回数 |

**特徴**:
- 累積カウンター方式
- ユーザーごとにクリック数を保存
- リセット機能なし（永続的に記録）

---

## 📡 API仕様

### エンドポイント

```
POST /api/users/[userId]/reservation-click
```

### リクエスト

**URL Parameters**:
- `userId` (string, required): LINEユーザーID（例: `Uxxxxxxxxxxxx`）

**Body**: なし（空のPOSTリクエスト）

### レスポンス

**成功時** (200 OK):
```json
{
  "success": true
}
```

**失敗時** (500 Internal Server Error):
```json
{
  "success": false,
  "error": "エラーメッセージ"
}
```

### 処理内容

1. 指定されたユーザーIDの`reservation_button_clicks`を+1
2. データベーストランザクションで安全に更新
3. 同時クリックにも対応（排他制御）

---

## 🖥️ LIFF側実装

### 対象ファイル

- `app/(liff)/adult/home/page.tsx` (AdultHome)
- `app/(liff)/kids/home/page.tsx` (KidsHome)

### 実装箇所

`handleReservation`関数内で、予約ページを開く直前にAPIをコール。

```typescript
const handleReservation = async () => {
  if (displayTicketNumber === "未登録") {
    alert("診察券番号が登録されていません。");
    return;
  }

  try {
    // 診察券番号をコピー
    await navigator.clipboard.writeText(displayTicketNumber);
    alert(`診察券番号をコピーしました！\n予約画面で貼り付けてください。\n\n診察券番号: ${displayTicketNumber}`);

    // 🆕 クリック数をカウント
    if (profile?.userId) {
      await fetch(`/api/users/${profile.userId}/reservation-click`, {
        method: 'POST',
      });
    }

    // アポツールを開く
    window.open("https://reservation.stransa.co.jp/...", "_blank");
  } catch (error) {
    console.error("予約ボタンクリックエラー:", error);
    // エラーが発生してもユーザー体験を妨げないため、予約ページは開く
  }
};
```

**重要**:
- APIコールが失敗しても予約ページは開く（ユーザー体験優先）
- エラーはコンソールにログ出力のみ

---

## 📊 管理ダッシュボード表示

### 1. 分析画面（/admin/analysis）

#### 追加する指標

**サマリーカード**:
```
📞 予約ボタンクリック数
総クリック数: 234回
平均クリック数: 2.3回/人
```

**計算式**:
- 総クリック数 = `SUM(reservation_button_clicks)`
- 平均クリック数 = `総クリック数 / 患者数`

### 2. 患者一覧画面（/admin）

#### テーブルに列を追加（オプション）

| 列名 | 表示内容 | 説明 |
|------|---------|------|
| 予約クリック | `3回` | 各患者のクリック回数 |

**ソート機能**: クリック数の多い順/少ない順でソート可能

---

## 📈 活用方法

### 1. ユーザーエンゲージメント分析

```sql
-- クリック数の多い患者トップ10
SELECT
  display_name AS 患者名,
  ticket_number AS 診察券番号,
  reservation_button_clicks AS クリック数,
  stamp_count AS スタンプ数
FROM profiles
WHERE reservation_button_clicks > 0
ORDER BY reservation_button_clicks DESC
LIMIT 10;
```

### 2. クリック率の計算

```sql
-- 予約ボタンをクリックしたことがある患者の割合
SELECT
  COUNT(*) FILTER (WHERE reservation_button_clicks > 0) AS クリックしたユーザー数,
  COUNT(*) AS 総ユーザー数,
  ROUND(
    100.0 * COUNT(*) FILTER (WHERE reservation_button_clicks > 0) / COUNT(*),
    2
  ) AS クリック率
FROM profiles;
```

### 3. 平均クリック数（アクティブユーザーのみ）

```sql
-- 1回以上クリックしたユーザーの平均クリック数
SELECT
  AVG(reservation_button_clicks) AS 平均クリック数
FROM profiles
WHERE reservation_button_clicks > 0;
```

### 4. クリック数とスタンプ数の相関

```sql
-- クリック数が多いほど来院も多いか？
SELECT
  reservation_button_clicks AS クリック数,
  AVG(stamp_count) AS 平均スタンプ数,
  COUNT(*) AS 人数
FROM profiles
WHERE reservation_button_clicks > 0
GROUP BY reservation_button_clicks
ORDER BY reservation_button_clicks;
```

---

## 🔄 データフロー

```
1. ユーザーがLIFFで「予約する」ボタンをクリック
   ↓
2. handleReservation() 関数が実行される
   ↓
3. 診察券番号をクリップボードにコピー
   ↓
4. POST /api/users/[userId]/reservation-click を呼び出し
   ↓
5. Supabaseで該当ユーザーのreservation_button_clicks +1
   ↓
6. 予約ページ（Stransa）を別タブで開く
   ↓
7. 管理ダッシュボードでリアルタイムに集計可能
```

---

## ⚠️ 注意事項・制約

### 制約1: 履歴は残らない
- いつクリックしたかの詳細履歴は保存されない
- 累積カウントのみ
- 将来的に詳細分析が必要な場合は、別途`reservation_clicks`テーブルを追加

### 制約2: 実際の予約完了とは別
- あくまで「予約ボタンをクリックした回数」
- 実際に予約を完了したかは不明
- 予約システム（Stransa）との連携は別途必要

### 制約3: オフライン時の動作
- ユーザーがオフラインの場合、カウントされない
- ネットワークエラー時もカウント漏れの可能性
- ただし、予約ページは開く（ユーザー体験優先）

### 制約4: 同時クリックの扱い
- データベースのトランザクション処理で排他制御
- 連打してもカウントは正確

---

## 🚀 将来の拡張案

### Phase 2: 詳細履歴テーブル（オプション）

より詳細な分析が必要になった場合、以下のテーブルを追加:

```sql
CREATE TABLE reservation_button_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  clicked_at TIMESTAMPTZ DEFAULT NOW(),
  source_page TEXT, -- 'adult_home', 'kids_home'
  ticket_number TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**可能になること**:
- 日別・週別・月別のクリック推移グラフ
- 時間帯別の分析（何時にクリックが多いか）
- A/Bテストの効果測定
- ユーザーごとのクリック履歴詳細

---

## 📝 実装チェックリスト

### データベース
- [ ] マイグレーションSQL実行（`006_add_reservation_clicks.sql`）
- [ ] カラムが正しく追加されたか確認
- [ ] デフォルト値0が設定されているか確認

### API
- [ ] `/api/users/[userId]/reservation-click/route.ts` 作成
- [ ] POSTメソッドの実装
- [ ] エラーハンドリングの実装
- [ ] 動作テスト（Postmanなどで確認）

### LIFF
- [ ] `AdultHome.tsx`の`handleReservation`修正
- [ ] `KidsHome.tsx`の`handleReservation`修正
- [ ] エラーハンドリング追加
- [ ] 実機テスト（スマホで動作確認）

### 管理ダッシュボード
- [ ] 分析画面にサマリーカード追加
- [ ] 患者一覧にクリック数列追加（オプション）
- [ ] ソート機能の実装（オプション）
- [ ] 表示テスト

### ドキュメント
- [ ] この仕様書の作成
- [ ] `00_ファイル構成.md`更新
- [ ] `99_変更履歴.md`更新
- [ ] 開発者への伝達事項作成

---

## 📞 問い合わせ・サポート

この機能に関する質問や不具合報告は、開発担当者までご連絡ください。

---

**作成日**: 2026年2月14日
**最終更新**: 2026年2月14日
**バージョン**: 1.0
