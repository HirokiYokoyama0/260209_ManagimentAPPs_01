# 一斉配信機能仕様書（シンプル版・Phase 1）

つくばホワイト歯科 管理ダッシュボードの一斉配信機能の**シンプル実装版**です。

---

## 🎯 Phase 1 の目標

**1画面で完結する、最小限の一斉配信機能を実装する**

- セグメント条件選択
- 対象者プレビュー表示
- メッセージ作成・送信
- 配信ログ閲覧

---

## 1. 画面構成（1画面完結）

### `/admin/broadcast` ページ

2つのタブで構成：
- **新規配信タブ**（メイン）
- **配信履歴タブ**

---

## 2. 新規配信タブ

### 2.1 セグメント条件選択

| 条件 | UI | 説明 |
|------|-----|------|
| **スタンプ数** | 数値入力（最小・最大） | 例: 最小 10、最大 20 |
| **最終来院日数** | 数値入力（最小・最大） | 例: 最小 90、最大 180（日） |
| **表示モード** | セレクトボックス | 全員 / 大人のみ / キッズのみ |
| **友だち登録** | チェックボックス | 「LINE友だち登録済みのみ」 |

### 2.2 対象者プレビュー

- **ボタン**: 「対象者を確認」
- **表示内容**:
  - 対象者数: 「〇〇名が条件に該当します」
  - 対象者リスト: 最初の10名を表示（名前・スタンプ数・最終来院日）
  - 推定メッセージ通数: 「〇〇通消費（無料枠: 月1000通）」

### 2.3 メッセージ作成

| 要素 | 仕様 |
|------|------|
| **テキストエリア** | 1000文字まで |
| **変数挿入ボタン** | `{name}`, `{stamp_count}`, `{ticket_number}` を挿入 |
| **文字数カウント** | リアルタイム表示「〇〇 / 1000文字」 |
| **定型テンプレート** | 3つ用意（定期検診・キャンペーン・お知らせ） |

**変数の説明**:
- `{name}` → 患者の氏名（未設定の場合「お客様」）
- `{stamp_count}` → 現在のスタンプ数
- `{ticket_number}` → 診察券番号（未設定の場合「未設定」）

### 2.4 送信実行

1. **送信ボタン**: 「〇〇名に送信」
2. **確認ダイアログ**:
   ```
   本当に送信しますか？
   対象者: 〇〇名
   メッセージ通数: 〇〇通

   [キャンセル] [送信する]
   ```
3. **送信処理**:
   - ローディング表示「送信中...」
   - 完了メッセージ「〇〇名に送信しました」
   - 自動的に配信履歴タブに切り替え

---

## 3. 配信履歴タブ

### 3.1 一覧表示

| 列 | 内容 |
|----|------|
| 送信日時 | YYYY-MM-DD HH:mm |
| 送信者 | 管理者名（固定: admin） |
| 対象者数 | 〇〇名 |
| 成功/失敗 | 〇〇成功 / △△失敗 |
| メッセージ | 最初の30文字... |
| アクション | [詳細] ボタン |

### 3.2 詳細モーダル

- セグメント条件
- 完全なメッセージ内容
- 送信結果（成功数・失敗数）

---

## 4. 技術仕様（簡略版）

### 4.1 データベース

#### broadcast_logs テーブル

```sql
CREATE TABLE broadcast_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sent_by TEXT NOT NULL,                    -- 送信者
  segment_conditions JSONB NOT NULL,        -- セグメント条件
  message_text TEXT NOT NULL,               -- メッセージ
  target_count INTEGER NOT NULL,            -- 対象者数
  success_count INTEGER DEFAULT 0,          -- 成功数
  failed_count INTEGER DEFAULT 0,           -- 失敗数
  sent_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_broadcast_logs_sent_at ON broadcast_logs(sent_at DESC);
ALTER TABLE broadcast_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_public_read" ON broadcast_logs FOR SELECT USING (true);
CREATE POLICY "allow_public_insert" ON broadcast_logs FOR INSERT WITH CHECK (true);
```

### 4.2 API エンドポイント

#### `POST /api/broadcast/preview`

**Request**:
```typescript
{
  stampCount?: { min?: number; max?: number };
  lastVisitDays?: { min?: number; max?: number };
  viewMode?: 'adult' | 'kids' | null;
  isLineFriend?: boolean;
}
```

**Response**:
```typescript
{
  count: number;              // 対象者数
  preview: Profile[];         // 最初の10名
  estimatedCost: number;      // 推定通数
}
```

#### `POST /api/broadcast/send`

**Request**:
```typescript
{
  segment: BroadcastSegment;  // セグメント条件
  message: string;            // メッセージ（変数含む）
  sentBy: string;             // 送信者名
}
```

**Response**:
```typescript
{
  success: boolean;
  broadcastLogId: string;
  targetCount: number;
  successCount: number;
  failedCount: number;
  error?: string;
}
```

#### `GET /api/broadcast/logs`

**Response**:
```typescript
{
  logs: Array<{
    id: string;
    sent_by: string;
    target_count: number;
    success_count: number;
    failed_count: number;
    sent_at: string;
    message_text: string;
    segment_conditions: BroadcastSegment;
  }>;
}
```

### 4.3 LINE Messaging API

#### 送信ロジック（簡略版）

```typescript
// 500人以下の場合
if (lineIds.length <= 500) {
  await sendMulticast(lineIds, message);
}

// 500人超の場合
else {
  const chunks = chunkArray(lineIds, 500);
  for (const chunk of chunks) {
    await sendMulticast(chunk, message);
    await sleep(500);  // レート制限対策
  }
}
```

**Multicast API**:
```typescript
POST https://api.line.me/v2/bot/message/multicast
Headers:
  Authorization: Bearer {CHANNEL_ACCESS_TOKEN}
Body:
{
  "to": ["U1234...", "U5678..."],  // 最大500件
  "messages": [{ "type": "text", "text": "メッセージ" }]
}
```

---

## 5. 変数置換ロジック

```typescript
function replaceVariables(message: string, profile: Profile): string {
  return message
    .replace(/{name}/g, profile.display_name || 'お客様')
    .replace(/{stamp_count}/g, String(profile.stamp_count || 0))
    .replace(/{ticket_number}/g, profile.ticket_number || '未設定');
}
```

---

## 6. セグメント抽出ロジック

```typescript
function filterProfiles(profiles: Profile[], segment: BroadcastSegment): Profile[] {
  return profiles.filter(p => {
    // スタンプ数
    if (segment.stampCount?.min && p.stamp_count < segment.stampCount.min) return false;
    if (segment.stampCount?.max && p.stamp_count > segment.stampCount.max) return false;

    // 最終来院日数
    if (segment.lastVisitDays && p.last_visit_date) {
      const days = daysSince(p.last_visit_date);
      if (segment.lastVisitDays.min && days < segment.lastVisitDays.min) return false;
      if (segment.lastVisitDays.max && days > segment.lastVisitDays.max) return false;
    }

    // 表示モード
    if (segment.viewMode && p.view_mode !== segment.viewMode) return false;

    // 友だち登録
    if (segment.isLineFriend && p.is_line_friend !== true) return false;

    return true;
  });
}
```

---

## 7. 省略した機能（将来対応）

### Phase 1 で実装しないもの

- ❌ 3ステップウィザードUI → 1画面で完結
- ❌ テスト送信機能 → 慎重に本番送信
- ❌ 夜間配信制限 → 手動で時間帯に注意
- ❌ プログレスバー → 「送信中...」のみ
- ❌ 変数置換プレビュー → 送信時に置換されることを説明
- ❌ AI支援メッセージ生成 → 手動入力
- ❌ 予約送信 → 即時送信のみ

### Phase 2 で追加予定

- [ ] 3ステップウィザードUI
- [ ] テスト送信（管理者のLINEに送信）
- [ ] 夜間配信制限（21:00-9:00は警告）
- [ ] 変数置換のリアルタイムプレビュー

---

## 8. UI ワイヤーフレーム

```
┌─────────────────────────────────────────────┐
│ 一斉配信                                     │
│ [新規配信] [配信履歴]                       │
├─────────────────────────────────────────────┤
│                                               │
│ ■ 対象者の絞り込み                          │
│                                               │
│ スタンプ数                                   │
│ 最小 [____] 個  最大 [____] 個              │
│                                               │
│ 最終来院からの日数                          │
│ 最小 [____] 日  最大 [____] 日              │
│                                               │
│ 表示モード                                   │
│ [全員 ▼]                                    │
│                                               │
│ ☑ LINE友だち登録済みのみ                   │
│                                               │
│ [対象者を確認] ボタン                       │
│                                               │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━            │
│ 対象者: 45名                                │
│ 推定メッセージ通数: 45通                    │
│                                               │
│ 【対象者プレビュー】                        │
│ 1. 山田太郎 (スタンプ: 15個)               │
│ 2. 佐藤花子 (スタンプ: 18個)               │
│ ...                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━            │
│                                               │
│ ■ メッセージ                                │
│                                               │
│ 定型テンプレート: [定期検診のご案内 ▼]     │
│                                               │
│ ┌───────────────────────────────┐   │
│ │ {name}様                              │   │
│ │                                       │   │
│ │ いつもありがとうございます。          │   │
│ │ そろそろ定期検診の時期です。          │   │
│ │                                       │   │
│ └───────────────────────────────┘   │
│                                               │
│ 変数: [{name}] [{stamp_count}] [{ticket_number}] │
│ 文字数: 68 / 1000                            │
│                                               │
│ [45名に送信] ボタン                          │
│                                               │
└─────────────────────────────────────────────┘
```

---

## 9. 実装の優先順位

### ステップ1: データベース・型定義
- [x] `broadcast_logs` テーブル作成
- [x] TypeScript型定義

### ステップ2: バックエンドAPI
- [ ] `/api/broadcast/preview`
- [ ] `/api/broadcast/send`
- [ ] `/api/broadcast/logs`

### ステップ3: フロントエンド
- [ ] `/admin/broadcast` ページ作成
- [ ] 新規配信タブUI
- [ ] 配信履歴タブUI

### ステップ4: テスト
- [ ] セグメント抽出のテスト
- [ ] 変数置換のテスト
- [ ] 実際のLINE送信テスト

---

## 10. 環境変数

`.env.local` に以下を設定：

```env
# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN=your-long-lived-access-token

# または
LINE_CHANNEL_ID=your-channel-id
LINE_CHANNEL_SECRET=your-channel-secret
```

---

最終更新: 2026-02-14
