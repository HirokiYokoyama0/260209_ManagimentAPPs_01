# 86_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨_ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´

**ä½œæˆæ—¥:** 2026-02-25
**å¯¾è±¡:** ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆAdmin Dashboardï¼‰
**ç›®çš„:** ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé…ä¿¡ãƒ»çµæœé›†è¨ˆæ©Ÿèƒ½ã®å®Ÿè£…

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:** [85_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨.md](85_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ä»•æ§˜æ¤œè¨.md)

---

## ğŸ“‹ ç›®æ¬¡

1. [æ©Ÿèƒ½æ¦‚è¦](#1-æ©Ÿèƒ½æ¦‚è¦)
2. [ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé…ä¿¡ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½](#2-ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé…ä¿¡ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½)
3. [LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã®åˆ¶å¾¡](#3-liffã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã®åˆ¶å¾¡)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#4-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
5. [ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢è¨­è¨ˆ](#5-ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢è¨­è¨ˆ)
6. [å®Ÿè£…ãƒ•ãƒ­ãƒ¼](#6-å®Ÿè£…ãƒ•ãƒ­ãƒ¼)
7. [ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®é›†è¨ˆãƒ»å¯è¦–åŒ–](#7-ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®é›†è¨ˆå¯è¦–åŒ–)
8. [LINEé€£æºï¼ˆè‡ªå‹•é…ä¿¡ï¼‰](#8-lineé€£æºè‡ªå‹•é…ä¿¡)
9. [ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ä¾‹](#9-ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ä¾‹)

---

## 1. æ©Ÿèƒ½æ¦‚è¦

### 1.1 å®Ÿç¾ã§ãã‚‹ã“ã¨

| æ©Ÿèƒ½ | èª¬æ˜ | å®Ÿç¾å¯èƒ½æ€§ |
|------|------|-----------|
| **ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é…ä¿¡** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€Œã“ã®äººã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¦‹ã›ã‚‹ã€ã‚’é¸æŠ | âœ… å®Œå…¨ã«å¯èƒ½ |
| **LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤º** | ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸç¬é–“ã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«/ç”»é¢é·ç§»ã§è¡¨ç¤º | âœ… å®Œå…¨ã«å¯èƒ½ |
| **æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°** | ã€Œæœ€çµ‚æ¥é™¢æ—¥ãŒ30æ—¥ä»¥å†…ã€ã€Œã‚¹ã‚¿ãƒ³ãƒ—æ•°ãŒ5å€‹ä»¥ä¸Šã€ãªã©ã§è‡ªå‹•æŠ½å‡º | âœ… å®Œå…¨ã«å¯èƒ½ |
| **LINEè‡ªå‹•é…ä¿¡é€£æº** | ã€Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå¯¾è±¡è€…ã«LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ–‰é€ä¿¡ã€ | âœ… å¯èƒ½ï¼ˆMessaging APIï¼‰ |
| **å›ç­”çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª** | ã€Œèª°ãŒå›ç­”æ¸ˆã¿/æœªå›ç­”ã‹ã€ã‚’ä¸€è¦§è¡¨ç¤º | âœ… å®Œå…¨ã«å¯èƒ½ |
| **çµæœã®é›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•åŒ–** | å›ç­”å†…å®¹ã‚’è‡ªå‹•é›†è¨ˆã—ã¦ã‚°ãƒ©ãƒ•è¡¨ç¤º | âœ… å®Œå…¨ã«å¯èƒ½ |

### 1.2 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆç”»é¢                              â”‚   â”‚
â”‚  â”‚    - ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜æ–‡ã€å ±é…¬ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’è¨­å®š         â”‚   â”‚
â”‚  â”‚    - è³ªå•å†…å®¹ï¼ˆJSONBå½¢å¼ï¼‰ã‚’å…¥åŠ›                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. é…ä¿¡å¯¾è±¡è€…é¸æŠç”»é¢                              â”‚   â”‚
â”‚  â”‚    - å…¨å“¡ / æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ / å€‹åˆ¥é¸æŠ                â”‚   â”‚
â”‚  â”‚    - ãƒ•ã‚£ãƒ«ã‚¿ä¾‹: æœ€çµ‚æ¥é™¢æ—¥ã€ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã€å¹´é½¢å±¤     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. é…ä¿¡è¨­å®š                                       â”‚   â”‚
â”‚  â”‚    - LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤º: ON/OFF                   â”‚   â”‚
â”‚  â”‚    - LINEè‡ªå‹•é…ä¿¡: ON/OFF                         â”‚   â”‚
â”‚  â”‚    - é…ä¿¡æœŸé–“: é–‹å§‹æ—¥ã€œçµ‚äº†æ—¥                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. å›ç­”çŠ¶æ³ä¸€è¦§                                    â”‚   â”‚
â”‚  â”‚    - é…ä¿¡å¯¾è±¡è€…ãƒªã‚¹ãƒˆï¼ˆå›ç­”æ¸ˆã¿/æœªå›ç­”ï¼‰            â”‚   â”‚
â”‚  â”‚    - å›ç­”ç‡ã®è¡¨ç¤º                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 5. çµæœé›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•                                â”‚   â”‚
â”‚  â”‚    - è©•ä¾¡åˆ†å¸ƒï¼ˆæ˜Ÿè©•ä¾¡ã®ã‚°ãƒ©ãƒ•ï¼‰                     â”‚   â”‚
â”‚  â”‚    - NPSè¨ˆç®—ï¼ˆæ¨å¥¨è€… - æ‰¹åˆ¤è€…ï¼‰                    â”‚   â”‚
â”‚  â”‚    - è‡ªç”±è¨˜è¿°ã®ä¸€è¦§                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Database                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ surveys ãƒ†ãƒ¼ãƒ–ãƒ«                                   â”‚   â”‚
â”‚  â”‚  - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®šç¾©ï¼ˆè³ªå•å†…å®¹ã€å ±é…¬ãªã©ï¼‰              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ survey_targets ãƒ†ãƒ¼ãƒ–ãƒ«                            â”‚   â”‚
â”‚  â”‚  - é…ä¿¡å¯¾è±¡è€…ï¼ˆuser_id + survey_idï¼‰               â”‚   â”‚
â”‚  â”‚  - è¡¨ç¤ºçŠ¶æ…‹ï¼ˆshow_on_liff_openï¼‰                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ survey_answers ãƒ†ãƒ¼ãƒ–ãƒ«                            â”‚   â”‚
â”‚  â”‚  - å›ç­”ãƒ‡ãƒ¼ã‚¿                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LIFFã‚¢ãƒ—ãƒªï¼ˆæ‚£è€…å´ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®å‡¦ç†                                  â”‚   â”‚
â”‚  â”‚ 1. survey_targets ã‚’ç¢ºèª                          â”‚   â”‚
â”‚  â”‚ 2. show_on_liff_open = true ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ï¼Ÿ  â”‚   â”‚
â”‚  â”‚    - YES â†’ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º             â”‚   â”‚
â”‚  â”‚    - NO  â†’ é€šå¸¸ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã¸                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé…ä¿¡ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½

### 2.1 é…ä¿¡å¯¾è±¡è€…ã®é¸æŠæ–¹æ³•

#### â‘  å…¨å“¡é…ä¿¡
```sql
-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ã«è¨­å®š
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'satisfaction_2026Q1', true
from profiles;
-- â€» is_active ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„ãŸã‚æ¡ä»¶ãªã—
```

#### â‘¡ æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿é…ä¿¡
```sql
-- ä¾‹: æœ€çµ‚æ¥é™¢æ—¥ãŒ30æ—¥ä»¥å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'satisfaction_2026Q1', true
from profiles
where last_visit_date >= now() - interval '30 days';
-- â€» profiles.last_visit_date ã‚’ä½¿ç”¨ï¼ˆä¸è¦ãªJOINã‚’é¿ã‘ã‚‹ï¼‰

-- ä¾‹: ã‚¹ã‚¿ãƒ³ãƒ—æ•°ãŒ5å€‹ä»¥ä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'satisfaction_2026Q1', true
from profiles
where stamp_count >= 50;  -- â˜… stamp_countï¼ˆè¤‡æ•°å½¢ãªã—ï¼‰: 5å€‹ = 50pt

-- â€» å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ã¯Phase 1ã§ã¯æœªå®Ÿè£…ï¼ˆage ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ï¼‰
-- å°†æ¥å®Ÿè£…ã™ã‚‹å ´åˆã¯ birth_date ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã€å¹´é½¢ã‚’è¨ˆç®—
```

#### â‘¢ å€‹åˆ¥é¸æŠé…ä¿¡
```sql
-- ç®¡ç†ç”»é¢ã§é¸æŠã•ã‚ŒãŸç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
insert into survey_targets (user_id, survey_id, show_on_liff_open)
values
  ('user_001', 'satisfaction_2026Q1', true),
  ('user_002', 'satisfaction_2026Q1', true),
  ('user_003', 'satisfaction_2026Q1', true);
```

### 2.2 é…ä¿¡å¯¾è±¡è€…ã®æ¡ä»¶ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã€Œã‚ˆãä½¿ã†æ¡ä»¶ã€ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ç”¨æ„:

| ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå | æ¡ä»¶ | ç”¨é€” |
|--------------|------|------|
| **æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼** | ç™»éŒ²å¾Œ7æ—¥ä»¥å†… | åˆå›ä½“é¨“ã®æº€è¶³åº¦èª¿æŸ» |
| **ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼** | ã‚¹ã‚¿ãƒ³ãƒ—10å€‹ä»¥ä¸Š | ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£èª¿æŸ» |
| **ä¼‘çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼** | æœ€çµ‚æ¥é™¢æ—¥ãŒ90æ—¥ä»¥ä¸Šå‰ | é›¢è„±ç†ç”±ã®èª¿æŸ» |
| **æœ€è¿‘æ¥é™¢ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼** | æœ€çµ‚æ¥é™¢æ—¥ãŒ7æ—¥ä»¥å†… | ç›´è¿‘ã®æ²»ç™‚æº€è¶³åº¦èª¿æŸ» |
| **ç‰¹å®šå¹´é½¢å±¤** | å¹´é½¢ãŒ20-30ä»£ | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã®æ„è¦‹åé›†ï¼ˆPhase 1 ã§ã¯æœªå®Ÿè£…ãƒ»`age` ãªã—ï¼‰ |
| **LINEæœªèª­ãƒ¦ãƒ¼ã‚¶ãƒ¼** | ã‚¢ãƒ—ãƒªèµ·å‹•ãŒ30æ—¥ä»¥ä¸Šãªã— | ä¼‘çœ ç†ç”±ã®èª¿æŸ»ï¼ˆPhase 1 ã§ã¯æœªä½¿ç”¨ï¼‰ |

---

## 3. LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã®åˆ¶å¾¡

### 3.1 ä»•çµ„ã¿

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLIFFã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸç¬é–“ã«ã€ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå‹•ã:**

```typescript
// app/page.tsx ã¾ãŸã¯ app/layout.tsx
useEffect(() => {
  const checkPendingSurvey = async () => {
    // 1. ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    const userId = profile.id;

    // 2. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€Œè¡¨ç¤ºã™ã¹ãã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã€ãŒã‚ã‚‹ã‹ç¢ºèª
    const { data: targets } = await supabase
      .from('survey_targets')
      .select('survey_id, surveys(*)')
      .eq('user_id', userId)
      .eq('show_on_liff_open', true)
      .is('answered_at', null)  // ã¾ã å›ç­”ã—ã¦ã„ãªã„
      .eq('surveys.is_active', true);  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒå…¬é–‹ä¸­

    if (targets && targets.length > 0) {
      // 3. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const survey = targets[0];  // æœ€åˆã®1ã¤ã‚’è¡¨ç¤º
      setSurveyModal({
        isOpen: true,
        surveyId: survey.survey_id,
        title: survey.surveys.title,
      });
    }
  };

  checkPendingSurvey();
}, []);
```

### 3.2 è¡¨ç¤ºãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆæ¨å¥¨ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆèƒŒæ™¯ï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¥ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ãŠé¡˜ã„          â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚ å½“é™¢ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦         â”‚  â”‚
â”‚  â”‚ ãŠèã‹ã›ãã ã•ã„              â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚ âœ… å›ç­”ã§ã‚¹ã‚¿ãƒ³ãƒ—3å€‹ï¼         â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚ [ ä»Šã™ãå›ç­” ] [ ã‚ã¨ã§ ]     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… å¼·åˆ¶æ„ŸãŒãªã„ï¼ˆã€Œã‚ã¨ã§ã€ã§é–‰ã˜ã‚‰ã‚Œã‚‹ï¼‰
- âœ… æ—¢å­˜ã®ç”»é¢é·ç§»ã‚’ä¹±ã•ãªã„
- âœ… å›ç­”ç‡ãŒé«˜ã„ï¼ˆç›®ã«å…¥ã‚‹ç¢ºç‡100%ï¼‰

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: ç”»é¢é·ç§»ï¼ˆå¼·åˆ¶ï¼‰
```
ã‚¢ãƒ—ãƒªèµ·å‹• â†’ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã«ç›´æ¥é·ç§» â†’ å›ç­”å®Œäº† â†’ ãƒ›ãƒ¼ãƒ ç”»é¢
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… å›ç­”ç‡ãŒæœ€ã‚‚é«˜ã„
- âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒã‚„ã‚„æ‚ªåŒ–ï¼ˆå¼·åˆ¶æ„Ÿï¼‰

**æ¨å¥¨:** ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã‚’æ¡ç”¨

### 3.3 ã€Œã‚ã¨ã§ã€ãƒœã‚¿ãƒ³ã®æŒ™å‹•

```typescript
// ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ãŸå ´åˆï¼ˆ87 ã®å¯¾å¿œæ–¹é‡: RPC ã§ä¸€æ‹¬æ›´æ–°ï¼‰
const handleLater = async () => {
  await supabase.rpc('increment_survey_postponed', {
    p_user_id: userId,   // profiles.id
    p_survey_id: surveyId,
  });
  setSurveyModal({ isOpen: false });
};
```

**é‹ç”¨ãƒ«ãƒ¼ãƒ«ä¾‹:**
- ã€Œã‚ã¨ã§ã€ã‚’3å›æŠ¼ã—ãŸã‚‰ã€ãã‚Œä»¥é™ã¯è¡¨ç¤ºã—ãªã„ï¼ˆã—ã¤ã“ãã—ãªã„ï¼‰
- ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰24æ™‚é–“å¾Œã«å†è¡¨ç¤º

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 4.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `survey_targets`

```sql
create table survey_targets (
  id uuid primary key default gen_random_uuid(),
  user_id text not null references profiles(id) on delete cascade,
  survey_id text not null references surveys(id) on delete cascade,

  -- è¡¨ç¤ºåˆ¶å¾¡
  show_on_liff_open boolean not null default false,  -- LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã™ã‚‹ã‹

  -- å›ç­”çŠ¶æ³
  answered_at timestamptz,  -- å›ç­”å®Œäº†æ—¥æ™‚ï¼ˆNULLãªã‚‰æœªå›ç­”ï¼‰

  -- å¾Œå›ã—ã‚«ã‚¦ãƒ³ãƒˆ
  postponed_count integer not null default 0,  -- ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ãŸå›æ•°
  last_postponed_at timestamptz,  -- æœ€å¾Œã«ã€Œã‚ã¨ã§ã€ã‚’æŠ¼ã—ãŸæ—¥æ™‚

  -- ãƒ¡ã‚¿æƒ…å ±
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),

  -- é‡è¤‡é˜²æ­¢
  unique(user_id, survey_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
create index idx_survey_targets_user_id on survey_targets(user_id);
create index idx_survey_targets_survey_id on survey_targets(survey_id);
create index idx_survey_targets_show_on_liff on survey_targets(show_on_liff_open) where show_on_liff_open = true;
create index idx_survey_targets_answered on survey_targets(answered_at);

-- RLSãƒãƒªã‚·ãƒ¼
alter table survey_targets enable row level security;

-- anon keyã§å…¨ä»¶å‚ç…§ãƒ»æ›´æ–°å¯èƒ½ï¼ˆã‚¢ãƒ—ãƒªå±¤ã§user_idãƒ•ã‚£ãƒ«ã‚¿ï¼‰
create policy "anon_can_read_survey_targets"
  on survey_targets for select
  using (true);

create policy "anon_can_update_survey_targets"
  on survey_targets for update
  using (true);

-- ç®¡ç†è€…ï¼ˆSERVICE_ROLEï¼‰ã¯å…¨ä»¶æ“ä½œå¯èƒ½ï¼ˆRLSãƒã‚¤ãƒ‘ã‚¹ï¼‰
-- â€» service_role key ã¯RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã€ãƒãƒªã‚·ãƒ¼ä¸è¦
```

### 4.2 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µ: `surveys`

```sql
-- surveys ãƒ†ãƒ¼ãƒ–ãƒ«ã«é…ä¿¡é–¢é€£ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
alter table surveys add column if not exists
  auto_send_line boolean not null default false;  -- LINEè‡ªå‹•é…ä¿¡ã™ã‚‹ã‹

alter table surveys add column if not exists
  line_message_template jsonb;  -- LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

-- ä¾‹
update surveys set
  auto_send_line = true,
  line_message_template = '{
    "type": "flex",
    "altText": "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ãŠé¡˜ã„",
    "contents": {...}
  }'::jsonb
where id = 'satisfaction_2026Q1';
```

### 4.3 ãƒ“ãƒ¥ãƒ¼: é…ä¿¡å¯¾è±¡è€…ã®ä¸€è¦§

```sql
-- ç®¡ç†ç”»é¢ã§ã€Œèª°ãŒå›ç­”æ¸ˆã¿/æœªå›ç­”ã‹ã€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ“ãƒ¥ãƒ¼
create view survey_target_status as
select
  st.id,
  st.survey_id,
  s.title as survey_title,
  st.user_id,
  p.real_name,
  p.display_name,  -- â˜… display_nameï¼ˆline_display_name ã§ã¯ãªã„ï¼‰
  st.show_on_liff_open,
  st.answered_at,
  case
    when st.answered_at is not null then 'å›ç­”æ¸ˆã¿'
    else 'æœªå›ç­”'
  end as status,
  st.postponed_count,
  st.last_postponed_at,
  st.created_at
from survey_targets st
join surveys s on st.survey_id = s.id
join profiles p on st.user_id = p.id
order by st.created_at desc;
-- â€» PostgreSQL ã§ã¯ VIEW ã® ORDER BY ã¯çµæœé †ã‚’ä¿è¨¼ã—ãªã„ã€‚åˆ©ç”¨å´ï¼ˆAPIï¼‰ã§ .order('created_at', { ascending: false }) ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã€‚
```

---

## 5. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢è¨­è¨ˆ

### 5.1 ç”»é¢æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ ] [ æ–°è¦ä½œæˆ ] [ é…ä¿¡è¨­å®š ] [ çµæœé›†è¨ˆ ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID              | ã‚¿ã‚¤ãƒˆãƒ«         | é…ä¿¡å¯¾è±¡ | å›ç­”ç‡    â”‚
â”‚ satisfaction_Q1 | æº€è¶³åº¦èª¿æŸ» 2æœˆ   | 120äºº   | 45% (54) â”‚
â”‚ event_feedback  | ã‚¤ãƒ™ãƒ³ãƒˆæ„Ÿæƒ³     | 30äºº    | 80% (24) â”‚
â”‚                                                          â”‚
â”‚ [ + æ–°è¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆ ]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. é…ä¿¡å¯¾è±¡è€…é¸æŠï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ: æº€è¶³åº¦èª¿æŸ» 2æœˆï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é…ä¿¡æ–¹æ³•:                                                 â”‚
â”‚ â—‹ å…¨å“¡é…ä¿¡                                               â”‚
â”‚ â— æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿                                            â”‚
â”‚ â—‹ å€‹åˆ¥é¸æŠ                                               â”‚
â”‚                                                          â”‚
â”‚ â”€â”€ æ¡ä»¶è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ æœ€çµ‚æ¥é™¢æ—¥: [ 30æ—¥ä»¥å†… â–¼ ]                               â”‚
â”‚ ã‚¹ã‚¿ãƒ³ãƒ—æ•°: [ 5å€‹ä»¥ä¸Š â–¼ ]                                â”‚
â”‚ å¹´é½¢å±¤:     [ æŒ‡å®šãªã— â–¼ ]                               â”‚
â”‚                                                          â”‚
â”‚ âœ… è©²å½“è€…: 120äºº                                          â”‚
â”‚                                                          â”‚
â”‚ [ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ] [ é…ä¿¡è¨­å®šã¸ ]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. é…ä¿¡è¨­å®š                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤º: ON                                 â”‚
â”‚    â†’ ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸç¬é–“ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º                      â”‚
â”‚                                                          â”‚
â”‚ â˜ LINEè‡ªå‹•é…ä¿¡: OFF                                      â”‚
â”‚    â†’ é…ä¿¡å¯¾è±¡è€…ã«LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ–‰é€ä¿¡                  â”‚
â”‚                                                          â”‚
â”‚ é…ä¿¡æœŸé–“:                                                 â”‚
â”‚ é–‹å§‹æ—¥: [ 2026-02-25 ]                                   â”‚
â”‚ çµ‚äº†æ—¥: [ 2026-03-10 ]                                   â”‚
â”‚                                                          â”‚
â”‚ [ ã‚­ãƒ£ãƒ³ã‚»ãƒ« ] [ é…ä¿¡é–‹å§‹ ]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å›ç­”çŠ¶æ³ä¸€è¦§                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å  | å›ç­”çŠ¶æ³ | å¾Œå›ã—å›æ•° | æœ€çµ‚æ“ä½œæ—¥æ™‚         â”‚
â”‚ ç”°ä¸­å¤ªéƒ    | å›ç­”æ¸ˆã¿ | 0å›       | 2026-02-25 10:30    â”‚
â”‚ ä½è—¤èŠ±å­    | æœªå›ç­”   | 2å›       | 2026-02-24 18:00    â”‚
â”‚ éˆ´æœ¨ä¸€éƒ    | æœªå›ç­”   | 0å›       | -                   â”‚
â”‚                                                          â”‚
â”‚ å›ç­”ç‡: 45% (54 / 120äºº)                                 â”‚
â”‚                                                          â”‚
â”‚ [ CSVå‡ºåŠ› ]                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç”»é¢ãƒ•ãƒ­ãƒ¼

```
1. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆ
   â†“
2. é…ä¿¡å¯¾è±¡è€…é¸æŠï¼ˆå…¨å“¡/æ¡ä»¶/å€‹åˆ¥ï¼‰
   â†“
3. é…ä¿¡è¨­å®šï¼ˆLIFFåˆæœŸè¡¨ç¤º ON/OFFã€LINEé…ä¿¡ ON/OFFï¼‰
   â†“
4. é…ä¿¡é–‹å§‹ï¼ˆsurvey_targets ã«ãƒ¬ã‚³ãƒ¼ãƒ‰æŒ¿å…¥ï¼‰
   â†“
5. å›ç­”çŠ¶æ³ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
   â†“
6. çµæœé›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º
```

---

## 6. å®Ÿè£…ãƒ•ãƒ­ãƒ¼

### 6.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ï¼‰

**æ³¨:** æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æœ€æ–°æ§‹æˆã«åˆã‚ã›ã‚‹ã€‚
- **ç”»é¢:** ç®¡ç†æ©Ÿèƒ½ã¯ `app/admin/` é…ä¸‹ï¼ˆæ‚£è€…ä¸€è¦§ãƒ»åˆ†æãƒ»ä¸€æ–‰é…ä¿¡ãƒ»ç‰¹å…¸äº¤æ›ãƒ»ãƒ­ã‚°ç­‰ã¨åŒæ§˜ï¼‰ã€‚
- **API:** æ—¢å­˜ã¨åŒæ§˜ã« `app/api/` é…ä¸‹ã«é…ç½®ï¼ˆ`app/api/profiles`ãƒ»`app/api/broadcast`ãƒ»`app/api/activity-logs` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã€‚

```
app/
â”œâ”€â”€ admin/                         # ç®¡ç†ç”»é¢ãƒ«ãƒ¼ãƒˆï¼ˆæ—¢å­˜: /admin, /admin/analysis ç­‰ï¼‰
â”‚   â””â”€â”€ surveys/
â”‚       â”œâ”€â”€ page.tsx               # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§
â”‚       â”œâ”€â”€ [surveyId]/
â”‚       â”‚   â”œâ”€â”€ page.tsx           # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè©³ç´°
â”‚       â”‚   â”œâ”€â”€ targets/
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx       # é…ä¿¡å¯¾è±¡è€…é¸æŠ
â”‚       â”‚   â”œâ”€â”€ results/
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx       # çµæœé›†è¨ˆ
â”‚       â””â”€â”€ new/
â”‚           â””â”€â”€ page.tsx           # æ–°è¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆ
â”œâ”€â”€ api/                           # æ—¢å­˜APIã¨åŒæ§˜ï¼ˆapp/api/profiles, broadcast ç­‰ï¼‰
â”‚   â””â”€â”€ surveys/
â”‚       â”œâ”€â”€ create/
â”‚       â”‚   â””â”€â”€ route.ts           # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆAPI
â”‚       â”œâ”€â”€ targets/
â”‚       â”‚   â”œâ”€â”€ create/
â”‚       â”‚   â”‚   â””â”€â”€ route.ts      # é…ä¿¡å¯¾è±¡è€…è¨­å®šAPI
â”‚       â”‚   â””â”€â”€ list/
â”‚       â”‚       â””â”€â”€ route.ts      # é…ä¿¡å¯¾è±¡è€…ä¸€è¦§API
â”‚       â”œâ”€â”€ results/
â”‚       â”‚   â””â”€â”€ route.ts          # çµæœé›†è¨ˆAPI
â”‚       â””â”€â”€ send-line/
â”‚           â””â”€â”€ route.ts          # LINEä¸€æ–‰é€ä¿¡ï¼ˆPhase 5ï¼‰
components/
â”œâ”€â”€ surveys/
â”‚   â”œâ”€â”€ SurveyList.tsx            # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ TargetSelector.tsx        # é…ä¿¡å¯¾è±¡è€…é¸æŠã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ ConditionFilter.tsx       # æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ DistributionSettings.tsx  # é…ä¿¡è¨­å®šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ ResultsChart.tsx          # çµæœã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```

### 6.2 APIå®Ÿè£…ä¾‹

#### â‘  é…ä¿¡å¯¾è±¡è€…è¨­å®šAPI

**`app/api/surveys/targets/create/route.ts`** ï¼ˆæ—¢å­˜ã® `app/api/families`ãƒ»`app/api/activity-logs` ã¨åŒæ§˜ã« `app/api/` é…ä¸‹ï¼‰
```typescript
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    // â˜… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨APIã¯ service_role ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆfamilies, activity-logs ã¨åŒæ§˜ï¼‰
    const supabase = createSupabaseAdminClient();

    // â€» ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼ã¯æ—¢å­˜ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§å®Ÿæ–½æ¸ˆã¿
    const body = await request.json();
    const {
      surveyId,
      targetType,  // 'all' | 'filter' | 'manual'
      filterConditions,  // { lastVisitDays: 30, minStamps: 5, ... }
      manualUserIds,  // ['user_001', 'user_002', ...]
      showOnLiffOpen,
    } = body;

    let targetUserIds: string[] = [];

    // é…ä¿¡å¯¾è±¡è€…ã®æŠ½å‡º
    if (targetType === 'all') {
      // å…¨å“¡ï¼ˆis_active ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„ï¼‰
      const { data: users } = await supabase
        .from('profiles')
        .select('id');
      targetUserIds = users?.map((u) => u.id) || [];

    } else if (targetType === 'filter') {
      // æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿
      let query = supabase.from('profiles').select('id');

      if (filterConditions.lastVisitDays) {
        // æœ€çµ‚æ¥é™¢æ—¥ãƒ•ã‚£ãƒ«ã‚¿
        query = query.gte(
          'last_visit_date',
          new Date(Date.now() - filterConditions.lastVisitDays * 24 * 60 * 60 * 1000).toISOString()
        );
      }

      if (filterConditions.minStamps) {
        // ã‚¹ã‚¿ãƒ³ãƒ—æ•°ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆ10å€æ•´æ•°ã€â˜… stamp_count ã«ä¿®æ­£ï¼‰
        query = query.gte('stamp_count', filterConditions.minStamps * 10);
      }

      // å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ã¯ Phase 1 ã§ã¯æœªå®Ÿè£…ï¼ˆage ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ï¼‰
      // if (filterConditions.ageMin || filterConditions.ageMax) {
      //   if (filterConditions.ageMin) query = query.gte('age', filterConditions.ageMin);
      //   if (filterConditions.ageMax) query = query.lte('age', filterConditions.ageMax);
      // }

      const { data: users } = await query;
      targetUserIds = users?.map((u) => u.id) || [];

    } else if (targetType === 'manual') {
      // å€‹åˆ¥é¸æŠ
      targetUserIds = manualUserIds;
    }

    // survey_targets ã«æŒ¿å…¥
    const targets = targetUserIds.map((userId) => ({
      user_id: userId,
      survey_id: surveyId,
      show_on_liff_open: showOnLiffOpen,
    }));

    const { error } = await supabase
      .from('survey_targets')
      .insert(targets);

    if (error) throw error;

    return NextResponse.json({
      success: true,
      targetCount: targetUserIds.length,
    });
  } catch (error) {
    console.error('Create survey targets error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

#### â‘¡ å›ç­”çŠ¶æ³ä¸€è¦§API

**`app/api/surveys/targets/list/route.ts`**
```typescript
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  try {
    const supabase = createSupabaseAdminClient();
    const { searchParams } = new URL(request.url);
    const surveyId = searchParams.get('surveyId');

    if (!surveyId) {
      return NextResponse.json({ error: 'surveyId required' }, { status: 400 });
    }

    // survey_target_status ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—
    const { data: targets, error } = await supabase
      .from('survey_target_status')
      .select('*')
      .eq('survey_id', surveyId)
      .order('created_at', { ascending: false });

    if (error) throw error;

    // å›ç­”ç‡è¨ˆç®—
    const totalCount = targets?.length || 0;
    const answeredCount = targets?.filter((t) => t.answered_at).length || 0;
    const answerRate = totalCount > 0 ? (answeredCount / totalCount) * 100 : 0;

    return NextResponse.json({
      targets,
      stats: {
        totalCount,
        answeredCount,
        unansweredCount: totalCount - answeredCount,
        answerRate: Math.round(answerRate),
      },
    });
  } catch (error) {
    console.error('List survey targets error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### 6.3 LIFFã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…

**æ³¨:** ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **Supabase Auth ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“**ï¼ˆ87 ã®èªè¨¼æ–¹é‡ã«æº–æ‹ ï¼‰ã€‚LIFF ã§ã¯ LINE ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ã§ã€`survey_targets.user_id` ã¯ **`profiles.id`** ã‚’æŒ‡ã™ã€‚

- **é‡è¦:** LINE SDK ã® `userId` ã¯ **`profiles.line_user_id`** ã«ç›¸å½“ã™ã‚‹ã€‚`survey_targets.user_id` ã¯ **`profiles.id`**ï¼ˆPKï¼‰ã®ãŸã‚ã€LIFF å´ã§ã¯ã€ŒLINE user id â†’ profiles.id ã®è§£æ±ºã€ãŒå¿…è¦ã€‚
- è§£æ±ºæ–¹æ³•ã®ä¾‹: (1) æ—¢å­˜ã® LIFF ç”¨ APIï¼ˆä¾‹: `/api/users/me`ï¼‰ã§ `line_user_id` ã‚’æ¸¡ã— `profiles.id` ã‚’è¿”ã™ã€(2) anon ã§ `profiles` ã‚’ `line_user_id = liffUserId` ã§ 1 ä»¶å–å¾—ã— `id` ã‚’ä½¿ã†ã€‚ä»¥ä¸‹ã¯ã€Œæ—¢ã«ã‚¢ãƒ—ãƒªå†…ã§ `profile.id`ï¼ˆprofiles.idï¼‰ã‚’ä¿æŒã—ã¦ã„ã‚‹ã€å‰æã®ä¾‹ã€‚

**`app/layout.tsx` ã¾ãŸã¯ `app/page.tsx`**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useLiff } from '@/hooks/useLiff';
import { supabase } from '@/lib/supabase';
import SurveyModal from '@/components/survey/SurveyModal';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  const { profile } = useLiff(); // LINE ã® userId + ã‚¢ãƒ—ãƒªç”¨ profileï¼ˆprofiles.id ã‚’ä¿æŒã—ã¦ã„ã‚‹æƒ³å®šï¼‰
  const [surveyModal, setSurveyModal] = useState<{
    isOpen: boolean;
    surveyId: string;
    title: string;
  } | null>(null);

  useEffect(() => {
    if (profile?.id) {
      checkPendingSurvey();
    }
  }, [profile?.id]);

  const checkPendingSurvey = async () => {
    try {
      // â˜… survey_targets.user_id ã¯ profiles.idï¼ˆPKï¼‰ã€‚LINE userId ã®å ´åˆã¯äº‹å‰ã« profiles.id ã«è§£æ±ºã™ã‚‹ã“ã¨
      if (!profile?.id) return;

      const { data: targets } = await supabase
        .from('survey_targets')
        .select(`
          survey_id,
          surveys (
            id,
            title,
            description,
            reward_stamps
          )
        `)
        .eq('user_id', profile.id)
        .eq('show_on_liff_open', true)
        .is('answered_at', null)
        .eq('surveys.is_active', true)
        .lt('postponed_count', 3);

      if (targets && targets.length > 0) {
        const target = targets[0];
        setSurveyModal({
          isOpen: true,
          surveyId: target.survey_id,
          title: target.surveys.title,
        });
      }
    } catch (error) {
      console.error('Failed to check pending survey:', error);
    }
  };

  const handleSurveyComplete = () => {
    setSurveyModal(null);
  };

  const handleSurveyLater = async () => {
    if (!surveyModal || !profile?.id) return;

    await supabase.rpc('increment_survey_postponed', {
      p_user_id: profile.id,
      p_survey_id: surveyModal.surveyId,
    });

    setSurveyModal(null);
  };

  return (
    <>
      {children}
      {surveyModal && (
        <SurveyModal
          isOpen={surveyModal.isOpen}
          surveyId={surveyModal.surveyId}
          title={surveyModal.title}
          onComplete={handleSurveyComplete}
          onLater={handleSurveyLater}
        />
      )}
    </>
  );
}
```

**`components/survey/SurveyModal.tsx`**
```typescript
'use client';

import { useRouter } from 'next/navigation';

interface SurveyModalProps {
  isOpen: boolean;
  surveyId: string;
  title: string;
  onComplete: () => void;
  onLater: () => void;
}

export default function SurveyModal({
  isOpen,
  surveyId,
  title,
  onComplete,
  onLater,
}: SurveyModalProps) {
  const router = useRouter();

  if (!isOpen) return null;

  const handleStart = () => {
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã«é·ç§»
    router.push(`/survey/${surveyId}`);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h2 className="text-xl font-bold mb-2">ğŸ¥ {title}</h2>
        <p className="text-sm text-gray-600 mb-4">
          å½“é™¢ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ãŠèã‹ã›ãã ã•ã„
        </p>

        <div className="bg-green-50 p-3 rounded-lg mb-6">
          <p className="text-sm text-green-800">
            âœ… å›ç­”ã„ãŸã ãã¨ã‚¹ã‚¿ãƒ³ãƒ—3å€‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼
          </p>
        </div>

        <div className="flex gap-3">
          <button
            onClick={onLater}
            className="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700"
          >
            ã‚ã¨ã§
          </button>
          <button
            onClick={handleStart}
            className="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold"
          >
            ä»Šã™ãå›ç­”
          </button>
        </div>
      </div>
    </div>
  );
}
```

---

## 7. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®é›†è¨ˆãƒ»å¯è¦–åŒ–

### 7.1 é›†è¨ˆAPI

**`app/api/surveys/results/route.ts`**
```typescript
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const supabase = createSupabaseAdminClient();
  const { searchParams } = new URL(request.url);
  const surveyId = searchParams.get('surveyId');

  // Q1ã®è©•ä¾¡åˆ†å¸ƒ
  const { data: q1Distribution } = await supabase
    .from('survey_answers')
    .select('q1_rating')
    .eq('survey_id', surveyId);

  const ratingCounts = {
    5: 0, 4: 0, 3: 0, 2: 0, 1: 0,
  };
  q1Distribution?.forEach((ans) => {
    if (ans.q1_rating) ratingCounts[ans.q1_rating]++;
  });

  // Q3ã®NPSè¨ˆç®—
  const { data: q3Data } = await supabase
    .from('survey_answers')
    .select('q3_recommend')
    .eq('survey_id', surveyId);

  const promoters = q3Data?.filter((ans) => ans.q3_recommend >= 9).length || 0;
  const detractors = q3Data?.filter((ans) => ans.q3_recommend <= 6).length || 0;
  const total = q3Data?.length || 0;
  const nps = total > 0 ? ((promoters - detractors) / total) * 100 : 0;

  // è‡ªç”±è¨˜è¿°
  const { data: comments } = await supabase
    .from('survey_answers')
    .select('q2_comment, created_at, profiles(real_name)')
    .eq('survey_id', surveyId)
    .not('q2_comment', 'is', null)
    .order('created_at', { ascending: false });

  return NextResponse.json({
    q1Distribution: ratingCounts,
    nps: Math.round(nps),
    comments,
  });
}
```

### 7.2 ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**`components/surveys/ResultsChart.tsx`**
```typescript
'use client';

import { Bar, Pie } from 'react-chartjs-2';

export default function ResultsChart({ results }: { results: any }) {
  // Q1ã®è©•ä¾¡åˆ†å¸ƒï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
  const barData = {
    labels: ['â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸', 'â­ï¸â­ï¸â­ï¸â­ï¸', 'â­ï¸â­ï¸â­ï¸', 'â­ï¸â­ï¸', 'â­ï¸'],
    datasets: [
      {
        label: 'å›ç­”æ•°',
        data: [
          results.q1Distribution[5],
          results.q1Distribution[4],
          results.q1Distribution[3],
          results.q1Distribution[2],
          results.q1Distribution[1],
        ],
        backgroundColor: '#4CAF50',
      },
    ],
  };

  return (
    <div>
      <h3 className="text-lg font-bold mb-4">Q1. æº€è¶³åº¦è©•ä¾¡</h3>
      <Bar data={barData} />

      <h3 className="text-lg font-bold mt-8 mb-4">NPSï¼ˆæ¨å¥¨åº¦ï¼‰</h3>
      <div className="text-4xl font-bold text-green-600 mb-2">
        {results.nps}
      </div>
      <p className="text-sm text-gray-600">
        æ¨å¥¨è€…ï¼ˆ9-10ç‚¹ï¼‰ã®å‰²åˆ - æ‰¹åˆ¤è€…ï¼ˆ0-6ç‚¹ï¼‰ã®å‰²åˆ
      </p>

      <h3 className="text-lg font-bold mt-8 mb-4">Q2. è‡ªç”±è¨˜è¿°</h3>
      <div className="space-y-3">
        {results.comments.map((comment: any, i: number) => (
          <div key={i} className="p-3 bg-gray-50 rounded">
            <p className="text-sm">{comment.q2_comment}</p>
            <p className="text-xs text-gray-500 mt-1">
              {comment.profiles.real_name} - {new Date(comment.created_at).toLocaleDateString()}
            </p>
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## 8. LINEé€£æºï¼ˆè‡ªå‹•é…ä¿¡ï¼‰

### 8.1 LINE Messaging API ã¨ã®é€£æº

```typescript
// app/api/surveys/send-line/route.ts
import { Client } from '@line/bot-sdk';
import { createSupabaseAdminClient } from '@/lib/supabase/server-admin';
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  const supabase = createSupabaseAdminClient();
  const body = await request.json();
  const { surveyId, targetUserIds } = body;

  const client = new Client({
    channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN!,
  });

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±å–å¾—
  const { data: survey } = await supabase
    .from('surveys')
    .select('*')
    .eq('id', surveyId)
    .single();

  // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®LINE IDã‚’å–å¾—
  const { data: profiles } = await supabase
    .from('profiles')
    .select('line_user_id')
    .in('id', targetUserIds);

  const lineUserIds = profiles?.map((p) => p.line_user_id) || [];

  // Flex Messageã‚’ä½œæˆ
  const message = {
    type: 'flex',
    altText: `${survey.title}ã®ãŠé¡˜ã„`,
    contents: {
      type: 'bubble',
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: `ğŸ“‹ ${survey.title}`,
            weight: 'bold',
            size: 'xl',
          },
          {
            type: 'text',
            text: survey.description,
            size: 'sm',
            color: '#666666',
            wrap: true,
          },
          {
            type: 'text',
            text: `âœ… å›ç­”ã§ã‚¹ã‚¿ãƒ³ãƒ—${survey.reward_stamps}å€‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼`,
            size: 'sm',
            color: '#00B900',
            weight: 'bold',
            margin: 'md',
          },
        ],
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            action: {
              type: 'uri',
              label: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å›ç­”ã™ã‚‹',
              uri: `https://liff.line.me/${process.env.LIFF_ID}/survey/${surveyId}`,
            },
            style: 'primary',
            color: '#4CAF50',
          },
        ],
      },
    },
  };

  // ä¸€æ–‰é€ä¿¡ï¼ˆmulticastï¼‰
  await client.multicast(lineUserIds, [message]);

  return NextResponse.json({ success: true, sentCount: lineUserIds.length });
}
```

---

## 9. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ä¾‹

### 9.1 ã‚±ãƒ¼ã‚¹1: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®åˆå›æº€è¶³åº¦èª¿æŸ»

**ç›®çš„:** åˆè¨ºæ™‚ã®ä½“é¨“ã‚’è©•ä¾¡ã—ã¦ã‚‚ã‚‰ã„ã€æ”¹å–„ç‚¹ã‚’æŠŠæ¡

**è¨­å®š:**
- é…ä¿¡å¯¾è±¡: ç™»éŒ²å¾Œ7æ—¥ä»¥å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
- LIFFåˆæœŸè¡¨ç¤º: ON
- LINEé…ä¿¡: OFFï¼ˆã‚¢ãƒ—ãƒªå†…ã ã‘ã§å®Œçµï¼‰
- å ±é…¬: ã‚¹ã‚¿ãƒ³ãƒ—1å€‹

**SQL:**
```sql
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'first_visit_survey', true
from profiles
where created_at >= now() - interval '7 days';
```

### 9.2 ã‚±ãƒ¼ã‚¹2: ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£èª¿æŸ»

**ç›®çš„:** å¸¸é€£å®¢ã®æ„è¦‹ã‚’èã„ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã«æ´»ã‹ã™

**è¨­å®š:**
- é…ä¿¡å¯¾è±¡: ã‚¹ã‚¿ãƒ³ãƒ—10å€‹ä»¥ä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
- LIFFåˆæœŸè¡¨ç¤º: ON
- LINEé…ä¿¡: ONï¼ˆLINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚é€ã‚‹ï¼‰
- å ±é…¬: ã‚¹ã‚¿ãƒ³ãƒ—1å€‹

**SQL:**
```sql
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'loyalty_survey_2026Q1', true
from profiles
where stamp_count >= 100;  -- â˜… stamp_count: 10å€‹ = 100pt
```

### 9.3 ã‚±ãƒ¼ã‚¹3: ä¼‘çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é›¢è„±ç†ç”±èª¿æŸ»

**ç›®çš„:** ãªãœã‚¢ãƒ—ãƒªã‚’ä½¿ã‚ãªããªã£ãŸã®ã‹ã‚’æŠŠæ¡

**è¨­å®š:**
- é…ä¿¡å¯¾è±¡: æœ€çµ‚æ¥é™¢æ—¥ãŒ90æ—¥ä»¥ä¸Šå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
- LIFFåˆæœŸè¡¨ç¤º: ON
- LINEé…ä¿¡: ONï¼ˆå¾©å¸°ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…±ã«ï¼‰
- å ±é…¬: ã‚¹ã‚¿ãƒ³ãƒ—1å€‹

**SQL:**
```sql
-- â˜… profiles.last_visit_date ã‚’ä½¿ç”¨ï¼ˆä¸è¦ãªJOINå‰Šé™¤ï¼‰
insert into survey_targets (user_id, survey_id, show_on_liff_open)
select id, 'churn_survey_2026Q1', true
from profiles
where last_visit_date < now() - interval '90 days'
   or last_visit_date is null;
```

### 9.4 ã‚±ãƒ¼ã‚¹4: ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ã¸ã®æ„Ÿæƒ³èª¿æŸ»

**ç›®çš„:** ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¾‹: ç„¡æ–™æ¤œè¨ºã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼‰ã®åŠ¹æœæ¸¬å®š

**è¨­å®š:**
- é…ä¿¡å¯¾è±¡: å€‹åˆ¥é¸æŠï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ãƒªã‚¹ãƒˆï¼‰
- LIFFåˆæœŸè¡¨ç¤º: ON
- LINEé…ä¿¡: ON
- å ±é…¬: ã‚¹ã‚¿ãƒ³ãƒ—3å€‹

**æ‰‹é †:**
1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€Œå€‹åˆ¥é¸æŠã€ã‚’é¸ã¶
2. ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ã®CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ or æ‰‹å‹•é¸æŠ
3. é…ä¿¡é–‹å§‹

---

## 10. ã¾ã¨ã‚

### 10.1 å®Ÿç¾å¯èƒ½ãªæ©Ÿèƒ½

| æ©Ÿèƒ½ | å®Ÿç¾æ–¹æ³• | å·¥æ•° |
|------|---------|------|
| **ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é…ä¿¡** | `survey_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç† | ä½ |
| **LIFFåˆæœŸè¡¨ç¤ºåˆ¶å¾¡** | `show_on_liff_open` ãƒ•ãƒ©ã‚°ã§åˆ¶å¾¡ | ä½ |
| **æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°** | SQL WHEREå¥ã§å‹•çš„æŠ½å‡º | ä¸­ |
| **å›ç­”çŠ¶æ³ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°** | `answered_at` ã§å›ç­”æ¸ˆã¿åˆ¤å®š | ä½ |
| **LINEè‡ªå‹•é…ä¿¡** | Messaging API ã® multicast | ä¸­ |
| **çµæœé›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•åŒ–** | Chart.js ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ | ä¸­ |

### 10.2 æ¨å¥¨å®Ÿè£…é †åº

| Phase | å†…å®¹ | å„ªå…ˆåº¦ |
|-------|------|--------|
| **Phase 1** | `survey_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€LIFFåˆæœŸè¡¨ç¤ºæ©Ÿèƒ½ | âœ… æœ€å„ªå…ˆ |
| **Phase 2** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®é…ä¿¡å¯¾è±¡è€…é¸æŠUI | âœ… é«˜ |
| **Phase 3** | æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆæœ€çµ‚æ¥é™¢æ—¥ã€ã‚¹ã‚¿ãƒ³ãƒ—æ•°ãªã©ï¼‰ | âœ… é«˜ |
| **Phase 4** | å›ç­”çŠ¶æ³ä¸€è¦§ç”»é¢ | âœ… é«˜ |
| **Phase 5** | LINEè‡ªå‹•é…ä¿¡æ©Ÿèƒ½ | ğŸ”„ ä¸­ |
| **Phase 6** | çµæœé›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º | ğŸ”„ ä¸­ |

### 10.3 æœŸå¾…åŠ¹æœ

- ğŸ“ˆ **å›ç­”ç‡ã®å‘ä¸Š:** LIFFã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤ºã«ã‚ˆã‚Šã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèªçŸ¥ç‡100%
- ğŸ“ˆ **ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦:** æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ã§ã€ŒèããŸã„äººã€ã«çµã£ã¦é…ä¿¡
- ğŸ“ˆ **é‹ç”¨åŠ¹ç‡åŒ–:** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ•°ã‚¯ãƒªãƒƒã‚¯ã§é…ä¿¡å®Œäº†
- ğŸ“ˆ **ãƒ‡ãƒ¼ã‚¿æ´»ç”¨:** å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ã«æ´»ç”¨

---

**æœ€çµ‚æ›´æ–°:** 2026-02-26ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å´ã®æœ€æ–°çŠ¶æ³ã«åˆã‚ã›ã¦ API ãƒ‘ã‚¹ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåãƒ»LIFF æ³¨è¨˜ã‚’ä¿®æ­£ï¼‰
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:** Phase 1å®Ÿè£…é–‹å§‹ï¼ˆ`survey_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ â†’ LIFFåˆæœŸè¡¨ç¤ºæ©Ÿèƒ½ï¼‰
