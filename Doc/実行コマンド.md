# ローカル実行コマンド集

## 📋 目次

1. [初回セットアップ](#初回セットアップ)
2. [開発サーバー起動](#開発サーバー起動)
3. [ngrokでの公開](#ngrokでの公開)
4. [トラブルシューティング](#トラブルシューティング)

**Vercel デプロイ（GitHub 連携）の準備** → [26_Vercelデプロイ準備.md](26_Vercelデプロイ準備.md)（環境変数・チェックリスト）

---

## 🚀 初回セットアップ

### 1. 依存パッケージのインストール

```bash
npm install
```

### 2. 環境変数の設定

```bash
# .env.exampleをコピー
copy .env.example .env.local
```

`.env.local`を編集:

```env
# ========== 必須（Supabase） ==========
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ========== 管理画面ログイン（本番では変更必須） ==========
ADMIN_USER=admin
ADMIN_PASSWORD=your-secure-password

# ========== LINE Messaging API（個別メッセージ送信用） ==========
LINE_CHANNEL_ID=your-channel-id
LINE_CHANNEL_SECRET=your-channel-secret
# または長期トークン:
LINE_CHANNEL_ACCESS_TOKEN=your-access-token

# ========== Cookie署名用（本番推奨） ==========
AUTH_SECRET=your-random-32-character-secret
```

---

## 🎮 開発サーバー起動

### メイン開発サーバー（Turbopack使用 - 推奨）

```bash
npm run dev
```

**起動確認:**
- URL: http://localhost:3003
- ブラウザで開いて「管理画面へ」→ ログイン（admin/admin）

---

### Webpack版開発サーバー（互換性確認用）

```bash
npm run dev:webpack
```

**起動確認:**
- URL: http://localhost:3000

---

## 🧪 Playwright E2E テスト

管理ダッシュボードの「DB が正しく更新され、画面が正しく切り替わるか」を自動検証する E2E テスト。

### 1. 事前準備

```bash
# ブラウザのインストール（初回のみ）
npx playwright install chromium
```

### 2. テスト実行

**開発サーバーを別ターミナルで起動してから:**

```bash
npm run dev
```

**別ターミナルでテスト実行:**

```bash
npm run test:e2e
```

**UI モード（おすすめ・ブラウザ操作を目視確認）:**

```bash
npm run test:e2e:ui
```

### 3. 認証情報

テストは `.env.local` の `ADMIN_USER` / `ADMIN_PASSWORD` を参照。未設定時は `admin` / `1234`。

### 4. CI（GitHub Actions）

`main` / `develop` への push で自動実行。事前に Secrets に以下を設定推奨:
- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `ADMIN_USER`, `ADMIN_PASSWORD`（未設定時は admin/1234）

---

## 🌐 ngrokでの公開（LINEアプリテスト用）

### ngrokとは？

外部（LINEアプリなど）から、ローカル環境にアクセスできるようにするツール。
LINE LIFFアプリのテストに必須。

---

### 1. ngrokのインストール

#### 方法A: 公式サイトからダウンロード

1. https://ngrok.com/ にアクセス
2. アカウント作成（無料）
3. Windows版をダウンロード
4. zipを解凍して`ngrok.exe`を適当な場所に配置

#### 方法B: Chocolateyでインストール（推奨）

```bash
# PowerShellを管理者権限で実行
choco install ngrok
```

---

### 2. ngrokの認証設定（初回のみ）

```bash
# ngrokダッシュボードで取得したトークンを設定
ngrok config add-authtoken YOUR_AUTHTOKEN_HERE
```

**トークン取得方法:**
1. https://dashboard.ngrok.com/get-started/your-authtoken にアクセス
2. 表示されたトークンをコピー
3. 上記コマンドで設定

---

### 3. Next.jsサーバーとngrokの起動

#### ターミナル1: Next.jsサーバー起動

```bash
npm run dev
```

起動確認: http://localhost:3003

#### ターミナル2: ngrok起動

```bash
# ポート3003を公開
ngrok http 3003
```

**出力例:**
```
Session Status                online
Account                       your-email@example.com
Version                       3.x.x
Region                        Japan (jp)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://xxxx-xx-xx-xx-xx.ngrok-free.app -> http://localhost:3003

Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

**公開URL:**
- `https://xxxx-xx-xx-xx-xx.ngrok-free.app`
- この URL が外部からアクセス可能

---

### 4. LINE LIFFアプリでの設定

1. **LINE Developersコンソール**にアクセス
   - https://developers.line.biz/console/

2. **LIFFアプリの設定**
   - Endpoint URL: `https://xxxx-xx-xx-xx-xx.ngrok-free.app`
   - （ngrokで表示されたURLを設定）

3. **動作確認**
   - LINEアプリでミニアプリを開く
   - ngrokのトンネル経由でローカル環境にアクセスされる

---

### ngrokの便利なオプション

#### カスタムドメイン（無料プランは不可）

```bash
ngrok http 3003 --domain=your-custom-domain.ngrok.app
```

#### 固定URL（有料プラン）

無料プランでは毎回URLが変わるため、開発時は以下の対応が必要:
- ngrok起動のたびにLIFF Endpoint URLを更新
- または、Vercelなど固定URLを持つ環境にデプロイ

#### Basic認証付き公開

```bash
ngrok http 3003 --basic-auth="username:password"
```

---

### ngrok Web Interface

ngrokのローカル管理画面:
- URL: http://127.0.0.1:4040
- リクエスト履歴の確認
- レスポンスの確認
- リプレイ機能

---

## 🔄 開発フロー（通常の流れ）

### ローカル開発のみ（管理画面）

```bash
# ターミナル1つだけ
npm run dev
```

→ http://localhost:3003 で管理画面にアクセス

---

### LIFF連携開発（ngrok使用）

```bash
# ターミナル1: Next.jsサーバー
npm run dev

# ターミナル2: ngrok
ngrok http 3003
```

**手順:**
1. ngrokのURL（`https://xxxx.ngrok-free.app`）をコピー
2. LINE Developersで LIFF Endpoint URLを更新
3. LINEアプリで動作確認
4. コード修正 → 自動リロード

---

## 🛠️ トラブルシューティング

### Q1. `npm run dev` で「ポート3003が使用中」エラー

**確認:**
```bash
# ポート3003を使用しているプロセスを確認
netstat -ano | findstr :3003
```

**解決:**
```bash
# プロセスを強制終了（PIDは上記コマンドで確認）
taskkill /PID [プロセスID] /F
```

---

### Q2. ngrokで「Session Expired」エラー

**原因:** 無料プランでは8時間でセッション切れ

**解決:**
```bash
# ngrokを再起動
# Ctrl+C で停止 → 再度起動
ngrok http 3003
```

---

### Q3. ngrokのURLが毎回変わる

**原因:** 無料プランでは固定URLが使えない

**対策:**
- 有料プラン（$8/月）にアップグレード
- または、開発時はVercelなど固定URLにデプロイ
- スクリプトで自動更新（高度）

---

### Q4. LIFFアプリで「403 Forbidden」エラー

**原因:** LIFF Endpoint URLが正しくない

**確認:**
1. ngrokの出力を確認（Forwarding の URL）
2. LINE Developers の LIFF設定を確認
3. URL末尾の`/`の有無を統一

**修正:**
```
× https://xxxx.ngrok-free.app/
○ https://xxxx.ngrok-free.app
```

---

### Q5. ビルドエラー「EBUSY: resource busy」

**原因:** Dropboxフォルダの同期ロック

**解決:**
```bash
# 一時的にDropbox同期を停止
# または、プロジェクトをDropbox外のフォルダに移動
```

---

### Q6. ENOENT（event-logs\[__metadata_id__\] や app-build-manifest.json が見つからない）

**原因:** 開発サーバー（`npm run dev`）起動中に本番ビルド（`npm run build`）を実行したため、両方が同じ `.next` フォルダを同時に触り、キャッシュが壊れた。

**予防:** 開発サーバーを**止めてから** `npm run build` を実行する。逆に、build 中は `npm run dev` を起動しない。

**復旧手順:**
```bash
# 1. 開発サーバーを止める（Ctrl+C）
# 2. .next を削除してキャッシュをリセット
rmdir /s /q .next
# または PowerShell:
Remove-Item -Recurse -Force .next

# 3. 開発する場合
npm run dev

# 本番ビルドする場合（dev は止めた状態で）
npm run build
```

---

## 📊 コマンド早見表

| コマンド | 用途 | ポート |
|---------|------|--------|
| `npm install` | パッケージインストール | - |
| `npm run dev` | 開発サーバー起動（Turbopack） | 3003 |
| `npm run dev:webpack` | 開発サーバー起動（Webpack） | 3000 |
| `npm run build` | 本番ビルド | - |
| `npm run start` | 本番サーバー起動 | 3000 |
| `ngrok http 3003` | ngrokトンネル起動 | 3003→外部 |
| `ngrok http 3003 --log=stdout` | ログ出力付き起動 | 3003→外部 |

---

## 🔐 セキュリティ注意事項

### ngrok使用時の注意

1. **環境変数の漏洩リスク**
   - ngrokで公開すると、誰でもアクセス可能
   - `.env.local` に機密情報を含めない
   - 開発用の認証情報を使用

2. **Basic認証の推奨**
   ```bash
   ngrok http 3003 --basic-auth="testuser:testpass123"
   ```

3. **セッション管理**
   - 開発終了後は必ず ngrok を停止
   - Ctrl+C で終了

---

## 📝 その他の便利なコマンド

### Supabase接続テスト

```bash
npm run test:supabase
```

### スキーマ確認

```bash
npm run test:schema
```

### TypeScript型チェック

```bash
npm run build
```

### キャッシュクリア

```bash
rmdir /s /q node_modules
rmdir /s /q .next
npm install
```

---

## 🎯 まとめ

**基本的な開発フロー:**
```bash
# 1. 初回のみ
npm install
copy .env.example .env.local
# → .env.local を編集

# 2. 通常の開発（管理画面のみ）
npm run dev

# 3. LIFF連携開発（2つのターミナル）
# ターミナル1:
npm run dev

# ターミナル2:
ngrok http 3003
```

---

**最終更新:** 2026-02-21
