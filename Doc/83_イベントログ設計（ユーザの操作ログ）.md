# ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°è¨­è¨ˆï¼ˆãƒ¦ãƒ¼ã‚¶ã®æ“ä½œãƒ­ã‚°ï¼‰

**ä½œæˆæ—¥**: 2026-02-23
**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ã®åŠ¹æœæ¸¬å®š
**æ–¹é‡**: Supabaseã®ã¿ã§å®Œçµã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­è¨ˆ

---

## 1. èƒŒæ™¯ãƒ»ç›®çš„

### å®Ÿç¾ã—ãŸã„ã“ã¨
- **LINEé…ä¿¡ã®åŠ¹æœæ¸¬å®š**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã‹ã‚‰ä½•äººãŒã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸã‹
- **æœªèª­ç‡ã®æŠŠæ¡**: é…ä¿¡å¯¾è±¡ã®ã†ã¡ã€ä½•%ãŒã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ãªã„ã‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ**: ã©ã®æ©Ÿèƒ½ãŒã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ã€é›¢è„±ãƒã‚¤ãƒ³ãƒˆã¯ã©ã“ã‹
- **ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ã®åŠ¹æœæ¸¬å®š**: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å¾Œã®æ¥é™¢ç‡å¤‰åŒ–ãªã©

### ãªãœSupabaseã ã‘ã§è‰¯ã„ã®ã‹
1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: ãƒ­ã‚°ãŒæºœã¾ã‚‹æ§˜å­ã‚’ç®¡ç†ç”»é¢ã§å³åº§ã«ç¢ºèªå¯èƒ½
2. **JSONBå‹ã®æŸ”è»Ÿæ€§**: å¾Œã‹ã‚‰è¿½åŠ ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç”±ã«å…¥ã‚Œã‚‰ã‚Œã‚‹
3. **åˆ†æã‚‚SQLã§å®Œçµ**: è¤‡é›‘ãªé›†è¨ˆã‚‚Supabaseä¸Šã§SQLã‚’å©ãã ã‘
4. **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆGoogle Analyticsç­‰ï¼‰ã®å°å…¥ä¸è¦

### ãƒ‡ãƒ¼ã‚¿å¢—åŠ ã¸ã®å¯¾å¿œ
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°: æœˆæ¬¡ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†å‰²ã§å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- TTLï¼ˆTime To Liveï¼‰: ä¸€å®šæœŸé–“å¾Œã«è‡ªå‹•å‰Šé™¤ã™ã‚‹ãƒãƒªã‚·ãƒ¼
- é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«: æ—¥æ¬¡ã§é›†è¨ˆã—ã¦å…ƒãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- 010_create_event_logs_table.sql
create table event_logs (
  id uuid default gen_random_uuid() primary key,
  user_id text references profiles(id),  -- èª°ãŒ
  event_name text not null,               -- ä½•ã‚’ï¼ˆ'app_open', 'stamp_click' ãªã©ï¼‰
  source text,                           -- ã©ã“ã‹ã‚‰ï¼ˆ'line_msg_0222' ãªã©ï¼‰
  metadata jsonb,                        -- ãã®ä»–è©³ç´°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ãªã©è‡ªç”±æ ï¼‰
  created_at timestamptz default now()   -- ã„ã¤
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
create index idx_event_logs_user_id on event_logs(user_id);
create index idx_event_logs_event_name on event_logs(event_name);
create index idx_event_logs_created_at on event_logs(created_at desc);
create index idx_event_logs_source on event_logs(source) where source is not null;

-- RLSãƒãƒªã‚·ãƒ¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
alter table event_logs enable row level security;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ­ã‚°ã®ã¿æ›¸ãè¾¼ã¿å¯èƒ½
create policy "Users can insert their own logs"
  on event_logs for insert
  with check (user_id = current_setting('app.current_user_id', true));

-- ç®¡ç†è€…ã¯å…¨ãƒ­ã‚°å‚ç…§å¯èƒ½ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ä½¿ç”¨ï¼‰
create policy "Admins can view all logs"
  on event_logs for select
  using (true);

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼‰
comment on table event_logs is 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ­ã‚°ï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨ï¼‰';
comment on column event_logs.event_name is 'ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥: app_open, stamp_scan, reward_exchange ãªã©';
comment on column event_logs.source is 'æµå…¥å…ƒ: line_msg_YYMMDD, direct, web ãªã©';
comment on column event_logs.metadata is 'è¿½åŠ ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰: user_agent, screen_size, referrer ãªã©';
```

### 2.2 LINEé…ä¿¡å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœªèª­ç‡ç®—å‡ºç”¨ï¼‰

```sql
-- 011_create_message_delivery_logs.sql
create table message_delivery_logs (
  id uuid default gen_random_uuid() primary key,
  campaign_id text not null,              -- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDï¼ˆä¾‹: 'msg_0222_checkup_reminder'ï¼‰
  campaign_name text not null,            -- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åï¼ˆä¾‹: '2æœˆå®šæœŸæ¤œè¨ºãƒªãƒã‚¤ãƒ³ãƒ‰'ï¼‰
  sent_at timestamptz default now(),      -- é…ä¿¡æ—¥æ™‚
  target_count int not null,              -- é…ä¿¡å¯¾è±¡è€…æ•°
  target_user_ids text[],                 -- é…ä¿¡å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDé…åˆ—
  message_content jsonb,                  -- é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
  created_by text,                        -- é…ä¿¡å®Ÿæ–½è€…ï¼ˆã‚¹ã‚¿ãƒƒãƒ•IDï¼‰
  notes text                              -- ãƒ¡ãƒ¢ï¼ˆé…ä¿¡ç›®çš„ãªã©ï¼‰
);

create index idx_message_delivery_campaign_id on message_delivery_logs(campaign_id);
create index idx_message_delivery_sent_at on message_delivery_logs(sent_at desc);

-- RLS: ç®¡ç†è€…ã®ã¿å‚ç…§ãƒ»æ›¸ãè¾¼ã¿å¯èƒ½
alter table message_delivery_logs enable row level security;
create policy "Admins only" on message_delivery_logs using (true);

comment on table message_delivery_logs is 'LINEé…ä¿¡å±¥æ­´ï¼ˆåŠ¹æœæ¸¬å®šç”¨ï¼‰';
```

---

## 3. è¨˜éŒ²ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

### 3.1 åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆ

| event_name | èª¬æ˜ | sourceä¾‹ | metadataä¾‹ |
|-----------|------|----------|-----------|
| `app_open` | ã‚¢ãƒ—ãƒªèµ·å‹• | `line_msg_0222`, `direct`, `push_notification` | `{user_agent, screen_size, referrer}` |
| `page_view` | ãƒšãƒ¼ã‚¸é–²è¦§ | è‡ªå‹• | `{page_path: '/stamp', previous_path: '/'}` |
| `session_start` | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ | è‡ªå‹• | `{session_id: 'xxx'}` |
| `session_end` | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† | è‡ªå‹• | `{duration_seconds: 120}` |

### 3.2 ã‚¹ã‚¿ãƒ³ãƒ—é–¢é€£

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `stamp_page_view` | ã‚¹ã‚¿ãƒ³ãƒ—ãƒšãƒ¼ã‚¸é–²è¦§ | `{current_stamp_count: 50}` |
| `stamp_scan_start` | QRã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ— | `{scan_type: 'qr'}` |
| `stamp_scan_success` | QRã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ | `{stamps_added: 5, type: 'regular'}` |
| `stamp_scan_fail` | QRã‚¹ã‚­ãƒ£ãƒ³å¤±æ•— | `{error: 'duplicate'}` |
| `stamp_history_view` | å±¥æ­´ãƒšãƒ¼ã‚¸é–²è¦§ | `{}` |
| `home_page_view` | è¨ºå¯Ÿåˆ¸ãƒšãƒ¼ã‚¸é–²è¦§ | `{current_stamp_count: 50}` |

### 3.3 ç‰¹å…¸é–¢é€£

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `reward_list_view` | ç‰¹å…¸ä¸€è¦§é–²è¦§ | `{}` |
| `reward_detail_view` | ç‰¹å…¸è©³ç´°é–²è¦§ | `{reward_id: 1, reward_name: 'ãƒ•ãƒƒç´ å¡—å¸ƒ'}` |
| `reward_exchange_start` | äº¤æ›ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ— | `{reward_id: 1}` |
| `reward_exchange_success` | äº¤æ›æˆåŠŸ | `{reward_id: 1, stamps_used: 10}` |

### 3.4 äºˆç´„é–¢é€£

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `reservation_button_click` | äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ | `{from_page: '/'}` |
| `reservation_external_link` | å¤–éƒ¨äºˆç´„ã‚µã‚¤ãƒˆã¸é·ç§» | `{url: 'https://...'}` |

### 3.5 ã‚²ãƒ¼ãƒ é–¢é€£

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `slot_game_open` | ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ ç”»é¢ã‚’é–‹ã | `{}` |
| `slot_game_play` | ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ | `{result: 'win', stamps_won: 5}` |
| `slot_game_win` | ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ å½“ãŸã‚Š | `{stamps_won: 8}` |
| `slot_game_lose` | ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ å¤–ã‚Œ | `{}` |

### 3.6 å®¶æ—æ©Ÿèƒ½é–¢é€£

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `family_join_start` | å®¶æ—å‚åŠ é–‹å§‹ | `{}` |
| `family_join_success` | å®¶æ—å‚åŠ æˆåŠŸ | `{family_id: 'xxx'}` |
| `child_mode_open` | å­ä¾›ãƒ¢ãƒ¼ãƒ‰é–‹ã | `{child_id: 'manual-child-xxx'}` |
| `child_mode_switch` | å­ä¾›ç”»é¢åˆ‡æ›¿ | `{from_child: 'xxx', to_child: 'yyy'}` |

### 3.7 ã‚¨ãƒ©ãƒ¼ãƒ»ç•°å¸¸ç³»

| event_name | èª¬æ˜ | metadataä¾‹ |
|-----------|------|-----------|
| `error_occurred` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | `{error_type: 'network', message: '...'}` |
| `api_call_failed` | APIå‘¼ã³å‡ºã—å¤±æ•— | `{endpoint: '/api/stamps', status: 500}` |

---

## 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 4.1 å…±é€šãƒ­ã‚°é€ä¿¡é–¢æ•°

```typescript
// lib/analytics.ts
import { supabase } from './supabase';

interface LogEventParams {
  eventName: string;
  source?: string;
  metadata?: Record<string, any>;
}

export const logEvent = async (params: LogEventParams) => {
  try {
    const { eventName, source, metadata } = params;

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æµå…¥å…ƒã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const sourceFromUrl = urlParams.get('from') || 'direct';

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç­‰ã®åŸºæœ¬æƒ…å ±ã‚’è‡ªå‹•è¿½åŠ 
    const enrichedMetadata = {
      ...metadata,
      user_agent: navigator.userAgent,
      screen_size: `${window.screen.width}x${window.screen.height}`,
      viewport_size: `${window.innerWidth}x${window.innerHeight}`,
      referrer: document.referrer || null,
      timestamp: new Date().toISOString(),
    };

    await supabase.from('event_logs').insert({
      event_name: eventName,
      source: source || sourceFromUrl,
      metadata: enrichedMetadata,
    });
  } catch (error) {
    // ãƒ­ã‚°é€ä¿¡å¤±æ•—ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å¦¨ã’ãªã„
    console.error('âš ï¸ Analytics error:', error);
  }
};
```

### 4.2 ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ­ã‚°ï¼ˆAppLayout.tsxï¼‰

```typescript
// components/layout/AppLayout.tsx
import { logEvent } from '@/lib/analytics';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { profile } = useProfile();

  useEffect(() => {
    if (profile?.userId) {
      // ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ­ã‚°
      logEvent({
        eventName: 'app_open',
      });
    }
  }, [profile?.userId]);

  // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰
}
```

### 4.3 QRã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°ï¼ˆscan/page.tsxï¼‰

```typescript
// app/scan/page.tsx
const handleScan = async () => {
  // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒ­ã‚°
  await logEvent({ eventName: 'stamp_scan_start' });

  try {
    const result = await window.liff.scanCodeV2();

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸãƒ­ã‚°
    await logEvent({
      eventName: 'stamp_scan_success',
      metadata: {
        stamps_added: payload.stamps,
        type: payload.type,
      },
    });
  } catch (error) {
    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ãƒ­ã‚°
    await logEvent({
      eventName: 'stamp_scan_fail',
      metadata: {
        error: error.message,
      },
    });
  }
};
```

### 4.4 äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚°ï¼ˆæ—¢å­˜å®Ÿè£…ã®æ‹¡å¼µï¼‰

```typescript
// components/(adult)/AdultHome.tsxï¼ˆæ—¢å­˜ã®reservation_button_clicksã«è¿½åŠ ï¼‰
const handleReservation = () => {
  // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚«ã‚¦ãƒ³ãƒˆ
  if (profile?.userId) {
    fetch(`/api/users/${profile.userId}/reservation-click`, {
      method: "POST",
    }).catch(console.error);
  }

  // ğŸ†• ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚‚è¨˜éŒ²
  logEvent({
    eventName: 'reservation_button_click',
    metadata: {
      from_page: '/',
      current_stamp_count: stampCount,
    },
  });

  // å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’é–‹ã
  window.open('https://reserva.be/tsukubawhite', '_blank');
};
```

---

## 5. åˆ†æç”¨SQLï¼ˆåŠ¹æœæ¸¬å®šï¼‰

### 5.1 LINEé…ä¿¡å¾Œã®ã‚¢ãƒ—ãƒªèµ·å‹•ç‡

```sql
-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã€Œmsg_0222ã€ã®åŠ¹æœæ¸¬å®š
with campaign_targets as (
  select unnest(target_user_ids) as user_id, sent_at
  from message_delivery_logs
  where campaign_id = 'msg_0222'
),
app_opens as (
  select distinct user_id
  from event_logs
  where event_name = 'app_open'
    and source = 'line_msg_0222'
    and created_at >= (select sent_at from campaign_targets limit 1)
    and created_at <= (select sent_at from campaign_targets limit 1) + interval '24 hours'
)
select
  count(distinct ct.user_id) as total_sent,
  count(distinct ao.user_id) as opened,
  round(100.0 * count(distinct ao.user_id) / count(distinct ct.user_id), 2) as open_rate_percent
from campaign_targets ct
left join app_opens ao on ct.user_id = ao.user_id;
```

### 5.2 æœªèª­ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆæŠ½å‡º

```sql
-- é…ä¿¡ã‹ã‚‰24æ™‚é–“ä»¥å†…ã«é–‹ã„ã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼
with campaign_targets as (
  select unnest(target_user_ids) as user_id, sent_at
  from message_delivery_logs
  where campaign_id = 'msg_0222'
),
app_opens as (
  select distinct user_id
  from event_logs
  where event_name = 'app_open'
    and source = 'line_msg_0222'
    and created_at >= (select sent_at from campaign_targets limit 1)
    and created_at <= (select sent_at from campaign_targets limit 1) + interval '24 hours'
)
select
  p.id,
  p.display_name,
  p.ticket_number
from campaign_targets ct
join profiles p on ct.user_id = p.id
left join app_opens ao on ct.user_id = ao.user_id
where ao.user_id is null  -- é–‹ã„ã¦ã„ãªã„äºº
order by p.display_name;
```

### 5.3 æ—¥åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆDAUï¼‰

```sql
select
  date(created_at) as date,
  count(distinct user_id) as daily_active_users
from event_logs
where event_name = 'app_open'
  and created_at >= current_date - interval '30 days'
group by date(created_at)
order by date desc;
```

### 5.4 ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥é›†è¨ˆï¼ˆäººæ°—æ©Ÿèƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰

```sql
select
  event_name,
  count(*) as total_events,
  count(distinct user_id) as unique_users,
  round(avg(extract(epoch from (lead(created_at) over (partition by user_id order by created_at) - created_at))), 2) as avg_time_to_next_action_seconds
from event_logs
where created_at >= current_date - interval '7 days'
group by event_name
order by total_events desc;
```

### 5.5 ã‚¹ã‚¿ãƒ³ãƒ—ã‚¹ã‚­ãƒ£ãƒ³ã®æˆåŠŸç‡

```sql
with scans as (
  select
    sum(case when event_name = 'stamp_scan_start' then 1 else 0 end) as starts,
    sum(case when event_name = 'stamp_scan_success' then 1 else 0 end) as successes,
    sum(case when event_name = 'stamp_scan_fail' then 1 else 0 end) as failures
  from event_logs
  where created_at >= current_date - interval '30 days'
)
select
  starts,
  successes,
  failures,
  round(100.0 * successes / starts, 2) as success_rate_percent
from scans;
```

### 5.6 èª°ãŒã„ã¤äºˆç´„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‹

```sql
-- äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å±¥æ­´ï¼ˆç›´è¿‘30æ—¥ï¼‰
select
  p.display_name,
  p.ticket_number,
  el.created_at as clicked_at,
  el.metadata->>'current_stamp_count' as stamps_at_click,
  el.metadata->>'from_page' as from_page
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name = 'reservation_button_click'
  and el.created_at >= current_date - interval '30 days'
order by el.created_at desc;

-- äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰
select
  p.display_name,
  p.ticket_number,
  count(*) as click_count,
  max(el.created_at) as last_clicked_at
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name = 'reservation_button_click'
  and el.created_at >= current_date - interval '30 days'
group by p.id, p.display_name, p.ticket_number
order by click_count desc;
```

### 5.7 èª°ãŒã„ã¤ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ãŸã‹

```sql
-- ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤å±¥æ­´ï¼ˆç›´è¿‘30æ—¥ï¼‰
select
  p.display_name,
  p.ticket_number,
  el.created_at as played_at,
  el.metadata->>'result' as result,
  (el.metadata->>'stamps_won')::int as stamps_won
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name = 'slot_game_play'
  and el.created_at >= current_date - interval '30 days'
order by el.created_at desc;

-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
select
  p.display_name,
  count(*) as play_count,
  sum((el.metadata->>'stamps_won')::int) as total_stamps_won,
  round(avg((el.metadata->>'stamps_won')::int), 2) as avg_stamps_per_play,
  max(el.created_at) as last_played_at
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name = 'slot_game_play'
  and el.created_at >= current_date - interval '30 days'
group by p.id, p.display_name
order by play_count desc;
```

### 5.8 èª°ãŒã„ã¤ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’ç¢ºèªã—ãŸã‹

```sql
-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒšãƒ¼ã‚¸é–²è¦§å±¥æ­´ï¼ˆç›´è¿‘7æ—¥ï¼‰
select
  p.display_name,
  p.ticket_number,
  el.event_name,
  el.created_at as viewed_at,
  (el.metadata->>'current_stamp_count')::int as stamps_at_view
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name in ('stamp_page_view', 'home_page_view')
  and el.created_at >= current_date - interval '7 days'
order by el.created_at desc;

-- ã‚¹ã‚¿ãƒ³ãƒ—ç¢ºèªé »åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
select
  p.display_name,
  count(*) as view_count,
  min(el.created_at) as first_view,
  max(el.created_at) as last_view,
  round(extract(epoch from (max(el.created_at) - min(el.created_at))) / 86400, 1) as days_between_first_and_last
from event_logs el
join profiles p on el.user_id = p.id
where el.event_name in ('stamp_page_view', 'home_page_view')
  and el.created_at >= current_date - interval '30 days'
group by p.id, p.display_name
having count(*) >= 3  -- 3å›ä»¥ä¸Šé–²è¦§ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
order by view_count desc;
```

### 5.9 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ãƒ•ãƒ­ãƒ¼åˆ†æ

```sql
-- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•å±¥æ­´ï¼ˆæ™‚ç³»åˆ—ï¼‰
select
  el.created_at,
  el.event_name,
  el.source,
  el.metadata
from event_logs el
where el.user_id = 'U5c70cd61...'  -- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  and el.created_at >= current_date - interval '7 days'
order by el.created_at asc;

-- é›¢è„±ãƒã‚¤ãƒ³ãƒˆåˆ†æï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å‰ã®æœ€å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
with last_actions as (
  select
    user_id,
    event_name,
    created_at,
    lead(event_name) over (partition by user_id order by created_at) as next_event
  from event_logs
  where created_at >= current_date - interval '7 days'
)
select
  event_name as last_action_before_exit,
  count(*) as exit_count
from last_actions
where next_event is null  -- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„ = ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
  and event_name != 'session_end'
group by event_name
order by exit_count desc;
```

---

## 6. ãƒ‡ãƒ¼ã‚¿å¢—åŠ å¯¾ç­–

### 6.1 ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæœˆæ¬¡ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†å‰²ï¼‰

```sql
-- æœˆæ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
create table event_logs_2026_02 partition of event_logs
  for values from ('2026-02-01') to ('2026-03-01');

create table event_logs_2026_03 partition of event_logs
  for values from ('2026-03-01') to ('2026-04-01');

-- å¤ã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
```

### 6.2 TTLï¼ˆè‡ªå‹•å‰Šé™¤ãƒãƒªã‚·ãƒ¼ï¼‰

```sql
-- 90æ—¥ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
create or replace function delete_old_event_logs()
returns void as $$
begin
  delete from event_logs
  where created_at < current_date - interval '90 days';
end;
$$ language plpgsql;

-- Supabase Edge Functionsã¾ãŸã¯å¤–éƒ¨cronã§å®šæœŸå®Ÿè¡Œ
```

### 6.3 é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚µãƒãƒªãƒ¼åŒ–ï¼‰

```sql
-- æ—¥æ¬¡é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
create table event_logs_daily_summary (
  date date primary key,
  total_events int,
  unique_users int,
  event_counts jsonb,  -- {app_open: 1234, stamp_scan: 567, ...}
  created_at timestamptz default now()
);

-- æ¯æ—¥æ·±å¤œã«å‰æ—¥åˆ†ã‚’é›†è¨ˆ
create or replace function summarize_daily_events()
returns void as $$
begin
  insert into event_logs_daily_summary (date, total_events, unique_users, event_counts)
  select
    date(created_at) as date,
    count(*) as total_events,
    count(distinct user_id) as unique_users,
    jsonb_object_agg(event_name, count) as event_counts
  from (
    select event_name, count(*) as count, created_at
    from event_logs
    where date(created_at) = current_date - interval '1 day'
    group by event_name, created_at
  ) sub
  group by date(created_at);
end;
$$ language plpgsql;
```

---

## 7. å®Ÿè£…ã®å·¥æ•°æ„Ÿ

### é›£æ˜“åº¦: â˜…â˜†â˜†â˜†â˜†ï¼ˆä½ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° | å‚™è€ƒ |
|-------|------|------|
| DBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | 10åˆ† | SQLã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ |
| `lib/analytics.ts` å®Ÿè£… | 30åˆ† | å…±é€šé–¢æ•°1ã¤ä½œæˆ |
| ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ­ã‚°å®Ÿè£… | 10åˆ† | AppLayout.tsxã«æ•°è¡Œè¿½åŠ  |
| å„ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°è¿½åŠ  | 5åˆ†/ç®‡æ‰€ | æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«1è¡Œè¿½åŠ ã™ã‚‹ã ã‘ |
| åˆ†æSQLä½œæˆ | 1æ™‚é–“ | å¿…è¦ã«å¿œã˜ã¦ä½œæˆ |
| **åˆè¨ˆ** | **2ã€œ3æ™‚é–“** | Phase 2å®¶æ—æ©Ÿèƒ½ã«æ¯”ã¹ã¦åœ§å€’çš„ã«ç°¡å˜ |

### é‹ç”¨ã‚³ã‚¹ãƒˆ
- LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ã‘ã‚‹ãƒ«ãƒ¼ãƒ«åŒ–ï¼ˆ0åˆ†ï¼‰
- Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆæœˆ1å›ã€10åˆ†ï¼‰

---

## 8. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 8.1 å€‹äººæƒ…å ±ä¿è­·
- **user_id ã®ã¿è¨˜éŒ²**: åå‰ã‚„è¨ºå¯Ÿåˆ¸ç•ªå·ã¯ event_logs ã«ä¿å­˜ã—ãªã„
- **åˆ†ææ™‚ã« JOIN**: å¿…è¦ãªæ™‚ã ã‘ profiles ãƒ†ãƒ¼ãƒ–ãƒ«ã¨çµåˆ
- **åŒ¿ååŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³**: å¿…è¦ã«å¿œã˜ã¦ user_id ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–

### 8.2 ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“
- **æ¨å¥¨**: 90æ—¥é–“ï¼ˆ3ãƒ¶æœˆï¼‰ã§è‡ªå‹•å‰Šé™¤
- **é•·æœŸä¿å­˜ãŒå¿…è¦ãªå ´åˆ**: æ—¥æ¬¡ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã«é›†è¨ˆã—ã¦å…ƒãƒ‡ãƒ¼ã‚¿å‰Šé™¤

### 8.3 RLSãƒãƒªã‚·ãƒ¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ­ã‚°ã®ã¿æ›¸ãè¾¼ã¿å¯èƒ½
- é–²è¦§ã¯ç®¡ç†è€…ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼‰ã®ã¿

---

## 9. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: æœ€å°æ§‹æˆï¼ˆæ¨å¥¨ï¼‰
1. `event_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
2. `lib/analytics.ts` å®Ÿè£…
3. `app_open` ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿è¨˜éŒ²
4. 1é€±é–“é‹ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

### Phase 2: æ‹¡å¼µ
5. ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆQRã‚¹ã‚­ãƒ£ãƒ³ã€ç‰¹å…¸äº¤æ›ã€äºˆç´„ãƒœã‚¿ãƒ³ï¼‰ã‚’è¿½åŠ 
6. LINEé…ä¿¡å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
7. åŠ¹æœæ¸¬å®šSQLã‚’å®Ÿè¡Œ

### Phase 3: æœ€é©åŒ–
8. ãƒ‡ãƒ¼ã‚¿å¢—åŠ çŠ¶æ³ã‚’ç¢ºèª
9. å¿…è¦ã«å¿œã˜ã¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã¾ãŸã¯TTLå°å…¥
10. ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åˆ†æã‚°ãƒ©ãƒ•è¿½åŠ 

---

## 10. å‚è€ƒï¼šLINEé…ä¿¡ã¨ã®é€£æºãƒ•ãƒ­ãƒ¼

```
1. ã‚¹ã‚¿ãƒƒãƒ•ãŒLINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
   â†“
2. message_delivery_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã«é…ä¿¡è¨˜éŒ²ã‚’ä¿å­˜
   - campaign_id: 'msg_0222_checkup'
   - target_user_ids: ['U5c70cd61...', 'U1234abcd...']
   - sent_at: 2026-02-22 10:00:00
   â†“
3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æµå…¥å…ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãURLã‚’å«ã‚ã‚‹
   ä¾‹: https://liff.line.me/xxx?from=line_msg_0222
   â†“
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¢ãƒ—ãƒªèµ·å‹•
   â†“
5. event_logs ã«è¨˜éŒ²
   - event_name: 'app_open'
   - source: 'line_msg_0222'
   - created_at: 2026-02-22 10:05:23
   â†“
6. åˆ†æSQLã§çªãåˆã‚ã›
   - é…ä¿¡æ•°: 100äºº
   - é–‹å°æ•°: 35äºº
   - é–‹å°ç‡: 35%
```

---

## 11. ã¾ã¨ã‚

### Supabaseã ã‘ã§å®Œçµã™ã‚‹ç†ç”±
âœ… PostgreSQLã®å¼·åŠ›ãªé›†è¨ˆæ©Ÿèƒ½
âœ… JSONBå‹ã®æŸ”è»Ÿæ€§
âœ… RLSã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é–²è¦§
âœ… å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ä¸è¦ã§ã‚³ã‚¹ãƒˆå‰Šæ¸›

### ãƒ‡ãƒ¼ã‚¿å¢—åŠ ã¸ã®å¯¾å¿œ
âœ… ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæœˆæ¬¡åˆ†å‰²ï¼‰
âœ… TTLï¼ˆè‡ªå‹•å‰Šé™¤ï¼‰
âœ… é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚µãƒãƒªãƒ¼åŒ–ï¼‰

### å·¥æ•°æ„Ÿ
âœ… å®Ÿè£…ï¼š2ã€œ3æ™‚é–“ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã«æ¯”ã¹ã¦åœ§å€’çš„ã«ç°¡å˜ï¼‰
âœ… é‹ç”¨ï¼šæœˆ10åˆ†ç¨‹åº¦

**æ¨å¥¨**: ã¾ãšã¯ `app_open` ã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã‚’è¨˜éŒ²ã—ã¦1é€±é–“é‹ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æºœã¾ã‚Šæ–¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ‹¡å¼µã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2026-02-23
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆå®Œäº†ãƒ»å®Ÿè£…å¾…ã¡
