# つくばホワイト歯科 管理ダッシュボード仕様書

## 1. 概要・コンセプト

**「現場での使いやすさ」と「将来のメッセージ拡張性」の両立**

- Next.js (TypeScript) + shadcn/ui で構築する、つくばホワイト歯科専用の管理画面。
- 患者（profiles）の一覧表示・スタンプ管理・個別メッセージ送信を一元的に扱い、将来的な LINE Messaging API 一斉送信にも対応できる土台を用意する。

---

## 2. 認証・セキュリティ

| 項目 | 仕様 |
|------|------|
| **認証方式** | 簡易認証（ログイン ID + パスワード）。デフォルトは `admin` / `1234`。 |
| **セッション** | 署名付き Cookie（`admin_session`）で保持。ミドルウェアで検証。 |
| **ルート保護** | `/admin` 配下は未認証時は `/admin/login` へリダイレクト。 |

### 実装のポイント

- 環境変数 `ADMIN_USER` / `ADMIN_PASSWORD` でログイン ID・パスワードを変更可能（未設定時は admin / 1234）。
- `AUTH_SECRET` で Cookie 署名用シークレットを指定可能（本番では設定推奨）。

---

## 3. 患者一覧画面（メイン）

### 3.1 データソース・表示

- **データソース**: Supabase の `profiles` テーブル。
- **UI**: shadcn/ui の **DataTable** コンポーネントで一覧表示。

### 3.2 検索・フィルタ

| 機能 | 仕様 |
|------|------|
| **リアルタイム検索** | 名前または診察券番号で絞り込み（クライアント側） |
| **表示項目** | 氏名、診察券番号、スタンプ数、**最終来院**、**更新**、操作 |

### 3.3 ステータス表示

| 項目 | 表示方法 |
|------|----------|
| **スタンプ数** | `stamp_count` をバッジで表示 |
| **最終来院** | Supabase の `last_visit_date` を JST で表示（未設定は —） |
| **更新** | Supabase の `updated_at` を JST で表示 |

### 3.4 編集可能項目

- **診察券番号**（`ticket_number`）と **最終来院日**（`last_visit_date`）は、各行の「編集」ボタンからダイアログで変更可能。保存時に `PATCH /api/profiles/[id]` で Supabase を更新する。

---

## 4. 個別操作（アクション）

リストの各行に、即座に操作できるボタンを配置。色・アイコンで識別しやすくしている。

### 4.1 編集（診察券番号・最終来院日）

- **編集** ボタンでダイアログを開き、診察券番号と最終来院日を入力して保存。`PATCH /api/profiles/[id]` で Supabase を更新。

### 4.2 スタンプのクイック修正

| 操作 | 仕様 |
|------|------|
| **-1 / +1** | クリックで DB を即時更新。SWR でキャッシュ更新。色分け（-1: ローズ系、+1: エメラルド系）。 |
| **数値** | Dialog で 0〜999 を直接入力して保存。 |

### 4.3 メッセージ送信

- **メッセージ** ボタン（インディゴ強調）で、右から **Sheet** をスライド表示。定型文＋自由入力で送信し、care_messages に保存（LINE 設定があれば push も送信）。

---

## 5. 個別メッセージ送信機能

LINE Messaging API 連携を視野に入れた仕様。

### 5.1 簡易テキスト送信

| 項目 | 内容 |
|------|------|
| **定型文** | 「お疲れ様でした」「次回予約は〇〇です」などのテンプレートを選択可能（将来拡張でテンプレート管理も検討） |
| **自由入力** | 定型文に加え、自由テキストを入力して送信 |

### 5.2 ケア記録の保存

- 送信した内容は DB に保存する。
- 患者側の「ケア記録」タブでも同じ内容を参照できるようにする（既存の LINE ミニアプリ仕様と整合）。

### 5.3 一斉送信（将来拡張）

- 特定の条件（例：スタンプ10個の人、最終来院が○ヶ月前の人）に一括でメッセージを送る **土台** を設計段階で考慮する。
- 条件指定UI・送信履歴・送信前確認ダイアログなどの要件を、フェーズ2で詳細化。

---

## 6. 技術スタック

| 役割 | 技術 | 理由 |
|------|------|------|
| **Framework** | Next.js 16 (App Router) | Vercel へのデプロイが容易で、API 構築も内包できる |
| **UI Library** | shadcn/ui | 管理画面に必要な「表・ボタン・入力欄」が高品質で揃う |
| **Database** | Supabase (PostgreSQL) | 既に接続済みの `profiles` テーブルを活用 |
| **データ取得・キャッシュ** | SWR または React Query | スタンプ更新時など、画面をリロードせずに数値を反映 |
| **外部API** | LINE Messaging API | `pushMessage` により、管理者から患者へ能動的に通知 |

### 補足

- **Python/Flask** の経験があれば、Next.js の API Routes や Server Actions の考え方は転用しやすい。
- Cursor との相性も良く、型安全な TypeScript で開発しやすい。

---

## 7. 画面・ルート構成（案）

| パス | 説明 |
|------|------|
| `/admin/login` | 管理者ログイン |
| `/admin` | ダッシュボードトップ（患者一覧がメイン） |
| `/admin/patients` | 患者一覧（メイン画面をここにしても可） |

※ 一覧と個別操作は同一画面内で完結する想定。

---

## 8. データ・API まわり

- **profiles**: `stamp_count`, `ticket_number`, `last_visit_date`, `updated_at` などを利用。診察券番号・最終来院日は `PATCH /api/profiles/[id]` で更新。
- **care_messages**: 送信メッセージを保存。`supabase/002_create_care_messages_table.sql` で作成。RLS は SELECT/INSERT 許可。
- **LINE Messaging API**: .env.local の Channel ID/Secret または Access Token で pushMessage を実行。

---

## 9. 今後の拡張候補

- 定型文の管理画面（テンプレートの追加・編集・削除）。
- 一斉送信の条件ビルダー（スタンプ数、最終来院日、タグなど）。
- 送信履歴の一覧・検索。
- 管理者ロールの分離（閲覧のみ / スタンプ編集可 / メッセージ送信可 など）。

---

## 10. 実装メモ・セットアップ

### 環境変数（.env.local）

- `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` … 既存の Supabase 接続用。
- **LINE Messaging API（プッシュ送信）**
  - `LINE_CHANNEL_ID` または `Channel_ID` … LINE チャネル ID
  - `LINE_CHANNEL_SECRET` または `Channel_secret` … LINE チャネルシークレット
  - 上記2つがあると、送信時に短期チャネルアクセストークンを取得して pushMessage を実行します。
  - オプション: `LINE_CHANNEL_ACCESS_TOKEN` を設定すると、こちらを優先して使用（長期トークンは LINE Developers コンソールで発行）。

### 認証（簡易）

- ログイン **ID**: `admin`、**パスワード**: `1234` でログイン（変更する場合は .env.local の `ADMIN_USER` / `ADMIN_PASSWORD` を設定）。
- 未認証で `/admin` にアクセスすると `/admin/login` にリダイレクトされる。

### ケア記録テーブル（care_messages）

- 個別メッセージを使う前に、Supabase SQL エディタで `supabase/002_create_care_messages_table.sql` を実行するだけ。追加のキー設定は不要。

### 起動

- `npm install` のあと `npm run dev` で開発サーバー起動。トップ `/` から「管理画面へ」で `/admin` に遷移（未認証時は `/admin/login` へ）。
- **遅い場合**: `npm run dev` は Turbopack 使用で軽量化済み。さらに速くしたいときは `npm run build` → `npm run start` で本番モード起動（初回ビルド後はレスポンスが速い）。

---

*本仕様書は、Next.js + shadcn/ui による管理ダッシュボードの設計・実装の指針として利用する。*
