# 89_アンケート機能 Phase 4 集計結果・一覧確認 仕様

**作成日:** 2026-02-26  
**目的:** Phase 4 に含める「集計結果」「一覧確認」の仕様を 86 等に基づき整理する。

**関連:** [88_アンケート機能_ダッシュボード開発計画.md](88_アンケート機能_ダッシュボード開発計画.md) / [86_アンケート機能仕様検討_ダッシュボード側.md](86_アンケート機能仕様検討_ダッシュボード側.md)

---

## Phase 4 の範囲（集計・一覧を含む）

Phase 4 では次を対象とする。

| 区分 | 内容 | 主な画面・API |
|------|------|----------------|
| **一覧確認** | アンケート一覧で配信対象数・回答率を確認する | `/admin/surveys`（一覧） |
| **一覧確認** | 配信対象者ごとの回答状況（回答済み/未回答・後回し回数）を確認する | `/admin/surveys/[surveyId]/targets`（回答状況一覧） |
| **集計結果** | アンケートごとの回答を集計し、Q1分布・NPS・自由記述を表示する | `/admin/surveys/[surveyId]/results`（結果集計） |
| **配信設定** | LIFF初期表示 ON/OFF・配信期間の更新 | アンケート詳細 or 専用 UI（別途実装） |

---

## 1. 一覧確認の仕様

### 1.1 アンケート一覧（`/admin/surveys`）

**目的:** 全アンケートを一覧し、配信規模と回答率をひと目で把握する。

| 項目 | 仕様（86 5.1 準拠） | 現状 |
|------|---------------------|------|
| 表示列 | ID、タイトル、報酬（個）、状態（公開/非公開）、**配信対象数**、**回答率**、操作 | 配信対象数・回答率は**未表示**（Phase 4 で追加） |
| 配信対象数 | 当該 survey_id の `survey_targets` の件数 | API で取得するか、一覧 API の拡張で返す |
| 回答率 | 回答済み数 / 配信対象数（%）。例: 45% (54/120) | 同上 |
| 操作 | 配信対象者・詳細・結果集計へのリンク | ✅ 実装済み |

**データ取得案:**
- **案A:** `GET /api/surveys` のレスポンスに、各 survey ごとに `targetCount`, `answeredCount`, `answerRate` を含める（サブクエリ or 別テーブル集計）。
- **案B:** 一覧は現状のままにして、詳細ページで配信対象数・回答率を表示するのみ。

**受け入れ:** 一覧画面で「配信対象 ○人」「回答率 ○%」が分かること。

---

### 1.2 回答状況一覧（`/admin/surveys/[surveyId]/targets`）

**目的:** あるアンケートについて「誰が回答済みか・未回答か・後回し回数」を確認する。

| 項目 | 仕様（86 5.1「4. 回答状況一覧」） | 現状 |
|------|----------------------------------|------|
| サマリ | 対象者数、回答済み数、未回答数、回答率（%） | ✅ 実装済み |
| 表の列 | 表示名/本名、LIFF表示、状態（回答済み/未回答）、後回し回数、登録日時、操作（未回答に戻す） | ✅ 実装済み |
| データ元 | `survey_target_status` ビュー（targets/list API） | ✅ 実装済み |
| CSV 出力 | 任意（Phase 4 であれば望ましい） | 未実装（任意） |

**受け入れ:** 配信対象者ごとに回答状況・後回し回数が一覧で確認でき、回答済みを未回答に戻す操作ができること。→ **達成済み。**

---

## 2. 集計結果の仕様

**目的:** アンケートの回答内容を集計し、Q1（満足度）・Q3（NPS）・Q2（自由記述）を確認する。

### 2.1 データ（86 7.1 集計API 準拠）

| 項目 | 内容 | API | 現状 |
|------|------|-----|------|
| Q1 分布 | 1〜5 の各評価の件数 | `GET /api/surveys/results?surveyId=` の `q1Distribution` | ✅ 実装済み |
| NPS | 推奨者（9–10点）− 批判者（0–6点）を回答数で割り100倍（-100〜100） | 同 `nps` | ✅ 実装済み |
| 自由記述 | Q2 のコメント一覧（本文・回答日時・回答者） | 同 `comments` | ✅ 実装済み（氏名は user_id のみの場合は要拡張） |

### 2.2 画面表示（86 7.2 想定）

| 項目 | 仕様 | 現状 |
|------|------|------|
| 画面 | `/admin/surveys/[surveyId]/results` | ✅ 実装済み |
| Q1 | 1〜5 の評価別件数を棒グラフ or 横棒のバーで表示 | ✅ 横棒バーで表示 |
| NPS | 数値と「推奨者−批判者」の説明 | ✅ 表示済み |
| Q2 自由記述 | コメント本文・日時・回答者（real_name があれば表示） | ✅ 本文・日時・user_id 表示（氏名は API 次第で拡張可） |

**受け入れ:** 集計 API のデータが結果画面に反映され、Q1 分布・NPS・自由記述が確認できること。→ **達成済み（氏名表示は必要に応じて拡張）。**

---

## 3. Phase 4 チェックリスト（集計・一覧）

| # | 項目 | 仕様 | 状態 |
|---|------|------|------|
| 1 | 回答状況一覧 | 対象者・回答済み/未回答・後回し・操作 | ✅ 済 |
| 2 | 結果集計画面 | Q1 分布・NPS・自由記述 | ✅ 済 |
| 3 | 結果集計 API | q1Distribution, nps, comments | ✅ 済 |
| 4 | アンケート一覧の「配信対象数」「回答率」 | 一覧表に列追加 or API 拡張 | 🔲 要対応 |
| 5 | 配信設定 UI | LIFF初期表示 ON/OFF・配信期間の更新 | 🔲 要対応 |
| 6 | CSV 出力（回答状況） | 任意 | 未（任意） |

---

## 4. 補足：一覧での配信対象数・回答率の実装方針

- **API:** `GET /api/surveys` で、各 survey に対し `survey_targets` の件数と `answered_at IS NOT NULL` の件数を返す（サブクエリ or 集計ビュー）。  
  または `GET /api/surveys?withStats=1` のようにオプションで統計付きレスポンスを返す。
- **画面:** 一覧テーブルに「配信対象」列（例: 120人）と「回答率」列（例: 45% (54)）を追加する。

---

**最終更新:** 2026-02-26
